<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Country Balls: Mariage 💕</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap');
        
        * {
            font-family: 'Nunito', sans-serif;
        }
        
        body {
            transition: all 0.3s ease;
        }
        
        .flag-heart {
            background: linear-gradient(45deg, #FF6B9D, #FFB5C5);
            border-radius: 50%;
            box-shadow: 0 8px 25px rgba(255, 107, 157, 0.3);
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .flag-heart:hover {
            transform: translateY(-5px) scale(1.05);
            box-shadow: 0 12px 35px rgba(255, 107, 157, 0.5);
        }
        
        .btn {
            transition: all 0.3s ease;
            border: none;
            border-radius: 12px;
            padding: 12px 24px;
            font-weight: 600;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        
        .btn-primary {
            background: linear-gradient(45deg, #5D5CDE, #7C4DFF);
            color: white;
        }
        
        .btn-success {
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
        }
        
        .btn-warning {
            background: linear-gradient(45deg, #ffc107, #fd7e14);
            color: white;
        }
        
        .btn-secondary {
            background: linear-gradient(45deg, #6c757d, #495057);
            color: white;
        }
        
        .message {
            padding: 20px;
            border-radius: 15px;
            margin: 15px 0;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            animation: slideIn 0.5s ease-out;
        }
        
        .message.success {
            background: linear-gradient(45deg, #d4edda, #c3e6cb);
            border-left: 5px solid #28a745;
        }
        
        .message.error {
            background: linear-gradient(45deg, #f8d7da, #f1b0b7);
            border-left: 5px solid #dc3545;
        }
        
        .message.special {
            background: linear-gradient(45deg, #e2e3ff, #c8ccff);
            border-left: 5px solid #5D5CDE;
        }
        
        .message.impossible-message {
            background: linear-gradient(45deg, #FF6B6B, #FF8E53);
            color: white;
            border: 2px solid #FF4444;
        }
        
        .special-message {
            padding: 25px;
            border-radius: 15px;
            margin: 20px 0;
            text-align: center;
            color: white;
            font-weight: 600;
            box-shadow: 0 8px 30px rgba(0,0,0,0.2);
        }
        
        .heart-animation {
            position: fixed;
            font-size: 30px;
            pointer-events: none;
            z-index: 1000;
            animation: floatUp 2s ease-out forwards;
        }
        
        .country-card {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 20px;
            padding: 25px;
            margin: 20px 0;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }
        
        .country-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 20px 50px rgba(0,0,0,0.15);
            border-color: #5D5CDE;
        }
        
        .xp-bar {
            background: linear-gradient(90deg, #5D5CDE, #7C4DFF);
            height: 12px;
            border-radius: 6px;
            transition: width 0.8s ease;
            position: relative;
            overflow: hidden;
        }
        
        .xp-bar::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            animation: shimmer 2s infinite;
        }
        
        /* Mode sombre amélioré */
        .dark,
        .dark body,
        html.dark,
        html.dark body {
            background-color: #181818 !important;
            color: #ffffff !important;
        }
        
        .dark .country-card {
            background: rgba(30, 30, 30, 0.9) !important;
            border-color: #444 !important;
            color: #ffffff !important;
        }
        
        .dark .btn-primary {
            background: linear-gradient(45deg, #7C4DFF, #5D5CDE) !important;
        }
        
        .dark .message.success {
            background: linear-gradient(45deg, #1a4532, #166534) !important;
            color: #ffffff !important;
        }
        
        .dark .message.error {
            background: linear-gradient(45deg, #4c1d24, #7f1d1d) !important;
            color: #ffffff !important;
        }
        
        .dark .message.special {
            background: linear-gradient(45deg, #312e81, #3730a3) !important;
            color: #ffffff !important;
        }
        
        /* Forcer le fond sombre partout */
        html[data-theme="dark"],
        html[data-theme="dark"] body,
        .dark,
        .dark body {
            background: #181818 !important;
            color: #ffffff !important;
        }
        
        /* Container principal en mode sombre */
        .dark .container {
            background: transparent !important;
        }

        /* ========================================== */
        /* SYSTÈME AERO GLASS AVEC RÉGLAGE D'INTENSITÉ */
        /* ========================================== */
        
        :root {
            --aero-blur-intensity: 16px;
            --aero-opacity: 0.15;
            --aero-border-opacity: 0.4;
            --aero-brightness: 0.9;
        }
        
        /* Classe principale Aero Glass */
        .aero-glass {
            backdrop-filter: blur(var(--aero-blur-intensity)) brightness(var(--aero-brightness));
            -webkit-backdrop-filter: blur(var(--aero-blur-intensity)) brightness(var(--aero-brightness));
            background: rgba(255, 255, 255, var(--aero-opacity)) !important;
            border: 1.5px solid rgba(255, 255, 255, var(--aero-border-opacity)) !important;
            box-shadow: 
                0 8px 32px rgba(31, 38, 135, 0.37),
                inset 0 1px 0 rgba(255, 255, 255, 0.3),
                inset 0 -1px 0 rgba(255, 255, 255, 0.1) !important;
            position: relative;
            overflow: hidden;
        }
        
        /* Mode sombre pour Aero Glass */
        .dark .aero-glass {
            background: rgba(30, 30, 30, 0.25) !important;
            border: 1.5px solid rgba(255, 255, 255, 0.2) !important;
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.5),
                inset 0 1px 0 rgba(255, 255, 255, 0.2),
                inset 0 -1px 0 rgba(255, 255, 255, 0.05) !important;
        }
        
        /* Pseudo-élément pour renforcer l'effet glassmorphism */
        .aero-glass::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, 
                transparent, 
                rgba(255, 255, 255, 0.6), 
                transparent);
            z-index: 1;
            pointer-events: none;
        }
        
        /* Pseudo-élément pour l'effet de reflet */
        .aero-glass::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, 
                transparent, 
                rgba(255, 255, 255, 0.1), 
                transparent);
            animation: aeroShimmer 3s ease-in-out infinite;
            z-index: 1;
            pointer-events: none;
        }
        
        @keyframes aeroShimmer {
            0%, 100% { 
                left: -100%; 
                opacity: 0; 
            }
            50% { 
                left: 100%; 
                opacity: 1; 
            }
        }
        
        /* Applications spécifiques de l'effet Aero Glass */
        
        /* Cartes principales */
        .country-card.aero-glass {
            transition: all 0.3s ease;
        }
        
        .country-card.aero-glass:hover {
            backdrop-filter: blur(calc(var(--aero-blur-intensity) + 4px)) brightness(1.1);
            -webkit-backdrop-filter: blur(calc(var(--aero-blur-intensity) + 4px)) brightness(1.1);
            transform: translateY(-2px);
            box-shadow: 
                0 12px 40px rgba(31, 38, 135, 0.5),
                inset 0 1px 0 rgba(255, 255, 255, 0.4),
                inset 0 -1px 0 rgba(255, 255, 255, 0.2) !important;
        }
        
        /* Messages avec effet Aero */
        .message.aero-glass {
            backdrop-filter: blur(var(--aero-blur-intensity)) brightness(var(--aero-brightness));
            -webkit-backdrop-filter: blur(var(--aero-blur-intensity)) brightness(var(--aero-brightness));
        }
        
        .message.success.aero-glass {
            background: rgba(212, 237, 218, 0.3) !important;
            border-left: 5px solid rgba(40, 167, 69, 0.8) !important;
        }
        
        .message.error.aero-glass {
            background: rgba(248, 215, 218, 0.3) !important;
            border-left: 5px solid rgba(220, 53, 69, 0.8) !important;
        }
        
        .message.special.aero-glass {
            background: rgba(226, 227, 255, 0.3) !important;
            border-left: 5px solid rgba(93, 92, 222, 0.8) !important;
        }
        
        /* Chat avec effet Aero */
        .chat-window.aero-glass {
            backdrop-filter: blur(var(--aero-blur-intensity)) brightness(var(--aero-brightness));
            -webkit-backdrop-filter: blur(var(--aero-blur-intensity)) brightness(var(--aero-brightness));
            background: rgba(255, 255, 255, 0.12) !important;
            border-radius: 20px !important;
        }
        
        .dark .chat-window.aero-glass {
            background: rgba(30, 30, 30, 0.2) !important;
        }
        
        /* En-tête de chat avec effet subtil */
        .chat-header.aero-glass {
            background: rgba(93, 92, 222, 0.15) !important;
            backdrop-filter: blur(calc(var(--aero-blur-intensity) / 2));
            -webkit-backdrop-filter: blur(calc(var(--aero-blur-intensity) / 2));
        }
        
        /* Boutons avec effet léger */
        .btn.aero-glass {
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.3) !important;
            position: relative;
            overflow: hidden;
        }
        
        .btn.aero-glass:hover {
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            transform: translateY(-1px);
        }
        
        /* Modales et overlays */
        .modal-aero {
            backdrop-filter: blur(calc(var(--aero-blur-intensity) * 1.5));
            -webkit-backdrop-filter: blur(calc(var(--aero-blur-intensity) * 1.5));
            background: rgba(255, 255, 255, 0.08) !important;
        }
        
        /* Sélecteurs et inputs */
        .form-aero {
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            background: rgba(255, 255, 255, 0.1) !important;
            border: 1px solid rgba(255, 255, 255, 0.3) !important;
        }
        
        .dark .form-aero {
            background: rgba(60, 60, 60, 0.2) !important;
            border: 1px solid rgba(255, 255, 255, 0.15) !important;
        }
        
        /* Compatibilité navigateurs - Fallback pour les navigateurs non compatibles */
        @supports not (backdrop-filter: blur(1px)) {
            .aero-glass {
                background: rgba(255, 255, 255, 0.85) !important;
                box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37) !important;
            }
            
            .dark .aero-glass {
                background: rgba(30, 30, 30, 0.85) !important;
            }
            
            .chat-window.aero-glass {
                background: rgba(255, 255, 255, 0.95) !important;
            }
            
            .dark .chat-window.aero-glass {
                background: rgba(30, 30, 30, 0.95) !important;
            }
        }
        
        /* Styles pour le curseur de réglage d'intensité */
        .aero-intensity-slider {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: linear-gradient(90deg, 
                rgba(93, 92, 222, 0.3), 
                rgba(93, 92, 222, 0.8));
            outline: none;
            -webkit-appearance: none;
            appearance: none;
            cursor: pointer;
        }
        
        .aero-intensity-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: linear-gradient(45deg, #5D5CDE, #7C4DFF);
            cursor: pointer;
            border: 2px solid rgba(255, 255, 255, 0.8);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        
        .aero-intensity-slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: linear-gradient(45deg, #5D5CDE, #7C4DFF);
            cursor: pointer;
            border: 2px solid rgba(255, 255, 255, 0.8);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        
        /* Panneau de contrôle Aero */
        .aero-control-panel {
            backdrop-filter: blur(20px) brightness(1.1);
            -webkit-backdrop-filter: blur(20px) brightness(1.1);
            background: rgba(255, 255, 255, 0.1) !important;
            border: 1.5px solid rgba(255, 255, 255, 0.3) !important;
            border-radius: 12px;
            padding: 20px;
            margin: 10px 0;
        }
        
        .dark .aero-control-panel {
            background: rgba(30, 30, 30, 0.2) !important;
            border: 1.5px solid rgba(255, 255, 255, 0.15) !important;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-30px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        @keyframes floatUp {
            from {
                opacity: 1;
                transform: translateY(0);
            }
            to {
                opacity: 0;
                transform: translateY(-100px);
            }
        }
        
        @keyframes shimmer {
            0% { left: -100%; }
            100% { left: 100%; }
        }
        
        @keyframes heartbeat {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        
        /* Animations pour jalousie et guerre */
        @keyframes dramaticPulse {
            0%, 100% { transform: scale(1); box-shadow: 0 0 20px rgba(255, 0, 0, 0.5); }
            50% { transform: scale(1.03); box-shadow: 0 0 30px rgba(255, 0, 0, 0.8); }
        }
        
        @keyframes warAlert {
            0%, 100% { 
                box-shadow: 0 0 40px rgba(255, 0, 0, 0.8);
                border-color: #FF0000;
            }
            50% { 
                box-shadow: 0 0 60px rgba(255, 255, 0, 1);
                border-color: #FFFF00;
            }
        }
        
        @keyframes explosionBlink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
        
        @keyframes warShake {
            0%, 100% { transform: translateX(0) translateY(0); }
            25% { transform: translateX(-8px) translateY(-5px); }
            75% { transform: translateX(8px) translateY(5px); }
        }
        
        @keyframes explosionPop {
            0% { transform: scale(0); opacity: 1; }
            50% { transform: scale(2); opacity: 0.9; }
            100% { transform: scale(3); opacity: 0; }
        }
        
        @keyframes warFlash {
            0%, 100% { opacity: 0; }
            50% { opacity: 1; }
        }
        
        @keyframes nuclearFlash {
            0% { opacity: 0; transform: scale(0); }
            25% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.9; transform: scale(1.5); }
            100% { opacity: 0; transform: scale(4); }
        }
        
        @keyframes mushroomRise {
            0% { 
                transform: translate(-50%, 150%); 
                opacity: 0; 
                font-size: 50px; 
            }
            50% { 
                transform: translate(-50%, -30%); 
                opacity: 1; 
                font-size: 100px; 
            }
            100% { 
                transform: translate(-50%, -50%); 
                opacity: 0.8; 
                font-size: 150px; 
            }
        }
        
        @keyframes heartsFloat {
            0% { transform: translateY(30px); opacity: 0; }
            50% { transform: translateY(-15px); opacity: 1; }
            100% { transform: translateY(0); opacity: 1; }
        }
        
        @keyframes tensionFlash {
            0%, 100% { opacity: 0; }
            50% { opacity: 1; }
        }
        
        /* ========================================== */
        /* STYLES POUR LE TCHAT INTERACTIF */
        /* ========================================== */
        
        .chat-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 350px;
            height: 500px;
            z-index: 1000;
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }
        
        .chat-container.minimized {
            height: 60px;
            width: 200px;
        }
        
        .chat-window {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            height: 100%;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .dark .chat-window {
            background: rgba(30, 30, 30, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .chat-header {
            padding: 15px 20px;
            background: linear-gradient(135deg, rgba(93, 92, 222, 0.1), rgba(124, 77, 255, 0.1));
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-radius: 20px 20px 0 0;
        }
        
        .chat-partner-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .chat-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(45deg, #5D5CDE, #7C4DFF);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            color: white;
            font-weight: bold;
        }
        
        .chat-partner-details h4 {
            margin: 0;
            font-size: 16px;
            font-weight: 600;
            color: #333;
        }
        
        .dark .chat-partner-details h4 {
            color: #fff;
        }
        
        .chat-partner-details p {
            margin: 0;
            font-size: 12px;
            color: #666;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .dark .chat-partner-details p {
            color: #ccc;
        }
        
        .chat-controls {
            display: flex;
            gap: 8px;
        }
        
        .chat-btn {
            width: 32px;
            height: 32px;
            border: none;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            color: #5D5CDE;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            font-size: 14px;
        }
        
        .chat-btn:hover {
            background: rgba(93, 92, 222, 0.2);
            transform: scale(1.1);
        }
        
        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .chat-messages::-webkit-scrollbar {
            width: 4px;
        }
        
        .chat-messages::-webkit-scrollbar-track {
            background: transparent;
        }
        
        .chat-messages::-webkit-scrollbar-thumb {
            background: rgba(93, 92, 222, 0.3);
            border-radius: 2px;
        }
        
        .message-bubble {
            max-width: 80%;
            padding: 12px 16px;
            border-radius: 18px;
            font-size: 14px;
            line-height: 1.4;
            animation: messageSlideIn 0.3s ease-out;
            position: relative;
        }
        
        .message-bubble.sent {
            align-self: flex-end;
            background: linear-gradient(135deg, #5D5CDE, #7C4DFF);
            color: white;
            border-bottom-right-radius: 6px;
        }
        
        .message-bubble.received {
            align-self: flex-start;
            background: rgba(240, 240, 240, 0.8);
            color: #333;
            border-bottom-left-radius: 6px;
        }
        
        .dark .message-bubble.received {
            background: rgba(60, 60, 60, 0.8);
            color: #fff;
        }
        
        .message-time {
            font-size: 10px;
            opacity: 0.7;
            margin-top: 4px;
        }
        
        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 16px;
            background: rgba(240, 240, 240, 0.8);
            border-radius: 18px;
            border-bottom-left-radius: 6px;
            max-width: 80%;
            align-self: flex-start;
        }
        
        .dark .typing-indicator {
            background: rgba(60, 60, 60, 0.8);
        }
        
        .typing-dots {
            display: flex;
            gap: 3px;
        }
        
        .typing-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #999;
            animation: typingDot 1.4s ease-in-out infinite both;
        }
        
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        .typing-dot:nth-child(3) { animation-delay: 0s; }
        
        .chat-input-area {
            padding: 15px 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(255, 255, 255, 0.05);
            border-radius: 0 0 20px 20px;
        }
        
        .quick-messages {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
            flex-wrap: wrap;
        }
        
        .quick-msg-btn {
            padding: 6px 12px;
            border: 1px solid rgba(93, 92, 222, 0.3);
            border-radius: 15px;
            background: rgba(93, 92, 222, 0.1);
            color: #5D5CDE;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .quick-msg-btn:hover {
            background: rgba(93, 92, 222, 0.2);
            transform: translateY(-1px);
        }
        
        .chat-input-container {
            display: flex;
            gap: 8px;
            align-items: flex-end;
        }
        
        .chat-input {
            flex: 1;
            padding: 12px 16px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            background: rgba(255, 255, 255, 0.8);
            font-size: 14px;
            resize: none;
            max-height: 80px;
            min-height: 44px;
        }
        
        .dark .chat-input {
            background: rgba(60, 60, 60, 0.8);
            color: #fff;
            border-color: rgba(255, 255, 255, 0.1);
        }
        
        .chat-input:focus {
            outline: none;
            border-color: #5D5CDE;
            box-shadow: 0 0 0 2px rgba(93, 92, 222, 0.2);
        }
        
        .emoji-btn {
            width: 44px;
            height: 44px;
            border: none;
            border-radius: 50%;
            background: linear-gradient(45deg, #5D5CDE, #7C4DFF);
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            font-size: 18px;
        }
        
        .emoji-btn:hover {
            transform: scale(1.1);
        }
        
        .send-btn {
            width: 44px;
            height: 44px;
            border: none;
            border-radius: 50%;
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            font-size: 16px;
        }
        
        .send-btn:hover {
            transform: scale(1.1);
        }
        
        .send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .emoji-picker {
            position: absolute;
            bottom: 60px;
            right: 60px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 15px;
            padding: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            display: none;
            grid-template-columns: repeat(6, 1fr);
            gap: 8px;
            max-width: 250px;
        }
        
        .dark .emoji-picker {
            background: rgba(30, 30, 30, 0.95);
            border-color: rgba(255, 255, 255, 0.1);
        }
        
        .emoji-picker.show {
            display: grid;
            animation: fadeIn 0.2s ease-out;
        }
        
        .emoji-option {
            width: 32px;
            height: 32px;
            border: none;
            border-radius: 8px;
            background: transparent;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .emoji-option:hover {
            background: rgba(93, 92, 222, 0.1);
            transform: scale(1.2);
        }
        
        .chat-notification {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #ff4444;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        
        @keyframes messageSlideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes typingDot {
            0%, 80%, 100% {
                transform: scale(0);
                opacity: 0.5;
            }
            40% {
                transform: scale(1);
                opacity: 1;
            }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }
        
        /* ========================================== */
        /* NOUVELLES FONCTIONNALITÉS CHAT AVANCÉES */
        /* ========================================== */
        
        /* Réactions sur les messages */
        .message-reactions {
            margin-top: 8px;
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }
        
        .message-bubble:hover .reaction-add-btn {
            opacity: 1;
        }
        
        .reaction-add-btn {
            position: absolute;
            top: -15px;
            right: 10px;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid rgba(0, 0, 0, 0.1);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            opacity: 0;
            transition: all 0.2s ease;
            z-index: 10;
        }
        
        .reaction-add-btn:hover {
            transform: scale(1.1);
            background: rgba(93, 92, 222, 0.1);
        }
        
        .reaction-item {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 12px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 1px solid rgba(0, 0, 0, 0.1);
        }
        
        .dark .reaction-item {
            background: rgba(60, 60, 60, 0.8);
            color: #fff;
        }
        
        .reaction-item:hover {
            transform: scale(1.05);
            background: rgba(93, 92, 222, 0.2);
        }
        
        .reaction-item.selected {
            background: linear-gradient(45deg, #5D5CDE, #7C4DFF);
            color: white;
        }
        
        /* Sondages */
        .poll-container {
            background: linear-gradient(135deg, rgba(93, 92, 222, 0.1), rgba(124, 77, 255, 0.1));
            border-radius: 15px;
            padding: 15px;
            margin: 10px 0;
            border: 1px solid rgba(93, 92, 222, 0.3);
        }
        
        .poll-question {
            font-weight: 600;
            margin-bottom: 12px;
            color: #5D5CDE;
        }
        
        .dark .poll-question {
            color: #7C4DFF;
        }
        
        .poll-options {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .poll-option {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.7);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
        }
        
        .dark .poll-option {
            background: rgba(60, 60, 60, 0.7);
        }
        
        .poll-option:hover {
            background: rgba(93, 92, 222, 0.2);
        }
        
        .poll-option.voted {
            background: rgba(93, 92, 222, 0.3);
            cursor: default;
        }
        
        .poll-progress {
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            background: linear-gradient(90deg, rgba(93, 92, 222, 0.4), rgba(124, 77, 255, 0.4));
            transition: width 0.8s ease;
            z-index: 1;
        }
        
        .poll-option-content {
            position: relative;
            z-index: 2;
            display: flex;
            align-items: center;
            gap: 10px;
            width: 100%;
        }
        
        .poll-percentage {
            margin-left: auto;
            font-weight: 600;
            font-size: 14px;
        }
        
        /* Drama Cards */
        .drama-card {
            background: linear-gradient(135deg, #FF6B6B, #FF8E53);
            color: white;
            border-radius: 15px;
            padding: 20px;
            margin: 15px 0;
            text-align: center;
            box-shadow: 0 8px 25px rgba(255, 107, 107, 0.3);
            animation: dramaticEntrance 0.8s ease-out;
            position: relative;
            overflow: hidden;
        }
        
        .drama-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            animation: cardShimmer 2s ease-in-out infinite;
        }
        
        .drama-card-header {
            font-size: 24px;
            margin-bottom: 10px;
        }
        
        .drama-card-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 8px;
        }
        
        .drama-card-description {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 15px;
        }
        
        .drama-card-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        /* Messages de guerre */
        .war-chat-mode .chat-window {
            border: 2px solid #FF0000;
            animation: warPulse 2s ease-in-out infinite;
        }
        
        .war-chat-mode .chat-header {
            background: linear-gradient(135deg, rgba(255, 0, 0, 0.2), rgba(255, 68, 68, 0.2));
        }
        
        .war-message {
            background: linear-gradient(135deg, #FF4444, #FF0000);
            color: white;
            border-radius: 15px;
            padding: 15px;
            margin: 10px 0;
            text-align: center;
            animation: warAlert 1s ease-in-out infinite;
        }
        
        /* Système de cadeaux */
        .gift-container {
            background: linear-gradient(135deg, #FFD700, #FFA500);
            border-radius: 15px;
            padding: 15px;
            margin: 10px 0;
            text-align: center;
            color: #8B4513;
            border: 2px solid #FFD700;
            animation: giftSparkle 2s ease-in-out infinite;
        }
        
        .gift-emoji {
            font-size: 48px;
            margin-bottom: 10px;
            animation: giftBounce 1s ease-in-out infinite;
        }
        
        .gift-text {
            font-weight: 600;
            font-size: 16px;
        }
        
        .gift-picker {
            position: absolute;
            bottom: 60px;
            right: 120px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            display: none;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            max-width: 200px;
        }
        
        .dark .gift-picker {
            background: rgba(30, 30, 30, 0.95);
        }
        
        .gift-picker.show {
            display: grid;
            animation: fadeIn 0.2s ease-out;
        }
        
        .gift-option {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            padding: 15px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            background: rgba(255, 255, 255, 0.5);
        }
        
        .dark .gift-option {
            background: rgba(60, 60, 60, 0.5);
        }
        
        .gift-option:hover {
            background: rgba(93, 92, 222, 0.2);
            transform: scale(1.05);
        }
        
        .gift-option-emoji {
            font-size: 32px;
        }
        
        .gift-option-text {
            font-size: 10px;
            text-align: center;
            font-weight: 600;
        }
        
        /* Mission coopérative */
        .coop-mission {
            background: linear-gradient(135deg, #4ECDC4, #44A08D);
            color: white;
            border-radius: 15px;
            padding: 20px;
            margin: 15px 0;
            text-align: center;
            border: 2px solid #4ECDC4;
        }
        
        .coop-mission-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 12px;
        }
        
        .coop-mission-question {
            font-size: 16px;
            margin-bottom: 15px;
            background: rgba(255, 255, 255, 0.2);
            padding: 10px;
            border-radius: 10px;
        }
        
        .coop-mission-answers {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .coop-answer {
            padding: 10px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 2px solid transparent;
        }
        
        .coop-answer:hover {
            background: rgba(255, 255, 255, 0.4);
        }
        
        .coop-answer.selected {
            border-color: white;
            background: rgba(255, 255, 255, 0.5);
        }
        
        .coop-answer.correct {
            background: rgba(40, 167, 69, 0.7);
        }
        
        .coop-answer.incorrect {
            background: rgba(220, 53, 69, 0.7);
        }
        
        /* Historique des dramas */
        .drama-history {
            max-height: 300px;
            overflow-y: auto;
            padding: 10px;
        }
        
        .drama-history-item {
            background: rgba(255, 255, 255, 0.8);
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 10px;
            border-left: 4px solid #FF6B6B;
        }
        
        .dark .drama-history-item {
            background: rgba(60, 60, 60, 0.8);
        }
        
        .drama-history-date {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }
        
        .dark .drama-history-date {
            color: #ccc;
        }
        
        .drama-history-type {
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .drama-history-impact {
            font-size: 14px;
            color: #FF6B6B;
        }
        
        /* Onglets du chat */
        .chat-tabs {
            display: flex;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(255, 255, 255, 0.05);
        }
        
        .chat-tab {
            flex: 1;
            padding: 12px;
            text-align: center;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            color: #666;
            transition: all 0.2s ease;
            border-bottom: 3px solid transparent;
        }
        
        .dark .chat-tab {
            color: #ccc;
        }
        
        .chat-tab:hover {
            background: rgba(93, 92, 222, 0.1);
        }
        
        .chat-tab.active {
            color: #5D5CDE;
            border-bottom-color: #5D5CDE;
            background: rgba(93, 92, 222, 0.1);
        }
        
        .chat-tab-content {
            display: none;
            flex: 1;
            overflow: hidden;
        }
        
        .chat-tab-content.active {
            display: flex;
            flex-direction: column;
        }
        
        /* Animations spéciales */
        @keyframes dramaticEntrance {
            0% { transform: scale(0.8) rotate(-5deg); opacity: 0; }
            50% { transform: scale(1.05) rotate(2deg); }
            100% { transform: scale(1) rotate(0deg); opacity: 1; }
        }
        
        @keyframes cardShimmer {
            0% { left: -100%; }
            100% { left: 100%; }
        }
        
        @keyframes warPulse {
            0%, 100% { box-shadow: 0 0 20px rgba(255, 0, 0, 0.5); }
            50% { box-shadow: 0 0 40px rgba(255, 0, 0, 0.8); }
        }
        
        @keyframes giftSparkle {
            0%, 100% { box-shadow: 0 0 20px rgba(255, 215, 0, 0.5); }
            50% { box-shadow: 0 0 30px rgba(255, 215, 0, 0.8); }
        }
        
        @keyframes giftBounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        
        /* Animations pour les ruptures dramatiques */
        @keyframes breakupFall {
            0% { 
                transform: translateY(0) rotate(0deg); 
                opacity: 1; 
            }
            100% { 
                transform: translateY(100vh) rotate(360deg); 
                opacity: 0; 
            }
        }
        
        @keyframes breakupShake {
            0%, 100% { transform: translateX(0) translateY(0); }
            10% { transform: translateX(-10px) translateY(-5px); }
            20% { transform: translateX(10px) translateY(5px); }
            30% { transform: translateX(-8px) translateY(-3px); }
            40% { transform: translateX(8px) translateY(3px); }
            50% { transform: translateX(-6px) translateY(-2px); }
            60% { transform: translateX(6px) translateY(2px); }
            70% { transform: translateX(-4px) translateY(-1px); }
            80% { transform: translateX(4px) translateY(1px); }
            90% { transform: translateX(-2px) translateY(0); }
        }
        
        @keyframes sadnessOverlay {
            0% { opacity: 0; }
            50% { opacity: 0.6; }
            100% { opacity: 0; }
        }
        
        @keyframes breakupDisappear {
            0% { 
                transform: scale(1); 
                opacity: 1; 
            }
            50% { 
                transform: scale(0.95); 
                opacity: 0.5; 
            }
            100% { 
                transform: scale(0.8); 
                opacity: 0; 
            }
        }
        
        /* Responsive design pour mobile */
        @media (max-width: 768px) {
            .chat-container {
                width: calc(100vw - 20px);
                right: 10px;
                left: 10px;
                bottom: 10px;
            }
            
            .chat-container.minimized {
                width: 180px;
                right: 10px;
                left: auto;
            }
            
            .gift-picker {
                right: 10px;
                max-width: 150px;
                grid-template-columns: repeat(2, 1fr);
            }
            
            .coop-mission-answers {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body class="min-h-screen bg-white text-gray-800 transition-colors duration-300">
    <div class="container mx-auto px-4 py-8 max-w-4xl">
        <!-- Header -->
        <header class="text-center mb-8">
            <h1 class="text-4xl md:text-5xl font-bold bg-gradient-to-r from-pink-500 to-purple-600 bg-clip-text text-transparent mb-4">
                💕 Country Balls: Mariage 💕
            </h1>
            <p class="text-lg text-gray-600 dark:text-gray-300">
                Trouvez l'amour à travers le monde ! 🌍💖
            </p>
            
            <!-- Sélecteurs de langue et thème -->
            <div class="flex flex-wrap gap-4 justify-center items-center mt-4">
                <div class="flex flex-col items-center">
                    <label class="text-sm font-semibold mb-1">🌐 Langue d'interface</label>
                    <select id="languageSelect" class="p-2 border-2 border-purple-300 rounded-lg text-sm focus:border-purple-500 focus:outline-none transition-colors duration-300 dark:bg-gray-700 dark:border-gray-600 dark:text-white" onchange="changeLanguage()">
                        <option value="fr">🇫🇷 Français</option>
                        <option value="en">🇺🇸 English</option>
                        <option value="es">🇪🇸 Español</option>
                        <option value="de">🇩🇪 Deutsch</option>
                        <option value="it">🇮🇹 Italiano</option>
                    </select>
                </div>
                
                <div class="flex flex-col items-center">
                    <label class="text-sm font-semibold mb-1">🗣️ Prononciation</label>
                    <select id="pronunciationSelect" class="p-2 border-2 border-purple-300 rounded-lg text-sm focus:border-purple-500 focus:outline-none transition-colors duration-300 dark:bg-gray-700 dark:border-gray-600 dark:text-white" onchange="changePronunciationLanguage()">
                        <option value="auto">🌍 Auto (selon origine)</option>
                        <option value="fr">🇫🇷 Français</option>
                        <option value="en">🇺🇸 English</option>
                        <option value="es">🇪🇸 Español</option>
                        <option value="de">🇩🇪 Deutsch</option>
                        <option value="it">🇮🇹 Italiano</option>
                        <option value="ar">🇲🇦 العربية</option>
                        <option value="kab">ⵣ Kabyle</option>
                    </select>
                </div>
                
                <button id="themeToggle" class="btn btn-secondary" onclick="toggleTheme()">
                    🌙 Mode Sombre
                </button>
            </div>
        </header>

        <!-- Écran de création de personnage -->
        <div id="characterCreation" class="text-center">
            <div class="country-card">
                <h2 class="text-3xl font-bold mb-6 text-center">✨ Création de votre Country Ball ✨</h2>
                
                <!-- Informations de base -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div>
                        <label class="block text-lg font-semibold mb-3">👤 Prénom :</label>
                        <input type="text" id="firstName" placeholder="Votre prénom..." 
                               class="w-full p-4 border-2 border-purple-300 rounded-lg text-base focus:border-purple-500 focus:outline-none transition-colors duration-300 dark:bg-gray-700 dark:border-gray-600 dark:text-white"
                               onchange="updateCharacterPreview()">
                    </div>
                    
                    <div>
                        <label class="block text-lg font-semibold mb-3">🏷️ Nom de famille :</label>
                        <input type="text" id="lastName" placeholder="Votre nom..." 
                               class="w-full p-4 border-2 border-purple-300 rounded-lg text-base focus:border-purple-500 focus:outline-none transition-colors duration-300 dark:bg-gray-700 dark:border-gray-600 dark:text-white"
                               onchange="updateCharacterPreview()">
                    </div>
                    
                    <div>
                        <label class="block text-lg font-semibold mb-3">⚧️ Genre :</label>
                        <select id="genderSelect" 
                                class="w-full p-4 border-2 border-purple-300 rounded-lg text-base focus:border-purple-500 focus:outline-none transition-colors duration-300 dark:bg-gray-700 dark:border-gray-600 dark:text-white"
                                onchange="updateCharacterPreview()">
                            <option value="">Choisissez...</option>
                            <option value="male">👨 Homme</option>
                            <option value="female">👩 Femme</option>
                        </select>
                    </div>
                </div>

                <!-- Sélection des origines multiples -->
                <div class="mb-8">
                    <label class="block text-lg font-semibold mb-3">🌍 Vos origines (sélectionnez jusqu'à 3) :</label>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3 max-h-60 overflow-y-auto border-2 border-purple-200 rounded-lg p-4 dark:border-gray-600">
                        <div class="origin-checkbox">
                            <input type="checkbox" id="origin_France" value="France" onchange="updateOriginSelection()">
                            <label for="origin_France" class="flex items-center gap-2 cursor-pointer p-2 rounded hover:bg-purple-100 dark:hover:bg-gray-700">
                                <span>🇫🇷</span> <span>France</span>
                            </label>
                        </div>
                        <div class="origin-checkbox">
                            <input type="checkbox" id="origin_Morocco" value="Morocco" onchange="updateOriginSelection()">
                            <label for="origin_Morocco" class="flex items-center gap-2 cursor-pointer p-2 rounded hover:bg-purple-100 dark:hover:bg-gray-700">
                                <span>🇲🇦</span> <span>Maroc</span>
                            </label>
                        </div>
                        <div class="origin-checkbox">
                            <input type="checkbox" id="origin_Algeria" value="Algeria" onchange="updateOriginSelection()">
                            <label for="origin_Algeria" class="flex items-center gap-2 cursor-pointer p-2 rounded hover:bg-purple-100 dark:hover:bg-gray-700">
                                <span>🇩🇿</span> <span>Algérie</span>
                            </label>
                        </div>
                        <div class="origin-checkbox">
                            <input type="checkbox" id="origin_Kabylia" value="Kabylia" onchange="updateOriginSelection()">
                            <label for="origin_Kabylia" class="flex items-center gap-2 cursor-pointer p-2 rounded hover:bg-purple-100 dark:hover:bg-gray-700">
                                <span>ⵣ</span> <span>Kabyle</span>
                            </label>
                        </div>
                        <div class="origin-checkbox">
                            <input type="checkbox" id="origin_Tunisia" value="Tunisia" onchange="updateOriginSelection()">
                            <label for="origin_Tunisia" class="flex items-center gap-2 cursor-pointer p-2 rounded hover:bg-purple-100 dark:hover:bg-gray-700">
                                <span>🇹🇳</span> <span>Tunisie</span>
                            </label>
                        </div>
                        <div class="origin-checkbox">
                            <input type="checkbox" id="origin_Lebanon" value="Lebanon" onchange="updateOriginSelection()">
                            <label for="origin_Lebanon" class="flex items-center gap-2 cursor-pointer p-2 rounded hover:bg-purple-100 dark:hover:bg-gray-700">
                                <span>🇱🇧</span> <span>Liban</span>
                            </label>
                        </div>
                        <div class="origin-checkbox">
                            <input type="checkbox" id="origin_Germany" value="Germany" onchange="updateOriginSelection()">
                            <label for="origin_Germany" class="flex items-center gap-2 cursor-pointer p-2 rounded hover:bg-purple-100 dark:hover:bg-gray-700">
                                <span>🇩🇪</span> <span>Allemagne</span>
                            </label>
                        </div>
                        <div class="origin-checkbox">
                            <input type="checkbox" id="origin_Turkey" value="Turkey" onchange="updateOriginSelection()">
                            <label for="origin_Turkey" class="flex items-center gap-2 cursor-pointer p-2 rounded hover:bg-purple-100 dark:hover:bg-gray-700">
                                <span>🇹🇷</span> <span>Turquie</span>
                            </label>
                        </div>
                        <div class="origin-checkbox">
                            <input type="checkbox" id="origin_Italy" value="Italy" onchange="updateOriginSelection()">
                            <label for="origin_Italy" class="flex items-center gap-2 cursor-pointer p-2 rounded hover:bg-purple-100 dark:hover:bg-gray-700">
                                <span>🇮🇹</span> <span>Italie</span>
                            </label>
                        </div>
                        <div class="origin-checkbox">
                            <input type="checkbox" id="origin_Spain" value="Spain" onchange="updateOriginSelection()">
                            <label for="origin_Spain" class="flex items-center gap-2 cursor-pointer p-2 rounded hover:bg-purple-100 dark:hover:bg-gray-700">
                                <span>🇪🇸</span> <span>Espagne</span>
                            </label>
                        </div>
                        <div class="origin-checkbox">
                            <input type="checkbox" id="origin_Canada" value="Canada" onchange="updateOriginSelection()">
                            <label for="origin_Canada" class="flex items-center gap-2 cursor-pointer p-2 rounded hover:bg-purple-100 dark:hover:bg-gray-700">
                                <span>🇨🇦</span> <span>Canada</span>
                            </label>
                        </div>
                        <div class="origin-checkbox">
                            <input type="checkbox" id="origin_US" value="United States" onchange="updateOriginSelection()">
                            <label for="origin_US" class="flex items-center gap-2 cursor-pointer p-2 rounded hover:bg-purple-100 dark:hover:bg-gray-700">
                                <span>🇺🇸</span> <span>États-Unis</span>
                            </label>
                        </div>
                        <div class="origin-checkbox">
                            <input type="checkbox" id="origin_Mexico" value="Mexico" onchange="updateOriginSelection()">
                            <label for="origin_Mexico" class="flex items-center gap-2 cursor-pointer p-2 rounded hover:bg-purple-100 dark:hover:bg-gray-700">
                                <span>🇲🇽</span> <span>Mexique</span>
                            </label>
                        </div>
                        <div class="origin-checkbox">
                            <input type="checkbox" id="origin_Brazil" value="Brazil" onchange="updateOriginSelection()">
                            <label for="origin_Brazil" class="flex items-center gap-2 cursor-pointer p-2 rounded hover:bg-purple-100 dark:hover:bg-gray-700">
                                <span>🇧🇷</span> <span>Brésil</span>
                            </label>
                        </div>
                        <div class="origin-checkbox">
                            <input type="checkbox" id="origin_UK" value="United Kingdom" onchange="updateOriginSelection()">
                            <label for="origin_UK" class="flex items-center gap-2 cursor-pointer p-2 rounded hover:bg-purple-100 dark:hover:bg-gray-700">
                                <span>🇬🇧</span> <span>Royaume-Uni</span>
                            </label>
                        </div>
                        <div class="origin-checkbox">
                            <input type="checkbox" id="origin_Japan" value="Japan" onchange="updateOriginSelection()">
                            <label for="origin_Japan" class="flex items-center gap-2 cursor-pointer p-2 rounded hover:bg-purple-100 dark:hover:bg-gray-700">
                                <span>🇯🇵</span> <span>Japon</span>
                            </label>
                        </div>
                    </div>
                    <div id="selectedOrigins" class="mt-3 text-sm text-purple-600 dark:text-purple-400"></div>
                </div>

                <!-- Chiffre porte-bonheur -->
                <div class="mb-8">
                    <label class="block text-lg font-semibold mb-3">🍀 Votre chiffre porte-bonheur :</label>
                    <div class="flex justify-center gap-2">
                        <input type="number" id="luckyNumber" min="0" max="99" placeholder="7" 
                               class="w-20 p-3 border-2 border-purple-300 rounded-lg text-base text-center focus:border-purple-500 focus:outline-none transition-colors duration-300 dark:bg-gray-700 dark:border-gray-600 dark:text-white"
                               onchange="updateCharacterPreview()">
                        <span class="self-center text-sm text-gray-600 dark:text-gray-400">(0-99)</span>
                    </div>
                </div>

                <!-- Personnalisation visuelle -->
                <div class="mb-8">
                    <label class="block text-lg font-semibold mb-3">🎨 Style de votre Country Ball :</label>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <!-- Couleur de fond -->
                        <div>
                            <label class="block text-sm font-medium mb-2">🌈 Couleur :</label>
                            <select id="ballColor" onchange="updateCharacterPreview()" 
                                    class="w-full p-2 border-2 border-purple-300 rounded-lg text-sm focus:border-purple-500 focus:outline-none dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                                <option value="#FF6B9D">💖 Rose</option>
                                <option value="#5D5CDE">💜 Violet</option>
                                <option value="#4ECDC4">💙 Turquoise</option>
                                <option value="#FFD93D">💛 Jaune</option>
                                <option value="#FF6B6B">❤️ Rouge</option>
                                <option value="#4CAF50">💚 Vert</option>
                                <option value="#FF9800">🧡 Orange</option>
                                <option value="#9C27B0">💜 Violet foncé</option>
                            </select>
                        </div>
                        
                        <!-- Accessoire -->
                        <div>
                            <label class="block text-sm font-medium mb-2">👒 Accessoire :</label>
                            <select id="ballAccessory" onchange="updateCharacterPreview()" 
                                    class="w-full p-2 border-2 border-purple-300 rounded-lg text-sm focus:border-purple-500 focus:outline-none dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                                <option value="">Aucun</option>
                                <option value="🧢">🧢 Casquette</option>
                                <option value="👑">👑 Couronne</option>
                                <option value="🎩">🎩 Haut-de-forme</option>
                                <option value="👒">👒 Chapeau</option>
                                <option value="🧣">🧣 Écharpe</option>
                                <option value="👓">👓 Lunettes</option>
                                <option value="😎">😎 Lunettes de soleil</option>
                                <option value="🎀">🎀 Nœud</option>
                            </select>
                        </div>
                        
                        <!-- Style spécial selon origine -->
                        <div>
                            <label class="block text-sm font-medium mb-2">🏺 Style culturel :</label>
                            <select id="culturalStyle" onchange="updateCharacterPreview()" 
                                    class="w-full p-2 border-2 border-purple-300 rounded-lg text-sm focus:border-purple-500 focus:outline-none dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                                <option value="">Standard</option>
                                <option value="🧕">🧕 Hijab (style arabe)</option>
                                <option value="ⵣ">ⵣ Tatouage kabyle</option>
                                <option value="🥖">🥖 Baguette française</option>
                                <option value="🍕">🍕 Style italien</option>
                                <option value="🌮">🌮 Style mexicain</option>
                                <option value="🍁">🍁 Style canadien</option>
                                <option value="🗾">🗾 Style japonais</option>
                                <option value="🏰">🏰 Style européen</option>
                            </select>
                        </div>
                        
                        <!-- Expression -->
                        <div>
                            <label class="block text-sm font-medium mb-2">😊 Expression :</label>
                            <select id="ballExpression" onchange="updateCharacterPreview()" 
                                    class="w-full p-2 border-2 border-purple-300 rounded-lg text-sm focus:border-purple-500 focus:outline-none dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                                <option value="😊">😊 Souriant</option>
                                <option value="😍">😍 Amoureux</option>
                                <option value="😎">😎 Cool</option>
                                <option value="🤗">🤗 Câlin</option>
                                <option value="😄">😄 Joyeux</option>
                                <option value="🥰">🥰 Adorable</option>
                                <option value="😋">😋 Gourmand</option>
                                <option value="🤩">🤩 Émerveillé</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Aperçu du personnage -->
                <div class="mb-8 p-6 bg-gradient-to-br from-purple-100 to-pink-100 dark:from-purple-900/30 dark:to-pink-900/30 rounded-xl border-2 border-purple-200 dark:border-purple-700">
                    <h3 class="text-xl font-bold mb-4">👁️ Aperçu de votre Country Ball</h3>
                    <div id="characterPreview" class="flex flex-col items-center">
                        <div id="ballPreview" class="w-32 h-32 rounded-full border-4 border-white shadow-lg flex items-center justify-center text-4xl mb-4" 
                             style="background: linear-gradient(45deg, #FF6B9D, #FFB5C5);">
                            😊
                        </div>
                        <div id="previewFlags" class="mb-2 text-2xl"></div>
                        <div id="previewName" class="text-lg font-bold text-purple-700 dark:text-purple-300 mb-1">Votre nom</div>
                        <div id="previewDescription" class="text-sm text-gray-600 dark:text-gray-400 text-center max-w-md italic"></div>
                        <div id="previewLuckyNumber" class="text-lg font-bold text-yellow-600 dark:text-yellow-400 mt-2"></div>
                    </div>
                </div>

                <!-- Section prononciations avancées -->
                <div id="pronunciationSection" class="mb-8 hidden">
                    <h3 class="text-xl font-bold mb-4">🗣️ Prononciations de votre prénom</h3>
                    <div id="pronunciationOptions" class="space-y-4"></div>
                </div>

                <!-- Panneau de configuration Aero Glass -->
                <div class="aero-control-panel">
                    <h4 class="text-lg font-bold mb-4 text-center">✨ Configuration Effet Aero Glass ✨</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-semibold mb-2">🌫️ Intensité du flou :</label>
                            <input type="range" id="aeroBlurSlider" class="aero-intensity-slider" 
                                   min="4" max="24" value="16" step="2" 
                                   oninput="updateAeroIntensity(this.value)">
                            <div class="flex justify-between text-xs mt-1">
                                <span>4px (léger)</span>
                                <span id="aeroBlurValue">16px</span>
                                <span>24px (intense)</span>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold mb-2">🎭 Effet appliqué sur :</label>
                            <div class="flex flex-wrap gap-2">
                                <button class="btn btn-sm" style="background: rgba(93, 92, 222, 0.2);" onclick="toggleAeroClass('.country-card', 'aero-glass')">
                                    🃏 Cartes
                                </button>
                                <button class="btn btn-sm" style="background: rgba(93, 92, 222, 0.2);" onclick="toggleAeroClass('.message', 'aero-glass')">
                                    💬 Messages
                                </button>
                                <button class="btn btn-sm" style="background: rgba(93, 92, 222, 0.2);" onclick="toggleAeroClass('.btn', 'aero-glass')">
                                    🔘 Boutons
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="text-center mt-4">
                        <button class="btn btn-secondary" onclick="resetAeroSettings()">
                            🔄 Réinitialiser l'effet
                        </button>
                    </div>
                </div>

                <!-- Quiz culturel intégré -->
                <div id="culturalQuizSection" class="mb-8 hidden">
                    <div class="country-card">
                        <h3 class="text-xl font-bold mb-4 text-center">🧠 Quiz Culturel 🧠</h3>
                        <div id="quizContainer">
                            <!-- Le quiz sera chargé ici -->
                        </div>
                    </div>
                </div>

                <!-- Boutons d'action -->
                <div class="flex flex-col sm:flex-row gap-4 justify-center">
                    <button id="quizBtn" class="btn btn-warning" onclick="startProfileQuiz()">
                        🧠 Quiz culturel (+bonus XP)
                    </button>
                    <button id="startGameBtn" class="btn btn-primary text-xl px-8 py-4" onclick="startMainGame()" style="display: none;">
                        🚀 Commencer l'aventure !
                    </button>
                    <button id="skipQuizBtn" class="btn btn-secondary" onclick="skipQuiz()" style="display: none;">
                        ⏭️ Passer le quiz
                    </button>
                </div>
            </div>
        </div>

        <!-- Jeu principal -->
        <div id="gameMain" class="hidden">
            <!-- Informations du joueur -->
            <div class="country-card mb-6">
                <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                    <div>
                        <h2 class="text-2xl font-bold" id="playerInfo">Joueur</h2>
                        <p class="text-gray-600 dark:text-gray-300" id="playerDetails">Niveau 1</p>
                        <div id="playerBadges" class="flex flex-wrap gap-2 mt-2">
                            <!-- Badges seront affichés ici -->
                        </div>
                    </div>
                    
                    <div class="flex-1 max-w-md">
                        <div class="flex justify-between text-sm mb-2">
                            <span>XP</span>
                            <span id="xpText">0 / 100</span>
                        </div>
                        <div class="bg-gray-200 dark:bg-gray-700 rounded-full h-3">
                            <div id="xpBar" class="xp-bar h-3 rounded-full" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Menu de navigation -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                <button class="btn btn-primary" onclick="showSection('explore')">
                    🌍 Explorer
                </button>
                <button class="btn btn-success" onclick="showSection('marriage')">
                    💒 Mariages
                </button>
                <button class="btn btn-warning" onclick="showSection('missions')">
                    🎯 Missions
                </button>
                <button class="btn btn-secondary" onclick="showSection('saves')">
                    💾 Sauvegardes
                </button>
            </div>

            <!-- Section Explorer -->
            <div id="exploreSection" class="section">
                <div class="country-card">
                    <h3 class="text-2xl font-bold mb-6 text-center">🌍 Explorez le monde et trouvez l'amour ! 🌍</h3>
                    
                    <div class="text-center mb-6">
                        <button id="exploreBtn" class="btn btn-primary text-xl px-8 py-4" onclick="exploreWorld()">
                            🚀 Explorer un pays aléatoire !
                        </button>
                    </div>
                    
                    <div id="exploreResult" class="hidden"></div>
                </div>
            </div>

            <!-- Section Mariages -->
            <div id="marriageSection" class="section hidden">
                <div class="country-card">
                    <h3 class="text-2xl font-bold mb-6 text-center">💒 Vos Mariages 💒</h3>
                    <div id="marriageList">
                        <p class="text-center text-gray-500 dark:text-gray-400">Aucun mariage pour le moment. Explorez le monde !</p>
                    </div>
                </div>
            </div>

            <!-- Section Missions -->
            <div id="missionsSection" class="section hidden">
                <div class="country-card">
                    <h3 class="text-2xl font-bold mb-6 text-center">🎯 Missions 🎯</h3>
                    <div id="missionsList"></div>
                </div>
            </div>

            <!-- Section Sauvegardes -->
            <div id="savesSection" class="section hidden">
                <div class="country-card">
                    <h3 class="text-2xl font-bold mb-6 text-center">💾 Sauvegardes 💾</h3>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                        <button class="btn btn-success" onclick="showSaveMenu()">
                            💾 Sauvegarder
                        </button>
                        <button class="btn btn-warning" onclick="showLoadMenu()">
                            📁 Charger
                        </button>
                    </div>
                    
                    <div id="saveLoadContent"></div>
                </div>
            </div>

            <!-- Chat/Messages -->
            <div class="country-card mt-8">
                <h3 class="text-xl font-bold mb-4">📱 Actualités et Messages</h3>
                <div id="messageContainer" class="space-y-3 max-h-96 overflow-y-auto">
                    <div class="message special">
                        💕 Bienvenue dans Country Balls: Mariage ! Explorez le monde et trouvez l'amour ! 💕
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Composant de tchat interactif AVANCÉ -->
    <div id="chatContainer" class="chat-container hidden">
        <div class="chat-window">
            <!-- En-tête du tchat -->
            <div class="chat-header">
                <div class="chat-partner-info">
                    <div class="chat-avatar" id="chatAvatar">💕</div>
                    <div class="chat-partner-details">
                        <h4 id="chatPartnerName">Chat Romance</h4>
                        <p id="chatPartnerStatus">
                            <span class="online-indicator" style="width: 8px; height: 8px; background: #28a745; border-radius: 50%; display: inline-block; margin-right: 5px;"></span>
                            En ligne
                        </p>
                    </div>
                </div>
                
                <div class="chat-controls">
                    <button class="chat-btn" onclick="toggleChat()" title="Réduire">
                        ➖
                    </button>
                    <button class="chat-btn" onclick="closeChat()" title="Fermer">
                        ❌
                    </button>
                </div>
            </div>
            
            <!-- Onglets du tchat -->
            <div class="chat-tabs">
                <div class="chat-tab active" onclick="switchChatTab('messages')">💬 Messages</div>
                <div class="chat-tab" onclick="switchChatTab('history')">📖 Historique</div>
            </div>
            
            <!-- Contenu des onglets -->
            <div class="chat-tab-content active" id="messagesTab">
                <!-- Messages du tchat -->
                <div class="chat-messages" id="chatMessages">
                    <div class="message-bubble received">
                        <div>Salut ! 👋 Félicitations pour votre aventure romantique !</div>
                        <div class="message-time" id="welcomeTime"></div>
                        <!-- Bouton de réaction -->
                        <button class="reaction-add-btn" onclick="showReactionPicker(this)">😊</button>
                        <div class="message-reactions" id="reactions-0"></div>
                    </div>
                </div>
                
                <!-- Zone de saisie -->
                <div class="chat-input-area">
                    <!-- Messages rapides -->
                    <div class="quick-messages">
                        <button class="quick-msg-btn" onclick="sendQuickMessage('💕 Je t\'aime')">💕 Je t'aime</button>
                        <button class="quick-msg-btn" onclick="sendQuickMessage('😍 Tu es magnifique')">😍 Magnifique</button>
                        <button class="quick-msg-btn" onclick="sendQuickMessage('🌹 Pour toi')">🌹 Pour toi</button>
                        <button class="quick-msg-btn" onclick="sendQuickMessage('💑 Ensemble pour toujours')">💑 Ensemble</button>
                        <button class="quick-msg-btn" onclick="createPoll()">📊 Sondage</button>
                        <button class="quick-msg-btn" onclick="triggerDramaCard()">🎭 Drama</button>
                    </div>
                    
                    <!-- Barre de saisie -->
                    <div class="chat-input-container">
                        <textarea 
                            id="chatInput" 
                            class="chat-input" 
                            placeholder="Écrivez votre message..."
                            rows="1"
                            onkeydown="handleChatKeydown(event)"
                            oninput="adjustTextareaHeight(this)"
                        ></textarea>
                        <button class="emoji-btn" onclick="toggleEmojiPicker()" title="Émojis">
                            😊
                        </button>
                        <button class="emoji-btn" onclick="toggleGiftPicker()" title="Cadeaux" style="background: linear-gradient(45deg, #FFD700, #FFA500);">
                            🎁
                        </button>
                        <button class="send-btn" onclick="sendChatMessage()" title="Envoyer" id="chatSendBtn" disabled>
                            ➤
                        </button>
                    </div>
                    
                    <!-- Sélecteur d'émojis -->
                    <div class="emoji-picker" id="emojiPicker">
                        <button class="emoji-option" onclick="addEmoji('😊')">😊</button>
                        <button class="emoji-option" onclick="addEmoji('😍')">😍</button>
                        <button class="emoji-option" onclick="addEmoji('🥰')">🥰</button>
                        <button class="emoji-option" onclick="addEmoji('😘')">😘</button>
                        <button class="emoji-option" onclick="addEmoji('💕')">💕</button>
                        <button class="emoji-option" onclick="addEmoji('💖')">💖</button>
                        <button class="emoji-option" onclick="addEmoji('💗')">💗</button>
                        <button class="emoji-option" onclick="addEmoji('💘')">💘</button>
                        <button class="emoji-option" onclick="addEmoji('💝')">💝</button>
                        <button class="emoji-option" onclick="addEmoji('💞')">💞</button>
                        <button class="emoji-option" onclick="addEmoji('💓')">💓</button>
                        <button class="emoji-option" onclick="addEmoji('❤️')">❤️</button>
                        <button class="emoji-option" onclick="addEmoji('🌹')">🌹</button>
                        <button class="emoji-option" onclick="addEmoji('🌺')">🌺</button>
                        <button class="emoji-option" onclick="addEmoji('🌷')">🌷</button>
                        <button class="emoji-option" onclick="addEmoji('🌸')">🌸</button>
                        <button class="emoji-option" onclick="addEmoji('💐')">💐</button>
                        <button class="emoji-option" onclick="addEmoji('🎉')">🎉</button>
                        <button class="emoji-option" onclick="addEmoji('🎊')">🎊</button>
                        <button class="emoji-option" onclick="addEmoji('✨')">✨</button>
                        <button class="emoji-option" onclick="addEmoji('💫')">💫</button>
                        <button class="emoji-option" onclick="addEmoji('⭐')">⭐</button>
                        <button class="emoji-option" onclick="addEmoji('🌟')">🌟</button>
                        <button class="emoji-option" onclick="addEmoji('💥')">💥</button>
                        <button class="emoji-option" onclick="addEmoji('🔥')">🔥</button>
                        <button class="emoji-option" onclick="addEmoji('👑')">👑</button>
                        <button class="emoji-option" onclick="addEmoji('💎')">💎</button>
                        <button class="emoji-option" onclick="addEmoji('🍾')">🍾</button>
                        <button class="emoji-option" onclick="addEmoji('🥂')">🥂</button>
                        <button class="emoji-option" onclick="addEmoji('🍷')">🍷</button>
                        <button class="emoji-option" onclick="addEmoji('🍫')">🍫</button>
                        <button class="emoji-option" onclick="addEmoji('🍰')">🍰</button>
                        <button class="emoji-option" onclick="addEmoji('🎂')">🎂</button>
                        <button class="emoji-option" onclick="addEmoji('🍭')">🍭</button>
                        <button class="emoji-option" onclick="addEmoji('🍯')">🍯</button>
                        <button class="emoji-option" onclick="addEmoji('🌙')">🌙</button>
                        <button class="emoji-option" onclick="addEmoji('☀️')">☀️</button>
                    </div>
                    
                    <!-- Sélecteur de cadeaux -->
                    <div class="gift-picker" id="giftPicker">
                        <div class="gift-option" onclick="sendGift('🥘', 'Couscous kabyle')">
                            <div class="gift-option-emoji">🥘</div>
                            <div class="gift-option-text">Couscous</div>
                        </div>
                        <div class="gift-option" onclick="sendGift('🎵', 'Musique traditionnelle')">
                            <div class="gift-option-emoji">🎵</div>
                            <div class="gift-option-text">Musique</div>
                        </div>
                        <div class="gift-option" onclick="sendGift('🎁', 'Cadeau surprise')">
                            <div class="gift-option-emoji">🎁</div>
                            <div class="gift-option-text">Surprise</div>
                        </div>
                        <div class="gift-option" onclick="sendGift('🌹', 'Bouquet de roses')">
                            <div class="gift-option-emoji">🌹</div>
                            <div class="gift-option-text">Roses</div>
                        </div>
                        <div class="gift-option" onclick="sendGift('💍', 'Bague précieuse')">
                            <div class="gift-option-emoji">💍</div>
                            <div class="gift-option-text">Bague</div>
                        </div>
                        <div class="gift-option" onclick="sendGift('🧸', 'Peluche mignonne')">
                            <div class="gift-option-emoji">🧸</div>
                            <div class="gift-option-text">Peluche</div>
                        </div>
                        <div class="gift-option" onclick="sendGift('🍫', 'Chocolats fins')">
                            <div class="gift-option-emoji">🍫</div>
                            <div class="gift-option-text">Chocolats</div>
                        </div>
                        <div class="gift-option" onclick="sendGift('🕯️', 'Dîner romantique')">
                            <div class="gift-option-emoji">🕯️</div>
                            <div class="gift-option-text">Dîner</div>
                        </div>
                        <div class="gift-option" onclick="sendGift('🎈', 'Ballons de fête')">
                            <div class="gift-option-emoji">🎈</div>
                            <div class="gift-option-text">Ballons</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Onglet Historique des dramas -->
            <div class="chat-tab-content" id="historyTab">
                <div class="drama-history" id="dramaHistory">
                    <div class="text-center text-gray-500 dark:text-gray-400 p-4">
                        Aucun drama pour le moment... 😌
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Notification de nouveaux messages -->
        <div class="chat-notification hidden" id="chatNotification">1</div>
    </div>

    <script>
        // Configuration du thème dark/light
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });

        // État du jeu
        let gameState = {
            player: {
                firstName: '',
                lastName: '',
                country: '',
                fullName: '',
                gender: '',
                level: 1,
                xp: 0,
                visitedCountries: new Set() // Suivi des pays visités
            },
            currentSection: 'explore',
            theme: 'light',
            language: 'fr', // Langue d'interface
            pronunciationLanguage: 'auto' // Langue de prononciation préférée
        };

        // Historique des mariages
        let marriageHistory = [];
        let discoveredCouples = new Set();

        // Système de jalousie et guerre
        let relationshipStability = 100;
        let jealousyEvents = [];

        // Liste des pays avec emojis
        const countries = {
            'France': '🇫🇷',
            'Germany': '🇩🇪',
            'United States': '🇺🇸',
            'Japan': '🇯🇵',
            'United Kingdom': '🇬🇧',
            'Italy': '🇮🇹',
            'Spain': '🇪🇸',
            'Canada': '🇨🇦',
            'Australia': '🇦🇺',
            'Brazil': '🇧🇷',
            'Mexico': '🇲🇽',
            'China': '🇨🇳',
            'India': '🇮🇳',
            'South Korea': '🇰🇷',
            'Russia': '🇷🇺',
            'Netherlands': '🇳🇱',
            'Sweden': '🇸🇪',
            'Norway': '🇳🇴',
            'Denmark': '🇩🇰',
            'Finland': '🇫🇮',
            'Switzerland': '🇨🇭',
            'Belgium': '🇧🇪',
            'Austria': '🇦🇹',
            'Portugal': '🇵🇹',
            'Poland': '🇵🇱',
            'Czech Republic': '🇨🇿',
            'Greece': '🇬🇷',
            'Turkey': '🇹🇷',
            'Egypt': '🇪🇬',
            'Morocco': '🇲🇦',
            'Algeria': '🇩🇿',
            'Kabylia': 'ⵣ',
            'Tunisia': '🇹🇳',
            'South Africa': '🇿🇦',
            'Nigeria': '🇳🇬',
            'Kenya': '🇰🇪',
            'Argentina': '🇦🇷',
            'Chile': '🇨🇱',
            'Peru': '🇵🇪',
            'Colombia': '🇨🇴',
            'Venezuela': '🇻🇪',
            'Thailand': '🇹🇭',
            'Vietnam': '🇻🇳',
            'Philippines': '🇵🇭',
            'Indonesia': '🇮🇩',
            'Malaysia': '🇲🇾',
            'Singapore': '🇸🇬',
            'New Zealand': '🇳🇿',
            'Saudi Arabia': '🇸🇦',
            'UAE': '🇦🇪',
            'Iran': '🇮🇷'
        };

        // Combinaisons d'origines multiples possibles
        const multiOriginCombinations = [
            // Origines franco-maghrébines
            { primary: 'France', secondary: 'Morocco', probability: 0.15 },
            { primary: 'France', secondary: 'Algeria', probability: 0.15 },
            { primary: 'France', secondary: 'Tunisia', probability: 0.10 },
            { primary: 'France', secondary: 'Kabylia', probability: 0.08 },
            
            // Origines germano-turques
            { primary: 'Germany', secondary: 'Turkey', probability: 0.12 },
            
            // Origines euro-américaines
            { primary: 'United States', secondary: 'Italy', probability: 0.08 },
            { primary: 'United States', secondary: 'Ireland', probability: 0.06 },
            { primary: 'Canada', secondary: 'France', probability: 0.10 },
            
            // Origines hispano-latines
            { primary: 'Spain', secondary: 'Mexico', probability: 0.08 },
            { primary: 'United States', secondary: 'Mexico', probability: 0.12 },
            
            // Origines asiatiques mixtes
            { primary: 'Japan', secondary: 'Brazil', probability: 0.05 },
            { primary: 'China', secondary: 'Singapore', probability: 0.06 },
            
            // Origines libano-maghrébines
            { primary: 'Lebanon', secondary: 'Morocco', probability: 0.06 },
            { primary: 'Lebanon', secondary: 'France', probability: 0.08 },
            
            // Origines australo-européennes
            { primary: 'Australia', secondary: 'United Kingdom', probability: 0.10 },
            
            // Origines sud-africaines
            { primary: 'South Africa', secondary: 'Netherlands', probability: 0.05 },
            
            // Autres combinaisons intéressantes
            { primary: 'Belgium', secondary: 'Congo', probability: 0.04 },
            { primary: 'Portugal', secondary: 'Brazil', probability: 0.08 },
            { primary: 'United Kingdom', secondary: 'India', probability: 0.07 },
            { primary: 'Russia', secondary: 'Kazakhstan', probability: 0.05 }
        ];

        // Fonction pour obtenir le drapeau d'un pays (avec support des origines multiples)
        function getCountryFlag(countryOrOrigins) {
            if (typeof countryOrOrigins === 'string') {
                // Origine simple
                return countries[countryOrOrigins] || '🏳️';
            } else if (countryOrOrigins && countryOrOrigins.primary) {
                // Origines multiples
                const primaryFlag = countries[countryOrOrigins.primary] || '🏳️';
                const secondaryFlag = countries[countryOrOrigins.secondary] || '🏳️';
                return `${primaryFlag}-${secondaryFlag}`;
            }
            return '🏳️';
        }

        // Fonction pour formater l'affichage des origines
        function formatOrigins(countryOrOrigins) {
            if (typeof countryOrOrigins === 'string') {
                // Origine simple
                return countryOrOrigins;
            } else if (countryOrOrigins && countryOrOrigins.primary) {
                // Origines multiples
                return `${countryOrOrigins.primary} - ${countryOrOrigins.secondary}`;
            }
            return countryOrOrigins;
        }

        // Fonction pour générer un personnage avec prononciation selon ses origines
        function generateCharacterWithPronunciation(origins, playerGender) {
            // Déterminer le genre opposé au joueur
            const characterGender = playerGender === 'male' ? 'female' : 'male';
            
            // Déterminer le/les pays d'origine
            const primaryCountry = typeof origins === 'string' ? origins : origins.primary;
            const secondaryCountry = typeof origins === 'object' ? origins.secondary : null;
            
            // Générer le prénom depuis le pays principal
            const names = namesByCountry[primaryCountry] || namesByCountry['United States'];
            const nameData = names[characterGender] ? 
                names[characterGender][Math.floor(Math.random() * names[characterGender].length)] :
                { name: 'Alex', pronunciation: { english: 'A-lex' } };
            
            // Construire l'objet prononciation selon les origines
            let prononciation = {};
            
            if (typeof origins === 'string') {
                // Origine simple
                prononciation = nameData.pronunciation || {};
            } else {
                // Origines multiples - combiner les prononciations
                const primaryNameData = namesByCountry[primaryCountry]?.[characterGender] || [];
                const secondaryNameData = namesByCountry[secondaryCountry]?.[characterGender] || [];
                
                // Trouver les prononciations du prénom dans les deux cultures
                const primaryPronunciation = primaryNameData.find(n => n.name === nameData.name)?.pronunciation || {};
                const secondaryPronunciation = secondaryNameData.find(n => n.name === nameData.name)?.pronunciation || {};
                
                // Fusionner les prononciations
                prononciation = { ...primaryPronunciation, ...secondaryPronunciation };
                
                // Si pas de prononciation pour le pays secondaire, en créer une approximative
                if (!prononciation[getLanguageCode(secondaryCountry)]) {
                    prononciation[getLanguageCode(secondaryCountry)] = adaptPronunciationToLanguage(nameData.name, secondaryCountry);
                }
            }
            
            return {
                prenom: nameData.name,
                nom: generateLastName(primaryCountry),
                genre: characterGender,
                origine: formatOrigins(origins),
                prononciation: prononciation
            };
        }

        // Fonction pour obtenir le code de langue d'un pays
        function getLanguageCode(country) {
            const languageCodes = {
                'France': 'french',
                'Germany': 'german',
                'United States': 'english',
                'United Kingdom': 'english',
                'Japan': 'japanese',
                'Italy': 'italian',
                'Spain': 'spanish',
                'Brazil': 'portuguese',
                'Mexico': 'spanish',
                'China': 'chinese',
                'India': 'hindi',
                'Russia': 'russian',
                'Turkey': 'turkish',
                'Lebanon': 'arabic',
                'Morocco': 'arabic',
                'Algeria': 'arabic',
                'Kabylia': 'berber'
            };
            return languageCodes[country] || 'english';
        }

        // Fonction pour adapter la prononciation à une langue donnée
        function adaptPronunciationToLanguage(name, country) {
            // Adaptations basiques selon les caractéristiques phonétiques des langues
            const adaptations = {
                'France': () => name.replace(/th/g, 'z').replace(/h/g, '').toLowerCase().split('').map((c, i) => i === 0 ? c.toUpperCase() : c).join(''),
                'Germany': () => name.replace(/c/g, 'k').replace(/j/g, 'y'),
                'Arabic': () => name.replace(/p/g, 'b').replace(/v/g, 'f'),
                'Japanese': () => name.replace(/l/g, 'r').replace(/th/g, 's'),
                'Spanish': () => name.replace(/ph/g, 'f').replace(/th/g, 't'),
                'Chinese': () => name.split('').join('-').toLowerCase()
            };
            
            const languageFamily = {
                'France': 'France',
                'Morocco': 'Arabic',
                'Algeria': 'Arabic',
                'Tunisia': 'Arabic',
                'Lebanon': 'Arabic',
                'Germany': 'Germany',
                'Japan': 'Japanese',
                'Spain': 'Spanish',
                'Mexico': 'Spanish',
                'China': 'Chinese'
            };
            
            const family = languageFamily[country] || 'English';
            const adapter = adaptations[family];
            
            return adapter ? adapter() : name;
        }

        // Fonction pour obtenir un pays aléatoire (avec possibilité d'origines multiples)
        function generateRandomOrigins() {
            // 25% de chance d'avoir des origines multiples
            if (Math.random() < 0.25) {
                const combination = multiOriginCombinations[Math.floor(Math.random() * multiOriginCombinations.length)];
                if (Math.random() < combination.probability) {
                    return {
                        primary: combination.primary,
                        secondary: combination.secondary
                    };
                }
            }
            
            // Sinon, origine simple
            const countryNames = Object.keys(countries).filter(country => 
                country !== gameState.player.country
            );
            return countryNames[Math.floor(Math.random() * countryNames.length)];
        }

        // Prénoms par pays avec prononciations
        const namesByCountry = {
            'France': {
                male: [
                    { name: 'Pierre', pronunciation: { french: 'Pee-air' } },
                    { name: 'Jean', pronunciation: { french: 'Zhahn' } },
                    { name: 'François', pronunciation: { french: 'Frahn-swah' } },
                    { name: 'Michel', pronunciation: { french: 'Mee-shell' } },
                    { name: 'Alain', pronunciation: { french: 'Ah-lahn' } },
                    { name: 'Philippe', pronunciation: { french: 'Fee-leep' } },
                    { name: 'Daniel', pronunciation: { french: 'Dah-nee-ell' } },
                    { name: 'Bernard', pronunciation: { french: 'Ber-nar' } },
                    { name: 'Christian', pronunciation: { french: 'Krees-tee-ahn' } },
                    { name: 'Thierry', pronunciation: { french: 'Tee-air-ree' } }
                ],
                female: [
                    { name: 'Marie', pronunciation: { french: 'Mah-ree' } },
                    { name: 'Françoise', pronunciation: { french: 'Frahn-swahz' } },
                    { name: 'Monique', pronunciation: { french: 'Moh-neek' } },
                    { name: 'Catherine', pronunciation: { french: 'Kah-treen' } },
                    { name: 'Isabelle', pronunciation: { french: 'Ee-zah-bell' } },
                    { name: 'Sylvie', pronunciation: { french: 'Seel-vee' } },
                    { name: 'Christine', pronunciation: { french: 'Krees-teen' } },
                    { name: 'Brigitte', pronunciation: { french: 'Bree-zheet' } },
                    { name: 'Martine', pronunciation: { french: 'Mar-teen' } },
                    { name: 'Nicole', pronunciation: { french: 'Nee-kohl' } }
                ]
            },
            'Germany': {
                male: [
                    { name: 'Hans', pronunciation: { german: 'Hahnss' } },
                    { name: 'Wolfgang', pronunciation: { german: 'Volf-gahng' } },
                    { name: 'Klaus', pronunciation: { german: 'Klowss' } },
                    { name: 'Jürgen', pronunciation: { german: 'Yur-gen' } },
                    { name: 'Dieter', pronunciation: { german: 'Dee-ter' } },
                    { name: 'Peter', pronunciation: { german: 'Pay-ter' } },
                    { name: 'Andreas', pronunciation: { german: 'Ahn-dray-ahs' } },
                    { name: 'Thomas', pronunciation: { german: 'Toh-mahs' } },
                    { name: 'Michael', pronunciation: { german: 'Mee-khah-el' } },
                    { name: 'Stefan', pronunciation: { german: 'Shte-fahn' } }
                ],
                female: [
                    { name: 'Ursula', pronunciation: { german: 'Oor-zoo-lah' } },
                    { name: 'Ingrid', pronunciation: { german: 'In-greed' } },
                    { name: 'Monika', pronunciation: { german: 'Moh-nee-kah' } },
                    { name: 'Petra', pronunciation: { german: 'Pay-trah' } },
                    { name: 'Sabine', pronunciation: { german: 'Zah-bee-neh' } },
                    { name: 'Gabriele', pronunciation: { german: 'Gah-bree-ay-leh' } },
                    { name: 'Andrea', pronunciation: { german: 'Ahn-dray-ah' } },
                    { name: 'Susanne', pronunciation: { german: 'Zoo-zah-neh' } },
                    { name: 'Brigitte', pronunciation: { german: 'Bree-git-teh' } },
                    { name: 'Christine', pronunciation: { german: 'Krees-tee-neh' } }
                ]
            },
            'Lebanon': {
                male: [
                    { name: 'Ahmad', pronunciation: { arabic: 'Ah-mad', french: 'Ah-mahd' } },
                    { name: 'Mohammed', pronunciation: { arabic: 'Mou-ham-mad', french: 'Mo-ha-med' } },
                    { name: 'Ali', pronunciation: { arabic: 'Ah-lee', french: 'A-li' } },
                    { name: 'Omar', pronunciation: { arabic: 'Oh-mar', french: 'O-mar' } },
                    { name: 'Khalil', pronunciation: { arabic: 'Kha-leel', french: 'Kha-lil' } },
                    { name: 'Youssef', pronunciation: { arabic: 'You-sef', french: 'You-sef' } },
                    { name: 'Samir', pronunciation: { arabic: 'Sa-meer', french: 'Sa-mir' } },
                    { name: 'Hassan', pronunciation: { arabic: 'Has-san', french: 'Has-sane' } },
                    { name: 'Rami', pronunciation: { arabic: 'Ra-mee', french: 'Ra-mi' } },
                    { name: 'Fadi', pronunciation: { arabic: 'Fa-dee', french: 'Fa-di' } }
                ],
                female: [
                    { name: 'Layla', pronunciation: { arabic: 'Lay-la', french: 'Laï-la' } },
                    { name: 'Fatima', pronunciation: { arabic: 'Fa-ti-ma', french: 'Fa-ti-ma' } },
                    { name: 'Amina', pronunciation: { arabic: 'A-mee-na', french: 'A-mi-na' } },
                    { name: 'Zahra', pronunciation: { arabic: 'Zah-ra', french: 'Za-hra' } },
                    { name: 'Nadia', pronunciation: { arabic: 'Na-dee-ya', french: 'Na-dia' } },
                    { name: 'Rania', pronunciation: { arabic: 'Ra-nee-ya', french: 'Ra-nia' } },
                    { name: 'Samar', pronunciation: { arabic: 'Sa-mar', french: 'Sa-mar' } },
                    { name: 'Dina', pronunciation: { arabic: 'Dee-na', french: 'Di-na' } },
                    { name: 'Maya', pronunciation: { arabic: 'Ma-ya', french: 'Ma-ya' } },
                    { name: 'Lina', pronunciation: { arabic: 'Lee-na', french: 'Li-na' } }
                ]
            },
            'Morocco': {
                male: [
                    { name: 'Mohammed', pronunciation: { arabic: 'Mou-ham-mad', french: 'Mo-ha-med' } },
                    { name: 'Ahmed', pronunciation: { arabic: 'Ah-med', french: 'Ah-med' } },
                    { name: 'Youssef', pronunciation: { arabic: 'You-sef', french: 'You-sef' } },
                    { name: 'Hassan', pronunciation: { arabic: 'Has-san', french: 'Has-sane' } },
                    { name: 'Omar', pronunciation: { arabic: 'Oh-mar', french: 'O-mar' } },
                    { name: 'Rachid', pronunciation: { arabic: 'Ra-sheed', french: 'Ra-chid' } },
                    { name: 'Karim', pronunciation: { arabic: 'Ka-reem', french: 'Ka-rim' } },
                    { name: 'Saïd', pronunciation: { arabic: 'Sa-eed', french: 'Sa-ïd' } },
                    { name: 'Abdel', pronunciation: { arabic: 'Ab-del', french: 'Ab-del' } },
                    { name: 'Mustapha', pronunciation: { arabic: 'Mus-ta-fa', french: 'Mus-ta-pha' } }
                ],
                female: [
                    { name: 'Fatima', pronunciation: { arabic: 'Fa-ti-ma', french: 'Fa-ti-ma' } },
                    { name: 'Aicha', pronunciation: { arabic: 'Ah-ee-sha', french: 'Aï-cha' } },
                    { name: 'Khadija', pronunciation: { arabic: 'Kha-dee-ja', french: 'Kha-di-ja' } },
                    { name: 'Zahra', pronunciation: { arabic: 'Zah-ra', french: 'Za-hra' } },
                    { name: 'Amina', pronunciation: { arabic: 'A-mee-na', french: 'A-mi-na' } },
                    { name: 'Nadia', pronunciation: { arabic: 'Na-dee-ya', french: 'Na-dia' } },
                    { name: 'Leila', pronunciation: { arabic: 'Lay-la', french: 'Leï-la' } },
                    { name: 'Rachida', pronunciation: { arabic: 'Ra-shee-da', french: 'Ra-chi-da' } },
                    { name: 'Malika', pronunciation: { arabic: 'Ma-li-ka', french: 'Ma-li-ka' } },
                    { name: 'Hafida', pronunciation: { arabic: 'Ha-fee-da', french: 'Ha-fi-da' } }
                ]
            },
            'Algeria': {
                male: [
                    { name: 'Mohammed', pronunciation: { arabic: 'Mou-ham-mad', french: 'Mo-ha-med' } },
                    { name: 'Ahmed', pronunciation: { arabic: 'Ah-med', french: 'Ah-med' } },
                    { name: 'Ali', pronunciation: { arabic: 'Ah-lee', french: 'A-li' } },
                    { name: 'Omar', pronunciation: { arabic: 'Oh-mar', french: 'O-mar' } },
                    { name: 'Karim', pronunciation: { arabic: 'Ka-reem', french: 'Ka-rim' } },
                    { name: 'Yacine', pronunciation: { arabic: 'Ya-seen', french: 'Ya-cine' } },
                    { name: 'Sofiane', pronunciation: { arabic: 'So-fee-an', french: 'So-fi-ane' } },
                    { name: 'Amine', pronunciation: { arabic: 'A-meen', french: 'A-mine' } },
                    { name: 'Riad', pronunciation: { arabic: 'Ree-ad', french: 'Ri-ad' } },
                    { name: 'Farid', pronunciation: { arabic: 'Fa-reed', french: 'Fa-rid' } }
                ],
                female: [
                    { name: 'Fatima', pronunciation: { arabic: 'Fa-ti-ma', french: 'Fa-ti-ma' } },
                    { name: 'Aicha', pronunciation: { arabic: 'Ah-ee-sha', french: 'Aï-cha' } },
                    { name: 'Amina', pronunciation: { arabic: 'A-mee-na', french: 'A-mi-na' } },
                    { name: 'Zahra', pronunciation: { arabic: 'Zah-ra', french: 'Za-hra' } },
                    { name: 'Samira', pronunciation: { arabic: 'Sa-mee-ra', french: 'Sa-mi-ra' } },
                    { name: 'Nadia', pronunciation: { arabic: 'Na-dee-ya', french: 'Na-dia' } },
                    { name: 'Karima', pronunciation: { arabic: 'Ka-ree-ma', french: 'Ka-ri-ma' } },
                    { name: 'Yasmina', pronunciation: { arabic: 'Yas-mee-na', french: 'Yas-mi-na' } },
                    { name: 'Leila', pronunciation: { arabic: 'Lay-la', french: 'Leï-la' } },
                    { name: 'Soraya', pronunciation: { arabic: 'So-ra-ya', french: 'So-ra-ya' } }
                ]
            },
            'Turkey': {
                male: [
                    { name: 'Mehmet', pronunciation: { turkish: 'Meh-met' } },
                    { name: 'Mustafa', pronunciation: { turkish: 'Mus-ta-fa' } },
                    { name: 'Ali', pronunciation: { turkish: 'A-li' } },
                    { name: 'Ahmet', pronunciation: { turkish: 'Ah-met' } },
                    { name: 'Hasan', pronunciation: { turkish: 'Ha-san' } },
                    { name: 'Osman', pronunciation: { turkish: 'Os-man' } },
                    { name: 'Emre', pronunciation: { turkish: 'Em-re' } },
                    { name: 'Burak', pronunciation: { turkish: 'Bu-rak' } },
                    { name: 'Kemal', pronunciation: { turkish: 'Ke-mal' } },
                    { name: 'Cem', pronunciation: { turkish: 'Jem' } }
                ],
                female: [
                    { name: 'Ayşe', pronunciation: { turkish: 'Ah-ye-she' } },
                    { name: 'Fatma', pronunciation: { turkish: 'Fat-ma' } },
                    { name: 'Emine', pronunciation: { turkish: 'E-mi-ne' } },
                    { name: 'Hatice', pronunciation: { turkish: 'Ha-ti-je' } },
                    { name: 'Zeynep', pronunciation: { turkish: 'Zey-nep' } },
                    { name: 'Merve', pronunciation: { turkish: 'Mer-ve' } },
                    { name: 'Elif', pronunciation: { turkish: 'E-lif' } },
                    { name: 'Selin', pronunciation: { turkish: 'Se-lin' } },
                    { name: 'Burcu', pronunciation: { turkish: 'Bur-ju' } },
                    { name: 'Deniz', pronunciation: { turkish: 'De-niz' } }
                ]
            },
            'United States': {
                male: [
                    { name: 'James', pronunciation: { english: 'Jayms' } },
                    { name: 'Robert', pronunciation: { english: 'Rob-ert' } },
                    { name: 'John', pronunciation: { english: 'John' } },
                    { name: 'Michael', pronunciation: { english: 'My-kel' } },
                    { name: 'David', pronunciation: { english: 'Day-vid' } },
                    { name: 'William', pronunciation: { english: 'Wil-yem' } },
                    { name: 'Richard', pronunciation: { english: 'Rich-erd' } },
                    { name: 'Joseph', pronunciation: { english: 'Jo-zef' } },
                    { name: 'Thomas', pronunciation: { english: 'Tom-es' } },
                    { name: 'Christopher', pronunciation: { english: 'Kris-to-fer' } }
                ],
                female: [
                    { name: 'Mary', pronunciation: { english: 'Mare-ee' } },
                    { name: 'Patricia', pronunciation: { english: 'Pa-trish-a' } },
                    { name: 'Jennifer', pronunciation: { english: 'Jen-i-fer' } },
                    { name: 'Linda', pronunciation: { english: 'Lin-da' } },
                    { name: 'Elizabeth', pronunciation: { english: 'E-liz-a-beth' } },
                    { name: 'Barbara', pronunciation: { english: 'Bar-ba-ra' } },
                    { name: 'Susan', pronunciation: { english: 'Su-zen' } },
                    { name: 'Jessica', pronunciation: { english: 'Jes-i-ka' } },
                    { name: 'Sarah', pronunciation: { english: 'Sare-a' } },
                    { name: 'Karen', pronunciation: { english: 'Care-en' } }
                ]
            },
            'Japan': {
                male: [
                    { name: 'Hiroshi', pronunciation: { japanese: 'Hi-ro-shi' } },
                    { name: 'Takeshi', pronunciation: { japanese: 'Ta-ke-shi' } },
                    { name: 'Akira', pronunciation: { japanese: 'A-ki-ra' } },
                    { name: 'Satoshi', pronunciation: { japanese: 'Sa-to-shi' } },
                    { name: 'Kazuhiro', pronunciation: { japanese: 'Ka-zu-hi-ro' } },
                    { name: 'Masahiro', pronunciation: { japanese: 'Ma-sa-hi-ro' } },
                    { name: 'Yuji', pronunciation: { japanese: 'Yu-ji' } },
                    { name: 'Shinji', pronunciation: { japanese: 'Shin-ji' } },
                    { name: 'Koji', pronunciation: { japanese: 'Ko-ji' } },
                    { name: 'Taro', pronunciation: { japanese: 'Ta-ro' } }
                ],
                female: [
                    { name: 'Yoko', pronunciation: { japanese: 'Yo-ko' } },
                    { name: 'Keiko', pronunciation: { japanese: 'Kei-ko' } },
                    { name: 'Michiko', pronunciation: { japanese: 'Mi-chi-ko' } },
                    { name: 'Naoko', pronunciation: { japanese: 'Na-o-ko' } },
                    { name: 'Tomoko', pronunciation: { japanese: 'To-mo-ko' } },
                    { name: 'Hiroko', pronunciation: { japanese: 'Hi-ro-ko' } },
                    { name: 'Mayumi', pronunciation: { japanese: 'Ma-yu-mi' } },
                    { name: 'Akiko', pronunciation: { japanese: 'A-ki-ko' } },
                    { name: 'Kyoko', pronunciation: { japanese: 'Kyo-ko' } },
                    { name: 'Noriko', pronunciation: { japanese: 'No-ri-ko' } }
                ]
            },
            'United Kingdom': {
                male: [
                    { name: 'James', pronunciation: { english: 'Jayms' } },
                    { name: 'John', pronunciation: { english: 'John' } },
                    { name: 'Robert', pronunciation: { english: 'Rob-ert' } },
                    { name: 'Michael', pronunciation: { english: 'My-kel' } },
                    { name: 'William', pronunciation: { english: 'Wil-yem' } },
                    { name: 'David', pronunciation: { english: 'Day-vid' } },
                    { name: 'Richard', pronunciation: { english: 'Rich-erd' } },
                    { name: 'Charles', pronunciation: { english: 'Charlz' } },
                    { name: 'Joseph', pronunciation: { english: 'Jo-zef' } },
                    { name: 'Thomas', pronunciation: { english: 'Tom-es' } }
                ],
                female: [
                    { name: 'Mary', pronunciation: { english: 'Mare-ee' } },
                    { name: 'Patricia', pronunciation: { english: 'Pa-trish-a' } },
                    { name: 'Jennifer', pronunciation: { english: 'Jen-i-fer' } },
                    { name: 'Linda', pronunciation: { english: 'Lin-da' } },
                    { name: 'Elizabeth', pronunciation: { english: 'E-liz-a-beth' } },
                    { name: 'Barbara', pronunciation: { english: 'Bar-ba-ra' } },
                    { name: 'Susan', pronunciation: { english: 'Su-zen' } },
                    { name: 'Jessica', pronunciation: { english: 'Jes-i-ka' } },
                    { name: 'Sarah', pronunciation: { english: 'Sare-a' } },
                    { name: 'Karen', pronunciation: { english: 'Care-en' } }
                ]
            },
            'Italy': {
                male: [
                    { name: 'Giuseppe', pronunciation: { italian: 'Ju-zep-pe' } },
                    { name: 'Antonio', pronunciation: { italian: 'An-to-nio' } },
                    { name: 'Mario', pronunciation: { italian: 'Ma-rio' } },
                    { name: 'Francesco', pronunciation: { italian: 'Fran-ches-ko' } },
                    { name: 'Giovanni', pronunciation: { italian: 'Jo-van-ni' } },
                    { name: 'Salvatore', pronunciation: { italian: 'Sal-va-to-re' } },
                    { name: 'Angelo', pronunciation: { italian: 'An-je-lo' } },
                    { name: 'Vincenzo', pronunciation: { italian: 'Vin-chen-tso' } },
                    { name: 'Pietro', pronunciation: { italian: 'Pie-tro' } },
                    { name: 'Carlo', pronunciation: { italian: 'Car-lo' } }
                ],
                female: [
                    { name: 'Maria', pronunciation: { italian: 'Ma-ria' } },
                    { name: 'Anna', pronunciation: { italian: 'An-na' } },
                    { name: 'Giuseppina', pronunciation: { italian: 'Ju-zep-pi-na' } },
                    { name: 'Rosa', pronunciation: { italian: 'Ro-za' } },
                    { name: 'Angela', pronunciation: { italian: 'An-je-la' } },
                    { name: 'Giovanna', pronunciation: { italian: 'Jo-van-na' } },
                    { name: 'Teresa', pronunciation: { italian: 'Te-re-za' } },
                    { name: 'Lucia', pronunciation: { italian: 'Lu-chia' } },
                    { name: 'Carmela', pronunciation: { italian: 'Car-me-la' } },
                    { name: 'Caterina', pronunciation: { italian: 'Ca-te-ri-na' } }
                ]
            },
            'Spain': {
                male: [
                    { name: 'Antonio', pronunciation: { spanish: 'An-to-nio' } },
                    { name: 'José', pronunciation: { spanish: 'Ho-sé' } },
                    { name: 'Manuel', pronunciation: { spanish: 'Ma-nuel' } },
                    { name: 'Francisco', pronunciation: { spanish: 'Fran-this-ko' } },
                    { name: 'Juan', pronunciation: { spanish: 'Huan' } },
                    { name: 'David', pronunciation: { spanish: 'Da-vid' } },
                    { name: 'José Antonio', pronunciation: { spanish: 'Ho-sé An-to-nio' } },
                    { name: 'José Luis', pronunciation: { spanish: 'Ho-sé Luis' } },
                    { name: 'Jesús', pronunciation: { spanish: 'He-sus' } },
                    { name: 'Javier', pronunciation: { spanish: 'Ha-vier' } }
                ],
                female: [
                    { name: 'María Carmen', pronunciation: { spanish: 'Ma-ri-a Car-men' } },
                    { name: 'María', pronunciation: { spanish: 'Ma-ri-a' } },
                    { name: 'Carmen', pronunciation: { spanish: 'Car-men' } },
                    { name: 'Josefa', pronunciation: { spanish: 'Ho-se-fa' } },
                    { name: 'Isabel', pronunciation: { spanish: 'I-sa-bel' } },
                    { name: 'Ana María', pronunciation: { spanish: 'A-na Ma-ri-a' } },
                    { name: 'María Dolores', pronunciation: { spanish: 'Ma-ri-a Do-lo-res' } },
                    { name: 'María Pilar', pronunciation: { spanish: 'Ma-ri-a Pi-lar' } },
                    { name: 'María Teresa', pronunciation: { spanish: 'Ma-ri-a Te-re-sa' } },
                    { name: 'Ana', pronunciation: { spanish: 'A-na' } }
                ]
            },
            'Brazil': {
                male: [
                    { name: 'José', pronunciation: { portuguese: 'Zho-zé' } },
                    { name: 'João', pronunciation: { portuguese: 'Zhow-ow' } },
                    { name: 'Antonio', pronunciation: { portuguese: 'An-to-nio' } },
                    { name: 'Francisco', pronunciation: { portuguese: 'Fran-this-ko' } },
                    { name: 'Carlos', pronunciation: { portuguese: 'Car-los' } },
                    { name: 'Paulo', pronunciation: { portuguese: 'Pow-lo' } },
                    { name: 'Pedro', pronunciation: { portuguese: 'Pe-dro' } },
                    { name: 'Lucas', pronunciation: { portuguese: 'Lu-kas' } },
                    { name: 'Luiz', pronunciation: { portuguese: 'Lu-is' } },
                    { name: 'Marcos', pronunciation: { portuguese: 'Mar-kos' } }
                ],
                female: [
                    { name: 'Maria', pronunciation: { portuguese: 'Ma-ri-a' } },
                    { name: 'Ana', pronunciation: { portuguese: 'A-na' } },
                    { name: 'Francisca', pronunciation: { portuguese: 'Fran-this-ka' } },
                    { name: 'Antonia', pronunciation: { portuguese: 'An-to-nia' } },
                    { name: 'Adriana', pronunciation: { portuguese: 'A-dri-a-na' } },
                    { name: 'Juliana', pronunciation: { portuguese: 'Zhu-li-a-na' } },
                    { name: 'Márcia', pronunciation: { portuguese: 'Mar-sia' } },
                    { name: 'Fernanda', pronunciation: { portuguese: 'Fer-nan-da' } },
                    { name: 'Patricia', pronunciation: { portuguese: 'Pa-tri-sia' } },
                    { name: 'Aline', pronunciation: { portuguese: 'A-li-ne' } }
                ]
            },
            'Mexico': {
                male: [
                    { name: 'José', pronunciation: { spanish: 'Ho-sé' } },
                    { name: 'Luis', pronunciation: { spanish: 'Luis' } },
                    { name: 'Juan', pronunciation: { spanish: 'Huan' } },
                    { name: 'Miguel', pronunciation: { spanish: 'Mi-gel' } },
                    { name: 'Carlos', pronunciation: { spanish: 'Car-los' } },
                    { name: 'Antonio', pronunciation: { spanish: 'An-to-nio' } },
                    { name: 'Francisco', pronunciation: { spanish: 'Fran-this-ko' } },
                    { name: 'Alejandro', pronunciation: { spanish: 'A-le-han-dro' } },
                    { name: 'Rafael', pronunciation: { spanish: 'Ra-fa-el' } },
                    { name: 'Jesús', pronunciation: { spanish: 'He-sus' } }
                ],
                female: [
                    { name: 'María', pronunciation: { spanish: 'Ma-ri-a' } },
                    { name: 'Guadalupe', pronunciation: { spanish: 'Gua-da-lu-pe' } },
                    { name: 'Juana', pronunciation: { spanish: 'Hua-na' } },
                    { name: 'Margarita', pronunciation: { spanish: 'Mar-ga-ri-ta' } },
                    { name: 'Francisca', pronunciation: { spanish: 'Fran-this-ka' } },
                    { name: 'Rosa', pronunciation: { spanish: 'Ro-sa' } },
                    { name: 'Antonia', pronunciation: { spanish: 'An-to-nia' } },
                    { name: 'Ana', pronunciation: { spanish: 'A-na' } },
                    { name: 'Carmen', pronunciation: { spanish: 'Car-men' } },
                    { name: 'Martha', pronunciation: { spanish: 'Mar-ta' } }
                ]
            },
            'China': {
                male: [
                    { name: 'Wei', pronunciation: { chinese: 'Way' } },
                    { name: 'Ming', pronunciation: { chinese: 'Ming' } },
                    { name: 'Jun', pronunciation: { chinese: 'Jün' } },
                    { name: 'Qiang', pronunciation: { chinese: 'Chi-ang' } },
                    { name: 'Gang', pronunciation: { chinese: 'Gang' } },
                    { name: 'Lei', pronunciation: { chinese: 'Lay' } },
                    { name: 'Tao', pronunciation: { chinese: 'Tao' } },
                    { name: 'Peng', pronunciation: { chinese: 'Pung' } },
                    { name: 'Jie', pronunciation: { chinese: 'Jye' } },
                    { name: 'Hao', pronunciation: { chinese: 'Hao' } }
                ],
                female: [
                    { name: 'Li', pronunciation: { chinese: 'Li' } },
                    { name: 'Wang', pronunciation: { chinese: 'Wang' } },
                    { name: 'Zhang', pronunciation: { chinese: 'Jang' } },
                    { name: 'Liu', pronunciation: { chinese: 'Liu' } },
                    { name: 'Chen', pronunciation: { chinese: 'Chen' } },
                    { name: 'Yang', pronunciation: { chinese: 'Yang' } },
                    { name: 'Zhao', pronunciation: { chinese: 'Jao' } },
                    { name: 'Huang', pronunciation: { chinese: 'Huang' } },
                    { name: 'Zhou', pronunciation: { chinese: 'Jou' } },
                    { name: 'Wu', pronunciation: { chinese: 'Wu' } }
                ]
            },
            'India': {
                male: [
                    { name: 'Raj', pronunciation: { hindi: 'Rahj' } },
                    { name: 'Ravi', pronunciation: { hindi: 'Ra-vi' } },
                    { name: 'Anil', pronunciation: { hindi: 'A-nil' } },
                    { name: 'Sunil', pronunciation: { hindi: 'Su-nil' } },
                    { name: 'Sanjay', pronunciation: { hindi: 'San-jay' } },
                    { name: 'Rakesh', pronunciation: { hindi: 'Ra-kesh' } },
                    { name: 'Ajay', pronunciation: { hindi: 'A-jay' } },
                    { name: 'Vijay', pronunciation: { hindi: 'Vi-jay' } },
                    { name: 'Ashok', pronunciation: { hindi: 'A-shok' } },
                    { name: 'Deepak', pronunciation: { hindi: 'Dee-pak' } }
                ],
                female: [
                    { name: 'Sunita', pronunciation: { hindi: 'Su-ni-ta' } },
                    { name: 'Asha', pronunciation: { hindi: 'A-sha' } },
                    { name: 'Usha', pronunciation: { hindi: 'U-sha' } },
                    { name: 'Rekha', pronunciation: { hindi: 'Re-kha' } },
                    { name: 'Meera', pronunciation: { hindi: 'Mee-ra' } },
                    { name: 'Pooja', pronunciation: { hindi: 'Poo-ja' } },
                    { name: 'Kavita', pronunciation: { hindi: 'Ka-vi-ta' } },
                    { name: 'Anita', pronunciation: { hindi: 'A-ni-ta' } },
                    { name: 'Sushma', pronunciation: { hindi: 'Sush-ma' } },
                    { name: 'Ritu', pronunciation: { hindi: 'Ri-tu' } }
                ]
            },
            'Russia': {
                male: [
                    { name: 'Александр', pronunciation: { russian: 'A-lek-sandr' } },
                    { name: 'Сергей', pronunciation: { russian: 'Ser-gey' } },
                    { name: 'Дмитрий', pronunciation: { russian: 'Dmi-tri' } },
                    { name: 'Андрей', pronunciation: { russian: 'An-drey' } },
                    { name: 'Алексей', pronunciation: { russian: 'A-lek-sey' } },
                    { name: 'Михаил', pronunciation: { russian: 'Mi-kha-il' } },
                    { name: 'Евгений', pronunciation: { russian: 'Yev-ge-ni' } },
                    { name: 'Николай', pronunciation: { russian: 'Ni-ko-lay' } },
                    { name: 'Владимир', pronunciation: { russian: 'Vla-di-mir' } },
                    { name: 'Игорь', pronunciation: { russian: 'I-gor' } }
                ],
                female: [
                    { name: 'Елена', pronunciation: { russian: 'Ye-le-na' } },
                    { name: 'Татьяна', pronunciation: { russian: 'Ta-tya-na' } },
                    { name: 'Наталья', pronunciation: { russian: 'Na-ta-lya' } },
                    { name: 'Ольга', pronunciation: { russian: 'Ol-ga' } },
                    { name: 'Светлана', pronunciation: { russian: 'Svet-la-na' } },
                    { name: 'Людмила', pronunciation: { russian: 'Lyu-dmi-la' } },
                    { name: 'Галина', pronunciation: { russian: 'Ga-li-na' } },
                    { name: 'Ирина', pronunciation: { russian: 'I-ri-na' } },
                    { name: 'Анна', pronunciation: { russian: 'An-na' } },
                    { name: 'Екатерина', pronunciation: { russian: 'Ye-ka-te-ri-na' } }
                ]
            },
            'Kabylia': {
                male: [
                    { name: 'Massinissa', pronunciation: { berber: 'Mas-si-nis-sa', french: 'Mas-si-nis-sa' } },
                    { name: 'Tarik', pronunciation: { berber: 'Ta-rik', french: 'Ta-rik' } },
                    { name: 'Youcef', pronunciation: { berber: 'You-sef', french: 'You-sef' } },
                    { name: 'Amirouche', pronunciation: { berber: 'A-mi-rouch', french: 'A-mi-rouche' } },
                    { name: 'Akli', pronunciation: { berber: 'Ak-li', french: 'Ak-li' } },
                    { name: 'Jugurtha', pronunciation: { berber: 'Ju-gur-tha', french: 'Ju-gur-tha' } },
                    { name: 'Mohand', pronunciation: { berber: 'Mo-hand', french: 'Mo-hand' } },
                    { name: 'Said', pronunciation: { berber: 'Sa-id', french: 'Sa-ïd' } },
                    { name: 'Larbi', pronunciation: { berber: 'Lar-bi', french: 'Lar-bi' } },
                    { name: 'Ouali', pronunciation: { berber: 'Oua-li', french: 'Oua-li' } }
                ],
                female: [
                    { name: 'Tamazight', pronunciation: { berber: 'Ta-ma-zight', french: 'Ta-ma-zight' } },
                    { name: 'Kahina', pronunciation: { berber: 'Ka-hi-na', french: 'Ka-hi-na' } },
                    { name: 'Fadhma', pronunciation: { berber: 'Fadh-ma', french: 'Fadh-ma' } },
                    { name: 'Malika', pronunciation: { berber: 'Ma-li-ka', french: 'Ma-li-ka' } },
                    { name: 'Zahra', pronunciation: { berber: 'Zah-ra', french: 'Za-hra' } },
                    { name: 'Yamina', pronunciation: { berber: 'Ya-mi-na', french: 'Ya-mi-na' } },
                    { name: 'Tassadit', pronunciation: { berber: 'Tas-sa-dit', french: 'Tas-sa-dit' } },
                    { name: 'Djamila', pronunciation: { berber: 'Dja-mi-la', french: 'Dja-mi-la' } },
                    { name: 'Noura', pronunciation: { berber: 'Nou-ra', french: 'Nou-ra' } },
                    { name: 'Fatima', pronunciation: { berber: 'Fa-ti-ma', french: 'Fa-ti-ma' } }
                ]
            }
        };

        // Missions disponibles
        const missions = {
            'first_marriage': {
                title: '💑 Premier Amour',
                description: 'Se marier pour la première fois',
                reward: 100,
                completed: false
            },
            'five_marriages': {
                title: '💕 Collectionneur de Cœurs',
                description: 'Se marier 5 fois',
                reward: 250,
                completed: false
            },
            'ten_marriages': {
                title: '👑 Roi/Reine du Mariage',
                description: 'Se marier 10 fois',
                reward: 500,
                completed: false
            },
            'continent_explorer': {
                title: '🌍 Explorateur Continental',
                description: 'Se marier avec des partenaires de 3 continents différents',
                reward: 300,
                completed: false
            },
            'polyglot': {
                title: '🗣️ Polyglotte Romantique',
                description: 'Se marier avec des partenaires parlant 5 langues différentes',
                reward: 400,
                completed: false
            },
            'diplomat': {
                title: '🤝 Diplomate de l\'Amour',
                description: 'Résoudre 3 conflits par la discussion',
                reward: 200,
                completed: false
            },
            'peace_maker': {
                title: '🕊️ Artisan de Paix',
                description: 'Négocier avec succès 2 traités de paix',
                reward: 300,
                completed: false
            },
            'explorer': {
                title: '🗺️ Explorateur',
                description: 'Visiter tous les pays disponibles',
                reward: 1000,
                completed: false
            }
        };

        // Système de sauvegarde avec auto-save
        let saveStatus = {
            hasUnsavedChanges: false,
            lastSaveTime: null,
            currentState: 'saved' // 'saved', 'has-changes', 'saving', 'error'
        };

        // ============================================
        // SYSTÈME DE JALOUSIE ET GUERRE DRAMATIQUE
        // ============================================

        // Déclencher événement de jalousie automatiquement
        function triggerJealousyEvent() {
            // Seulement s'il y a des mariages
            if (marriageHistory.length === 0) return;
            
            // Sélectionner un pays aléatoire des mariages
            const randomMarriage = marriageHistory[Math.floor(Math.random() * marriageHistory.length)];
            const targetCountry = randomMarriage.partnerCountry;
            
            // Messages dramatiques selon le type d'événement
            const eventTypes = [
                {
                    type: 'ex_returns',
                    message: `😱 Drama ! Un(e) ex de ${targetCountry} essaie de récupérer votre partenaire !`,
                    effect: -20,
                    emoji: '💔💔💔'
                },
                {
                    type: 'celebrity_crush',
                    message: `📸 Scandale ! Votre partenaire de ${targetCountry} a été vu(e) avec une célébrité !`,
                    effect: -15,
                    emoji: '📸📸📸'
                },
                {
                    type: 'family_disapproval',
                    message: `💔 La famille de ${targetCountry} n'approuve pas votre relation !`,
                    effect: -25,
                    emoji: '⚡😤⚡'
                },
                {
                    type: 'social_media_drama',
                    message: `📱 Drama sur les réseaux ! Votre relation avec ${targetCountry} fait polémique !`,
                    effect: -10,
                    emoji: '📱💬📱'
                },
                {
                    type: 'old_flame',
                    message: `🌹 Coup de théâtre ! Une ancienne flamme de ${targetCountry} réapparaît !`,
                    effect: -18,
                    emoji: '🌹💕🌹'
                }
            ];
            
            const selectedEvent = eventTypes[Math.floor(Math.random() * eventTypes.length)];
            executeJealousyEvent(selectedEvent, targetCountry);
        }

        // Exécuter un événement de jalousie dramatique
        function executeJealousyEvent(eventType, country) {
            const messageContainer = document.getElementById('messageContainer');
            const eventDiv = document.createElement('div');
            eventDiv.className = 'jealousy-message';
            eventDiv.style.background = 'linear-gradient(45deg, #FF6B6B, #FF8E53)';
            eventDiv.style.color = 'white';
            eventDiv.style.padding = '25px';
            eventDiv.style.borderRadius = '15px';
            eventDiv.style.margin = '15px 0';
            eventDiv.style.textAlign = 'center';
            eventDiv.style.animation = 'dramaticPulse 2s ease-in-out infinite';
            eventDiv.style.border = '2px solid #FF0000';
            eventDiv.style.boxShadow = '0 0 20px rgba(255, 0, 0, 0.5)';
            
            eventDiv.innerHTML = `
                <div style="font-size: 3em; margin-bottom: 15px;">${eventType.emoji}</div>
                <div style="font-size: 20px; font-weight: bold; margin-bottom: 15px;">
                    🚨 DRAMA RELATIONNEL ! 🚨
                </div>
                <div style="font-size: 18px; margin-bottom: 20px; background: rgba(0,0,0,0.3); padding: 15px; border-radius: 10px;">
                    ${eventType.message}
                </div>
                <div style="font-size: 14px; opacity: 0.9; margin: 15px 0;">
                    💔 Stabilité relationnelle affectée : ${eventType.effect} points !
                </div>
                
                <div style="margin: 25px 0; display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                    <button class="btn btn-success" onclick="handleJealousyReaction('discuss', '${country}', ${eventType.effect})">
                        💬 Discuter calmement
                    </button>
                    <button class="btn btn-warning" onclick="handleJealousyReaction('ignore', '${country}', ${eventType.effect})">
                        😤 Ignorer le problème
                    </button>
                    <button class="btn btn-warning" onclick="handleJealousyReaction('jealous', '${country}', ${eventType.effect})">
                        😠 Devenir jaloux/jalouse
                    </button>
                    <button class="btn" style="background: linear-gradient(45deg, #8B0000, #FF0000); color: white;" onclick="triggerWarEvent('${country}')">
                        ⚔️ Déclencher une guerre !
                    </button>
                </div>
            `;
            
            messageContainer.appendChild(eventDiv);
            
            // Effets visuels selon la gravité
            if (eventType.effect < -20) {
                createHeartbreakEffect();
            } else {
                createTensionEffect();
            }
            
            // Réduire la stabilité relationnelle
            relationshipStability = Math.max(0, relationshipStability + eventType.effect);
            
            markUnsavedChanges();
        }

        // Gérer les réactions de jalousie
        function handleJealousyReaction(reactionType, country, originalEffect) {
            // Supprimer le message d'événement
            document.querySelectorAll('.jealousy-message').forEach(msg => msg.remove());
            
            let stabilityChange = 0;
            let responseMessage = '';
            
            switch (reactionType) {
                case 'ignore':
                    stabilityChange = Math.floor(originalEffect * 0.5);
                    responseMessage = `😤 Vous avez choisi d'ignorer le problème avec ${country}. La tension persiste...`;
                    break;
                    
                case 'discuss':
                    stabilityChange = Math.abs(originalEffect) * 1.5;
                    responseMessage = `💬 Discussion réussie ! Votre relation avec ${country} est plus forte maintenant !`;
                    gainXP(25);
                    
                    // Chance d'événement de réconciliation
                    if (Math.random() < 0.6) {
                        setTimeout(() => {
                            triggerReconciliationEvent(country);
                        }, 3000);
                    }
                    break;
                    
                case 'jealous':
                    stabilityChange = originalEffect * 1.5;
                    responseMessage = `😠 Votre jalousie a empiré les choses avec ${country} ! Situation explosive !`;
                    break;
            }
            
            relationshipStability = Math.max(0, Math.min(100, relationshipStability + stabilityChange));
            showMessage(responseMessage, reactionType === 'discuss' ? 'success' : 'error');
            markUnsavedChanges();
        }

        // ÉVÉNEMENT DE GUERRE DRAMATIQUE (comme demandé)
        function triggerWarEvent(country) {
            // Supprimer le message de jalousie
            document.querySelectorAll('.jealousy-message').forEach(msg => msg.remove());
            
            const messageContainer = document.getElementById('messageContainer');
            const warDiv = document.createElement('div');
            warDiv.className = 'war-message';
            warDiv.style.background = 'linear-gradient(45deg, #8B0000, #FF0000, #FF4500)';
            warDiv.style.color = 'white';
            warDiv.style.padding = '30px';
            warDiv.style.borderRadius = '15px';
            warDiv.style.margin = '15px 0';
            warDiv.style.textAlign = 'center';
            warDiv.style.border = '3px solid #FF0000';
            warDiv.style.boxShadow = '0 0 40px rgba(255, 0, 0, 0.8)';
            warDiv.style.animation = 'warAlert 1s ease-in-out infinite';
            
            // Message automatique exact comme demandé
            const warMessage = `Oh non 😭 Israël qui attaque ${country} !`;
            
            warDiv.innerHTML = `
                <div style="font-size: 4em; margin-bottom: 20px;">⚔️💥⚔️</div>
                <div style="font-size: 24px; font-weight: bold; margin-bottom: 15px; text-shadow: 2px 2px 4px rgba(0,0,0,0.7);">
                    🚨 GUERRE DÉCLENCHÉE ! 🚨
                </div>
                <div style="font-size: 20px; margin-bottom: 20px; background: rgba(0,0,0,0.5); padding: 20px; border-radius: 15px; border: 2px solid #FFFF00;">
                    ${warMessage}
                </div>
                <div style="font-size: 16px; margin: 20px 0;">
                    💣 La jalousie a dégénéré en conflit international !<br>
                    🏛️ Relations diplomatiques rompues !<br>
                    💔 Stabilité relationnelle : -40 points !
                </div>
                
                <div style="font-size: 3em; margin: 20px 0; animation: explosionBlink 0.5s infinite;">
                    🔥💣🔥
                </div>
                
                <div style="margin: 25px 0; display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
                    <button class="btn btn-warning" onclick="attemptPeaceTreaty('${country}')">
                        🕊️ Négocier la paix
                    </button>
                    <button class="btn" style="background: linear-gradient(45deg, #FF4500, #FF0000);" onclick="escalateWar('${country}')">
                        💥 Escalade militaire
                    </button>
                    <button class="btn btn-success" onclick="callUN('${country}')">
                        🏛️ Appeler l'ONU
                    </button>
                    <button class="btn btn-secondary" onclick="endWarEvent()">
                        ✖️ Fermer
                    </button>
                </div>
            `;
            
            messageContainer.appendChild(warDiv);
            
            // Effets visuels spectaculaires de guerre
            createWarEffects();
            playWarSound();
            
            // Pénalité massive pour la stabilité
            relationshipStability = Math.max(0, relationshipStability - 40);
            
            markUnsavedChanges();
        }

        // Négocier la paix
        function attemptPeaceTreaty(country) {
            document.querySelectorAll('.war-message').forEach(msg => msg.remove());
            
            if (Math.random() > 0.4) { // 60% de chance de succès
                showMessage(`🕊️ Succès diplomatique ! Traité de paix signé avec ${country} ! Relations normalisées.`, 'success');
                relationshipStability = Math.min(100, relationshipStability + 30);
                gainXP(100);
                updateMissions('peace_maker');
            } else {
                showMessage(`💥 Échec des négociations ! ${country} refuse le dialogue. Le conflit continue...`, 'error');
            }
        }

        // Escalade militaire
        function escalateWar(country) {
            document.querySelectorAll('.war-message').forEach(msg => msg.remove());
            
            showMessage(`💣 Escalade catastrophique ! Conflit majeur avec ${country} ! Toutes relations affectées !`, 'error');
            relationshipStability = Math.max(0, relationshipStability - 30);
            gameState.player.xp = Math.max(0, gameState.player.xp - 100);
            updateXPDisplay();
            createNuclearEffect();
        }

        // Appeler l'ONU
        function callUN(country) {
            document.querySelectorAll('.war-message').forEach(msg => msg.remove());
            
            const unMessage = `🏛️ L'ONU intervient ! Cessez-le-feu immédiat entre tous les pays ! Mission de paix réussie.`;
            showMessage(unMessage, 'success');
            relationshipStability = Math.min(100, relationshipStability + 50);
            gainXP(150);
        }

        // Fermer événement de guerre
        function endWarEvent() {
            document.querySelectorAll('.war-message').forEach(msg => msg.remove());
        }

        // Événement de réconciliation
        function triggerReconciliationEvent(country) {
            const reconciliationMessages = [
                `💕 Geste romantique ! Votre partenaire de ${country} vous fait une surprise !`,
                `📢 Déclaration publique ! ${country} proclame son amour devant tout le monde !`,
                `🤝 Réconciliation parfaite ! Problème résolu avec ${country} !`,
                `💑 Thérapie de couple réussie ! Relation avec ${country} renforcée !`
            ];
            
            const message = reconciliationMessages[Math.floor(Math.random() * reconciliationMessages.length)];
            
            const messageContainer = document.getElementById('messageContainer');
            const reconciliationDiv = document.createElement('div');
            reconciliationDiv.className = 'special-message';
            reconciliationDiv.style.background = 'linear-gradient(45deg, #4ECDC4, #44A08D)';
            reconciliationDiv.style.animation = 'heartsFloat 3s ease-in-out';
            
            reconciliationDiv.innerHTML = `
                <div style="font-size: 3em; margin-bottom: 15px;">💕💖💕</div>
                <div style="font-size: 18px; font-weight: bold; color: white; margin-bottom: 15px;">
                    ${message}
                </div>
                <div style="margin: 15px 0; font-size: 16px; color: rgba(255,255,255,0.9);">
                    Stabilité relationnelle : +25 points !
                </div>
                <div style="margin-top: 20px;">
                    <button class="btn btn-secondary" onclick="this.parentElement.remove()">
                        ✖️ Fermer
                    </button>
                </div>
            `;
            
            messageContainer.appendChild(reconciliationDiv);
            relationshipStability = Math.min(100, relationshipStability + 25);
            gainXP(30);
            createHeartAnimation();
        }

        // Effets visuels pour la guerre
        function createWarEffects() {
            // Tremblement de l'écran
            document.body.style.animation = 'warShake 0.5s ease-in-out 5';
            
            // Explosions multiples
            for (let i = 0; i < 15; i++) {
                setTimeout(() => {
                    const explosion = document.createElement('div');
                    explosion.style.position = 'fixed';
                    explosion.style.left = Math.random() * window.innerWidth + 'px';
                    explosion.style.top = Math.random() * window.innerHeight + 'px';
                    explosion.style.fontSize = '60px';
                    explosion.style.pointerEvents = 'none';
                    explosion.style.zIndex = '9999';
                    explosion.textContent = '💥';
                    explosion.style.animation = 'explosionPop 1.2s ease-out';
                    document.body.appendChild(explosion);
                    
                    setTimeout(() => explosion.remove(), 1200);
                }, i * 200);
            }
            
            // Overlay rouge clignotant
            const warOverlay = document.createElement('div');
            warOverlay.style.position = 'fixed';
            warOverlay.style.top = '0';
            warOverlay.style.left = '0';
            warOverlay.style.width = '100%';
            warOverlay.style.height = '100%';
            warOverlay.style.background = 'rgba(255, 0, 0, 0.3)';
            warOverlay.style.pointerEvents = 'none';
            warOverlay.style.zIndex = '998';
            warOverlay.style.animation = 'warFlash 0.3s ease-in-out 10';
            document.body.appendChild(warOverlay);
            
            setTimeout(() => {
                warOverlay.remove();
                document.body.style.animation = '';
            }, 4000);
        }

        function createNuclearEffect() {
            const nuclearOverlay = document.createElement('div');
            nuclearOverlay.style.position = 'fixed';
            nuclearOverlay.style.top = '0';
            nuclearOverlay.style.left = '0';
            nuclearOverlay.style.width = '100%';
            nuclearOverlay.style.height = '100%';
            nuclearOverlay.style.background = 'radial-gradient(circle, rgba(255,255,255,0.9) 0%, rgba(255,100,0,0.8) 30%, rgba(255,0,0,0.6) 70%, rgba(0,0,0,0.4) 100%)';
            nuclearOverlay.style.pointerEvents = 'none';
            nuclearOverlay.style.zIndex = '9999';
            nuclearOverlay.style.animation = 'nuclearFlash 2.5s ease-out';
            document.body.appendChild(nuclearOverlay);
            
            const mushroom = document.createElement('div');
            mushroom.style.position = 'fixed';
            mushroom.style.top = '50%';
            mushroom.style.left = '50%';
            mushroom.style.transform = 'translate(-50%, -50%)';
            mushroom.style.fontSize = '150px';
            mushroom.style.zIndex = '10000';
            mushroom.textContent = '☢️';
            mushroom.style.animation = 'mushroomRise 3s ease-out';
            document.body.appendChild(mushroom);
            
            setTimeout(() => {
                nuclearOverlay.remove();
                mushroom.remove();
            }, 3000);
        }

        function createHeartbreakEffect() {
            for (let i = 0; i < 10; i++) {
                setTimeout(() => {
                    const heartbreak = document.createElement('div');
                    heartbreak.className = 'heart-animation';
                    heartbreak.textContent = '💔';
                    heartbreak.style.left = Math.random() * window.innerWidth + 'px';
                    heartbreak.style.top = window.innerHeight + 'px';
                    heartbreak.style.color = '#FF6B6B';
                    heartbreak.style.fontSize = '40px';
                    document.body.appendChild(heartbreak);
                    
                    setTimeout(() => heartbreak.remove(), 2000);
                }, i * 300);
            }
        }

        function createTensionEffect() {
            const tensionOverlay = document.createElement('div');
            tensionOverlay.style.position = 'fixed';
            tensionOverlay.style.top = '0';
            tensionOverlay.style.left = '0';
            tensionOverlay.style.width = '100%';
            tensionOverlay.style.height = '100%';
            tensionOverlay.style.background = 'rgba(255, 0, 0, 0.15)';
            tensionOverlay.style.pointerEvents = 'none';
            tensionOverlay.style.zIndex = '999';
            tensionOverlay.style.animation = 'tensionFlash 0.5s ease-in-out 4';
            document.body.appendChild(tensionOverlay);
            
            setTimeout(() => tensionOverlay.remove(), 2500);
        }

        // Son d'alerte de guerre
        function playWarSound() {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                
                // Sirène d'alerte dramatique
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.type = 'sawtooth';
                oscillator.frequency.setValueAtTime(300, audioContext.currentTime);
                oscillator.frequency.linearRampToValueAtTime(900, audioContext.currentTime + 0.7);
                oscillator.frequency.linearRampToValueAtTime(300, audioContext.currentTime + 1.4);
                
                gainNode.gain.setValueAtTime(0.4, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 2.5);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 2.5);
            } catch (error) {
                console.log('Audio de guerre non supporté:', error);
            }
        }

        // Bouton pour déclencher manuellement la jalousie (pour test)
        function addManualJealousyButton() {
            const gameMain = document.getElementById('gameMain');
            if (gameMain && !document.getElementById('jealousyTrigger')) {
                const buttonDiv = document.createElement('div');
                buttonDiv.style.textAlign = 'center';
                buttonDiv.style.margin = '20px 0';
                buttonDiv.innerHTML = `
                    <button id="jealousyTrigger" class="btn btn-warning" onclick="triggerJealousyEvent()">
                        😱 Déclencher un Drama Relationnel !
                    </button>
                    <div style="margin-top: 10px; font-size: 14px; opacity: 0.8;">
                        Stabilité relationnelle actuelle : <span style="font-weight: bold; color: ${relationshipStability > 70 ? '#28a745' : relationshipStability > 30 ? '#ffc107' : '#dc3545'}">${relationshipStability}/100</span>
                    </div>
                `;
                gameMain.appendChild(buttonDiv);
            }
        }

        // Système automatique de jalousie (toutes les 45 secondes)
        function startJealousySystem() {
            setInterval(() => {
                if (marriageHistory.length > 0 && Math.random() < 0.25) { // 25% de chance
                    triggerJealousyEvent();
                }
            }, 45000); // Toutes les 45 secondes
        }

        // ============================================
        // SYSTÈME DE TRADUCTIONS MULTILINGUES
        // ============================================

        // Traductions pour les différentes langues
        const translations = {
            fr: {
                interface_language: 'Langue d\'interface',
                pronunciation: 'Prononciation',
                auto_origin: 'Auto (selon origine)',
                dark_mode: 'Mode Sombre',
                light_mode: 'Mode Clair',
                character_creation: 'Création de votre Country Ball',
                first_name: 'Prénom :',
                last_name: 'Nom de famille :',
                gender: 'Genre :',
                choose: 'Choisissez...',
                male: 'Homme',
                female: 'Femme',
                choose_country: 'Choisissez votre pays :',
                start_adventure: 'Commencer l\'aventure !',
                level: 'Niveau',
                explore: 'Explorer',
                marriages: 'Mariages',
                missions: 'Missions',
                saves: 'Sauvegardes',
                explore_world: 'Explorez le monde et trouvez l\'amour !',
                explore_random: 'Explorer un pays aléatoire !',
                no_marriages: 'Aucun mariage pour le moment. Explorez le monde !',
                no_missions: 'Aucune mission disponible.',
                fill_all_fields: 'Veuillez remplir tous les champs !',
                welcome_message: 'Bienvenue ! Votre aventure amoureuse commence maintenant !',
                explore_message: 'Vous explorez {country} et rencontrez {name} !',
                propose_marriage: 'Demander en mariage',
                continue_exploring: 'Continuer à explorer',
                pronunciation_label: 'Prononciation :',
                pronunciation_unavailable: 'Prononciation non disponible'
            },
            en: {
                interface_language: 'Interface Language',
                pronunciation: 'Pronunciation',
                auto_origin: 'Auto (by origin)',
                dark_mode: 'Dark Mode',
                light_mode: 'Light Mode',
                character_creation: 'Create your Country Ball',
                first_name: 'First Name:',
                last_name: 'Last Name:',
                gender: 'Gender:',
                choose: 'Choose...',
                male: 'Male',
                female: 'Female',
                choose_country: 'Choose your country:',
                start_adventure: 'Start the adventure!',
                level: 'Level',
                explore: 'Explore',
                marriages: 'Marriages',
                missions: 'Missions',
                saves: 'Saves',
                explore_world: 'Explore the world and find love!',
                explore_random: 'Explore a random country!',
                no_marriages: 'No marriages yet. Explore the world!',
                no_missions: 'No missions available.',
                fill_all_fields: 'Please fill all fields!',
                welcome_message: 'Welcome! Your romantic adventure begins now!',
                explore_message: 'You explore {country} and meet {name}!',
                propose_marriage: 'Propose marriage',
                continue_exploring: 'Continue exploring',
                pronunciation_label: 'Pronunciation:',
                pronunciation_unavailable: 'Pronunciation unavailable'
            },
            es: {
                interface_language: 'Idioma de Interfaz',
                pronunciation: 'Pronunciación',
                auto_origin: 'Auto (según origen)',
                dark_mode: 'Modo Oscuro',
                light_mode: 'Modo Claro',
                character_creation: 'Crea tu Country Ball',
                first_name: 'Nombre:',
                last_name: 'Apellido:',
                gender: 'Género:',
                choose: 'Elegir...',
                male: 'Hombre',
                female: 'Mujer',
                choose_country: 'Elige tu país:',
                start_adventure: '¡Comenzar la aventura!',
                level: 'Nivel',
                explore: 'Explorar',
                marriages: 'Matrimonios',
                missions: 'Misiones',
                saves: 'Guardados',
                explore_world: '¡Explora el mundo y encuentra el amor!',
                explore_random: '¡Explorar un país aleatorio!',
                no_marriages: 'No hay matrimonios aún. ¡Explora el mundo!',
                no_missions: 'No hay misiones disponibles.',
                fill_all_fields: '¡Por favor completa todos los campos!',
                welcome_message: '¡Bienvenido! ¡Tu aventura romántica comienza ahora!',
                explore_message: '¡Exploras {country} y conoces a {name}!',
                propose_marriage: 'Proponer matrimonio',
                continue_exploring: 'Continuar explorando',
                pronunciation_label: 'Pronunciación:',
                pronunciation_unavailable: 'Pronunciación no disponible'
            },
            de: {
                interface_language: 'Oberflächensprache',
                pronunciation: 'Aussprache',
                auto_origin: 'Auto (nach Herkunft)',
                dark_mode: 'Dunkler Modus',
                light_mode: 'Heller Modus',
                character_creation: 'Erstelle deinen Country Ball',
                first_name: 'Vorname:',
                last_name: 'Nachname:',
                gender: 'Geschlecht:',
                choose: 'Wählen...',
                male: 'Mann',
                female: 'Frau',
                choose_country: 'Wähle dein Land:',
                start_adventure: 'Abenteuer beginnen!',
                level: 'Level',
                explore: 'Erkunden',
                marriages: 'Ehen',
                missions: 'Missionen',
                saves: 'Speicherstände',
                explore_world: 'Erkunde die Welt und finde die Liebe!',
                explore_random: 'Ein zufälliges Land erkunden!',
                no_marriages: 'Noch keine Ehen. Erkunde die Welt!',
                no_missions: 'Keine Missionen verfügbar.',
                fill_all_fields: 'Bitte fülle alle Felder aus!',
                welcome_message: 'Willkommen! Dein romantisches Abenteuer beginnt jetzt!',
                explore_message: 'Du erkundest {country} und triffst {name}!',
                propose_marriage: 'Heiratsantrag machen',
                continue_exploring: 'Weiter erkunden',
                pronunciation_label: 'Aussprache:',
                pronunciation_unavailable: 'Aussprache nicht verfügbar'
            },
            it: {
                interface_language: 'Lingua dell\'Interfaccia',
                pronunciation: 'Pronuncia',
                auto_origin: 'Auto (per origine)',
                dark_mode: 'Modalità Scura',
                light_mode: 'Modalità Chiara',
                character_creation: 'Crea il tuo Country Ball',
                first_name: 'Nome:',
                last_name: 'Cognome:',
                gender: 'Genere:',
                choose: 'Scegli...',
                male: 'Uomo',
                female: 'Donna',
                choose_country: 'Scegli il tuo paese:',
                start_adventure: 'Inizia l\'avventura!',
                level: 'Livello',
                explore: 'Esplora',
                marriages: 'Matrimoni',
                missions: 'Missioni',
                saves: 'Salvataggi',
                explore_world: 'Esplora il mondo e trova l\'amore!',
                explore_random: 'Esplora un paese casuale!',
                no_marriages: 'Nessun matrimonio ancora. Esplora il mondo!',
                no_missions: 'Nessuna missione disponibile.',
                fill_all_fields: 'Per favore compila tutti i campi!',
                welcome_message: 'Benvenuto! La tua avventura romantica inizia ora!',
                explore_message: 'Esplori {country} e incontri {name}!',
                propose_marriage: 'Proporre matrimonio',
                continue_exploring: 'Continua a esplorare',
                pronunciation_label: 'Pronuncia:',
                pronunciation_unavailable: 'Pronuncia non disponibile'
            }
        };

        // Fonction pour obtenir la traduction courante
        function getTranslation(key) {
            const language = gameState.language || 'fr';
            return translations[language]?.[key] || translations['fr'][key] || key;
        }

        // Fonction pour changer la langue d'interface
        function changeLanguage() {
            const selectedLanguage = document.getElementById('languageSelect').value;
            gameState.language = selectedLanguage;
            
            updateInterfaceLanguage(selectedLanguage);
            markUnsavedChanges();
        }

        // Fonction pour changer la langue de prononciation préférée
        function changePronunciationLanguage() {
            const selectedPronunciationLanguage = document.getElementById('pronunciationSelect').value;
            gameState.pronunciationLanguage = selectedPronunciationLanguage;
            markUnsavedChanges();
        }

        // Fonction pour mettre à jour l'interface selon la langue
        function updateInterfaceLanguage(language) {
            const t = translations[language];
            if (!t) return;

            // Mettre à jour les labels et textes de l'interface
            const languageLabel = document.querySelector('label[for="languageSelect"]');
            if (languageLabel) languageLabel.textContent = '🌐 ' + t.interface_language;
            
            const pronunciationLabel = document.querySelector('label[for="pronunciationSelect"]');
            if (pronunciationLabel) pronunciationLabel.textContent = '🗣️ ' + t.pronunciation;
            
            const themeButton = document.getElementById('themeToggle');
            if (themeButton) {
                const isDark = document.documentElement.classList.contains('dark');
                themeButton.textContent = isDark ? '☀️ ' + t.light_mode : '🌙 ' + t.dark_mode;
            }

            // Mettre à jour les options de prononciation
            const pronunciationSelect = document.getElementById('pronunciationSelect');
            if (pronunciationSelect && pronunciationSelect.children.length > 0) {
                pronunciationSelect.children[0].textContent = '🌍 ' + t.auto_origin;
            }

            // Mettre à jour la création de personnage
            const characterTitle = document.querySelector('#characterCreation h2');
            if (characterTitle) {
                characterTitle.textContent = '✨ ' + t.character_creation + ' ✨';
            }

            // Mettre à jour les labels de formulaire
            const firstNameLabel = document.querySelector('label[for="firstName"]');
            if (firstNameLabel) firstNameLabel.textContent = '👤 ' + t.first_name;
            
            const lastNameLabel = document.querySelector('label[for="lastName"]');
            if (lastNameLabel) lastNameLabel.textContent = '🏷️ ' + t.last_name;
            
            const genderLabel = document.querySelector('label[for="genderSelect"]');
            if (genderLabel) genderLabel.textContent = '⚧️ ' + t.gender;
            
            const countryLabel = document.querySelector('label[for="countrySelect"]');
            if (countryLabel) countryLabel.textContent = '🏳️ ' + t.choose_country;

            // Mettre à jour les options de genre
            const genderSelect = document.getElementById('genderSelect');
            if (genderSelect && genderSelect.children.length >= 3) {
                genderSelect.children[0].textContent = t.choose;
                genderSelect.children[1].textContent = '👨 ' + t.male;
                genderSelect.children[2].textContent = '👩 ' + t.female;
            }

            // Mettre à jour le bouton de démarrage
            const startButton = document.getElementById('startGameBtn');
            if (startButton) {
                startButton.textContent = '🚀 ' + t.start_adventure;
            }

            // Mettre à jour les boutons de navigation du jeu principal
            updateNavigationButtons(t);
            updateSectionTitles(t);
        }

        // Fonction pour mettre à jour les boutons de navigation
        function updateNavigationButtons(t) {
            const exploreBtn = document.querySelector('button[onclick="showSection(\'explore\')"]');
            if (exploreBtn) exploreBtn.textContent = '🌍 ' + t.explore;
            
            const marriageBtn = document.querySelector('button[onclick="showSection(\'marriage\')"]');
            if (marriageBtn) marriageBtn.textContent = '💒 ' + t.marriages;
            
            const missionsBtn = document.querySelector('button[onclick="showSection(\'missions\')"]');
            if (missionsBtn) missionsBtn.textContent = '🎯 ' + t.missions;
            
            const savesBtn = document.querySelector('button[onclick="showSection(\'saves\')"]');
            if (savesBtn) savesBtn.textContent = '💾 ' + t.saves;
        }

        // Fonction pour mettre à jour les titres des sections
        function updateSectionTitles(t) {
            const exploreTitle = document.querySelector('#exploreSection h3');
            if (exploreTitle) {
                exploreTitle.textContent = '🌍 ' + t.explore_world + ' 🌍';
            }

            const exploreButton = document.getElementById('exploreBtn');
            if (exploreButton) {
                exploreButton.textContent = '🚀 ' + t.explore_random;
            }

            const marriageTitle = document.querySelector('#marriageSection h3');
            if (marriageTitle) {
                marriageTitle.textContent = '💒 ' + t.marriages + ' 💒';
            }

            const missionsTitle = document.querySelector('#missionsSection h3');
            if (missionsTitle) {
                missionsTitle.textContent = '🎯 ' + t.missions + ' 🎯';
            }

            const savesTitle = document.querySelector('#savesSection h3');
            if (savesTitle) {
                savesTitle.textContent = '💾 ' + t.saves + ' 💾';
            }

            // Mettre à jour le contenu des sections si elles sont vides
            const marriageList = document.getElementById('marriageList');
            if (marriageList && marriageList.textContent.includes('Aucun mariage') || marriageList.textContent.includes('No marriages')) {
                marriageList.innerHTML = `<p class="text-center text-gray-500 dark:text-gray-400">${t.no_marriages}</p>`;
            }
        }

        // ============================================
        // FONCTIONS PRINCIPALES DU JEU
        // ============================================

        function initGame() {
            updateMissionsList();
            initTheme();
            initLanguageSettings();
        }

        function initLanguageSettings() {
            // Initialiser la langue selon l'état du jeu
            const languageSelect = document.getElementById('languageSelect');
            const pronunciationSelect = document.getElementById('pronunciationSelect');
            
            if (languageSelect) {
                languageSelect.value = gameState.language || 'fr';
            }
            
            if (pronunciationSelect) {
                pronunciationSelect.value = gameState.pronunciationLanguage || 'auto';
            }
            
            // Appliquer la langue actuelle
            updateInterfaceLanguage(gameState.language || 'fr');
        }

        function initTheme() {
            const themeToggle = document.getElementById('themeToggle');
            if (themeToggle) {
                const isDark = document.documentElement.classList.contains('dark');
                themeToggle.textContent = isDark ? '☀️ Mode Clair' : '🌙 Mode Sombre';
                gameState.theme = isDark ? 'dark' : 'light';
                
                // Forcer l'application du thème
                if (isDark) {
                    document.body.classList.add('dark');
                    document.documentElement.setAttribute('data-theme', 'dark');
                } else {
                    document.body.classList.remove('dark');
                    document.documentElement.setAttribute('data-theme', 'light');
                }
            }
        }

        function toggleTheme() {
            const isDarkBefore = document.documentElement.classList.contains('dark');
            
            // Toggle les classes
            document.documentElement.classList.toggle('dark');
            document.body.classList.toggle('dark');
            
            const isDarkAfter = document.documentElement.classList.contains('dark');
            
            // Mettre à jour le bouton
            const themeToggle = document.getElementById('themeToggle');
            if (themeToggle) {
                themeToggle.textContent = isDarkAfter ? '☀️ Mode Clair' : '🌙 Mode Sombre';
            }
            
            // Mettre à jour l'état du jeu
            gameState.theme = isDarkAfter ? 'dark' : 'light';
            
            // Attribut data pour CSS
            document.documentElement.setAttribute('data-theme', gameState.theme);
            
            // Forcer le re-rendu des styles
            document.body.style.transition = 'all 0.3s ease';
            
            if (gameState.player && gameState.player.fullName) {
                markUnsavedChanges();
            }
        }

        function startMainGame() {
            const firstName = document.getElementById('firstName').value.trim();
            const lastName = document.getElementById('lastName').value.trim();
            const gender = document.getElementById('genderSelect').value;

            if (!firstName || !lastName || !gender) {
                alert('⚠️ Veuillez remplir tous les champs obligatoires !');
                return;
            }

            if (selectedOrigins.length === 0) {
                alert('⚠️ Veuillez sélectionner au moins une origine !');
                return;
            }

            gameState.player.firstName = firstName;
            gameState.player.lastName = lastName;
            gameState.player.origins = selectedOrigins.slice(); // Copie des origines
            gameState.player.country = selectedOrigins[0]; // Pays principal pour compatibilité
            gameState.player.gender = gender;
            gameState.player.fullName = `${firstName} ${lastName}`;

            // Appliquer le bonus XP du quiz s'il y en a un en attente
            if (quizData.pendingBonus) {
                gameState.player.xp += quizData.pendingBonus;
                quizData.pendingBonus = 0;
            }

            document.getElementById('characterCreation').classList.add('hidden');
            document.getElementById('gameMain').classList.remove('hidden');

            updatePlayerInfo();
            
            const genderEmoji = gender === 'male' ? '👨' : '👩';
            const originsText = selectedOrigins.length > 1 ? 
                `aux origines multiples (${selectedOrigins.join(', ')})` : 
                `de ${selectedOrigins[0]}`;
            
            showMessage(`🎉 Bienvenue ${genderEmoji} ${gameState.player.fullName} ${originsText} ! Votre aventure amoureuse commence maintenant ! 🎉`, 'success');
            
            // Afficher le bonus XP du quiz si applicable
            if (quizData.completed && quizData.bonusXP > 0) {
                showMessage(`🧠 Bonus quiz culturel appliqué : +${quizData.bonusXP} XP !`, 'success');
            }
            
            markUnsavedChanges();
        }

        function updatePlayerInfo() {
            const flag = countries[gameState.player.country] || '🏳️';
            document.getElementById('playerInfo').textContent = 
                `${flag} ${gameState.player.fullName}`;
            document.getElementById('playerDetails').textContent = 
                `Niveau ${gameState.player.level} • ${gameState.player.country}`;
            updateXPDisplay();
        }

        function updateXPDisplay() {
            const xpNeeded = gameState.player.level * 100;
            const xpProgress = (gameState.player.xp / xpNeeded) * 100;
            
            document.getElementById('xpText').textContent = `${gameState.player.xp} / ${xpNeeded}`;
            document.getElementById('xpBar').style.width = `${Math.min(xpProgress, 100)}%`;
            
            // Vérifier montée de niveau
            if (gameState.player.xp >= xpNeeded) {
                levelUp();
            }
        }

        function levelUp() {
            gameState.player.level++;
            gameState.player.xp = 0;
            showMessage(`🎊 NIVEAU SUPÉRIEUR ! Vous êtes maintenant niveau ${gameState.player.level} ! 🎊`, 'special');
            updatePlayerInfo();
            createLevelUpEffect();
            markUnsavedChanges();
        }

        function gainXP(amount) {
            gameState.player.xp += amount;
            updateXPDisplay();
            markUnsavedChanges();
        }

        function createLevelUpEffect() {
            for (let i = 0; i < 20; i++) {
                setTimeout(() => {
                    createHeartAnimation();
                }, i * 100);
            }
        }

        function createHeartAnimation() {
            const heart = document.createElement('div');
            heart.className = 'heart-animation';
            heart.textContent = ['💖', '💕', '💗', '💘'][Math.floor(Math.random() * 4)];
            heart.style.left = Math.random() * window.innerWidth + 'px';
            heart.style.top = window.innerHeight + 'px';
            document.body.appendChild(heart);
            
            setTimeout(() => {
                heart.remove();
            }, 2000);
        }

        function showSection(sectionName) {
            gameState.currentSection = sectionName;
            
            document.querySelectorAll('.section').forEach(section => {
                section.classList.add('hidden');
            });
            
            document.getElementById(sectionName + 'Section').classList.remove('hidden');
            
            if (sectionName === 'missions') {
                updateMissionsList();
            } else if (sectionName === 'marriage') {
                updateMarriageList();
            }
            
            markUnsavedChanges();
        }

        function exploreWorld() {
            // Générer des origines (simple ou multiples)
            const randomOrigins = generateRandomOrigins();
            
            // Obtenir le drapeau et l'affichage formaté
            const countryFlag = getCountryFlag(randomOrigins);
            const displayOrigins = formatOrigins(randomOrigins);
            
            // Déterminer le pays principal pour les noms
            const primaryCountry = typeof randomOrigins === 'string' ? randomOrigins : randomOrigins.primary;
            
            // Générer une personne aléatoire du genre opposé au joueur
            const character = generateCharacterWithPronunciation(randomOrigins, gameState.player.gender);
            const firstName = character.prenom;
            const lastName = character.nom;
            const gender = character.genre;
            
            const resultDiv = document.getElementById('exploreResult');
            resultDiv.classList.remove('hidden');
            
            const genderEmoji = gender === 'male' ? '👨' : '👩';
            const genderText = gender === 'male' ? 'Homme' : 'Femme';
            
            // Créer une description enrichie pour les origines multiples
            let description = generateDescription(displayOrigins, firstName, gender);
            if (typeof randomOrigins === 'object') {
                description += ` ${firstName} a des origines mixtes et parle plusieurs langues !`;
            }
            
            resultDiv.innerHTML = `
                <div class="country-card text-center">
                    <div class="flag-heart w-24 h-24 mx-auto mb-4 flex items-center justify-center">
                        <span class="text-4xl">${countryFlag}</span>
                    </div>
                    <h4 class="text-2xl font-bold mb-2">${genderEmoji} ${firstName} ${lastName}</h4>
                    <p class="text-lg mb-2 font-semibold text-blue-600 dark:text-blue-400">${displayOrigins}</p>
                    
                    <!-- Affichage des prononciations amélioré -->
                    <div id="pronunciationDisplay" class="pronunciation-zone mb-4">
                        ${formatAdvancedPronunciation(character.prononciation, randomOrigins, firstName)}
                    </div>
                    <p class="text-sm text-purple-600 dark:text-purple-400 mb-4">${genderText}</p>
                    <p class="text-gray-600 dark:text-gray-300 mb-6">${description}</p>
                    
                    <div class="flex flex-col sm:flex-row gap-4 justify-center">
                        <button class="btn btn-success" onclick="proposeMarriage('${firstName}', '${lastName}', '${encodeURIComponent(JSON.stringify(randomOrigins))}', '${gender}')">
                            💍 Demander en mariage
                        </button>
                        <button class="btn btn-secondary" onclick="exploreWorld()">
                            🔄 Continuer à explorer
                        </button>
                    </div>
                </div>
            `;
            
            gainXP(10);
            
            // Ajouter le pays visité au suivi pour le badge Explorateur
            if (!gameState.player.visitedCountries) {
                gameState.player.visitedCountries = new Set();
            }
            gameState.player.visitedCountries.add(primaryCountry);
            
            // Vérifier la mission Explorateur
            updateMissions('explorer');
            
            showMessage(`🌍 Vous explorez ${displayOrigins} et rencontrez ${firstName} ${lastName} !`, 'special');
        }

        function generateLastName(country) {
            const lastNames = {
                'France': ['Martin', 'Bernard', 'Dubois', 'Thomas', 'Robert', 'Petit', 'Durand', 'Leroy', 'Moreau', 'Simon'],
                'Germany': ['Müller', 'Schmidt', 'Schneider', 'Fischer', 'Weber', 'Meyer', 'Wagner', 'Becker', 'Schulz', 'Hoffmann'],
                'United States': ['Smith', 'Johnson', 'Williams', 'Brown', 'Jones', 'Garcia', 'Miller', 'Davis', 'Rodriguez', 'Martinez'],
                'Japan': ['Sato', 'Suzuki', 'Takahashi', 'Tanaka', 'Watanabe', 'Ito', 'Yamamoto', 'Nakamura', 'Kobayashi', 'Kato'],
                'United Kingdom': ['Smith', 'Jones', 'Taylor', 'Williams', 'Brown', 'Davies', 'Evans', 'Wilson', 'Thomas', 'Roberts'],
                'Italy': ['Rossi', 'Russo', 'Ferrari', 'Esposito', 'Bianchi', 'Romano', 'Colombo', 'Ricci', 'Marino', 'Greco'],
                'Spain': ['García', 'Rodríguez', 'González', 'Fernández', 'López', 'Martínez', 'Sánchez', 'Pérez', 'Gómez', 'Martín'],
                'Brazil': ['Silva', 'Santos', 'Oliveira', 'Souza', 'Rodrigues', 'Ferreira', 'Alves', 'Pereira', 'Lima', 'Gomes'],
                'Mexico': ['Hernández', 'García', 'Martínez', 'González', 'López', 'Rodríguez', 'Pérez', 'Sánchez', 'Ramírez', 'Cruz'],
                'Russia': ['Иванов', 'Смирнов', 'Кузнецов', 'Попов', 'Васильев', 'Петров', 'Соколов', 'Михайлов', 'Новиков', 'Фёдоров'],
                'Kabylia': ['Ait Saïd', 'Ait Ali', 'Amellal', 'Meziane', 'Slimani', 'Idir', 'Mammeri', 'Feraoun', 'Ait Ahmed', 'Mohia']
            };
            
            const names = lastNames[country] || lastNames['United States'];
            return names[Math.floor(Math.random() * names.length)];
        }

        // Fonction pour formater l'affichage des prononciations
        function formatPronunciation(prononciation) {
            if (!prononciation || Object.keys(prononciation).length === 0) {
                return '<span class="text-gray-500">Prononciation non disponible</span>';
            }
            
            const pronunciations = [];
            for (const [langue, prononciation_text] of Object.entries(prononciation)) {
                const langueFormatted = langue.charAt(0).toUpperCase() + langue.slice(1);
                pronunciations.push(`[${langueFormatted}] ${prononciation_text}`);
            }
            
            return `<strong>Prononciation :</strong> ${pronunciations.join(' • ')}`;
        }

        // Fonction avancée pour afficher les prononciations selon les origines multiples
        function formatAdvancedPronunciation(prononciation, origins, firstName) {
            if (!prononciation || Object.keys(prononciation).length === 0) {
                return `
                    <div class="text-sm text-gray-500 dark:text-gray-400 text-center italic">
                        Prononciation non disponible
                    </div>
                `;
            }
            
            // Déterminer les langues/origines à afficher
            let targetOrigins = [];
            if (typeof origins === 'string') {
                // Origine simple
                targetOrigins = [{ name: origins, code: getLanguageCode(origins) }];
            } else if (origins && origins.primary) {
                // Origines multiples
                targetOrigins = [
                    { name: origins.primary, code: getLanguageCode(origins.primary) },
                    { name: origins.secondary, code: getLanguageCode(origins.secondary) }
                ];
            }
            
            // Mapping des codes de langue vers les noms affichés
            const languageDisplayNames = {
                'french': 'Français',
                'arabic': 'Arabe',
                'berber': 'Kabyle',
                'german': 'Allemand',
                'english': 'Anglais',
                'italian': 'Italien',
                'spanish': 'Espagnol',
                'portuguese': 'Portugais',
                'japanese': 'Japonais',
                'chinese': 'Chinois',
                'hindi': 'Hindi',
                'russian': 'Russe',
                'turkish': 'Turc'
            };
            
            // Construire l'affichage des prononciations
            const pronunciationItems = [];
            
            for (const origin of targetOrigins) {
                const langCode = origin.code;
                const displayName = languageDisplayNames[langCode] || origin.name;
                
                if (prononciation[langCode]) {
                    pronunciationItems.push(`<span class="font-semibold text-purple-600 dark:text-purple-400">${displayName}</span> : <span class="text-gray-700 dark:text-gray-300">[${prononciation[langCode]}]</span>`);
                } else {
                    pronunciationItems.push(`<span class="font-semibold text-purple-600 dark:text-purple-400">${displayName}</span> : <span class="text-gray-500 dark:text-gray-400 italic">N/A</span>`);
                }
            }
            
            // Si pas de prononciations pour les origines, afficher toutes les prononciations disponibles
            if (pronunciationItems.length === 0 || pronunciationItems.every(item => item.includes('N/A'))) {
                for (const [langue, prononciation_text] of Object.entries(prononciation)) {
                    const displayName = languageDisplayNames[langue] || langue.charAt(0).toUpperCase() + langue.slice(1);
                    pronunciationItems.push(`<span class="font-semibold text-purple-600 dark:text-purple-400">${displayName}</span> : <span class="text-gray-700 dark:text-gray-300">[${prononciation_text}]</span>`);
                }
            }
            
            return `
                <div class="bg-purple-50 dark:bg-purple-900/20 p-3 rounded-lg border border-purple-200 dark:border-purple-700">
                    <div class="text-sm font-semibold text-purple-800 dark:text-purple-300 mb-2 text-center">
                        🗣️ Prononciation de "${firstName}"
                    </div>
                    <div class="text-sm text-center space-y-1">
                        ${pronunciationItems.join(' • ')}
                    </div>
                </div>
            `;
        }

        function generateDescription(country, firstName, gender) {
            const descriptions = [
                `${firstName} est ${gender === 'male' ? 'un artiste passionné' : 'une artiste passionnée'} de ${country}.`,
                `${firstName} travaille comme ${gender === 'male' ? 'ingénieur' : 'ingénieure'} et adore voyager.`,
                `${firstName} est ${gender === 'male' ? 'un chef cuisinier talentueux' : 'une chef cuisinière talentueuse'} de ${country}.`,
                `${firstName} enseigne l'art et rêve de voir le monde.`,
                `${firstName} est ${gender === 'male' ? 'un musicien' : 'une musicienne'} qui compose de magnifiques mélodies.`,
                `${firstName} est passionné${gender === 'male' ? '' : 'e'} de littérature et écrit des poèmes.`,
                `${firstName} travaille dans la mode et crée de superbes designs.`,
                `${firstName} est ${gender === 'male' ? 'un photographe aventurier' : 'une photographe aventurière'} qui capture la beauté du monde.`
            ];
            
            return descriptions[Math.floor(Math.random() * descriptions.length)];
        }

        function proposeMarriage(firstName, lastName, encodedOrigins, gender) {
            // Décoder les origines
            let origins;
            try {
                origins = JSON.parse(decodeURIComponent(encodedOrigins));
            } catch (error) {
                // Si le décodage échoue, traiter comme une origine simple
                origins = encodedOrigins;
            }
            
            const displayOrigins = formatOrigins(origins);
            
            // Vérifier si déjà marié avec cette personne
            const alreadyMarried = marriageHistory.some(marriage => 
                marriage.partner === `${firstName} ${lastName}` && formatOrigins(marriage.partnerOrigins) === displayOrigins
            );
            
            if (alreadyMarried) {
                showMessage(`💔 Vous êtes déjà marié(e) avec ${firstName} ${lastName} !`, 'error');
                return;
            }
            
            const success = Math.random() > 0.3; // 70% de chance de succès
            
            if (success) {
                addToMarriageHistory(firstName, lastName, origins, gender);
                gainXP(50);
                const genderEmoji = gender === 'male' ? '👨' : '👩';
                
                // Jouer le son de victoire
                playVictorySound();
                
                // Message avec bouton de partage
                showMarriageSuccessMessage(firstName, lastName, displayOrigins, gender, genderEmoji);
                
                updateMissions('first_marriage');
                updateMissions('five_marriages');
                updateMissions('ten_marriages');
                updateMissions('continent_explorer');
                updateMissions('polyglot');
                
                // Ajouter le bouton de jalousie après le premier mariage
                if (marriageHistory.length === 1) {
                    setTimeout(() => {
                        addManualJealousyButton();
                    }, 1000);
                }
            } else {
                showMessage(`💔 ${firstName} ${lastName} a décliné votre demande. Ne vous découragez pas !`, 'error');
                gainXP(10);
            }
            
            createHeartAnimation();
            document.getElementById('exploreResult').innerHTML = '';
            document.getElementById('exploreResult').classList.add('hidden');
            markUnsavedChanges();
        }

        function addToMarriageHistory(firstName, lastName, origins, gender) {
            const marriage = {
                partner: `${firstName} ${lastName}`,
                partnerOrigins: origins, // Stocker les origines complètes
                partnerCountry: typeof origins === 'string' ? origins : origins.primary, // Pays principal pour compatibilité
                partnerGender: gender,
                date: new Date().toLocaleDateString('fr-FR'),
                flag: getCountryFlag(origins)
            };
            
            marriageHistory.push(marriage);
            
            // Initialiser le tchat avec le nouveau partenaire
            if (marriageHistory.length === 1) {
                const displayOrigins = formatOrigins(origins);
                initializeChatWithPartner(firstName, lastName, displayOrigins, gender);
            }
            
            markUnsavedChanges();
        }

        function updateMarriageList() {
            const marriageList = document.getElementById('marriageList');
            
            if (marriageHistory.length === 0) {
                marriageList.innerHTML = '<p class="text-center text-gray-500 dark:text-gray-400">Aucun mariage pour le moment. Explorez le monde !</p>';
                return;
            }
            
            // Vider la liste d'abord
            marriageList.innerHTML = '';
            
            // Créer chaque carte de mariage
            marriageHistory.forEach((marriage, index) => {
                const genderEmoji = marriage.partnerGender === 'male' ? '👨' : '👩';
                const genderText = marriage.partnerGender === 'male' ? 'Homme' : 'Femme';
                
                // Créer la carte de mariage
                const marriageCard = document.createElement('div');
                marriageCard.className = 'country-card';
                marriageCard.id = `marriage-${index}`;
                
                marriageCard.innerHTML = `
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-4">
                            <div class="text-4xl">${marriage.flag}</div>
                            <div>
                                <h4 class="text-xl font-bold">${genderEmoji} ${marriage.partner}</h4>
                                <p class="text-gray-600 dark:text-gray-300">${marriage.partnerCountry}</p>
                                <p class="text-sm text-purple-600 dark:text-purple-400">${genderText}</p>
                                <p class="text-sm text-gray-500 dark:text-gray-400">Marié(e) le ${marriage.date}</p>
                            </div>
                        </div>
                        <div class="flex items-center gap-4">
                            <div class="text-2xl">💕</div>
                            <button class="btn breakup-btn" style="background: linear-gradient(45deg, #dc3545, #c82333); color: white; padding: 8px 16px; font-size: 14px;" 
                                    data-partner-name="${marriage.partner}" 
                                    data-partner-country="${marriage.partnerCountry}" 
                                    data-partner-gender="${marriage.partnerGender}" 
                                    data-marriage-index="${index}">
                                💔 Je te quitte
                            </button>
                        </div>
                    </div>
                `;
                
                // Ajouter l'event listener directement au bouton
                const breakupBtn = marriageCard.querySelector('.breakup-btn');
                breakupBtn.addEventListener('click', function(event) {
                    event.preventDefault();
                    const partnerName = this.getAttribute('data-partner-name');
                    const partnerCountry = this.getAttribute('data-partner-country');
                    const partnerGender = this.getAttribute('data-partner-gender');
                    const marriageIndex = parseInt(this.getAttribute('data-marriage-index'));
                    
                    console.log('🔥 Bouton rupture cliqué:', partnerName);
                    
                    // Appeler directement breakUp avec confirmation
                    confirmAndBreakUp(marriageIndex, partnerName, partnerCountry, partnerGender);
                });
                
                // Ajouter la carte à la liste
                marriageList.appendChild(marriageCard);
            });
        }

        // Fonction de confirmation et rupture
        function confirmAndBreakUp(marriageIndex, partnerName, partnerCountry, partnerGender) {
            const genderEmoji = partnerGender === 'male' ? '👨' : '👩';
            
            // Message de confirmation clair
            const confirmMessage = `💔 RUPTURE DÉFINITIVE 💔\n\nÊtes-vous vraiment sûr(e) de vouloir rompre avec :\n${genderEmoji} ${partnerName} de ${partnerCountry} ?\n\n⚠️ Cette action supprimera définitivement ce mariage !\n\n✅ Cliquez sur "OK" pour confirmer la rupture\n❌ Cliquez sur "Annuler" pour garder votre mariage`;
            
            if (confirm(confirmMessage)) {
                console.log('✅ Rupture confirmée par l\'utilisateur');
                // Appeler breakUp pour effectuer la rupture
                breakUp(marriageIndex, partnerName, partnerCountry, genderEmoji);
            } else {
                console.log('❌ Rupture annulée par l\'utilisateur');
                showMessage(`💕 Vous avez gardé votre mariage avec ${genderEmoji} ${partnerName} ! L'amour triomphe ! 💕`, 'success');
            }
        }

        function updateMissions(missionKey) {
            if (!missionKey || missions[missionKey].completed) return;
            
            let shouldComplete = false;
            
            switch (missionKey) {
                case 'first_marriage':
                    shouldComplete = marriageHistory.length >= 1;
                    break;
                case 'five_marriages':
                    shouldComplete = marriageHistory.length >= 5;
                    break;
                case 'ten_marriages':
                    shouldComplete = marriageHistory.length >= 10;
                    break;
                case 'continent_explorer':
                    const continents = new Set();
                    marriageHistory.forEach(marriage => {
                        const continent = getContinent(marriage.partnerCountry);
                        if (continent) continents.add(continent);
                    });
                    shouldComplete = continents.size >= 3;
                    break;
                case 'polyglot':
                    const languages = new Set();
                    marriageHistory.forEach(marriage => {
                        const language = getMainLanguage(marriage.partnerCountry);
                        if (language) languages.add(language);
                    });
                    shouldComplete = languages.size >= 5;
                    break;
                case 'diplomat':
                    // Compté dans handleJealousyReaction
                    break;
                case 'peace_maker':
                    // Compté dans attemptPeaceTreaty
                    break;
            }
            
            if (shouldComplete) {
                missions[missionKey].completed = true;
                gainXP(missions[missionKey].reward);
                showMessage(`🎯 Mission accomplie : ${missions[missionKey].title} ! +${missions[missionKey].reward} XP !`, 'success');
                markUnsavedChanges();
            }
        }

        function getContinent(country) {
            const continents = {
                'Europe': ['France', 'Germany', 'United Kingdom', 'Italy', 'Spain', 'Netherlands', 'Sweden', 'Norway', 'Denmark', 'Finland', 'Switzerland', 'Belgium', 'Austria', 'Portugal', 'Poland', 'Czech Republic', 'Greece', 'Turkey'],
                'Asia': ['Japan', 'China', 'India', 'South Korea', 'Russia', 'Thailand', 'Vietnam', 'Philippines', 'Indonesia', 'Malaysia', 'Singapore', 'Saudi Arabia', 'UAE', 'Iran', 'Iraq', 'Syria', 'Lebanon', 'Jordan'],
                'America': ['United States', 'Canada', 'Brazil', 'Mexico', 'Argentina', 'Chile', 'Peru', 'Colombia', 'Venezuela'],
                'Africa': ['Egypt', 'Morocco', 'Algeria', 'Kabylia', 'Tunisia', 'South Africa', 'Nigeria', 'Kenya', 'Libya', 'Sudan', 'Ethiopia', 'Ghana'],
                'Oceania': ['Australia', 'New Zealand']
            };
            
            for (const [continent, countries] of Object.entries(continents)) {
                if (countries.includes(country)) {
                    return continent;
                }
            }
            return null;
        }

        function getMainLanguage(country) {
            const languages = {
                'French': ['France', 'Belgium', 'Switzerland'],
                'German': ['Germany', 'Austria', 'Switzerland'],
                'English': ['United States', 'United Kingdom', 'Canada', 'Australia', 'New Zealand'],
                'Japanese': ['Japan'],
                'Italian': ['Italy'],
                'Spanish': ['Spain', 'Mexico', 'Argentina', 'Chile', 'Peru', 'Colombia', 'Venezuela'],
                'Portuguese': ['Brazil', 'Portugal'],
                'Chinese': ['China'],
                'Hindi': ['India'],
                'Korean': ['South Korea'],
                'Russian': ['Russia'],
                'Dutch': ['Netherlands'],
                'Swedish': ['Sweden'],
                'Norwegian': ['Norway'],
                'Danish': ['Denmark'],
                'Finnish': ['Finland'],
                'Arabic': ['Egypt', 'Morocco', 'Algeria', 'Tunisia', 'Saudi Arabia', 'UAE', 'Iraq', 'Syria', 'Lebanon', 'Jordan'],
                'Berber': ['Kabylia'],
                'Thai': ['Thailand'],
                'Vietnamese': ['Vietnam'],
                'Tagalog': ['Philippines'],
                'Indonesian': ['Indonesia'],
                'Malay': ['Malaysia', 'Singapore'],
                'Turkish': ['Turkey'],
                'Greek': ['Greece'],
                'Polish': ['Poland'],
                'Czech': ['Czech Republic']
            };
            
            for (const [language, countries] of Object.entries(languages)) {
                if (countries.includes(country)) {
                    return language;
                }
            }
            return null;
        }

        function updateMissionsList() {
            const missionsList = document.getElementById('missionsList');
            
            missionsList.innerHTML = Object.entries(missions).map(([key, mission]) => `
                <div class="country-card ${mission.completed ? 'opacity-75' : ''}">
                    <div class="flex items-center justify-between">
                        <div class="flex-1">
                            <h4 class="text-lg font-bold ${mission.completed ? 'text-green-600 dark:text-green-400' : ''}">${mission.title}</h4>
                            <p class="text-gray-600 dark:text-gray-300">${mission.description}</p>
                            <p class="text-sm text-purple-600 dark:text-purple-400">Récompense : ${mission.reward} XP</p>
                        </div>
                        <div class="text-3xl">
                            ${mission.completed ? '✅' : '⭐'}
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function showMessage(text, type = 'special') {
            const messageContainer = document.getElementById('messageContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            messageDiv.innerHTML = `
                <div class="flex justify-between items-center">
                    <span>${text}</span>
                    <button class="btn btn-secondary ml-4 py-1 px-3 text-sm" onclick="this.parentElement.parentElement.remove()">
                        ✖️
                    </button>
                </div>
            `;
            messageContainer.appendChild(messageDiv);
            
            // Auto-scroll vers le bas
            messageContainer.scrollTop = messageContainer.scrollHeight;
            markUnsavedChanges();
        }

        // Système de sauvegarde adapté (sans localStorage)
        let gameSaves = {}; // Sauvegardes en mémoire uniquement
        
        function markUnsavedChanges() {
            saveStatus.hasUnsavedChanges = true;
            saveStatus.currentState = 'has-changes';
        }

        function markSaveInProgress() {
            saveStatus.currentState = 'saving';
        }

        function markSaveSuccess() {
            saveStatus.hasUnsavedChanges = false;
            saveStatus.currentState = 'saved';
            saveStatus.lastSaveTime = Date.now();
        }

        function markSaveError() {
            saveStatus.currentState = 'error';
        }

        function showSaveMenu() {
            const saveLoadContent = document.getElementById('saveLoadContent');
            saveLoadContent.innerHTML = `
                <div class="space-y-4">
                    <div class="message error">
                        <strong>ℹ️ Note :</strong> Les sauvegardes en mémoire disparaîtront si vous rechargez la page. 
                        Utilisez l'export de fichier .json pour une sauvegarde permanente.
                    </div>
                    <div>
                        <label class="block text-lg font-semibold mb-2">💾 Nom de la sauvegarde :</label>
                        <input type="text" id="saveNameInput" placeholder="Ma partie..." 
                               class="w-full p-3 border-2 border-purple-300 rounded-lg text-base focus:border-purple-500 focus:outline-none transition-colors duration-300 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <button class="btn btn-success" onclick="saveGame()">
                            💾 Sauvegarder (Session)
                        </button>
                        <button class="btn btn-primary" onclick="downloadSaveFile()">
                            📁 Télécharger .json
                        </button>
                        <button class="btn btn-warning" onclick="exportSaveData()">
                            📤 Exporter Code
                        </button>
                        <button class="btn btn-secondary" onclick="document.getElementById('saveLoadContent').innerHTML = ''">
                            ❌ Annuler
                        </button>
                    </div>
                </div>
            `;
        }

        function saveGame() {
            const saveName = document.getElementById('saveNameInput').value.trim() || 'Sauvegarde';
            
            const saveData = {
                gameState: gameState,
                marriageHistory: marriageHistory,
                discoveredCouples: Array.from(discoveredCouples),
                missions: missions,
                relationshipStability: relationshipStability,
                jealousyEvents: jealousyEvents,
                saveTime: Date.now()
            };
            
            gameSaves[saveName] = saveData;
            
            showMessage(`💾 Partie sauvegardée : ${saveName} (session uniquement)`, 'success');
            document.getElementById('saveLoadContent').innerHTML = '';
            markSaveSuccess();
        }

        function exportSaveData() {
            const saveData = {
                gameState: gameState,
                marriageHistory: marriageHistory,
                discoveredCouples: Array.from(discoveredCouples),
                missions: missions,
                relationshipStability: relationshipStability,
                jealousyEvents: jealousyEvents,
                saveTime: Date.now()
            };
            
            // Encoder en base64 avec support Unicode
            const exportCode = btoa(unescape(encodeURIComponent(JSON.stringify(saveData))));
            
            const saveLoadContent = document.getElementById('saveLoadContent');
            saveLoadContent.innerHTML = `
                <div class="space-y-4">
                    <div class="message success">
                        <strong>📤 Code de sauvegarde généré !</strong><br>
                        Copiez ce code pour restaurer votre partie plus tard :
                    </div>
                    <div>
                        <textarea id="exportCodeArea" class="w-full p-3 border-2 border-green-300 rounded-lg text-sm h-32 font-mono resize-none dark:bg-gray-700 dark:border-gray-600 dark:text-white" readonly>${exportCode}</textarea>
                    </div>
                    <div class="flex gap-4">
                        <button class="btn btn-success flex-1" onclick="copyExportCode()">
                            📋 Copier le Code
                        </button>
                        <button class="btn btn-secondary" onclick="document.getElementById('saveLoadContent').innerHTML = ''">
                            ✖️ Fermer
                        </button>
                    </div>
                </div>
            `;
        }

        function copyExportCode() {
            const exportCodeArea = document.getElementById('exportCodeArea');
            exportCodeArea.select();
            exportCodeArea.setSelectionRange(0, 99999);
            
            try {
                navigator.clipboard.writeText(exportCodeArea.value);
                showMessage('📋 Code de sauvegarde copié dans le presse-papiers !', 'success');
            } catch (error) {
                showMessage('❌ Impossible de copier automatiquement. Veuillez copier manuellement.', 'error');
            }
        }

        function showLoadMenu() {
            let savesList = '';
            
            for (const [saveName, saveData] of Object.entries(gameSaves)) {
                const saveTime = new Date(saveData.saveTime).toLocaleString('fr-FR');
                savesList += `
                    <div class="country-card">
                        <div class="flex justify-between items-center">
                            <div>
                                <h4 class="font-bold">${saveName}</h4>
                                <p class="text-sm text-gray-600 dark:text-gray-400">${saveTime}</p>
                                <p class="text-sm text-gray-600 dark:text-gray-300">
                                    ${saveData.gameState.player.fullName} - Niveau ${saveData.gameState.player.level}
                                </p>
                            </div>
                            <div class="flex gap-2">
                                <button class="btn btn-success" onclick="loadSaveFromMemory('${saveName}')">
                                    📁 Charger
                                </button>
                                <button class="btn btn-warning" onclick="deleteSave('${saveName}')">
                                    🗑️
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            if (savesList === '') {
                savesList = '<p class="text-center text-gray-500 dark:text-gray-400">Aucune sauvegarde en mémoire.</p>';
            }
            
            document.getElementById('saveLoadContent').innerHTML = `
                <div class="space-y-4">
                    <div class="message error">
                        <strong>ℹ️ Sauvegardes de session :</strong> Ces sauvegardes disparaîtront si vous rechargez la page.
                    </div>
                    ${savesList}
                    <div class="space-y-4">
                        <div class="border-t pt-4">
                            <h4 class="font-bold mb-2">📥 Importer depuis un fichier .json :</h4>
                            <div class="space-y-2">
                                <input type="file" id="jsonFileInput" accept=".json" 
                                       class="w-full p-3 border-2 border-purple-300 rounded-lg text-base focus:border-purple-500 focus:outline-none transition-colors duration-300 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                                <button class="btn btn-primary w-full" onclick="loadJsonFile()">
                                    📁 Charger fichier .json
                                </button>
                            </div>
                        </div>
                        <div class="border-t pt-4">
                            <h4 class="font-bold mb-2">📥 Importer depuis un code :</h4>
                            <div class="space-y-2">
                                <textarea id="importCodeArea" placeholder="Collez votre code de sauvegarde ici..." 
                                          class="w-full p-3 border-2 border-purple-300 rounded-lg text-sm h-24 font-mono resize-none dark:bg-gray-700 dark:border-gray-600 dark:text-white"></textarea>
                                <button class="btn btn-success w-full" onclick="importSaveData()">
                                    📥 Importer Code de Sauvegarde
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="text-center">
                        <button class="btn btn-secondary" onclick="document.getElementById('saveLoadContent').innerHTML = ''">
                            ❌ Fermer
                        </button>
                    </div>
                </div>
            `;
        }

        function loadSaveFromMemory(saveName) {
            if (gameSaves[saveName]) {
                loadSaveData(gameSaves[saveName]);
            }
        }

        function importSaveData() {
            const importCodeArea = document.getElementById('importCodeArea');
            const importCode = importCodeArea.value.trim();
            
            if (!importCode) {
                showMessage('❌ Veuillez coller un code de sauvegarde !', 'error');
                return;
            }
            
            try {
                // Décoder base64 avec support Unicode
                const saveDataString = decodeURIComponent(escape(atob(importCode)));
                const saveData = JSON.parse(saveDataString);
                loadSaveData(saveData);
            } catch (error) {
                showMessage('❌ Code de sauvegarde invalide !', 'error');
            }
        }

        function loadSaveData(saveData) {
            try {
                gameState = saveData.gameState;
                marriageHistory = saveData.marriageHistory || [];
                discoveredCouples = new Set(saveData.discoveredCouples || []);
                
                if (saveData.missions) {
                    Object.assign(missions, saveData.missions);
                }
                
                relationshipStability = saveData.relationshipStability || 100;
                jealousyEvents = saveData.jealousyEvents || [];
                
                document.getElementById('characterCreation').classList.add('hidden');
                document.getElementById('gameMain').classList.remove('hidden');
                
                updatePlayerInfo();
                updateMarriageList();
                updateMissionsList();
                
                if (gameState.theme === 'dark') {
                    document.documentElement.classList.add('dark');
                } else {
                    document.documentElement.classList.remove('dark');
                }
                initTheme();
                
                showMessage('📁 Partie chargée avec succès !', 'success');
                document.getElementById('saveLoadContent').innerHTML = '';
                markSaveSuccess();
                
                // Ajouter le bouton de jalousie si il y a des mariages
                if (marriageHistory.length > 0) {
                    setTimeout(() => {
                        addManualJealousyButton();
                    }, 500);
                }
                
                return true;
            } catch (error) {
                showMessage('❌ Erreur lors du chargement de la sauvegarde !', 'error');
                markSaveError();
                return false;
            }
        }

        function deleteSave(saveName) {
            if (confirm(`Êtes-vous sûr de vouloir supprimer la sauvegarde "${saveName}" ?`)) {
                delete gameSaves[saveName];
                showMessage(`🗑️ Sauvegarde "${saveName}" supprimée`, 'success');
                showLoadMenu();
            }
        }

        // ============================================
        // SYSTÈME DE FICHIERS JSON
        // ============================================

        // Télécharger la sauvegarde au format .json
        function downloadSaveFile() {
            const saveName = document.getElementById('saveNameInput').value.trim() || 'Ma_partie';
            
            const saveData = {
                gameState: gameState,
                marriageHistory: marriageHistory,
                discoveredCouples: Array.from(discoveredCouples),
                missions: missions,
                relationshipStability: relationshipStability,
                jealousyEvents: jealousyEvents,
                saveTime: Date.now(),
                version: "1.0"
            };
            
            // Créer le fichier JSON
            const jsonString = JSON.stringify(saveData, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            // Créer un nom de fichier valide
            const filename = `${saveName.replace(/[^a-z0-9]/gi, '_')}_${new Date().toISOString().split('T')[0]}.json`;
            
            // Créer le lien de téléchargement
            const downloadLink = document.createElement('a');
            downloadLink.href = url;
            downloadLink.download = filename;
            downloadLink.style.display = 'none';
            
            // Déclencher le téléchargement
            document.body.appendChild(downloadLink);
            downloadLink.click();
            document.body.removeChild(downloadLink);
            
            // Nettoyer l'URL
            URL.revokeObjectURL(url);
            
            showMessage(`📁 Fichier ${filename} téléchargé avec succès !`, 'success');
            document.getElementById('saveLoadContent').innerHTML = '';
            markSaveSuccess();
        }

        // Charger un fichier .json
        function loadJsonFile() {
            const fileInput = document.getElementById('jsonFileInput');
            const file = fileInput.files[0];
            
            if (!file) {
                showMessage('❌ Veuillez sélectionner un fichier .json !', 'error');
                return;
            }
            
            if (!file.name.toLowerCase().endsWith('.json')) {
                showMessage('❌ Le fichier doit avoir l\'extension .json !', 'error');
                return;
            }
            
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const saveData = JSON.parse(e.target.result);
                    
                    // Vérifier la structure de base du fichier
                    if (!saveData.gameState || !saveData.gameState.player) {
                        throw new Error('Fichier de sauvegarde invalide');
                    }
                    
                    // Charger les données
                    if (loadSaveData(saveData)) {
                        showMessage(`📁 Fichier ${file.name} chargé avec succès !`, 'success');
                        
                        // Réinitialiser l'input file
                        fileInput.value = '';
                    }
                } catch (error) {
                    console.error('Erreur lors du chargement du fichier JSON:', error);
                    showMessage('❌ Fichier JSON invalide ou corrompu !', 'error');
                }
            };
            
            reader.onerror = function() {
                showMessage('❌ Erreur lors de la lecture du fichier !', 'error');
            };
            
            reader.readAsText(file);
        }

        // ============================================
        // SYSTÈME AUDIO ET PARTAGE
        // ============================================

        // Son de victoire pour mariage réussi
        function playVictorySound() {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                
                // Mélodie joyeuse à 3 notes
                const notes = [
                    { frequency: 523.25, time: 0 },     // Do
                    { frequency: 659.25, time: 0.15 },  // Mi
                    { frequency: 783.99, time: 0.3 },   // Sol
                    { frequency: 1046.5, time: 0.45 }   // Do aigu
                ];
                
                notes.forEach(note => {
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    
                    oscillator.type = 'sine';
                    oscillator.frequency.setValueAtTime(note.frequency, audioContext.currentTime + note.time);
                    
                    gainNode.gain.setValueAtTime(0, audioContext.currentTime + note.time);
                    gainNode.gain.linearRampToValueAtTime(0.3, audioContext.currentTime + note.time + 0.05);
                    gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + note.time + 0.4);
                    
                    oscillator.start(audioContext.currentTime + note.time);
                    oscillator.stop(audioContext.currentTime + note.time + 0.4);
                });
                
            } catch (error) {
                console.log('Audio de victoire non supporté:', error);
            }
        }

        // Message de mariage réussi avec bouton de partage
        function showMarriageSuccessMessage(firstName, lastName, country, gender, genderEmoji) {
            const messageContainer = document.getElementById('messageContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message success marriage-success';
            messageDiv.style.background = 'linear-gradient(45deg, #d4edda, #c3e6cb)';
            messageDiv.style.border = '2px solid #28a745';
            messageDiv.style.boxShadow = '0 8px 25px rgba(40, 167, 69, 0.3)';
            
            const shareText = `💕 Mariage réussi ! Je me suis marié(e) avec ${genderEmoji} ${firstName} ${lastName} de ${country} dans Country Balls: Mariage ! 🌍💍`;
            
            messageDiv.innerHTML = `
                <div class="flex flex-col gap-3">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <div class="text-lg font-bold mb-2">🎉 FÉLICITATIONS ! 🎉</div>
                            <div class="text-base">
                                💕 ${genderEmoji} ${firstName} ${lastName} a accepté votre demande ! Vous voilà mariés ! 💕
                            </div>
                            <div class="text-sm text-green-700 dark:text-green-300 mt-2">
                                🌍 ${country} • ${new Date().toLocaleDateString('fr-FR')} • +50 XP
                            </div>
                        </div>
                        <button class="btn btn-secondary ml-4 py-1 px-3 text-sm" onclick="this.closest('.marriage-success').remove()">
                            ✖️
                        </button>
                    </div>
                    
                    <div class="flex flex-wrap gap-2 pt-3 border-t border-green-300">
                        <button class="btn btn-success" onclick="shareMarriage('${shareText.replace(/'/g, "\\'")}', '${firstName}', '${lastName}', '${country}', '${gender}')">
                            📤 Partager ce mariage
                        </button>
                        <button class="btn btn-primary" onclick="showSection('marriage')">
                            💒 Voir tous mes mariages
                        </button>
                    </div>
                </div>
            `;
            
            messageContainer.appendChild(messageDiv);
            messageContainer.scrollTop = messageContainer.scrollHeight;
        }

        // Système de partage
        function shareMarriage(shareText, firstName, lastName, country, gender) {
            const flag = countries[country] || '🏳️';
            const genderEmoji = gender === 'male' ? '👨' : '👩';
            const fullShareText = `${shareText}\n\n🎮 Jouez aussi : Country Balls Mariage !`;
            
            // Essayer d'abord le partage natif
            if (navigator.share) {
                navigator.share({
                    title: 'Country Balls: Mariage 💕',
                    text: fullShareText,
                    url: window.location.href
                }).then(() => {
                    showMessage('📤 Mariage partagé avec succès !', 'success');
                }).catch((error) => {
                    console.log('Partage natif annulé:', error);
                    showCustomShareDialog(shareText, firstName, lastName, country, gender, flag, genderEmoji);
                });
            } else {
                // Fallback : dialogue de partage personnalisé
                showCustomShareDialog(shareText, firstName, lastName, country, gender, flag, genderEmoji);
            }
        }

        // Dialogue de partage personnalisé
        function showCustomShareDialog(shareText, firstName, lastName, country, gender, flag, genderEmoji) {
            const messageContainer = document.getElementById('messageContainer');
            const shareDialog = document.createElement('div');
            shareDialog.className = 'message special share-dialog';
            shareDialog.style.background = 'linear-gradient(45deg, #667eea, #764ba2)';
            shareDialog.style.color = 'white';
            shareDialog.style.border = '2px solid #5D5CDE';
            shareDialog.style.maxWidth = '500px';
            shareDialog.style.margin = '0 auto';
            
            const encodedText = encodeURIComponent(shareText);
            const encodedUrl = encodeURIComponent(window.location.href);
            
            shareDialog.innerHTML = `
                <div class="text-center">
                    <div class="text-xl font-bold mb-4">📤 Partager votre mariage</div>
                    <div class="text-lg mb-4">${flag} ${genderEmoji} ${firstName} ${lastName}</div>
                    
                    <div class="bg-white bg-opacity-20 p-3 rounded-lg mb-4 text-sm">
                        <div class="font-semibold mb-2">📝 Message à partager :</div>
                        <div class="text-left italic">"${shareText}"</div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-2 mb-4">
                        <button class="btn btn-success" onclick="copyToClipboard('${shareText.replace(/'/g, "\\'")}')">
                            📋 Copier le texte
                        </button>
                        <button class="btn btn-warning" onclick="openWhatsAppShare('${encodedText}')">
                            💬 WhatsApp
                        </button>
                        <button class="btn btn-primary" onclick="openFacebookShare('${encodedText}', '${encodedUrl}')">
                            📘 Facebook
                        </button>
                        <button class="btn" style="background: linear-gradient(45deg, #E4405F, #FF6B6B); color: white;" onclick="openInstagramStory()">
                            📷 Instagram Story
                        </button>
                        <button class="btn" style="background: linear-gradient(45deg, #1DA1F2, #55ACEE); color: white;" onclick="openTwitterShare('${encodedText}', '${encodedUrl}')">
                            🐦 Twitter
                        </button>
                        <button class="btn" style="background: linear-gradient(45deg, #0077B5, #00A0DC); color: white;" onclick="openLinkedInShare('${encodedText}', '${encodedUrl}')">
                            💼 LinkedIn
                        </button>
                    </div>
                    
                    <button class="btn btn-secondary" onclick="this.closest('.share-dialog').remove()">
                        ✖️ Fermer
                    </button>
                </div>
            `;
            
            messageContainer.appendChild(shareDialog);
            messageContainer.scrollTop = messageContainer.scrollHeight;
        }

        // Fonctions de partage spécifiques
        function copyToClipboard(text) {
            try {
                navigator.clipboard.writeText(text).then(() => {
                    showMessage('📋 Texte copié dans le presse-papiers !', 'success');
                    document.querySelector('.share-dialog')?.remove();
                });
            } catch (error) {
                // Fallback pour navigateurs non compatibles
                const textArea = document.createElement('textarea');
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                showMessage('📋 Texte copié !', 'success');
                document.querySelector('.share-dialog')?.remove();
            }
        }

        function openWhatsAppShare(text) {
            window.open(`https://wa.me/?text=${text}`, '_blank');
            document.querySelector('.share-dialog')?.remove();
        }

        function openFacebookShare(text, url) {
            window.open(`https://www.facebook.com/sharer/sharer.php?u=${url}&quote=${text}`, '_blank');
            document.querySelector('.share-dialog')?.remove();
        }

        function openTwitterShare(text, url) {
            window.open(`https://twitter.com/intent/tweet?text=${text}&url=${url}`, '_blank');
            document.querySelector('.share-dialog')?.remove();
        }

        function openLinkedInShare(text, url) {
            window.open(`https://www.linkedin.com/sharing/share-offsite/?url=${url}&summary=${text}`, '_blank');
            document.querySelector('.share-dialog')?.remove();
        }

        function openInstagramStory() {
            showMessage('📷 Instagram Story : Prenez une capture d\'écran et partagez-la dans votre story Instagram !', 'special');
            document.querySelector('.share-dialog')?.remove();
        }

        // ============================================
        // SYSTÈME DE TCHAT INTERACTIF
        // ============================================

        // État du tchat
        let chatState = {
            isOpen: false,
            isMinimized: false,
            currentPartner: null,
            unreadMessages: 0,
            typingTimeout: null,
            chatHistory: []
        };

        // Messages automatiques du partenaire virtuel
        const partnerResponses = [
            "C'est incroyable ! 😍",
            "Tu me fais rêver... 💕",
            "J'aimerais tellement te rencontrer ! 🌹",
            "Parle-moi de ton pays ! 🌍",
            "Tu es si romantique 💖",
            "Cette aventure est magique ✨",
            "Je pense à toi... 😘",
            "Raconte-moi tes rêves 🌙",
            "Tu illumines ma journée ☀️",
            "Quel est ton endroit préféré ? 🏞️",
            "J'adore discuter avec toi ! 😊",
            "Tu me rends si heureux/heureuse 💝",
            "Quelle belle histoire d'amour ! 📖",
            "Je t'envoie tout mon amour 💞",
            "Tu es vraiment spécial(e) 👑"
        ];

        // Initialiser le tchat lors d'un mariage réussi
        function initializeChatWithPartner(firstName, lastName, country, gender) {
            const partner = {
                name: `${firstName} ${lastName}`,
                country: country,
                gender: gender,
                flag: countries[country] || '🏳️',
                avatar: gender === 'male' ? '👨' : '👩'
            };
            
            chatState.currentPartner = partner;
            updateChatHeader(partner);
            
            // Afficher le tchat automatiquement
            setTimeout(() => {
                showChat();
                // Message de bienvenue du partenaire
                setTimeout(() => {
                    addPartnerMessage(`Salut ${gameState.player.firstName} ! 💕 Je suis si heureux/heureuse d'être marié(e) avec toi ! 🎉`);
                }, 1000);
            }, 2000);
        }

        // Mettre à jour l'en-tête du tchat
        function updateChatHeader(partner) {
            document.getElementById('chatAvatar').textContent = partner.flag;
            document.getElementById('chatPartnerName').textContent = `${partner.avatar} ${partner.name}`;
            document.getElementById('chatPartnerStatus').innerHTML = `
                <span class="online-indicator" style="width: 8px; height: 8px; background: #28a745; border-radius: 50%; display: inline-block; margin-right: 5px;"></span>
                ${partner.country}
            `;
            
            // Initialiser l'heure de bienvenue
            document.getElementById('welcomeTime').textContent = new Date().toLocaleTimeString('fr-FR', {
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // Afficher le tchat
        function showChat() {
            const chatContainer = document.getElementById('chatContainer');
            chatContainer.classList.remove('hidden');
            chatState.isOpen = true;
            chatState.isMinimized = false;
            clearNotifications();
        }

        // Masquer/Afficher le tchat
        function toggleChat() {
            const chatContainer = document.getElementById('chatContainer');
            
            if (chatState.isMinimized) {
                // Restaurer
                chatContainer.classList.remove('minimized');
                chatState.isMinimized = false;
            } else {
                // Minimiser
                chatContainer.classList.add('minimized');
                chatState.isMinimized = true;
            }
        }

        // Fermer le tchat
        function closeChat() {
            const chatContainer = document.getElementById('chatContainer');
            chatContainer.classList.add('hidden');
            chatState.isOpen = false;
            chatState.isMinimized = false;
            clearNotifications();
        }

        // Envoyer un message rapide
        function sendQuickMessage(message) {
            sendMessage(message);
        }

        // Envoyer un message du tchat
        function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (message) {
                sendMessage(message);
                input.value = '';
                adjustTextareaHeight(input);
                updateSendButton();
            }
        }

        // Envoyer un message (fonction principale)
        function sendMessage(message) {
            // Ajouter le message du joueur
            addPlayerMessage(message);
            
            // Simulation de frappe du partenaire
            showTypingIndicator();
            
            // Réponse automatique du partenaire (simulé)
            setTimeout(() => {
                hideTypingIndicator();
                const response = generatePartnerResponse(message);
                addPartnerMessage(response);
            }, Math.random() * 3000 + 1000); // 1-4 secondes
        }

        // Ajouter un message du joueur
        function addPlayerMessage(message) {
            const messagesContainer = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message-bubble sent';
            
            const currentTime = new Date().toLocaleTimeString('fr-FR', {
                hour: '2-digit',
                minute: '2-digit'
            });
            
            messageDiv.innerHTML = `
                <div>${message}</div>
                <div class="message-time">${currentTime}</div>
            `;
            
            messagesContainer.appendChild(messageDiv);
            scrollToBottom();
            
            // Sauvegarder dans l'historique
            chatState.chatHistory.push({
                type: 'sent',
                message: message,
                time: currentTime
            });
        }

        // Ajouter un message du partenaire
        function addPartnerMessage(message) {
            const messagesContainer = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message-bubble received';
            
            const currentTime = new Date().toLocaleTimeString('fr-FR', {
                hour: '2-digit',
                minute: '2-digit'
            });
            
            messageDiv.innerHTML = `
                <div>${message}</div>
                <div class="message-time">${currentTime}</div>
            `;
            
            messagesContainer.appendChild(messageDiv);
            scrollToBottom();
            
            // Notification si le tchat est fermé ou minimisé
            if (!chatState.isOpen || chatState.isMinimized) {
                showNotification();
            }
            
            // Sauvegarder dans l'historique
            chatState.chatHistory.push({
                type: 'received',
                message: message,
                time: currentTime
            });
        }

        // Générer une réponse du partenaire basée sur le message
        function generatePartnerResponse(playerMessage) {
            const lowerMessage = playerMessage.toLowerCase();
            
            // Réponses contextuelles
            if (lowerMessage.includes('amour') || lowerMessage.includes('aime')) {
                return `Moi aussi je t'aime ! 💕 Tu es tout pour moi !`;
            }
            if (lowerMessage.includes('mariage') || lowerMessage.includes('marié')) {
                return `Notre mariage est le plus beau jour de ma vie ! 💒✨`;
            }
            if (lowerMessage.includes('pays') || lowerMessage.includes('voyage')) {
                return `J'aimerais explorer le monde avec toi ! 🌍 ${countries[gameState.player.country]} et ${chatState.currentPartner.flag} ensemble !`;
            }
            if (lowerMessage.includes('rêve') || lowerMessage.includes('futur')) {
                return `Mes rêves se réalisent avec toi ! 🌟 Construisons notre avenir ensemble !`;
            }
            if (lowerMessage.includes('belle') || lowerMessage.includes('beau')) {
                return `Tu es encore plus beau/belle ! 😍 Mon cœur bat la chamade !`;
            }
            if (lowerMessage.includes('merci') || lowerMessage.includes('remercie')) {
                return `C'est moi qui te remercie ! 🙏 Tu es un cadeau du ciel !`;
            }
            if (lowerMessage.includes('triste') || lowerMessage.includes('mal')) {
                return `Ne sois pas triste... 🤗 Je suis là pour toi, toujours ! 💝`;
            }
            if (lowerMessage.includes('heureux') || lowerMessage.includes('heureuse') || lowerMessage.includes('joie')) {
                return `Ta joie illumine mon monde ! ☀️ Restons heureux ensemble ! 🎉`;
            }
            
            // Réponse aléatoire par défaut
            return partnerResponses[Math.floor(Math.random() * partnerResponses.length)];
        }

        // Afficher l'indicateur de frappe
        function showTypingIndicator() {
            const messagesContainer = document.getElementById('chatMessages');
            const typingDiv = document.createElement('div');
            typingDiv.className = 'typing-indicator';
            typingDiv.id = 'typingIndicator';
            
            typingDiv.innerHTML = `
                <span style="font-size: 12px; color: #666;">En train d'écrire...</span>
                <div class="typing-dots">
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                </div>
            `;
            
            messagesContainer.appendChild(typingDiv);
            scrollToBottom();
        }

        // Masquer l'indicateur de frappe
        function hideTypingIndicator() {
            const typingIndicator = document.getElementById('typingIndicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }

        // Faire défiler vers le bas
        function scrollToBottom() {
            const messagesContainer = document.getElementById('chatMessages');
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // Gestion des touches du clavier
        function handleChatKeydown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendChatMessage();
            }
            updateSendButton();
        }

        // Ajuster la hauteur du textarea
        function adjustTextareaHeight(textarea) {
            textarea.style.height = 'auto';
            const newHeight = Math.min(textarea.scrollHeight, 80);
            textarea.style.height = newHeight + 'px';
            updateSendButton();
        }

        // Mettre à jour le bouton d'envoi
        function updateSendButton() {
            const input = document.getElementById('chatInput');
            const sendBtn = document.getElementById('chatSendBtn');
            
            if (input.value.trim()) {
                sendBtn.disabled = false;
                sendBtn.style.opacity = '1';
            } else {
                sendBtn.disabled = true;
                sendBtn.style.opacity = '0.5';
            }
        }

        // Toggle du sélecteur d'émojis
        function toggleEmojiPicker() {
            const emojiPicker = document.getElementById('emojiPicker');
            emojiPicker.classList.toggle('show');
        }

        // Ajouter un émoji
        function addEmoji(emoji) {
            const input = document.getElementById('chatInput');
            const cursorPos = input.selectionStart;
            const textBefore = input.value.substring(0, cursorPos);
            const textAfter = input.value.substring(cursorPos);
            
            input.value = textBefore + emoji + textAfter;
            input.selectionStart = input.selectionEnd = cursorPos + emoji.length;
            
            adjustTextareaHeight(input);
            updateSendButton();
            input.focus();
            
            // Fermer le sélecteur d'émojis
            document.getElementById('emojiPicker').classList.remove('show');
        }

        // Afficher notification de nouveau message
        function showNotification() {
            chatState.unreadMessages++;
            const notification = document.getElementById('chatNotification');
            notification.textContent = chatState.unreadMessages;
            notification.classList.remove('hidden');
        }

        // Effacer les notifications
        function clearNotifications() {
            chatState.unreadMessages = 0;
            document.getElementById('chatNotification').classList.add('hidden');
        }

        // Fermer le sélecteur d'émojis en cliquant ailleurs
        document.addEventListener('click', function(event) {
            const emojiPicker = document.getElementById('emojiPicker');
            const emojiBtn = document.querySelector('.emoji-btn');
            const giftPicker = document.getElementById('giftPicker');
            
            if (emojiPicker && !emojiPicker.contains(event.target) && !emojiBtn.contains(event.target)) {
                emojiPicker.classList.remove('show');
            }
            
            if (giftPicker && !giftPicker.contains(event.target)) {
                giftPicker.classList.remove('show');
            }
        });

        // ============================================
        // NOUVELLES FONCTIONNALITÉS CHAT AVANCÉES
        // ============================================

        // Variables pour les nouvelles fonctionnalités
        let messageReactions = {};
        let activePoll = null;
        let activeMission = null;
        let dramHistory = [];
        let currentActiveTab = 'messages';

        // 1. RÉACTIONS EMOJI DIRECTES
        function showReactionPicker(button) {
            // Supprimer les autres pickers ouverts
            document.querySelectorAll('.reaction-picker').forEach(picker => picker.remove());
            
            const reactionPicker = document.createElement('div');
            reactionPicker.className = 'reaction-picker';
            reactionPicker.style.position = 'absolute';
            reactionPicker.style.top = '-50px';
            reactionPicker.style.left = '0';
            reactionPicker.style.background = 'rgba(255, 255, 255, 0.95)';
            reactionPicker.style.padding = '10px';
            reactionPicker.style.borderRadius = '15px';
            reactionPicker.style.boxShadow = '0 8px 25px rgba(0,0,0,0.2)';
            reactionPicker.style.display = 'flex';
            reactionPicker.style.gap = '8px';
            reactionPicker.style.zIndex = '999';
            reactionPicker.style.border = '1px solid rgba(0,0,0,0.1)';
            
            const reactions = ['😍', '😂', '😱', '👏', '💕', '🔥', '😢', '😮'];
            
            reactions.forEach(emoji => {
                const reactionBtn = document.createElement('button');
                reactionBtn.textContent = emoji;
                reactionBtn.style.fontSize = '20px';
                reactionBtn.style.padding = '8px';
                reactionBtn.style.border = 'none';
                reactionBtn.style.background = 'transparent';
                reactionBtn.style.borderRadius = '8px';
                reactionBtn.style.cursor = 'pointer';
                reactionBtn.style.transition = 'all 0.2s ease';
                
                reactionBtn.onmouseover = () => {
                    reactionBtn.style.background = 'rgba(93, 92, 222, 0.2)';
                    reactionBtn.style.transform = 'scale(1.2)';
                };
                reactionBtn.onmouseout = () => {
                    reactionBtn.style.background = 'transparent';
                    reactionBtn.style.transform = 'scale(1)';
                };
                
                reactionBtn.onclick = () => {
                    addReactionToMessage(button, emoji);
                    reactionPicker.remove();
                };
                
                reactionPicker.appendChild(reactionBtn);
            });
            
            button.parentElement.style.position = 'relative';
            button.parentElement.appendChild(reactionPicker);
            
            // Fermer après 5 secondes
            setTimeout(() => {
                if (reactionPicker.parentElement) {
                    reactionPicker.remove();
                }
            }, 5000);
        }

        function addReactionToMessage(button, emoji) {
            const messageBubble = button.closest('.message-bubble');
            const reactionsContainer = messageBubble.querySelector('.message-reactions');
            const messageId = messageBubble.getAttribute('data-message-id') || `msg-${Date.now()}`;
            
            messageBubble.setAttribute('data-message-id', messageId);
            
            if (!messageReactions[messageId]) {
                messageReactions[messageId] = {};
            }
            
            if (!messageReactions[messageId][emoji]) {
                messageReactions[messageId][emoji] = {
                    count: 0,
                    users: []
                };
            }
            
            const currentUser = gameState.player.firstName || 'Moi';
            
            // Toggle réaction
            if (messageReactions[messageId][emoji].users.includes(currentUser)) {
                // Retirer réaction
                messageReactions[messageId][emoji].count--;
                messageReactions[messageId][emoji].users = messageReactions[messageId][emoji].users.filter(u => u !== currentUser);
                
                if (messageReactions[messageId][emoji].count === 0) {
                    delete messageReactions[messageId][emoji];
                }
            } else {
                // Ajouter réaction
                messageReactions[messageId][emoji].count++;
                messageReactions[messageId][emoji].users.push(currentUser);
            }
            
            updateReactionsDisplay(reactionsContainer, messageId);
        }

        function updateReactionsDisplay(container, messageId) {
            if (!messageReactions[messageId]) {
                container.innerHTML = '';
                return;
            }
            
            container.innerHTML = '';
            
            Object.entries(messageReactions[messageId]).forEach(([emoji, data]) => {
                if (data.count > 0) {
                    const reactionItem = document.createElement('div');
                    reactionItem.className = 'reaction-item';
                    
                    const currentUser = gameState.player.firstName || 'Moi';
                    if (data.users.includes(currentUser)) {
                        reactionItem.classList.add('selected');
                    }
                    
                    reactionItem.innerHTML = `
                        <span>${emoji}</span>
                        <span>${data.count}</span>
                    `;
                    
                    reactionItem.onclick = () => {
                        const button = container.closest('.message-bubble').querySelector('.reaction-add-btn');
                        addReactionToMessage(button, emoji);
                    };
                    
                    container.appendChild(reactionItem);
                }
            });
        }

        // 2. SONDAGES EXPRESS
        function createPoll() {
            if (activePoll) {
                showMessage('⚠️ Un sondage est déjà en cours !', 'error');
                return;
            }
            
            const question = prompt('❓ Quelle est votre question pour le sondage ?');
            if (!question) return;
            
            const option1 = prompt('📝 Option 1 :');
            if (!option1) return;
            
            const option2 = prompt('📝 Option 2 :');
            if (!option2) return;
            
            activePoll = {
                question: question,
                options: [
                    { text: option1, votes: 0, voters: [] },
                    { text: option2, votes: 0, voters: [] }
                ],
                totalVotes: 0
            };
            
            addPollToChat(activePoll);
        }

        function addPollToChat(poll) {
            const messagesContainer = document.getElementById('chatMessages');
            const pollDiv = document.createElement('div');
            pollDiv.className = 'poll-container';
            pollDiv.id = 'activePoll';
            
            pollDiv.innerHTML = `
                <div class="poll-question">📊 ${poll.question}</div>
                <div class="poll-options" id="pollOptions">
                    ${poll.options.map((option, index) => `
                        <div class="poll-option" onclick="voteInPoll(${index})" data-option="${index}">
                            <div class="poll-progress" style="width: 0%"></div>
                            <div class="poll-option-content">
                                <span>${option.text}</span>
                                <span class="poll-percentage">0%</span>
                            </div>
                        </div>
                    `).join('')}
                </div>
                <div style="margin-top: 10px; font-size: 12px; opacity: 0.8; text-align: center;">
                    Votes total : <span id="pollTotalVotes">0</span>
                </div>
            `;
            
            messagesContainer.appendChild(pollDiv);
            scrollToBottom();
            
            // Simulation du vote du partenaire après 3-5 secondes
            setTimeout(() => {
                if (activePoll) {
                    const partnerChoice = Math.floor(Math.random() * poll.options.length);
                    voteInPoll(partnerChoice, 'partner');
                }
            }, Math.random() * 2000 + 3000);
        }

        function voteInPoll(optionIndex, voter = 'player') {
            if (!activePoll) return;
            
            const voterId = voter === 'partner' ? (chatState.currentPartner?.name || 'Partenaire') : (gameState.player.firstName || 'Moi');
            
            // Vérifier si l'utilisateur a déjà voté
            let hasVoted = false;
            activePoll.options.forEach(option => {
                if (option.voters.includes(voterId)) {
                    hasVoted = true;
                }
            });
            
            if (hasVoted && voter === 'player') {
                showMessage('⚠️ Vous avez déjà voté !', 'error');
                return;
            }
            
            // Ajouter le vote
            activePoll.options[optionIndex].votes++;
            activePoll.options[optionIndex].voters.push(voterId);
            activePoll.totalVotes++;
            
            updatePollDisplay();
            
            if (voter === 'partner') {
                addPartnerMessage(`J'ai voté pour "${activePoll.options[optionIndex].text}" ! 🗳️`);
            }
        }

        function updatePollDisplay() {
            const pollOptions = document.getElementById('pollOptions');
            const totalVotesSpan = document.getElementById('pollTotalVotes');
            
            if (!pollOptions || !activePoll) return;
            
            pollOptions.innerHTML = activePoll.options.map((option, index) => {
                const percentage = activePoll.totalVotes > 0 ? Math.round((option.votes / activePoll.totalVotes) * 100) : 0;
                
                return `
                    <div class="poll-option voted" data-option="${index}">
                        <div class="poll-progress" style="width: ${percentage}%"></div>
                        <div class="poll-option-content">
                            <span>${option.text}</span>
                            <span class="poll-percentage">${percentage}% (${option.votes})</span>
                        </div>
                    </div>
                `;
            }).join('');
            
            totalVotesSpan.textContent = activePoll.totalVotes;
            
            // Clôturer le sondage après 2 votes ou 30 secondes
            if (activePoll.totalVotes >= 2) {
                setTimeout(() => {
                    closePoll();
                }, 5000);
            }
        }

        function closePoll() {
            if (!activePoll) return;
            
            const winner = activePoll.options.reduce((prev, current) => 
                (prev.votes > current.votes) ? prev : current
            );
            
            addPartnerMessage(`📊 Résultats du sondage : "${winner.text}" l'emporte avec ${winner.votes} votes ! 🎉`);
            activePoll = null;
        }

        // 3. DRAMA CARDS
        const dramaCards = [
            {
                type: 'rupture',
                emoji: '💔',
                title: 'Rupture Dramatique !',
                description: 'Des rumeurs de rupture circulent... Est-ce vrai ?',
                impact: -15,
                color: '#FF6B6B'
            },
            {
                type: 'surprise',
                emoji: '🎉',
                title: 'Surprise Romantique !',
                description: 'Une surprise incroyable vous attend !',
                impact: 20,
                color: '#4ECDC4'
            },
            {
                type: 'invitation',
                emoji: '💒',
                title: 'Invitation Mariage !',
                description: 'Vous êtes invités à un mariage royal !',
                impact: 15,
                color: '#FFD93D'
            },
            {
                type: 'scandal',
                emoji: '📰',
                title: 'Scandale Médiatique !',
                description: 'Les médias parlent de votre relation !',
                impact: -10,
                color: '#FF8E53'
            },
            {
                type: 'voyage',
                emoji: '✈️',
                title: 'Voyage de Rêve !',
                description: 'Opportunity de voyage romantique à saisir !',
                impact: 25,
                color: '#667eea'
            }
        ];

        function triggerDramaCard() {
            const randomCard = dramaCards[Math.floor(Math.random() * dramaCards.length)];
            addDramaCard(randomCard);
        }

        function addDramaCard(card) {
            const messagesContainer = document.getElementById('chatMessages');
            const cardDiv = document.createElement('div');
            cardDiv.className = 'drama-card';
            cardDiv.style.background = `linear-gradient(135deg, ${card.color}, ${card.color}dd)`;
            
            cardDiv.innerHTML = `
                <div class="drama-card-header">${card.emoji}</div>
                <div class="drama-card-title">${card.title}</div>
                <div class="drama-card-description">${card.description}</div>
                <div class="drama-card-actions">
                    <button class="btn btn-success" onclick="handleDramaAction('accept', '${card.type}', ${card.impact})">
                        ✅ Accepter
                    </button>
                    <button class="btn btn-warning" onclick="handleDramaAction('ignore', '${card.type}', ${card.impact})">
                        🤷 Ignorer
                    </button>
                    <button class="btn btn-secondary" onclick="handleDramaAction('reject', '${card.type}', ${card.impact})">
                        ❌ Rejeter
                    </button>
                </div>
            `;
            
            messagesContainer.appendChild(cardDiv);
            scrollToBottom();
            
            // Ajouter à l'historique
            dramHistory.push({
                type: card.type,
                title: card.title,
                date: new Date().toLocaleDateString('fr-FR'),
                impact: card.impact,
                action: null
            });
            
            updateDramaHistory();
        }

        function handleDramaAction(action, cardType, impact) {
            // Supprimer la carte drama
            document.querySelectorAll('.drama-card').forEach(card => card.remove());
            
            let message = '';
            let actualImpact = impact;
            
            switch (action) {
                case 'accept':
                    message = `✅ Vous avez accepté ! Stabilité : ${impact > 0 ? '+' : ''}${impact}`;
                    break;
                case 'ignore':
                    actualImpact = Math.floor(impact * 0.5);
                    message = `🤷 Vous avez ignoré. Impact réduit : ${actualImpact > 0 ? '+' : ''}${actualImpact}`;
                    break;
                case 'reject':
                    actualImpact = impact > 0 ? -Math.abs(impact) : Math.abs(impact);
                    message = `❌ Vous avez rejeté. Impact inversé : ${actualImpact > 0 ? '+' : ''}${actualImpact}`;
                    break;
            }
            
            relationshipStability = Math.max(0, Math.min(100, relationshipStability + actualImpact));
            showMessage(message, actualImpact > 0 ? 'success' : 'error');
            
            // Mettre à jour l'historique avec l'action
            if (dramHistory.length > 0) {
                dramHistory[dramHistory.length - 1].action = action;
                dramHistory[dramHistory.length - 1].actualImpact = actualImpact;
            }
            
            updateDramaHistory();
        }

        // 4. MESSAGES SPÉCIAUX PENDANT GUERRE
        function enableWarChatMode() {
            const chatContainer = document.getElementById('chatContainer');
            chatContainer.classList.add('war-chat-mode');
            
            addWarMessage('💣 La situation est critique, restons soudés !');
            
            setTimeout(() => {
                addWarMessage('⚡ Tensions maximales ! Que faire ?', true);
            }, 3000);
        }

        function addWarMessage(message, withPeaceButton = false) {
            const messagesContainer = document.getElementById('chatMessages');
            const warDiv = document.createElement('div');
            warDiv.className = 'war-message';
            
            let content = `<div>${message}</div>`;
            
            if (withPeaceButton) {
                content += `
                    <div style="margin-top: 15px;">
                        <button class="btn btn-success" onclick="attemptPeaceFromChat()">
                            🤝 Tenter une réconciliation
                        </button>
                    </div>
                `;
            }
            
            warDiv.innerHTML = content;
            messagesContainer.appendChild(warDiv);
            scrollToBottom();
        }

        function attemptPeaceFromChat() {
            document.querySelectorAll('.war-message').forEach(msg => msg.remove());
            const chatContainer = document.getElementById('chatContainer');
            chatContainer.classList.remove('war-chat-mode');
            
            if (Math.random() > 0.3) {
                addPartnerMessage('🕊️ Tu as raison... Faisons la paix. Notre amour est plus fort ! 💕');
                relationshipStability = Math.min(100, relationshipStability + 30);
                showMessage('🕊️ Réconciliation réussie ! +30 stabilité !', 'success');
            } else {
                addPartnerMessage('😤 Non ! Il faut du temps pour guérir ces blessures...');
                showMessage('💔 Réconciliation échouée... Patience requise.', 'error');
            }
        }

        // 5. SYSTÈME DE CADEAUX VIRTUELS
        function toggleGiftPicker() {
            const giftPicker = document.getElementById('giftPicker');
            giftPicker.classList.toggle('show');
        }

        function sendGift(emoji, description) {
            const giftPicker = document.getElementById('giftPicker');
            giftPicker.classList.remove('show');
            
            addGiftToChat(emoji, description);
            
            // Réaction du partenaire
            setTimeout(() => {
                const reactions = [
                    'Oh ! Quel magnifique cadeau ! 😍',
                    'Tu me gâtes trop ! 🥰',
                    'C\'est exactement ce dont j\'avais besoin ! 💕',
                    'Tu es si attentionné(e) ! 🌟',
                    'Je vais le chérir pour toujours ! 💝'
                ];
                const reaction = reactions[Math.floor(Math.random() * reactions.length)];
                addPartnerMessage(reaction);
            }, 2000);
        }

        function addGiftToChat(emoji, description) {
            const messagesContainer = document.getElementById('chatMessages');
            const giftDiv = document.createElement('div');
            giftDiv.className = 'gift-container';
            
            giftDiv.innerHTML = `
                <div class="gift-emoji">${emoji}</div>
                <div class="gift-text">🎁 ${description}</div>
                <div style="font-size: 12px; margin-top: 8px; opacity: 0.8;">
                    Envoyé avec amour par ${gameState.player.firstName || 'Vous'} 💕
                </div>
            `;
            
            messagesContainer.appendChild(giftDiv);
            scrollToBottom();
            
            relationshipStability = Math.min(100, relationshipStability + 5);
        }

        // 6. MISSIONS COOPÉRATIVES
        const coopQuestions = [
            {
                question: 'Quelle est la capitale de la France ?',
                answers: ['Paris', 'Lyon', 'Marseille', 'Toulouse'],
                correct: 0
            },
            {
                question: 'Quel pays a inventé la pizza ?',
                answers: ['France', 'Italie', 'Grèce', 'Espagne'],
                correct: 1
            },
            {
                question: 'Quelle langue parle-t-on au Brésil ?',
                answers: ['Espagnol', 'Anglais', 'Portugais', 'Français'],
                correct: 2
            },
            {
                question: 'Combien de continents y a-t-il ?',
                answers: ['5', '6', '7', '8'],
                correct: 2
            }
        ];

        function startCoopMission() {
            if (activeMission) {
                showMessage('⚠️ Une mission est déjà en cours !', 'error');
                return;
            }
            
            const randomQuestion = coopQuestions[Math.floor(Math.random() * coopQuestions.length)];
            activeMission = {
                question: randomQuestion,
                playerAnswer: null,
                partnerAnswer: null,
                completed: false
            };
            
            addCoopMissionToChat(randomQuestion);
        }

        function addCoopMissionToChat(question) {
            const messagesContainer = document.getElementById('chatMessages');
            const missionDiv = document.createElement('div');
            missionDiv.className = 'coop-mission';
            missionDiv.id = 'activeMission';
            
            missionDiv.innerHTML = `
                <div class="coop-mission-title">🤝 Mission Coopérative</div>
                <div class="coop-mission-question">${question.question}</div>
                <div class="coop-mission-answers" id="missionAnswers">
                    ${question.answers.map((answer, index) => `
                        <div class="coop-answer" onclick="answerCoopQuestion(${index})" data-answer="${index}">
                            ${answer}
                        </div>
                    `).join('')}
                </div>
                <div style="font-size: 12px; text-align: center; margin-top: 10px;">
                    Répondez ensemble pour rétablir la paix ! ✨
                </div>
            `;
            
            messagesContainer.appendChild(missionDiv);
            scrollToBottom();
            
            // Le partenaire répond après 3-8 secondes
            setTimeout(() => {
                if (activeMission && !activeMission.completed) {
                    const partnerChoice = Math.floor(Math.random() * question.answers.length);
                    answerCoopQuestion(partnerChoice, 'partner');
                }
            }, Math.random() * 5000 + 3000);
        }

        function answerCoopQuestion(answerIndex, responder = 'player') {
            if (!activeMission || activeMission.completed) return;
            
            if (responder === 'player') {
                if (activeMission.playerAnswer !== null) {
                    showMessage('⚠️ Vous avez déjà répondu !', 'error');
                    return;
                }
                activeMission.playerAnswer = answerIndex;
            } else {
                activeMission.partnerAnswer = answerIndex;
                addPartnerMessage(`J'ai choisi : "${activeMission.question.answers[answerIndex]}" ! 🤔`);
            }
            
            // Mettre à jour l'affichage
            updateCoopMissionDisplay();
            
            // Vérifier si les deux ont répondu
            if (activeMission.playerAnswer !== null && activeMission.partnerAnswer !== null) {
                setTimeout(() => {
                    completeCoopMission();
                }, 2000);
            }
        }

        function updateCoopMissionDisplay() {
            const answersContainer = document.getElementById('missionAnswers');
            if (!answersContainer || !activeMission) return;
            
            answersContainer.innerHTML = activeMission.question.answers.map((answer, index) => {
                let className = 'coop-answer';
                let extraText = '';
                
                if (activeMission.playerAnswer === index) {
                    className += ' selected';
                    extraText = ' (Vous)';
                }
                if (activeMission.partnerAnswer === index) {
                    extraText += activeMission.playerAnswer === index ? ' (Vous deux)' : ` (${chatState.currentPartner?.name || 'Partenaire'})`;
                }
                
                return `
                    <div class="${className}" data-answer="${index}">
                        ${answer}${extraText}
                    </div>
                `;
            }).join('');
        }

        function completeCoopMission() {
            if (!activeMission || activeMission.completed) return;
            
            activeMission.completed = true;
            const correctAnswer = activeMission.question.correct;
            const bothCorrect = activeMission.playerAnswer === correctAnswer && activeMission.partnerAnswer === correctAnswer;
            const oneCorrect = activeMission.playerAnswer === correctAnswer || activeMission.partnerAnswer === correctAnswer;
            
            // Colorier les réponses
            const answersContainer = document.getElementById('missionAnswers');
            answersContainer.innerHTML = activeMission.question.answers.map((answer, index) => {
                let className = 'coop-answer';
                if (index === correctAnswer) {
                    className += ' correct';
                } else if (index === activeMission.playerAnswer || index === activeMission.partnerAnswer) {
                    className += ' incorrect';
                }
                
                let extraText = '';
                if (activeMission.playerAnswer === index) {
                    extraText = ' (Vous)';
                }
                if (activeMission.partnerAnswer === index) {
                    extraText += activeMission.playerAnswer === index ? ' (Vous deux)' : ` (${chatState.currentPartner?.name || 'Partenaire'})`;
                }
                
                return `
                    <div class="${className}">
                        ${answer}${extraText}
                        ${index === correctAnswer ? ' ✅' : ''}
                    </div>
                `;
            }).join('');
            
            let resultMessage = '';
            let stabilityBonus = 0;
            
            if (bothCorrect) {
                resultMessage = '🎉 Parfait ! Vous avez tous les deux la bonne réponse ! Paix rétablie ! +30 stabilité !';
                stabilityBonus = 30;
                gainXP(50);
            } else if (oneCorrect) {
                resultMessage = '👍 Pas mal ! L\'un de vous a trouvé la bonne réponse. +15 stabilité !';
                stabilityBonus = 15;
                gainXP(25);
            } else {
                resultMessage = '😅 Aucun de vous n\'a trouvé... Mais l\'effort compte ! +5 stabilité !';
                stabilityBonus = 5;
                gainXP(10);
            }
            
            relationshipStability = Math.min(100, relationshipStability + stabilityBonus);
            
            setTimeout(() => {
                addPartnerMessage(resultMessage);
                activeMission = null;
            }, 1000);
        }

        // 7. HISTORIQUE DES DRAMAS
        function updateDramaHistory() {
            const historyContainer = document.getElementById('dramaHistory');
            
            if (dramHistory.length === 0) {
                historyContainer.innerHTML = `
                    <div class="text-center text-gray-500 dark:text-gray-400 p-4">
                        Aucun drama pour le moment... 😌
                    </div>
                `;
                return;
            }
            
            historyContainer.innerHTML = dramHistory.map(drama => `
                <div class="drama-history-item">
                    <div class="drama-history-date">${drama.date}</div>
                    <div class="drama-history-type">${drama.title}</div>
                    <div class="drama-history-impact">
                        Impact : ${drama.actualImpact || drama.impact > 0 ? '+' : ''}${drama.actualImpact || drama.impact} stabilité
                        ${drama.action ? `(${drama.action === 'accept' ? 'Accepté' : drama.action === 'ignore' ? 'Ignoré' : 'Rejeté'})` : ''}
                    </div>
                </div>
            `).join('');
        }

        // ONGLETS DU CHAT
        function switchChatTab(tabName) {
            // Mettre à jour les onglets
            document.querySelectorAll('.chat-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.chat-tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Activer le bon onglet
            document.querySelector(`.chat-tab[onclick="switchChatTab('${tabName}')"]`).classList.add('active');
            document.getElementById(tabName + 'Tab').classList.add('active');
            
            currentActiveTab = tabName;
            
            if (tabName === 'history') {
                updateDramaHistory();
            }
        }

        // BOUTONS RAPIDES ÉTENDUS
        function addExtendedQuickButtons() {
            const quickMessages = document.querySelector('.quick-messages');
            
            // Ajouter le bouton de mission coopérative s'il n'existe pas
            if (!document.querySelector('[onclick="startCoopMission()"]')) {
                const missionBtn = document.createElement('button');
                missionBtn.className = 'quick-msg-btn';
                missionBtn.textContent = '🤝 Mission';
                missionBtn.onclick = startCoopMission;
                quickMessages.appendChild(missionBtn);
            }
        }

        // Initialiser les fonctionnalités étendues
        function initExtendedChatFeatures() {
            addExtendedQuickButtons();
            updateDramaHistory();
        }

        // ============================================
        // SYSTÈME DE RUPTURE DRAMATIQUE
        // ============================================

        function breakUp(marriageIndex, partnerName, partnerCountry, genderEmoji) {
            console.log(`💔 Tentative de rupture avec ${partnerName} (index: ${marriageIndex})`);
            
            // Vérifier que l'index est valide
            if (marriageIndex < 0 || marriageIndex >= marriageHistory.length) {
                console.error('❌ Index de mariage invalide:', marriageIndex);
                showMessage('❌ Erreur : Impossible de trouver ce mariage !', 'error');
                return;
            }
            
            // Récupérer les détails du mariage avant la suppression
            const marriage = marriageHistory[marriageIndex];
            
            // Confirmation dramatique
            const confirmMessage = `💔 Êtes-vous vraiment sûr(e) de vouloir quitter ${genderEmoji} ${partnerName} de ${partnerCountry} ?\n\n⚠️ Cette action est irréversible et aura des conséquences !`;
            
            if (!confirm(confirmMessage)) {
                console.log('💔 Rupture annulée par l\'utilisateur');
                return;
            }
            
            console.log(`💔 Rupture confirmée avec ${partnerName}`);
            
            // Supprimer immédiatement la carte avec animation
            const marriageCard = document.getElementById(`marriage-${marriageIndex}`);
            if (marriageCard) {
                marriageCard.style.animation = 'breakupDisappear 1s ease-out';
                marriageCard.style.pointerEvents = 'none'; // Désactiver les interactions
                
                setTimeout(() => {
                    if (marriageCard.parentElement) {
                        marriageCard.remove();
                    }
                }, 1000);
            }
            
            // Supprimer le mariage de l'historique
            marriageHistory.splice(marriageIndex, 1);
            console.log(`✅ ${partnerName} retiré de l'historique des mariages`);
            
            // Mettre à jour immédiatement l'affichage de la liste
            setTimeout(() => {
                updateMarriageList();
                console.log('✅ Liste des mariages mise à jour');
            }, 500);
            
            // Pénalités
            const xpLoss = Math.min(gameState.player.xp, 75);
            gameState.player.xp = Math.max(0, gameState.player.xp - xpLoss);
            relationshipStability = Math.max(0, relationshipStability - 50);
            
            // Mettre à jour les affichages
            updateXPDisplay();
            markUnsavedChanges();
            
            // Message de confirmation immédiat
            showMessage(`💔 Rupture confirmée ! Vous avez quitté ${genderEmoji} ${partnerName} de ${partnerCountry}. XP: -${xpLoss}, Stabilité: -50`, 'error');
            
            // Effets dramatiques de rupture (après le message de confirmation)
            setTimeout(() => {
                createBreakupEffects();
                playBreakupSound();
                
                // Message dramatique détaillé
                setTimeout(() => {
                    showBreakupMessage(partnerName, partnerCountry, genderEmoji, xpLoss);
                }, 1000);
            }, 200);
            
            // Message dans le tchat si c'était le partenaire principal
            if (chatState.currentPartner && chatState.currentPartner.name === partnerName) {
                setTimeout(() => {
                    addBreakupChatMessage(partnerName);
                }, 2000);
            }
            
            console.log(`✅ Rupture complète avec ${partnerName}`);
        }

        function createBreakupEffects() {
            // Cœurs brisés qui tombent
            for (let i = 0; i < 15; i++) {
                setTimeout(() => {
                    const brokenHeart = document.createElement('div');
                    brokenHeart.className = 'heart-animation';
                    brokenHeart.textContent = '💔';
                    brokenHeart.style.left = Math.random() * window.innerWidth + 'px';
                    brokenHeart.style.top = '0px';
                    brokenHeart.style.color = '#FF6B6B';
                    brokenHeart.style.fontSize = '50px';
                    brokenHeart.style.animation = 'breakupFall 3s ease-in';
                    document.body.appendChild(brokenHeart);
                    
                    setTimeout(() => brokenHeart.remove(), 3000);
                }, i * 200);
            }
            
            // Tremblement de l'écran
            document.body.style.animation = 'breakupShake 0.8s ease-in-out 3';
            
            // Overlay sombre temporaire
            const sadOverlay = document.createElement('div');
            sadOverlay.style.position = 'fixed';
            sadOverlay.style.top = '0';
            sadOverlay.style.left = '0';
            sadOverlay.style.width = '100%';
            sadOverlay.style.height = '100%';
            sadOverlay.style.background = 'rgba(0, 0, 0, 0.4)';
            sadOverlay.style.pointerEvents = 'none';
            sadOverlay.style.zIndex = '999';
            sadOverlay.style.animation = 'sadnessOverlay 2s ease-in-out';
            document.body.appendChild(sadOverlay);
            
            setTimeout(() => {
                sadOverlay.remove();
                document.body.style.animation = '';
            }, 2000);
        }

        function playBreakupSound() {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                
                // Son triste descendant
                const notes = [
                    { frequency: 523.25, time: 0 },     // Do
                    { frequency:493.88, time: 0.3 },   // Si
                    { frequency: 440.00, time: 0.6 },   // La
                    { frequency: 392.00, time: 0.9 },   // Sol
                    { frequency: 349.23, time: 1.2 }    // Fa
                ];
                
                notes.forEach(note => {
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    
                    oscillator.type = 'sine';
                    oscillator.frequency.setValueAtTime(note.frequency, audioContext.currentTime + note.time);
                    
                    gainNode.gain.setValueAtTime(0, audioContext.currentTime + note.time);
                    gainNode.gain.linearRampToValueAtTime(0.4, audioContext.currentTime + note.time + 0.05);
                    gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + note.time + 0.8);
                    
                    oscillator.start(audioContext.currentTime + note.time);
                    oscillator.stop(audioContext.currentTime + note.time + 0.8);
                });
                
            } catch (error) {
                console.log('Audio de rupture non supporté:', error);
            }
        }

        function showBreakupMessage(partnerName, partnerCountry, genderEmoji, xpLoss) {
            const messageContainer = document.getElementById('messageContainer');
            const breakupDiv = document.createElement('div');
            breakupDiv.className = 'message error breakup-message';
            breakupDiv.style.background = 'linear-gradient(45deg, #8B0000, #DC143C, #FF6B6B)';
            breakupDiv.style.color = 'white';
            breakupDiv.style.border = '3px solid #8B0000';
            breakupDiv.style.boxShadow = '0 8px 25px rgba(139, 0, 0, 0.5)';
            breakupDiv.style.animation = 'dramaticPulse 2s ease-in-out 3';
            
            const breakupMessages = [
                `C'est fini entre nous ! Notre amour n'était qu'un mensonge !`,
                `Je ne peux plus supporter cette relation ! C'est terminé !`,
                `Nos différences sont trop importantes... Nous devons nous séparer.`,
                `Cette histoire d'amour s'arrête ici ! Adieu !`,
                `Je mérite mieux que ça ! Je te quitte définitivement !`
            ];
            
            const randomMessage = breakupMessages[Math.floor(Math.random() * breakupMessages.length)];
            
            breakupDiv.innerHTML = `
                <div class="text-center">
                    <div style="font-size: 4em; margin-bottom: 20px;">💔💔💔</div>
                    <div style="font-size: 24px; font-weight: bold; margin-bottom: 15px; text-shadow: 2px 2px 4px rgba(0,0,0,0.7);">
                        🚨 RUPTURE DRAMATIQUE ! 🚨
                    </div>
                    <div style="font-size: 20px; margin-bottom: 20px; background: rgba(0,0,0,0.4); padding: 20px; border-radius: 15px;">
                        💔 Vous avez quitté ${genderEmoji} ${partnerName} de ${partnerCountry} !
                    </div>
                    <div style="font-size: 18px; margin: 15px 0; background: rgba(139,0,0,0.6); padding: 15px; border-radius: 10px;">
                        "${randomMessage}"
                    </div>
                    <div style="font-size: 16px; margin: 20px 0;">
                        💸 Perte d'XP : -${xpLoss} points<br>
                        💔 Stabilité relationnelle : -50 points<br>
                        😢 Reputation dégradée...
                    </div>
                    
                    <div style="font-size: 3em; margin: 20px 0; animation: explosionBlink 0.8s infinite;">
                        😭💔😭
                    </div>
                    
                    <div style="margin-top: 25px;">
                        <button class="btn btn-secondary" onclick="this.closest('.breakup-message').remove()">
                            😔 Accepter la réalité
                        </button>
                    </div>
                </div>
            `;
            
            messageContainer.appendChild(breakupDiv);
            messageContainer.scrollTop = messageContainer.scrollHeight;
        }

        function addBreakupChatMessage(partnerName) {
            if (chatState.isOpen || chatState.isMinimized) {
                const farewellMessages = [
                    `😭 Comment as-tu pu me faire ça ?! Je pensais qu'on s'aimait vraiment...`,
                    `💔 C'est fini alors... J'espère que tu seras heureux/heureuse sans moi.`,
                    `😢 Je ne comprends pas... Qu'est-ce qui n'allait pas dans notre relation ?`,
                    `😠 Tu me brises le cœur ! Je ne t'oublierai jamais !`,
                    `😭 Adieu ${gameState.player.firstName}... Tu vas me manquer terriblement.`
                ];
                
                const randomFarewell = farewellMessages[Math.floor(Math.random() * farewellMessages.length)];
                
                // Message d'adieu du partenaire
                setTimeout(() => {
                    addPartnerMessage(randomFarewell);
                }, 1000);
                
                // Fermer le tchat après le message d'adieu
                setTimeout(() => {
                    closeChat();
                    chatState.currentPartner = null;
                }, 4000);
            }
        }

        // ============================================
        // FONCTIONS DE CRÉATION DE PERSONNAGE
        // ============================================

        // Variables pour les origines sélectionnées
        let selectedOrigins = [];
        let quizData = {
            completed: false,
            score: 0,
            bonusXP: 0
        };

        // Mettre à jour la sélection des origines
        function updateOriginSelection() {
            const checkboxes = document.querySelectorAll('input[type="checkbox"][id^="origin_"]');
            selectedOrigins = [];
            
            checkboxes.forEach(checkbox => {
                if (checkbox.checked) {
                    selectedOrigins.push(checkbox.value);
                }
            });
            
            // Limiter à 3 origines maximum
            if (selectedOrigins.length > 3) {
                // Décocher la dernière sélectionnée
                const lastChecked = Array.from(checkboxes).find(cb => 
                    cb.checked && selectedOrigins[selectedOrigins.length - 1] === cb.value
                );
                if (lastChecked) {
                    lastChecked.checked = false;
                }
                selectedOrigins.pop();
                showMessage('⚠️ Maximum 3 origines autorisées !', 'error');
            }
            
            // Mettre à jour l'affichage
            const selectedOriginsDiv = document.getElementById('selectedOrigins');
            if (selectedOriginsDiv) {
                if (selectedOrigins.length === 0) {
                    selectedOriginsDiv.textContent = '';
                } else {
                    const flags = selectedOrigins.map(origin => countries[origin] || '🏳️').join(' ');
                    selectedOriginsDiv.textContent = `Sélectionnées : ${flags} ${selectedOrigins.join(', ')}`;
                }
            }
            
            updateCharacterPreview();
            updatePronunciationSection();
        }

        // Mettre à jour l'aperçu du personnage
        function updateCharacterPreview() {
            const firstName = document.getElementById('firstName')?.value.trim() || '';
            const lastName = document.getElementById('lastName')?.value.trim() || '';
            const gender = document.getElementById('genderSelect')?.value || '';
            const luckyNumber = document.getElementById('luckyNumber')?.value || '';
            const ballColor = document.getElementById('ballColor')?.value || '#FF6B9D';
            const ballAccessory = document.getElementById('ballAccessory')?.value || '';
            const culturalStyle = document.getElementById('culturalStyle')?.value || '';
            const ballExpression = document.getElementById('ballExpression')?.value || '😊';
            
            // Mettre à jour le nom
            const previewName = document.getElementById('previewName');
            if (previewName) {
                const fullName = firstName && lastName ? `${firstName} ${lastName}` : 'Votre nom';
                previewName.textContent = fullName;
            }
            
            // Mettre à jour les drapeaux
            const previewFlags = document.getElementById('previewFlags');
            if (previewFlags) {
                if (selectedOrigins.length > 0) {
                    const flags = selectedOrigins.map(origin => countries[origin] || '🏳️').join(' ');
                    previewFlags.textContent = flags;
                } else {
                    previewFlags.textContent = '🏳️';
                }
            }
            
            // Mettre à jour la description
            const previewDescription = document.getElementById('previewDescription');
            if (previewDescription) {
                previewDescription.textContent = generatePersonalDescription(firstName, lastName, gender, selectedOrigins);
            }
            
            // Mettre à jour le chiffre porte-bonheur
            const previewLuckyNumber = document.getElementById('previewLuckyNumber');
            if (previewLuckyNumber) {
                if (luckyNumber) {
                    previewLuckyNumber.textContent = `🍀 Chiffre porte-bonheur : ${luckyNumber}`;
                } else {
                    previewLuckyNumber.textContent = '';
                }
            }
            
            // Mettre à jour l'apparence du Country Ball
            const ballPreview = document.getElementById('ballPreview');
            if (ballPreview) {
                // Couleur de fond
                ballPreview.style.background = `linear-gradient(45deg, ${ballColor}, ${ballColor}88)`;
                
                // Contenu du ball (expression + accessoires + style culturel)
                let ballContent = ballExpression;
                if (ballAccessory) {
                    ballContent = ballAccessory + ballExpression;
                }
                if (culturalStyle) {
                    ballContent += culturalStyle;
                }
                
                ballPreview.textContent = ballContent;
            }
        }

        // Générer une description personnalisée
        function generatePersonalDescription(firstName, lastName, gender, origins) {
            if (!firstName) return 'Votre aventure commence ici...';
            
            const genderText = gender === 'male' ? 'homme' : gender === 'female' ? 'femme' : 'personne';
            const name = lastName ? `${firstName} ${lastName}` : firstName;
            
            if (origins.length === 0) {
                return `${name}, ${genderText} mystérieux(se) aux origines secrètes.`;
            } else if (origins.length === 1) {
                const origin = origins[0];
                const adjectives = {
                    'France': 'français(e)',
                    'Morocco': 'marocain(e)',
                    'Algeria': 'algérien(ne)',
                    'Kabylia': 'kabyle',
                    'Tunisia': 'tunisien(ne)',
                    'Lebanon': 'libanais(e)',
                    'Germany': 'allemand(e)',
                    'Turkey': 'turc(que)',
                    'Italy': 'italien(ne)',
                    'Spain': 'espagnol(e)',
                    'Canada': 'canadien(ne)',
                    'United States': 'américain(e)',
                    'Mexico': 'mexicain(e)',
                    'Brazil': 'brésilien(ne)',
                    'United Kingdom': 'britannique',
                    'Japan': 'japonais(e)'
                };
                const adjective = adjectives[origin] || `de ${origin}`;
                return `${name}, ${genderText} ${adjective}, fier(ère) de ses racines !`;
            } else {
                const originNames = origins.join(', ');
                return `${name}, ${genderText} aux origines multiples (${originNames}), citoyen(ne) du monde !`;
            }
        }

        // Mettre à jour la section de prononciation
        function updatePronunciationSection() {
            const pronunciationSection = document.getElementById('pronunciationSection');
            const pronunciationOptions = document.getElementById('pronunciationOptions');
            
            if (!pronunciationSection || !pronunciationOptions) return;
            
            const firstName = document.getElementById('firstName')?.value.trim() || '';
            
            if (!firstName || selectedOrigins.length === 0) {
                pronunciationSection.classList.add('hidden');
                return;
            }
            
            pronunciationSection.classList.remove('hidden');
            
            // Générer les options de prononciation pour chaque origine
            let pronunciationHTML = '';
            
            selectedOrigins.forEach(origin => {
                const languageCode = getLanguageCode(origin);
                const displayName = getLanguageDisplayName(languageCode);
                const pronunciation = adaptPronunciationToLanguage(firstName, origin);
                
                pronunciationHTML += `
                    <div class="bg-purple-50 dark:bg-purple-900/20 p-4 rounded-lg border border-purple-200 dark:border-purple-700">
                        <div class="flex items-center justify-between">
                            <div>
                                <span class="font-semibold text-purple-700 dark:text-purple-300">${countries[origin]} ${displayName}</span>
                                <div class="text-sm text-gray-600 dark:text-gray-400 mt-1">
                                    Prononciation : [${pronunciation}]
                                </div>
                            </div>
                            <button class="btn btn-sm btn-success" onclick="playPronunciation('${pronunciation}', '${displayName}')">
                                🔊 Écouter
                            </button>
                        </div>
                    </div>
                `;
            });
            
            pronunciationOptions.innerHTML = pronunciationHTML;
        }

        // Fonction pour obtenir le nom d'affichage de la langue
        function getLanguageDisplayName(languageCode) {
            const displayNames = {
                'french': 'Français',
                'arabic': 'Arabe',
                'berber': 'Amazigh (Kabyle)',
                'german': 'Allemand',
                'english': 'Anglais',
                'italian': 'Italien',
                'spanish': 'Espagnol',
                'portuguese': 'Portugais',
                'japanese': 'Japonais',
                'chinese': 'Chinois',
                'hindi': 'Hindi',
                'russian': 'Russe',
                'turkish': 'Turc'
            };
            return displayNames[languageCode] || languageCode;
        }

        // Jouer la prononciation (simulé)
        function playPronunciation(pronunciation, languageName) {
            showMessage(`🔊 Prononciation en ${languageName} : "${pronunciation}"`, 'special');
            
            // Simulation d'audio avec synthèse vocale si disponible
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(pronunciation);
                const voices = speechSynthesis.getVoices();
                
                // Essayer de trouver une voix appropriée
                const languageMap = {
                    'Français': 'fr',
                    'Arabe': 'ar',
                    'Allemand': 'de',
                    'Anglais': 'en',
                    'Italien': 'it',
                    'Espagnol': 'es',
                    'Japonais': 'ja'
                };
                
                const langCode = languageMap[languageName] || 'en';
                const voice = voices.find(voice => voice.lang.startsWith(langCode));
                
                if (voice) {
                    utterance.voice = voice;
                }
                
                utterance.rate = 0.8;
                utterance.pitch = 1;
                
                speechSynthesis.speak(utterance);
            } else {
                showMessage('⚠️ Synthèse vocale non supportée sur ce navigateur', 'error');
            }
        }

        // Quiz culturel
        function startCulturalQuiz() {
            if (selectedOrigins.length === 0) {
                showMessage('⚠️ Sélectionnez d\'abord vos origines pour commencer le quiz !', 'error');
                return;
            }
            
            // Questions du quiz selon les origines
            const quizQuestions = generateCulturalQuestions(selectedOrigins);
            
            if (quizQuestions.length === 0) {
                showMessage('⚠️ Pas de questions disponibles pour vos origines sélectionnées.', 'error');
                return;
            }
            
            showQuizModal(quizQuestions);
        }

        // Quiz culturel intégré à la création de profil
        function startProfileQuiz() {
            if (selectedOrigins.length === 0) {
                showMessage('⚠️ Sélectionnez d\'abord vos origines pour commencer le quiz !', 'error');
                return;
            }

            if (quizData.completed) {
                showMessage('✅ Vous avez déjà terminé le quiz culturel !', 'special');
                return;
            }

            // Masquer le bouton quiz et afficher les boutons de contrôle
            document.getElementById('quizBtn').style.display = 'none';
            document.getElementById('skipQuizBtn').style.display = 'inline-block';
            
            // Afficher la section quiz
            const quizSection = document.getElementById('culturalQuizSection');
            quizSection.classList.remove('hidden');
            
            // Générer et afficher le quiz dans la section intégrée
            const quizQuestions = generateCulturalQuestions(selectedOrigins);
            showIntegratedQuiz(quizQuestions);
        }

        // Afficher le quiz intégré dans la page
        function showIntegratedQuiz(questions) {
            const quizContainer = document.getElementById('quizContainer');
            
            // Initialiser les variables du quiz
            window.profileQuizQuestions = questions;
            window.profileQuestionIndex = 0;
            window.profileQuizScore = 0;
            window.profileQuizCorrectAnswers = 0;
            
            quizContainer.innerHTML = `
                <div class="text-center mb-6">
                    <div class="text-lg font-semibold text-purple-700 dark:text-purple-300">
                        Question <span id="profileCurrentQuestion">1</span> sur ${questions.length}
                    </div>
                    <div class="text-sm text-gray-600 dark:text-gray-400 mt-1">
                        Score actuel : <span id="profileQuizScore" class="font-bold text-green-600">0</span> points
                    </div>
                </div>
                
                <div id="profileQuizQuestionArea" class="mb-6">
                    <!-- Question sera chargée ici -->
                </div>
                
                <div class="text-center">
                    <button id="profileQuizNext" class="btn btn-secondary" onclick="skipProfileQuizQuestion()" style="display: none;">
                        ⏭️ Question suivante
                    </button>
                </div>
            `;
            
            loadProfileQuizQuestion();
        }

        // Charger une question du quiz de profil
        function loadProfileQuizQuestion() {
            const questions = window.profileQuizQuestions;
            const index = window.profileQuestionIndex;
            
            if (index >= questions.length) {
                completeProfileQuiz();
                return;
            }
            
            const question = questions[index];
            const questionArea = document.getElementById('profileQuizQuestionArea');
            const currentQuestionSpan = document.getElementById('profileCurrentQuestion');
            
            if (currentQuestionSpan) {
                currentQuestionSpan.textContent = index + 1;
            }
            
            if (questionArea) {
                // Déterminer l'origine de la question pour l'affichage
                const questionOrigin = getQuestionOrigin(question);
                const flag = countries[questionOrigin] || '🌍';
                
                questionArea.innerHTML = `
                    <div class="bg-gradient-to-r from-purple-50 to-pink-50 dark:from-purple-900/30 dark:to-pink-900/30 p-6 rounded-xl border-2 border-purple-200 dark:border-purple-700">
                        <div class="text-center mb-4">
                            <div class="text-3xl mb-2">${flag}</div>
                            <div class="text-sm text-purple-600 dark:text-purple-400 font-semibold">${questionOrigin}</div>
                        </div>
                        
                        <h4 class="text-xl font-bold text-center mb-6 text-gray-800 dark:text-gray-200">${question.question}</h4>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                            ${question.options.map((option, i) => `
                                <button class="profile-quiz-option text-left p-4 border-2 border-purple-200 dark:border-purple-600 rounded-lg hover:border-purple-500 hover:bg-purple-100 dark:hover:bg-purple-900/40 transition-all duration-200 font-medium text-gray-700 dark:text-gray-300" 
                                        onclick="selectProfileQuizAnswer(${i}, ${question.correct}, ${question.points})">
                                    ${option}
                                </button>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
        }

        // Déterminer l'origine d'une question (pour l'affichage du drapeau)
        function getQuestionOrigin(question) {
            // Mapper les questions à leurs origines en analysant le contenu
            const questionText = question.question.toLowerCase();
            
            if (questionText.includes('france') || questionText.includes('paris') || questionText.includes('français')) {
                return 'France';
            }
            if (questionText.includes('maroc') || questionText.includes('rabat') || questionText.includes('marocain')) {
                return 'Morocco';
            }
            if (questionText.includes('algérie') || questionText.includes('alger') || questionText.includes('algérien')) {
                return 'Algeria';
            }
            if (questionText.includes('kabyle') || questionText.includes('amazigh')) {
                return 'Kabylia';
            }
            if (questionText.includes('allemagne') || questionText.includes('berlin') || questionText.includes('allemand')) {
                return 'Germany';
            }
            if (questionText.includes('japon') || questionText.includes('tokyo') || questionText.includes('japonais')) {
                return 'Japan';
            }
            if (questionText.includes('italie') || questionText.includes('italien')) {
                return 'Italy';
            }
            if (questionText.includes('espagne') || questionText.includes('espagnol')) {
                return 'Spain';
            }
            if (questionText.includes('liban') || questionText.includes('libanais')) {
                return 'Lebanon';
            }
            if (questionText.includes('turquie') || questionText.includes('turc')) {
                return 'Turkey';
            }
            
            // Retourner la première origine sélectionnée par défaut
            return selectedOrigins[0] || 'France';
        }

        // Sélectionner une réponse dans le quiz de profil
        function selectProfileQuizAnswer(selectedIndex, correctIndex, points) {
            const options = document.querySelectorAll('.profile-quiz-option');
            
            // Désactiver tous les boutons et colorer les réponses
            options.forEach((option, index) => {
                option.disabled = true;
                option.style.pointerEvents = 'none';
                option.style.transform = 'none';
                
                if (index === correctIndex) {
                    option.style.background = 'linear-gradient(135deg, #d4edda, #c3e6cb)';
                    option.style.borderColor = '#28a745';
                    option.style.color = '#155724';
                    option.innerHTML += ' <span style="float: right; font-size: 1.2em;">✅</span>';
                } else if (index === selectedIndex) {
                    option.style.background = 'linear-gradient(135deg, #f8d7da, #f1b0b7)';
                    option.style.borderColor = '#dc3545';
                    option.style.color = '#721c24';
                    option.innerHTML += ' <span style="float: right; font-size: 1.2em;">❌</span>';
                } else {
                    option.style.opacity = '0.6';
                }
            });
            
            // Mettre à jour le score
            let feedbackMessage = '';
            if (selectedIndex === correctIndex) {
                window.profileQuizScore += points;
                window.profileQuizCorrectAnswers++;
                feedbackMessage = '🎉 Bonne réponse ! +' + points + ' points';
            } else {
                feedbackMessage = '❌ Mauvaise réponse. La bonne réponse était mise en vert.';
            }
            
            // Mettre à jour l'affichage du score
            const scoreSpan = document.getElementById('profileQuizScore');
            if (scoreSpan) {
                scoreSpan.textContent = window.profileQuizScore;
            }
            
            // Afficher le feedback temporaire
            showQuizFeedback(feedbackMessage, selectedIndex === correctIndex);
            
            // Afficher le bouton "Question suivante"
            document.getElementById('profileQuizNext').style.display = 'inline-block';
            
            // Passer automatiquement à la question suivante après 3 secondes
            setTimeout(() => {
                skipProfileQuizQuestion();
            }, 3000);
        }

        // Afficher le feedback du quiz
        function showQuizFeedback(message, isCorrect) {
            const questionArea = document.getElementById('profileQuizQuestionArea');
            const feedbackDiv = document.createElement('div');
            feedbackDiv.className = `quiz-feedback mt-4 p-3 rounded-lg text-center font-semibold ${isCorrect ? 'bg-green-100 text-green-800 border border-green-300' : 'bg-red-100 text-red-800 border border-red-300'}`;
            feedbackDiv.textContent = message;
            
            questionArea.appendChild(feedbackDiv);
            
            // Retirer le feedback après 2.5 secondes
            setTimeout(() => {
                if (feedbackDiv.parentElement) {
                    feedbackDiv.remove();
                }
            }, 2500);
        }

        // Passer à la question suivante
        function skipProfileQuizQuestion() {
            window.profileQuestionIndex++;
            document.getElementById('profileQuizNext').style.display = 'none';
            loadProfileQuizQuestion();
        }

        // Terminer le quiz de profil
        function completeProfileQuiz() {
            const score = window.profileQuizScore;
            const correctAnswers = window.profileQuizCorrectAnswers;
            const totalQuestions = window.profileQuizQuestions.length;
            const percentage = Math.round((correctAnswers / totalQuestions) * 100);
            
            let bonusXP = 0;
            let message = '';
            let badge = '';
            
            if (percentage === 100) {
                bonusXP = 100;
                message = '🏆 PARFAIT ! Tu maîtrises parfaitement tes origines culturelles !';
                badge = '🏆 Tu gagnes le badge Culture+ sur ton profil !';
                
                // Ajouter le badge au profil du joueur
                if (!gameState.player.badges) {
                    gameState.player.badges = [];
                }
                gameState.player.badges.push({
                    id: 'culture_plus',
                    name: 'Culture+',
                    emoji: '🏆',
                    description: 'Score parfait au quiz culturel'
                });
            } else if (percentage >= 80) {
                bonusXP = 75;
                message = '🎉 Excellent ! Tu connais très bien tes origines !';
            } else if (percentage >= 60) {
                bonusXP = 50;
                message = '👍 Très bien ! Tu as de bonnes connaissances culturelles !';
            } else if (percentage >= 40) {
                bonusXP = 30;
                message = '👌 Pas mal ! Continue à apprendre sur tes origines !';
            } else {
                bonusXP = 15;
                message = '🤔 Il te reste encore des choses à découvrir sur tes origines !';
            }
            
            const quizContainer = document.getElementById('quizContainer');
            quizContainer.innerHTML = `
                <div class="text-center">
                    <div class="text-6xl mb-6">${percentage === 100 ? '🏆' : percentage >= 60 ? '🎉' : '🤗'}</div>
                    <h4 class="text-2xl font-bold mb-4 text-purple-700 dark:text-purple-300">Quiz culturel terminé !</h4>
                    
                    <div class="bg-gradient-to-r from-purple-100 to-pink-100 dark:from-purple-900/40 dark:to-pink-900/40 p-6 rounded-xl border-2 border-purple-300 dark:border-purple-600 mb-6">
                        <div class="text-xl font-bold mb-2">${correctAnswers}/${totalQuestions} bonnes réponses !</div>
                        <div class="text-lg text-purple-600 dark:text-purple-400 mb-4">${message}</div>
                        <div class="text-xl font-bold text-green-600 dark:text-green-400">🌟 Tu gagnes +${bonusXP} XP bonus !</div>
                        ${badge ? `<div class="text-lg text-yellow-600 dark:text-yellow-400 mt-3 font-bold">${badge}</div>` : ''}
                    </div>
                    
                    <div class="text-sm text-gray-600 dark:text-gray-400 mb-6">
                        Le bonus XP sera ajouté à ton profil quand tu commenceras l'aventure !
                    </div>
                </div>
            `;
            
            // Marquer le quiz comme terminé
            quizData.completed = true;
            quizData.score = percentage;
            quizData.bonusXP = bonusXP;
            quizData.correctAnswers = correctAnswers;
            quizData.totalQuestions = totalQuestions;
            
            // Afficher le bouton "Commencer l'aventure" et masquer les autres
            document.getElementById('quizBtn').style.display = 'none';
            document.getElementById('skipQuizBtn').style.display = 'none';
            document.getElementById('startGameBtn').style.display = 'inline-block';
            
            showMessage(`🧠 Quiz culturel terminé ! Score : ${correctAnswers}/${totalQuestions} (+${bonusXP} XP)`, 'success');
        }

        // Passer le quiz (option pour ceux qui ne veulent pas le faire)
        function skipQuiz() {
            const confirmSkip = confirm('❓ Êtes-vous sûr de vouloir passer le quiz culturel ?\n\nVous manquerez des points XP bonus et la chance de gagner le badge Culture+ !');
            
            if (confirmSkip) {
                // Masquer la section quiz
                document.getElementById('culturalQuizSection').classList.add('hidden');
                document.getElementById('quizBtn').style.display = 'none';
                document.getElementById('skipQuizBtn').style.display = 'none';
                document.getElementById('startGameBtn').style.display = 'inline-block';
                
                showMessage('⏭️ Quiz culturel passé. Vous pouvez maintenant commencer l\'aventure !', 'special');
            }
        }

        // Générer des questions culturelles selon les origines
        function generateCulturalQuestions(origins) {
            const allQuestions = {
                'France': [
                    {
                        question: 'Quelle est la capitale de la France ?',
                        options: ['Lyon', 'Paris', 'Marseille', 'Toulouse'],
                        correct: 1,
                        points: 10
                    },
                    {
                        question: 'Quel monument célèbre se trouve à Paris ?',
                        options: ['Tour de Pise', 'Tour Eiffel', 'Big Ben', 'Statue de la Liberté'],
                        correct: 1,
                        points: 10
                    },
                    {
                        question: 'Quelle spécialité culinaire française est connue mondialement ?',
                        options: ['Paella', 'Croissant', 'Sushi', 'Hamburger'],
                        correct: 1,
                        points: 15
                    },
                    {
                        question: 'Combien de régions administratives compte la France métropolitaine ?',
                        options: ['12', '13', '14', '15'],
                        correct: 1,
                        points: 20
                    },
                    {
                        question: 'Quel président français a dit "Vive le Québec libre !" ?',
                        options: ['François Mitterrand', 'Charles de Gaulle', 'Jacques Chirac', 'Nicolas Sarkozy'],
                        correct: 1,
                        points: 25
                    },
                    {
                        question: 'Dans quelle ville se trouve le château de Versailles ?',
                        options: ['Paris', 'Versailles', 'Fontainebleau', 'Compiègne'],
                        correct: 1,
                        points: 15
                    }
                ],
                'Morocco': [
                    {
                        question: 'Quelle est la capitale du Maroc ?',
                        options: ['Casablanca', 'Marrakech', 'Rabat', 'Fès'],
                        correct: 2,
                        points: 10
                    },
                    {
                        question: 'Quel plat est typiquement marocain ?',
                        options: ['Paella', 'Couscous', 'Pizza', 'Sushi'],
                        correct: 1,
                        points: 10
                    },
                    {
                        question: 'Comment dit-on "merci" en arabe marocain (darija) ?',
                        options: ['Shukran', 'Baraka Allah fik', 'Marhaba', 'Maasalama'],
                        correct: 0,
                        points: 20
                    },
                    {
                        question: 'Quelle couleur domine le drapeau marocain ?',
                        options: ['Vert', 'Rouge', 'Bleu', 'Jaune'],
                        correct: 1,
                        points: 15
                    },
                    {
                        question: 'Quel océan borde le Maroc à l\'ouest ?',
                        options: ['Océan Indien', 'Océan Atlantique', 'Océan Pacifique', 'Mer Méditerranée'],
                        correct: 1,
                        points: 15
                    },
                    {
                        question: 'Dans quelle ville marocaine trouve-t-on la Koutoubia ?',
                        options: ['Rabat', 'Casablanca', 'Marrakech', 'Fès'],
                        correct: 2,
                        points: 25
                    }
                ],
                'Algeria': [
                    {
                        question: 'Quelle est la capitale de l\'Algérie ?',
                        options: ['Oran', 'Constantine', 'Alger', 'Annaba'],
                        correct: 2,
                        points: 10
                    },
                    {
                        question: 'Quel est le plus grand désert d\'Algérie ?',
                        options: ['Sahara', 'Gobi', 'Kalahari', 'Atacama'],
                        correct: 0,
                        points: 15
                    },
                    {
                        question: 'En quelle année l\'Algérie a-t-elle obtenu son indépendance ?',
                        options: ['1960', '1962', '1965', '1958'],
                        correct: 1,
                        points: 20
                    },
                    {
                        question: 'Quelle est la monnaie algérienne ?',
                        options: ['Dirham', 'Dinar', 'Franc', 'Euro'],
                        correct: 1,
                        points: 15
                    },
                    {
                        question: 'Quel port algérien est le plus important du pays ?',
                        options: ['Annaba', 'Oran', 'Alger', 'Bejaia'],
                        correct: 2,
                        points: 20
                    }
                ],
                'Kabylia': [
                    {
                        question: 'Comment dit-on "bonjour" en kabyle ?',
                        options: ['Salam', 'Azul', 'Bonjour', 'Hello'],
                        correct: 1,
                        points: 15
                    },
                    {
                        question: 'Comment dit-on "merci" en kabyle ?',
                        options: ['Tanmirt', 'Shukran', 'Merci', 'Gracias'],
                        correct: 0,
                        points: 20
                    },
                    {
                        question: 'Quel est le nom de l\'alphabet kabyle traditionnel ?',
                        options: ['Tifinagh', 'Arabe', 'Latin', 'Cyrillique'],
                        correct: 0,
                        points: 25
                    },
                    {
                        question: 'Dans quelle région d\'Algérie se trouve principalement la Kabylie ?',
                        options: ['Sud', 'Est', 'Nord', 'Ouest'],
                        correct: 2,
                        points: 15
                    },
                    {
                        question: 'Quel chanteur kabyle célèbre a popularisé la musique berbère ?',
                        options: ['Idir', 'Khaled', 'Cheb Mami', 'Faudel'],
                        correct: 0,
                        points: 25
                    }
                ],
                'Tunisia': [
                    {
                        question: 'Quelle est la capitale de la Tunisie ?',
                        options: ['Sfax', 'Sousse', 'Tunis', 'Kairouan'],
                        correct: 2,
                        points: 10
                    },
                    {
                        question: 'Quel site archéologique tunisien est classé au patrimoine mondial ?',
                        options: ['Carthage', 'Dougga', 'Kairouan', 'Tous les trois'],
                        correct: 3,
                        points: 25
                    },
                    {
                        question: 'Quelle spécialité tunisienne est un sandwich populaire ?',
                        options: ['Tajine', 'Fricassé', 'Couscous', 'Méchoui'],
                        correct: 1,
                        points: 20
                    }
                ],
                'Lebanon': [
                    {
                        question: 'Quelle est la capitale du Liban ?',
                        options: ['Tripoli', 'Beyrouth', 'Sidon', 'Baalbek'],
                        correct: 1,
                        points: 10
                    },
                    {
                        question: 'Quel plat libanais est fait de pois chiches écrasés ?',
                        options: ['Taboulé', 'Houmous', 'Fattoush', 'Kibbeh'],
                        correct: 1,
                        points: 15
                    },
                    {
                        question: 'Combien de langues officielles a le Liban ?',
                        options: ['1', '2', '3', '4'],
                        correct: 1,
                        points: 20
                    },
                    {
                        question: 'Quel est l\'arbre symbolique du Liban ?',
                        options: ['Olivier', 'Cèdre', 'Chêne', 'Pin'],
                        correct: 1,
                        points: 15
                    }
                ],
                'Germany': [
                    {
                        question: 'Quelle est la capitale de l\'Allemagne ?',
                        options: ['Munich', 'Berlin', 'Hambourg', 'Cologne'],
                        correct: 1,
                        points: 10
                    },
                    {
                        question: 'En quelle année le mur de Berlin est-il tombé ?',
                        options: ['1987', '1989', '1991', '1985'],
                        correct: 1,
                        points: 20
                    },
                    {
                        question: 'Quelle fête traditionnelle allemande célèbre la bière ?',
                        options: ['Oktoberfest', 'Karneval', 'Weihnachten', 'Ostern'],
                        correct: 0,
                        points: 15
                    },
                    {
                        question: 'Combien d\'États fédérés (Länder) compte l\'Allemagne ?',
                        options: ['14', '15', '16', '17'],
                        correct: 2,
                        points: 25
                    },
                    {
                        question: 'Quel compositeur allemand a écrit la 9e symphonie ?',
                        options: ['Mozart', 'Bach', 'Beethoven', 'Wagner'],
                        correct: 2,
                        points: 20
                    }
                ],
                'Turkey': [
                    {
                        question: 'Quelle est la capitale de la Turquie ?',
                        options: ['Istanbul', 'Ankara', 'Izmir', 'Antalya'],
                        correct: 1,
                        points: 10
                    },
                    {
                        question: 'Sur combien de continents s\'étend la Turquie ?',
                        options: ['1', '2', '3', '4'],
                        correct: 1,
                        points: 20
                    },
                    {
                        question: 'Quel détroit sépare l\'Europe de l\'Asie en Turquie ?',
                        options: ['Dardanelles', 'Bosphore', 'Gibraltar', 'Manche'],
                        correct: 1,
                        points: 25
                    },
                    {
                        question: 'Quel monument célèbre d\'Istanbul était à la fois église et mosquée ?',
                        options: ['Mosquée Bleue', 'Sainte-Sophie', 'Topkapi', 'Galata'],
                        correct: 1,
                        points: 20
                    }
                ],
                'Italy': [
                    {
                        question: 'Quelle est la capitale de l\'Italie ?',
                        options: ['Milan', 'Naples', 'Rome', 'Florence'],
                        correct: 2,
                        points: 10
                    },
                    {
                        question: 'Dans quelle ville italienne peut-on voir la tour de Pise ?',
                        options: ['Pise', 'Florence', 'Bologne', 'Vérone'],
                        correct: 0,
                        points: 15
                    },
                    {
                        question: 'Quel est le volcan actif le plus célèbre d\'Italie ?',
                        options: ['Stromboli', 'Vésuve', 'Etna', 'Vulcano'],
                        correct: 2,
                        points: 20
                    },
                    {
                        question: 'Quelle forme géographique caractérise l\'Italie ?',
                        options: ['Botte', 'Étoile', 'Croissant', 'Triangle'],
                        correct: 0,
                        points: 15
                    },
                    {
                        question: 'Quel artiste a peint la Joconde ?',
                        options: ['Michel-Ange', 'Raphaël', 'Léonard de Vinci', 'Botticelli'],
                        correct: 2,
                        points: 20
                    }
                ],
                'Spain': [
                    {
                        question: 'Quelle est la capitale de l\'Espagne ?',
                        options: ['Barcelone', 'Madrid', 'Séville', 'Valence'],
                        correct: 1,
                        points: 10
                    },
                    {
                        question: 'Quel monument célèbre de Barcelone n\'est toujours pas terminé ?',
                        options: ['Park Güell', 'Sagrada Familia', 'Casa Batlló', 'Casa Milà'],
                        correct: 1,
                        points: 20
                    },
                    {
                        question: 'Quelle danse traditionnelle espagnole est originaire d\'Andalousie ?',
                        options: ['Tango', 'Flamenco', 'Salsa', 'Paso doble'],
                        correct: 1,
                        points: 15
                    },
                    {
                        question: 'Combien de langues officielles y a-t-il en Espagne ?',
                        options: ['2', '3', '4', '5'],
                        correct: 2,
                        points: 25
                    }
                ],
                'Japan': [
                    {
                        question: 'Quelle est la capitale du Japon ?',
                        options: ['Osaka', 'Kyoto', 'Tokyo', 'Hiroshima'],
                        correct: 2,
                        points: 10
                    },
                    {
                        question: 'Comment s\'appelle l\'art japonais du pliage de papier ?',
                        options: ['Ikebana', 'Origami', 'Bonsaï', 'Sumi-e'],
                        correct: 1,
                        points: 15
                    },
                    {
                        question: 'Quel est le mont le plus haut du Japon ?',
                        options: ['Mont Aso', 'Mont Fuji', 'Mont Hakusan', 'Mont Ontake'],
                        correct: 1,
                        points: 15
                    },
                    {
                        question: 'Comment dit-on "merci" en japonais ?',
                        options: ['Konnichiwa', 'Sayonara', 'Arigato', 'Sumimasen'],
                        correct: 2,
                        points: 20
                    },
                    {
                        question: 'Quel sport traditionnel japonais met en scène des lutteurs ?',
                        options: ['Karaté', 'Judo', 'Sumo', 'Kendo'],
                        correct: 2,
                        points: 20
                    }
                ],
                'United States': [
                    {
                        question: 'Quelle est la capitale des États-Unis ?',
                        options: ['New York', 'Los Angeles', 'Washington D.C.', 'Chicago'],
                        correct: 2,
                        points: 10
                    },
                    {
                        question: 'Combien d\'États comptent les États-Unis ?',
                        options: ['48', '49', '50', '51'],
                        correct: 2,
                        points: 15
                    },
                    {
                        question: 'Dans quel État se trouve la Statue de la Liberté ?',
                        options: ['Californie', 'Texas', 'New York', 'Floride'],
                        correct: 2,
                        points: 15
                    },
                    {
                        question: 'Quel fleuve traverse le Grand Canyon ?',
                        options: ['Mississippi', 'Colorado', 'Missouri', 'Hudson'],
                        correct: 1,
                        points: 25
                    }
                ],
                'United Kingdom': [
                    {
                        question: 'Quelle est la capitale du Royaume-Uni ?',
                        options: ['Manchester', 'Londres', 'Birmingham', 'Liverpool'],
                        correct: 1,
                        points: 10
                    },
                    {
                        question: 'Combien de pays forment le Royaume-Uni ?',
                        options: ['3', '4', '5', '6'],
                        correct: 1,
                        points: 20
                    },
                    {
                        question: 'Quel célèbre monument londonien abrite Big Ben ?',
                        options: ['Buckingham Palace', 'Tower Bridge', 'Palais de Westminster', 'London Eye'],
                        correct: 2,
                        points: 20
                    },
                    {
                        question: 'À quelle heure les Britanniques prennent-ils traditionnellement le thé ?',
                        options: ['15h', '16h', '17h', '18h'],
                        correct: 2,
                        points: 15
                    }
                ],
                'Brazil': [
                    {
                        question: 'Quelle est la capitale du Brésil ?',
                        options: ['São Paulo', 'Rio de Janeiro', 'Brasília', 'Salvador'],
                        correct: 2,
                        points: 10
                    },
                    {
                        question: 'Quelle langue officielle parle-t-on au Brésil ?',
                        options: ['Espagnol', 'Portugais', 'Anglais', 'Français'],
                        correct: 1,
                        points: 15
                    },
                    {
                        question: 'Quel fleuve traverse le Brésil d\'ouest en est ?',
                        options: ['Nil', 'Mississippi', 'Amazone', 'Congo'],
                        correct: 2,
                        points: 20
                    },
                    {
                        question: 'Quelle danse brésilienne est associée au carnaval de Rio ?',
                        options: ['Samba', 'Tango', 'Salsa', 'Mambo'],
                        correct: 0,
                        points: 15
                    }
                ],
                'Mexico': [
                    {
                        question: 'Quelle est la capitale du Mexique ?',
                        options: ['Guadalajara', 'Monterrey', 'Mexico', 'Tijuana'],
                        correct: 2,
                        points: 10
                    },
                    {
                        question: 'Quelle civilisation ancienne était présente au Mexique ?',
                        options: ['Incas', 'Mayas', 'Aztèques', 'Mayas et Aztèques'],
                        correct: 3,
                        points: 20
                    },
                    {
                        question: 'Quel jour férié mexicain honore les morts ?',
                        options: ['Cinco de Mayo', 'Día de los Muertos', 'Día de la Independencia', 'Navidad'],
                        correct: 1,
                        points: 20
                    },
                    {
                        question: 'Quelle boisson alcoolisée est traditionnelle au Mexique ?',
                        options: ['Rhum', 'Whisky', 'Tequila', 'Vodka'],
                        correct: 2,
                        points: 15
                    }
                ],
                'Canada': [
                    {
                        question: 'Quelle est la capitale du Canada ?',
                        options: ['Toronto', 'Montréal', 'Vancouver', 'Ottawa'],
                        correct: 3,
                        points: 10
                    },
                    {
                        question: 'Combien de langues officielles a le Canada ?',
                        options: ['1', '2', '3', '4'],
                        correct: 1,
                        points: 15
                    },
                    {
                        question: 'Quel symbole apparaît sur le drapeau canadien ?',
                        options: ['Aigle', 'Feuille d\'érable', 'Castor', 'Ours'],
                        correct: 1,
                        points: 15
                    },
                    {
                        question: 'Quelle province canadienne est majoritairement francophone ?',
                        options: ['Ontario', 'Québec', 'Nouveau-Brunswick', 'Manitoba'],
                        correct: 1,
                        points: 20
                    }
                ],
                'China': [
                    {
                        question: 'Quelle est la capitale de la Chine ?',
                        options: ['Shanghai', 'Hong Kong', 'Pékin', 'Canton'],
                        correct: 2,
                        points: 10
                    },
                    {
                        question: 'Comment s\'appelle la grande muraille chinoise en chinois ?',
                        options: ['Chang Cheng', 'Da Qiang', 'Wei Qiang', 'Gao Qiang'],
                        correct: 0,
                        points: 25
                    },
                    {
                        question: 'Combien d\'animaux compte le zodiaque chinois ?',
                        options: ['10', '12', '14', '16'],
                        correct: 1,
                        points: 15
                    },
                    {
                        question: 'Quel art martial est originaire de Chine ?',
                        options: ['Karaté', 'Taekwondo', 'Kung Fu', 'Judo'],
                        correct: 2,
                        points: 20
                    }
                ],
                'India': [
                    {
                        question: 'Quelle est la capitale de l\'Inde ?',
                        options: ['Mumbai', 'Calcutta', 'New Delhi', 'Chennai'],
                        correct: 2,
                        points: 10
                    },
                    {
                        question: 'Quel monument emblématique se trouve à Agra ?',
                        options: ['Temple d\'or', 'Taj Mahal', 'Porte de l\'Inde', 'Fort Rouge'],
                        correct: 1,
                        points: 15
                    },
                    {
                        question: 'Combien de langues officielles reconnait l\'Inde ?',
                        options: ['2', '12', '22', '32'],
                        correct: 2,
                        points: 25
                    },
                    {
                        question: 'Quelle religion est majoritaire en Inde ?',
                        options: ['Bouddhisme', 'Islam', 'Hindouisme', 'Christianisme'],
                        correct: 2,
                        points: 15
                    }
                ],
                'Russia': [
                    {
                        question: 'Quelle est la capitale de la Russie ?',
                        options: ['Saint-Pétersbourg', 'Moscou', 'Volgograd', 'Kazan'],
                        correct: 1,
                        points: 10
                    },
                    {
                        question: 'Sur combien de fuseaux horaires s\'étend la Russie ?',
                        options: ['9', '11', '12', '15'],
                        correct: 1,
                        points: 25
                    },
                    {
                        question: 'Comment s\'appelle le célèbre théâtre de Moscou ?',
                        options: ['Mariinsky', 'Bolchoï', 'Vakhtangov', 'Maly'],
                        correct: 1,
                        points: 20
                    },
                    {
                        question: 'Quel lac russe est le plus profond du monde ?',
                        options: ['Lac Ladoga', 'Lac Baïkal', 'Lac Onega', 'Lac Peipous'],
                        correct: 1,
                        points: 20
                    }
                ]
            };
            
            let questions = [];
            origins.forEach(origin => {
                if (allQuestions[origin]) {
                    questions = questions.concat(allQuestions[origin]);
                }
            });
            
            // Mélanger et prendre maximum 5 questions
            return questions.sort(() => Math.random() - 0.5).slice(0, 5);
        }

        // Afficher le modal du quiz
        function showQuizModal(questions) {
            const modal = document.createElement('div');
            modal.style.position = 'fixed';
            modal.style.top = '0';
            modal.style.left = '0';
            modal.style.width = '100%';
            modal.style.height = '100%';
            modal.style.background = 'rgba(0, 0, 0, 0.8)';
            modal.style.display = 'flex';
            modal.style.alignItems = 'center';
            modal.style.justifyContent = 'center';
            modal.style.zIndex = '10000';
            modal.id = 'quizModal';
            
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 rounded-xl p-6 max-w-md w-full mx-4 max-h-90vh overflow-y-auto">
                    <div class="text-center mb-6">
                        <h3 class="text-2xl font-bold text-purple-700 dark:text-purple-300">🧠 Quiz Culturel</h3>
                        <p class="text-sm text-gray-600 dark:text-gray-400 mt-2">Testez vos connaissances sur vos origines !</p>
                    </div>
                    
                    <div id="quizContent">
                        <div id="quizProgress" class="mb-4">
                            Question <span id="currentQuestion">1</span> sur ${questions.length}
                        </div>
                        <div id="quizQuestionArea">
                            <!-- Questions will be loaded here -->
                        </div>
                    </div>
                    
                    <div class="flex justify-between mt-6">
                        <button class="btn btn-secondary" onclick="closeQuiz()">❌ Fermer</button>
                        <div>
                            Score : <span id="quizScore" class="font-bold text-purple-600">0</span> pts
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Initialiser le quiz
            window.currentQuizQuestions = questions;
            window.currentQuestionIndex = 0;
            window.quizScore = 0;
            
            loadQuizQuestion();
        }

        // Charger une question du quiz
        function loadQuizQuestion() {
            const questions = window.currentQuizQuestions;
            const index = window.currentQuestionIndex;
            
            if (index >= questions.length) {
                completeQuiz();
                return;
            }
            
            const question = questions[index];
            const questionArea = document.getElementById('quizQuestionArea');
            const currentQuestionSpan = document.getElementById('currentQuestion');
            
            if (currentQuestionSpan) {
                currentQuestionSpan.textContent = index + 1;
            }
            
            if (questionArea) {
                questionArea.innerHTML = `
                    <div class="mb-4">
                        <h4 class="text-lg font-semibold mb-4">${question.question}</h4>
                        <div class="space-y-2">
                            ${question.options.map((option, i) => `
                                <button class="quiz-option w-full text-left p-3 border-2 border-gray-300 rounded-lg hover:border-purple-500 hover:bg-purple-50 dark:border-gray-600 dark:hover:border-purple-400 dark:hover:bg-purple-900/20 transition-colors duration-200" 
                                        onclick="selectQuizAnswer(${i}, ${question.correct}, ${question.points})">
                                    ${option}
                                </button>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
        }

        // Sélectionner une réponse du quiz
        function selectQuizAnswer(selectedIndex, correctIndex, points) {
            const options = document.querySelectorAll('.quiz-option');
            
            // Désactiver tous les boutons
            options.forEach((option, index) => {
                option.disabled = true;
                option.style.pointerEvents = 'none';
                
                if (index === correctIndex) {
                    option.style.background = '#d4edda';
                    option.style.borderColor = '#28a745';
                    option.textContent += ' ✅';
                } else if (index === selectedIndex && selectedIndex !== correctIndex) {
                    option.style.background = '#f8d7da';
                    option.style.borderColor = '#dc3545';
                    option.textContent += ' ❌';
                }
            });
            
            // Mettre à jour le score
            if (selectedIndex === correctIndex) {
                window.quizScore += points;
                const scoreSpan = document.getElementById('quizScore');
                if (scoreSpan) {
                    scoreSpan.textContent = window.quizScore;
                }
            }
            
            // Passer à la question suivante après 2 secondes
            setTimeout(() => {
                window.currentQuestionIndex++;
                loadQuizQuestion();
            }, 2000);
        }

        // Terminer le quiz
        function completeQuiz() {
            const score = window.quizScore;
            const maxScore = window.currentQuizQuestions.reduce((sum, q) => sum + q.points, 0);
            const percentage = Math.round((score / maxScore) * 100);
            
            let bonusXP = 0;
            let message = '';
            
            if (percentage >= 80) {
                bonusXP = 50;
                message = '🏆 Excellent ! Vous maîtrisez parfaitement vos origines !';
            } else if (percentage >= 60) {
                bonusXP = 30;
                message = '👍 Très bien ! Vous connaissez bien votre culture !';
            } else if (percentage >= 40) {
                bonusXP = 15;
                message = '👌 Pas mal ! Continuez à apprendre sur vos origines !';
            } else {
                bonusXP = 5;
                message = '🤔 Il faut encore apprendre sur vos origines !';
            }
            
            const questionArea = document.getElementById('quizQuestionArea');
            if (questionArea) {
                questionArea.innerHTML = `
                    <div class="text-center">
                        <div class="text-4xl mb-4">🎉</div>
                        <h4 class="text-xl font-bold mb-4">Quiz terminé !</h4>
                        <div class="bg-purple-50 dark:bg-purple-900/20 p-4 rounded-lg mb-4">
                            <div class="text-lg font-semibold">Score : ${score}/${maxScore} (${percentage}%)</div>
                            <div class="text-sm text-purple-600 dark:text-purple-400">${message}</div>
                            <div class="text-lg font-bold text-green-600 dark:text-green-400 mt-2">+${bonusXP} XP bonus !</div>
                        </div>
                        <button class="btn btn-success w-full" onclick="applyQuizBonus(${bonusXP})">
                            ✨ Récupérer le bonus XP
                        </button>
                    </div>
                `;
            }
            
            quizData.completed = true;
            quizData.score = percentage;
            quizData.bonusXP = bonusXP;
        }

        // Appliquer le bonus XP du quiz
        function applyQuizBonus(bonusXP) {
            closeQuiz();
            
            // Ajouter le bonus XP au joueur si le jeu a commencé
            if (gameState.player && gameState.player.fullName) {
                gainXP(bonusXP);
                showMessage(`🎉 Quiz culturel terminé ! +${bonusXP} XP bonus !`, 'success');
            } else {
                // Stocker pour plus tard
                quizData.pendingBonus = bonusXP;
                showMessage(`🎉 Quiz terminé ! +${bonusXP} XP bonus vous attend au début du jeu !`, 'success');
            }
        }

        // Fermer le quiz
        function closeQuiz() {
            const modal = document.getElementById('quizModal');
            if (modal) {
                modal.remove();
            }
            
            // Nettoyer les variables globales
            window.currentQuizQuestions = null;
            window.currentQuestionIndex = 0;
            window.quizScore = 0;
        }

        // ============================================
        // SYSTÈME AERO GLASS AVEC RÉGLAGE D'INTENSITÉ
        // ============================================

        // Fonction pour mettre à jour l'intensité du flou Aero Glass
        function updateAeroIntensity(value) {
            const root = document.documentElement;
            root.style.setProperty('--aero-blur-intensity', value + 'px');
            
            // Mettre à jour l'affichage de la valeur
            const aeroBlurValue = document.getElementById('aeroBlurValue');
            if (aeroBlurValue) {
                aeroBlurValue.textContent = value + 'px';
            }
            
            // Sauvegarder la préférence
            if (gameState.player && gameState.player.fullName) {
                markUnsavedChanges();
            }
            
            console.log(`🌫️ Intensité Aero Glass mise à jour : ${value}px`);
        }

        // Fonction pour activer/désactiver l'effet Aero Glass sur des éléments
        function toggleAeroClass(selector, className) {
            const elements = document.querySelectorAll(selector);
            let activated = 0;
            let deactivated = 0;
            
            elements.forEach(element => {
                if (element.classList.contains(className)) {
                    element.classList.remove(className);
                    deactivated++;
                } else {
                    element.classList.add(className);
                    activated++;
                }
            });
            
            // Afficher un message de confirmation
            if (activated > 0) {
                showMessage(`✨ Effet Aero Glass activé sur ${activated} élément(s) ${getElementTypeName(selector)} !`, 'success');
            } else if (deactivated > 0) {
                showMessage(`❌ Effet Aero Glass désactivé sur ${deactivated} élément(s) ${getElementTypeName(selector)}.`, 'special');
            }
            
            console.log(`🎭 Toggle Aero Glass sur ${selector}: +${activated}, -${deactivated}`);
        }

        // Fonction utilitaire pour obtenir le nom du type d'élément
        function getElementTypeName(selector) {
            const typeNames = {
                '.country-card': 'cartes',
                '.message': 'messages',
                '.btn': 'boutons',
                '.chat-window': 'fenêtres de chat',
                '.chat-header': 'en-têtes de chat'
            };
            return typeNames[selector] || 'éléments';
        }

        // Fonction pour réinitialiser tous les paramètres Aero Glass
        function resetAeroSettings() {
            // Remettre l'intensité par défaut
            updateAeroIntensity(16);
            const aeroBlurSlider = document.getElementById('aeroBlurSlider');
            if (aeroBlurSlider) {
                aeroBlurSlider.value = 16;
            }
            
            // Retirer toutes les classes aero-glass
            const aeroElements = document.querySelectorAll('.aero-glass');
            aeroElements.forEach(element => {
                element.classList.remove('aero-glass');
            });
            
            // Remettre les propriétés CSS par défaut
            const root = document.documentElement;
            root.style.setProperty('--aero-blur-intensity', '16px');
            root.style.setProperty('--aero-opacity', '0.15');
            root.style.setProperty('--aero-border-opacity', '0.4');
            root.style.setProperty('--aero-brightness', '0.9');
            
            showMessage('🔄 Paramètres Aero Glass réinitialisés !', 'success');
            
            console.log('🔄 Tous les paramètres Aero Glass ont été réinitialisés');
        }

        // Fonction pour appliquer l'effet Aero Glass automatiquement sur les nouveaux éléments
        function applyAeroToNewElements() {
            // Observer les nouveaux éléments ajoutés au DOM
            const observer = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                    mutation.addedNodes.forEach(function(node) {
                        if (node.nodeType === Node.ELEMENT_NODE) {
                            // Appliquer automatiquement l'effet sur certains éléments
                            if (node.classList?.contains('country-card')) {
                                node.classList.add('aero-glass');
                            }
                            if (node.classList?.contains('message') && 
                                (node.classList.contains('success') || node.classList.contains('special'))) {
                                node.classList.add('aero-glass');
                            }
                            
                            // Chercher dans les enfants également
                            const childCards = node.querySelectorAll?.('.country-card');
                            childCards?.forEach(card => card.classList.add('aero-glass'));
                            
                            const childMessages = node.querySelectorAll?.('.message.success, .message.special');
                            childMessages?.forEach(msg => msg.classList.add('aero-glass'));
                        }
                    });
                });
            });
            
            // Observer les changements dans le container principal
            observer.observe(document.body, {
                childList: true,
                subtree: true
            });
            
            console.log('👁️ Observer Aero Glass initialisé pour les nouveaux éléments');
        }

        // Fonction pour créer un effet de démonstration Aero Glass
        function demonstrateAeroEffect() {
            const demoContainer = document.createElement('div');
            demoContainer.className = 'aero-glass demo-aero-container';
            demoContainer.style.position = 'fixed';
            demoContainer.style.top = '50%';
            demoContainer.style.left = '50%';
            demoContainer.style.transform = 'translate(-50%, -50%)';
            demoContainer.style.zIndex = '9999';
            demoContainer.style.padding = '30px';
            demoContainer.style.borderRadius = '20px';
            demoContainer.style.maxWidth = '400px';
            demoContainer.style.textAlign = 'center';
            demoContainer.style.animation = 'fadeIn 0.5s ease-out';
            
            demoContainer.innerHTML = `
                <div style="color: white; text-shadow: 2px 2px 4px rgba(0,0,0,0.7);">
                    <h3 style="font-size: 24px; margin-bottom: 20px;">✨ Effet Aero Glass Activé ✨</h3>
                    <p style="font-size: 16px; margin-bottom: 20px;">
                        Magnifique effet de transparence et de flou !<br>
                        Ajustez l'intensité avec le curseur ci-dessus.
                    </p>
                    <div style="display: flex; gap: 10px; justify-content: center; margin-top: 25px;">
                        <button class="btn btn-success" onclick="this.parentElement.parentElement.parentElement.remove()">
                            👍 Super !
                        </button>
                        <button class="btn btn-secondary" onclick="this.parentElement.parentElement.parentElement.remove()">
                            ✖️ Fermer
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(demoContainer);
            
            // Retirer automatiquement après 5 secondes
            setTimeout(() => {
                if (demoContainer.parentElement) {
                    demoContainer.remove();
                }
            }, 5000);
        }

        // Fonction pour activer automatiquement l'effet Aero Glass sur les éléments principaux
        function enableDefaultAeroEffects() {
            // Attendre que le DOM soit prêt
            setTimeout(() => {
                // Activer sur les cartes principales
                const countryCards = document.querySelectorAll('.country-card');
                countryCards.forEach(card => {
                    card.classList.add('aero-glass');
                });
                
                // Activer sur certains messages
                const specialMessages = document.querySelectorAll('.message.success, .message.special');
                specialMessages.forEach(msg => {
                    msg.classList.add('aero-glass');
                });
                
                // Activer sur le panneau de contrôle Aero
                const aeroPanel = document.querySelector('.aero-control-panel');
                if (aeroPanel) {
                    aeroPanel.classList.add('aero-glass');
                }
                
                console.log('✨ Effets Aero Glass par défaut appliqués');
            }, 500);
        }

        // Fonction pour sauvegarder les préférences Aero Glass
        function saveAeroPreferences() {
            const preferences = {
                blurIntensity: document.getElementById('aeroBlurSlider')?.value || 16,
                enabledElements: {
                    cards: document.querySelector('.country-card.aero-glass') !== null,
                    messages: document.querySelector('.message.aero-glass') !== null,
                    buttons: document.querySelector('.btn.aero-glass') !== null
                }
            };
            
            // Stocker dans gameState si disponible
            if (gameState) {
                gameState.aeroPreferences = preferences;
                markUnsavedChanges();
            }
            
            console.log('💾 Préférences Aero Glass sauvegardées:', preferences);
            return preferences;
        }

        // Fonction pour charger les préférences Aero Glass
        function loadAeroPreferences() {
            if (gameState && gameState.aeroPreferences) {
                const prefs = gameState.aeroPreferences;
                
                // Restaurer l'intensité du flou
                if (prefs.blurIntensity) {
                    updateAeroIntensity(prefs.blurIntensity);
                    const slider = document.getElementById('aeroBlurSlider');
                    if (slider) {
                        slider.value = prefs.blurIntensity;
                    }
                }
                
                // Restaurer les éléments activés
                if (prefs.enabledElements) {
                    setTimeout(() => {
                        if (prefs.enabledElements.cards) {
                            document.querySelectorAll('.country-card').forEach(el => 
                                el.classList.add('aero-glass'));
                        }
                        if (prefs.enabledElements.messages) {
                            document.querySelectorAll('.message').forEach(el => 
                                el.classList.add('aero-glass'));
                        }
                        if (prefs.enabledElements.buttons) {
                            document.querySelectorAll('.btn').forEach(el => 
                                el.classList.add('aero-glass'));
                        }
                    }, 300);
                }
                
                console.log('📂 Préférences Aero Glass chargées:', prefs);
            }
        }

        // ============================================
        // INITIALISATION
        // ============================================

        // Initialisation au chargement de la page (sans localStorage)
        window.onload = function() {
            initGame();
            initTheme();
            startJealousySystem();
            
            // Initialiser l'effet Aero Glass
            applyAeroToNewElements();
            enableDefaultAeroEffects();
            
            // Initialiser les événements du tchat
            const chatInput = document.getElementById('chatInput');
            if (chatInput) {
                chatInput.addEventListener('input', function() {
                    adjustTextareaHeight(this);
                    updateSendButton();
                });
            }
            
            // Charger les préférences Aero Glass
            setTimeout(() => {
                loadAeroPreferences();
            }, 1000);
            
            console.log('🎮 Jeu initialisé avec système Aero Glass avancé');
        };
    </script>
</body>
</html>
