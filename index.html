<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Country Balls: Mariage ğŸ’•</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap');
        
        * {
            font-family: 'Nunito', sans-serif;
        }
        
        body {
            transition: all 0.3s ease;
        }
        
        .flag-heart {
            background: linear-gradient(45deg, #FF6B9D, #FFB5C5);
            border-radius: 50%;
            box-shadow: 0 8px 25px rgba(255, 107, 157, 0.3);
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .flag-heart:hover {
            transform: translateY(-5px) scale(1.05);
            box-shadow: 0 12px 35px rgba(255, 107, 157, 0.5);
        }
        
        .btn {
            transition: all 0.3s ease;
            border: none;
            border-radius: 12px;
            padding: 12px 24px;
            font-weight: 600;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        
        .btn-primary {
            background: linear-gradient(45deg, #5D5CDE, #7C4DFF);
            color: white;
        }
        
        .btn-success {
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
        }
        
        .btn-warning {
            background: linear-gradient(45deg, #ffc107, #fd7e14);
            color: white;
        }
        
        .btn-secondary {
            background: linear-gradient(45deg, #6c757d, #495057);
            color: white;
        }

        .btn-info {
            background: linear-gradient(45deg, #0ea5e9, #2563eb);
            color: white;
        }

        .dark .btn-info {
            background: linear-gradient(45deg, #2563eb, #0ea5e9) !important;
        }
        
        .message {
            padding: 20px;
            border-radius: 15px;
            margin: 15px 0;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            animation: slideIn 0.5s ease-out;
        }
        
        .message.success {
            background: linear-gradient(45deg, #d4edda, #c3e6cb);
            border-left: 5px solid #28a745;
        }
        
        .message.error {
            background: linear-gradient(45deg, #f8d7da, #f1b0b7);
            border-left: 5px solid #dc3545;
        }
        
        .message.special {
            background: linear-gradient(45deg, #e2e3ff, #c8ccff);
            border-left: 5px solid #5D5CDE;
        }
        
        .message.impossible-message {
            background: linear-gradient(45deg, #FF6B6B, #FF8E53);
            color: white;
            border: 2px solid #FF4444;
        }
        
        .special-message {
            padding: 25px;
            border-radius: 15px;
            margin: 20px 0;
            text-align: center;
            color: white;
            font-weight: 600;
            box-shadow: 0 8px 30px rgba(0,0,0,0.2);
        }
        
        .heart-animation {
            position: fixed;
            font-size: 30px;
            pointer-events: none;
            z-index: 1000;
            animation: floatUp 2s ease-out forwards;
        }
        
        .country-card {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 20px;
            padding: 25px;
            margin: 20px 0;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }
        
        .country-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 20px 50px rgba(0,0,0,0.15);
            border-color: #5D5CDE;
        }
        
        .xp-bar {
            background: linear-gradient(90deg, #5D5CDE, #7C4DFF);
            height: 12px;
            border-radius: 6px;
            transition: width 0.8s ease;
            position: relative;
            overflow: hidden;
        }
        
        .xp-bar::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            animation: shimmer 2s infinite;
        }
        
        /* Mode sombre amÃ©liorÃ© */
        .dark,
        .dark body,
        html.dark,
        html.dark body {
            background-color: #181818 !important;
            color: #ffffff !important;
        }
        
        .dark .country-card {
            background: rgba(30, 30, 30, 0.9) !important;
            border-color: #444 !important;
            color: #ffffff !important;
        }
        
        .dark .btn-primary {
            background: linear-gradient(45deg, #7C4DFF, #5D5CDE) !important;
        }
        
        .dark .message.success {
            background: linear-gradient(45deg, #1a4532, #166534) !important;
            color: #ffffff !important;
        }
        
        .dark .message.error {
            background: linear-gradient(45deg, #4c1d24, #7f1d1d) !important;
            color: #ffffff !important;
        }
        
        .dark .message.special {
            background: linear-gradient(45deg, #312e81, #3730a3) !important;
            color: #ffffff !important;
        }
        
        /* Forcer le fond sombre partout */
        html[data-theme="dark"],
        html[data-theme="dark"] body,
        .dark,
        .dark body {
            background: #181818 !important;
            color: #ffffff !important;
        }
        
        /* Container principal en mode sombre */
        .dark .container {
            background: transparent !important;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-30px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        @keyframes floatUp {
            from {
                opacity: 1;
                transform: translateY(0);
            }
            to {
                opacity: 0;
                transform: translateY(-100px);
            }
        }
        
        @keyframes shimmer {
            0% { left: -100%; }
            100% { left: 100%; }
        }
        
        @keyframes heartbeat {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        
        /* Animations pour jalousie et guerre */
        @keyframes dramaticPulse {
            0%, 100% { transform: scale(1); box-shadow: 0 0 20px rgba(255, 0, 0, 0.5); }
            50% { transform: scale(1.03); box-shadow: 0 0 30px rgba(255, 0, 0, 0.8); }
        }
        
        @keyframes warAlert {
            0%, 100% { 
                box-shadow: 0 0 40px rgba(255, 0, 0, 0.8);
                border-color: #FF0000;
            }
            50% { 
                box-shadow: 0 0 60px rgba(255, 255, 0, 1);
                border-color: #FFFF00;
            }
        }
        
        @keyframes explosionBlink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
        
        @keyframes warShake {
            0%, 100% { transform: translateX(0) translateY(0); }
            25% { transform: translateX(-8px) translateY(-5px); }
            75% { transform: translateX(8px) translateY(5px); }
        }
        
        @keyframes explosionPop {
            0% { transform: scale(0); opacity: 1; }
            50% { transform: scale(2); opacity: 0.9; }
            100% { transform: scale(3); opacity: 0; }
        }
        
        @keyframes warFlash {
            0%, 100% { opacity: 0; }
            50% { opacity: 1; }
        }
        
        @keyframes nuclearFlash {
            0% { opacity: 0; transform: scale(0); }
            25% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.9; transform: scale(1.5); }
            100% { opacity: 0; transform: scale(4); }
        }
        
        @keyframes mushroomRise {
            0% { 
                transform: translate(-50%, 150%); 
                opacity: 0; 
                font-size: 50px; 
            }
            50% { 
                transform: translate(-50%, -30%); 
                opacity: 1; 
                font-size: 100px; 
            }
            100% { 
                transform: translate(-50%, -50%); 
                opacity: 0.8; 
                font-size: 150px; 
            }
        }
        
        @keyframes heartsFloat {
            0% { transform: translateY(30px); opacity: 0; }
            50% { transform: translateY(-15px); opacity: 1; }
            100% { transform: translateY(0); opacity: 1; }
        }
        
        @keyframes tensionFlash {
            0%, 100% { opacity: 0; }
            50% { opacity: 1; }
        }
        
        /* ========================================== */
        /* STYLES POUR LE TCHAT INTERACTIF */
        /* ========================================== */
        
        .chat-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 350px;
            height: 500px;
            z-index: 1000;
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }
        
        .chat-container.minimized {
            height: 60px;
            width: 200px;
        }
        
        .chat-window {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            height: 100%;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .dark .chat-window {
            background: rgba(30, 30, 30, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .chat-header {
            padding: 15px 20px;
            background: linear-gradient(135deg, rgba(93, 92, 222, 0.1), rgba(124, 77, 255, 0.1));
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-radius: 20px 20px 0 0;
        }
        
        .chat-partner-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .chat-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(45deg, #5D5CDE, #7C4DFF);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            color: white;
            font-weight: bold;
        }
        
        .chat-partner-details h4 {
            margin: 0;
            font-size: 16px;
            font-weight: 600;
            color: #333;
        }
        
        .dark .chat-partner-details h4 {
            color: #fff;
        }
        
        .chat-partner-details p {
            margin: 0;
            font-size: 12px;
            color: #666;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .dark .chat-partner-details p {
            color: #ccc;
        }
        
        .chat-controls {
            display: flex;
            gap: 8px;
        }
        
        .chat-btn {
            width: 32px;
            height: 32px;
            border: none;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            color: #5D5CDE;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            font-size: 14px;
        }
        
        .chat-btn:hover {
            background: rgba(93, 92, 222, 0.2);
            transform: scale(1.1);
        }
        
        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .chat-messages::-webkit-scrollbar {
            width: 4px;
        }
        
        .chat-messages::-webkit-scrollbar-track {
            background: transparent;
        }
        
        .chat-messages::-webkit-scrollbar-thumb {
            background: rgba(93, 92, 222, 0.3);
            border-radius: 2px;
        }
        
        .message-bubble {
            max-width: 80%;
            padding: 12px 16px;
            border-radius: 18px;
            font-size: 14px;
            line-height: 1.4;
            animation: messageSlideIn 0.3s ease-out;
            position: relative;
        }
        
        .message-bubble.sent {
            align-self: flex-end;
            background: linear-gradient(135deg, #5D5CDE, #7C4DFF);
            color: white;
            border-bottom-right-radius: 6px;
        }
        
        .message-bubble.received {
            align-self: flex-start;
            background: rgba(240, 240, 240, 0.8);
            color: #333;
            border-bottom-left-radius: 6px;
        }
        
        .dark .message-bubble.received {
            background: rgba(60, 60, 60, 0.8);
            color: #fff;
        }
        
        .message-time {
            font-size: 10px;
            opacity: 0.7;
            margin-top: 4px;
        }
        
        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 16px;
            background: rgba(240, 240, 240, 0.8);
            border-radius: 18px;
            border-bottom-left-radius: 6px;
            max-width: 80%;
            align-self: flex-start;
        }
        
        .dark .typing-indicator {
            background: rgba(60, 60, 60, 0.8);
        }
        
        .typing-dots {
            display: flex;
            gap: 3px;
        }
        
        .typing-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #999;
            animation: typingDot 1.4s ease-in-out infinite both;
        }
        
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        .typing-dot:nth-child(3) { animation-delay: 0s; }
        
        .chat-input-area {
            padding: 15px 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(255, 255, 255, 0.05);
            border-radius: 0 0 20px 20px;
        }
        
        .quick-messages {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
            flex-wrap: wrap;
        }
        
        .quick-msg-btn {
            padding: 6px 12px;
            border: 1px solid rgba(93, 92, 222, 0.3);
            border-radius: 15px;
            background: rgba(93, 92, 222, 0.1);
            color: #5D5CDE;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .quick-msg-btn:hover {
            background: rgba(93, 92, 222, 0.2);
            transform: translateY(-1px);
        }
        
        .chat-input-container {
            display: flex;
            gap: 8px;
            align-items: flex-end;
        }
        
        .chat-input {
            flex: 1;
            padding: 12px 16px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            background: rgba(255, 255, 255, 0.8);
            font-size: 14px;
            resize: none;
            max-height: 80px;
            min-height: 44px;
        }
        
        .dark .chat-input {
            background: rgba(60, 60, 60, 0.8);
            color: #fff;
            border-color: rgba(255, 255, 255, 0.1);
        }
        
        .chat-input:focus {
            outline: none;
            border-color: #5D5CDE;
            box-shadow: 0 0 0 2px rgba(93, 92, 222, 0.2);
        }
        
        .emoji-btn {
            width: 44px;
            height: 44px;
            border: none;
            border-radius: 50%;
            background: linear-gradient(45deg, #5D5CDE, #7C4DFF);
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            font-size: 18px;
        }
        
        .emoji-btn:hover {
            transform: scale(1.1);
        }
        
        .send-btn {
            width: 44px;
            height: 44px;
            border: none;
            border-radius: 50%;
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            font-size: 16px;
        }
        
        .send-btn:hover {
            transform: scale(1.1);
        }
        
        .send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .emoji-picker {
            position: absolute;
            bottom: 60px;
            right: 60px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 15px;
            padding: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            display: none;
            grid-template-columns: repeat(6, 1fr);
            gap: 8px;
            max-width: 250px;
        }
        
        .dark .emoji-picker {
            background: rgba(30, 30, 30, 0.95);
            border-color: rgba(255, 255, 255, 0.1);
        }
        
        .emoji-picker.show {
            display: grid;
            animation: fadeIn 0.2s ease-out;
        }
        
        .emoji-option {
            width: 32px;
            height: 32px;
            border: none;
            border-radius: 8px;
            background: transparent;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .emoji-option:hover {
            background: rgba(93, 92, 222, 0.1);
            transform: scale(1.2);
        }
        
        .chat-notification {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #ff4444;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        
        @keyframes messageSlideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes typingDot {
            0%, 80%, 100% {
                transform: scale(0);
                opacity: 0.5;
            }
            40% {
                transform: scale(1);
                opacity: 1;
            }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }
        
        /* ========================================== */
        /* NOUVELLES FONCTIONNALITÃ‰S CHAT AVANCÃ‰ES */
        /* ========================================== */
        
        /* RÃ©actions sur les messages */
        .message-reactions {
            margin-top: 8px;
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }
        
        .message-bubble:hover .reaction-add-btn {
            opacity: 1;
        }
        
        .reaction-add-btn {
            position: absolute;
            top: -15px;
            right: 10px;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid rgba(0, 0, 0, 0.1);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            opacity: 0;
            transition: all 0.2s ease;
            z-index: 10;
        }
        
        .reaction-add-btn:hover {
            transform: scale(1.1);
            background: rgba(93, 92, 222, 0.1);
        }
        
        .reaction-item {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 12px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 1px solid rgba(0, 0, 0, 0.1);
        }
        
        .dark .reaction-item {
            background: rgba(60, 60, 60, 0.8);
            color: #fff;
        }
        
        .reaction-item:hover {
            transform: scale(1.05);
            background: rgba(93, 92, 222, 0.2);
        }
        
        .reaction-item.selected {
            background: linear-gradient(45deg, #5D5CDE, #7C4DFF);
            color: white;
        }
        
        /* Sondages */
        .poll-container {
            background: linear-gradient(135deg, rgba(93, 92, 222, 0.1), rgba(124, 77, 255, 0.1));
            border-radius: 15px;
            padding: 15px;
            margin: 10px 0;
            border: 1px solid rgba(93, 92, 222, 0.3);
        }
        
        .poll-question {
            font-weight: 600;
            margin-bottom: 12px;
            color: #5D5CDE;
        }
        
        .dark .poll-question {
            color: #7C4DFF;
        }
        
        .poll-options {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .poll-option {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.7);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
        }
        
        .dark .poll-option {
            background: rgba(60, 60, 60, 0.7);
        }
        
        .poll-option:hover {
            background: rgba(93, 92, 222, 0.2);
        }
        
        .poll-option.voted {
            background: rgba(93, 92, 222, 0.3);
            cursor: default;
        }
        
        .poll-progress {
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            background: linear-gradient(90deg, rgba(93, 92, 222, 0.4), rgba(124, 77, 255, 0.4));
            transition: width 0.8s ease;
            z-index: 1;
        }
        
        .poll-option-content {
            position: relative;
            z-index: 2;
            display: flex;
            align-items: center;
            gap: 10px;
            width: 100%;
        }
        
        .poll-percentage {
            margin-left: auto;
            font-weight: 600;
            font-size: 14px;
        }
        
        /* Drama Cards */
        .drama-card {
            background: linear-gradient(135deg, #FF6B6B, #FF8E53);
            color: white;
            border-radius: 15px;
            padding: 20px;
            margin: 15px 0;
            text-align: center;
            box-shadow: 0 8px 25px rgba(255, 107, 107, 0.3);
            animation: dramaticEntrance 0.8s ease-out;
            position: relative;
            overflow: hidden;
        }
        
        .drama-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            animation: cardShimmer 2s ease-in-out infinite;
        }
        
        .drama-card-header {
            font-size: 24px;
            margin-bottom: 10px;
        }
        
        .drama-card-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 8px;
        }
        
        .drama-card-description {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 15px;
        }
        
        .drama-card-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        /* Messages de guerre */
        .war-chat-mode .chat-window {
            border: 2px solid #FF0000;
            animation: warPulse 2s ease-in-out infinite;
        }
        
        .war-chat-mode .chat-header {
            background: linear-gradient(135deg, rgba(255, 0, 0, 0.2), rgba(255, 68, 68, 0.2));
        }
        
        .war-message {
            background: linear-gradient(135deg, #FF4444, #FF0000);
            color: white;
            border-radius: 15px;
            padding: 15px;
            margin: 10px 0;
            text-align: center;
            animation: warAlert 1s ease-in-out infinite;
        }
        
        /* SystÃ¨me de cadeaux */
        .gift-container {
            background: linear-gradient(135deg, #FFD700, #FFA500);
            border-radius: 15px;
            padding: 15px;
            margin: 10px 0;
            text-align: center;
            color: #8B4513;
            border: 2px solid #FFD700;
            animation: giftSparkle 2s ease-in-out infinite;
        }
        
        .gift-emoji {
            font-size: 48px;
            margin-bottom: 10px;
            animation: giftBounce 1s ease-in-out infinite;
        }
        
        .gift-text {
            font-weight: 600;
            font-size: 16px;
        }
        
        .gift-picker {
            position: absolute;
            bottom: 60px;
            right: 120px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            display: none;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            max-width: 200px;
        }
        
        .dark .gift-picker {
            background: rgba(30, 30, 30, 0.95);
        }
        
        .gift-picker.show {
            display: grid;
            animation: fadeIn 0.2s ease-out;
        }
        
        .gift-option {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            padding: 15px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            background: rgba(255, 255, 255, 0.5);
        }
        
        .dark .gift-option {
            background: rgba(60, 60, 60, 0.5);
        }
        
        .gift-option:hover {
            background: rgba(93, 92, 222, 0.2);
            transform: scale(1.05);
        }
        
        .gift-option-emoji {
            font-size: 32px;
        }
        
        .gift-option-text {
            font-size: 10px;
            text-align: center;
            font-weight: 600;
        }
        
        /* Mission coopÃ©rative */
        .coop-mission {
            background: linear-gradient(135deg, #4ECDC4, #44A08D);
            color: white;
            border-radius: 15px;
            padding: 20px;
            margin: 15px 0;
            text-align: center;
            border: 2px solid #4ECDC4;
        }
        
        .coop-mission-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 12px;
        }
        
        .coop-mission-question {
            font-size: 16px;
            margin-bottom: 15px;
            background: rgba(255, 255, 255, 0.2);
            padding: 10px;
            border-radius: 10px;
        }
        
        .coop-mission-answers {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .coop-answer {
            padding: 10px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 2px solid transparent;
        }
        
        .coop-answer:hover {
            background: rgba(255, 255, 255, 0.4);
        }
        
        .coop-answer.selected {
            border-color: white;
            background: rgba(255, 255, 255, 0.5);
        }
        
        .coop-answer.correct {
            background: rgba(40, 167, 69, 0.7);
        }
        
        .coop-answer.incorrect {
            background: rgba(220, 53, 69, 0.7);
        }
        
        /* Historique des dramas */
        .drama-history {
            max-height: 300px;
            overflow-y: auto;
            padding: 10px;
        }
        
        .drama-history-item {
            background: rgba(255, 255, 255, 0.8);
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 10px;
            border-left: 4px solid #FF6B6B;
        }
        
        .dark .drama-history-item {
            background: rgba(60, 60, 60, 0.8);
        }
        
        .drama-history-date {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }
        
        .dark .drama-history-date {
            color: #ccc;
        }
        
        .drama-history-type {
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .drama-history-impact {
            font-size: 14px;
            color: #FF6B6B;
        }
        
        /* Onglets du chat */
        .chat-tabs {
            display: flex;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(255, 255, 255, 0.05);
        }
        
        .chat-tab {
            flex: 1;
            padding: 12px;
            text-align: center;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            color: #666;
            transition: all 0.2s ease;
            border-bottom: 3px solid transparent;
        }
        
        .dark .chat-tab {
            color: #ccc;
        }
        
        .chat-tab:hover {
            background: rgba(93, 92, 222, 0.1);
        }
        
        .chat-tab.active {
            color: #5D5CDE;
            border-bottom-color: #5D5CDE;
            background: rgba(93, 92, 222, 0.1);
        }
        
        .chat-tab-content {
            display: none;
            flex: 1;
            overflow: hidden;
        }
        
        .chat-tab-content.active {
            display: flex;
            flex-direction: column;
        }
        
        /* Animations spÃ©ciales */
        @keyframes dramaticEntrance {
            0% { transform: scale(0.8) rotate(-5deg); opacity: 0; }
            50% { transform: scale(1.05) rotate(2deg); }
            100% { transform: scale(1) rotate(0deg); opacity: 1; }
        }
        
        @keyframes cardShimmer {
            0% { left: -100%; }
            100% { left: 100%; }
        }
        
        @keyframes warPulse {
            0%, 100% { box-shadow: 0 0 20px rgba(255, 0, 0, 0.5); }
            50% { box-shadow: 0 0 40px rgba(255, 0, 0, 0.8); }
        }
        
        @keyframes giftSparkle {
            0%, 100% { box-shadow: 0 0 20px rgba(255, 215, 0, 0.5); }
            50% { box-shadow: 0 0 30px rgba(255, 215, 0, 0.8); }
        }
        
        @keyframes giftBounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        
        /* Animations pour les ruptures dramatiques */
        @keyframes breakupFall {
            0% { 
                transform: translateY(0) rotate(0deg); 
                opacity: 1; 
            }
            100% { 
                transform: translateY(100vh) rotate(360deg); 
                opacity: 0; 
            }
        }
        
        @keyframes breakupShake {
            0%, 100% { transform: translateX(0) translateY(0); }
            10% { transform: translateX(-10px) translateY(-5px); }
            20% { transform: translateX(10px) translateY(5px); }
            30% { transform: translateX(-8px) translateY(-3px); }
            40% { transform: translateX(8px) translateY(3px); }
            50% { transform: translateX(-6px) translateY(-2px); }
            60% { transform: translateX(6px) translateY(2px); }
            70% { transform: translateX(-4px) translateY(-1px); }
            80% { transform: translateX(4px) translateY(1px); }
            90% { transform: translateX(-2px) translateY(0); }
        }
        
        @keyframes sadnessOverlay {
            0% { opacity: 0; }
            50% { opacity: 0.6; }
            100% { opacity: 0; }
        }
        
        @keyframes breakupDisappear {
            0% {
                transform: scale(1);
                opacity: 1;
            }
            50% { 
                transform: scale(0.95); 
                opacity: 0.5; 
            }
            100% {
                transform: scale(0.8);
                opacity: 0;
            }
        }

        /* Quiz culturel */
        .quiz-card {
            background: rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(15px);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }

        .dark .quiz-card {
            background: rgba(30, 30, 30, 0.6);
        }

        .quiz-option {
            width: 100%;
        }

        .quiz-option.correct {
            background: linear-gradient(45deg, #16a34a, #15803d);
            color: white;
        }

        .quiz-option.incorrect {
            background: linear-gradient(45deg, #dc2626, #b91c1c);
            color: white;
        }

        /* Responsive design pour mobile */
        @media (max-width: 768px) {
            .chat-container {
                width: calc(100vw - 20px);
                right: 10px;
                left: 10px;
                bottom: 10px;
            }
            
            .chat-container.minimized {
                width: 180px;
                right: 10px;
                left: auto;
            }
            
            .gift-picker {
                right: 10px;
                max-width: 150px;
                grid-template-columns: repeat(2, 1fr);
            }
            
            .coop-mission-answers {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body class="min-h-screen bg-white text-gray-800 transition-colors duration-300">
    <div class="container mx-auto px-4 py-8 max-w-4xl">
        <!-- Header -->
        <header class="text-center mb-8">
            <h1 class="text-4xl md:text-5xl font-bold bg-gradient-to-r from-pink-500 to-purple-600 bg-clip-text text-transparent mb-4">
                ğŸ’• Country Balls: Mariage ğŸ’•
            </h1>
            <p class="text-lg text-gray-600 dark:text-gray-300">
                Trouvez l'amour Ã  travers le monde ! ğŸŒğŸ’–
            </p>
            
            <!-- Bouton de thÃ¨me -->
            <button id="themeToggle" class="btn btn-secondary mt-4" onclick="toggleTheme()">
                ğŸŒ™ Mode Sombre
            </button>
        </header>

        <!-- Ã‰cran de crÃ©ation de personnage -->
        <div id="characterCreation" class="text-center">
            <div class="country-card">
                <h2 class="text-3xl font-bold mb-6 text-center">âœ¨ CrÃ©ation de votre Country Ball âœ¨</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div>
                        <label class="block text-lg font-semibold mb-3">ğŸ‘¤ PrÃ©nom :</label>
                        <input type="text" id="firstName" placeholder="Votre prÃ©nom..." 
                               class="w-full p-4 border-2 border-purple-300 rounded-lg text-base focus:border-purple-500 focus:outline-none transition-colors duration-300 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                    </div>
                    
                    <div>
                        <label class="block text-lg font-semibold mb-3">ğŸ·ï¸ Nom de famille :</label>
                        <input type="text" id="lastName" placeholder="Votre nom..." 
                               class="w-full p-4 border-2 border-purple-300 rounded-lg text-base focus:border-purple-500 focus:outline-none transition-colors duration-300 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                    </div>
                    
                    <div>
                        <label class="block text-lg font-semibold mb-3">âš§ï¸ Genre :</label>
                        <select id="genderSelect" 
                                class="w-full p-4 border-2 border-purple-300 rounded-lg text-base focus:border-purple-500 focus:outline-none transition-colors duration-300 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                            <option value="">Choisissez...</option>
                            <option value="male">ğŸ‘¨ Homme</option>
                            <option value="female">ğŸ‘© Femme</option>
                        </select>
                    </div>
                </div>
                
                <div class="mt-6">
                    <label class="block text-lg font-semibold mb-3">ğŸ³ï¸ Choisissez votre pays :</label>
                    <select id="countrySelect" 
                            class="w-full p-4 border-2 border-purple-300 rounded-lg text-base focus:border-purple-500 focus:outline-none transition-colors duration-300 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                        <option value="">SÃ©lectionnez un pays...</option>
                        <option value="France">ğŸ‡«ğŸ‡· France</option>
                        <option value="Germany">ğŸ‡©ğŸ‡ª Allemagne</option>
                        <option value="United States">ğŸ‡ºğŸ‡¸ Ã‰tats-Unis</option>
                        <option value="Japan">ğŸ‡¯ğŸ‡µ Japon</option>
                        <option value="United Kingdom">ğŸ‡¬ğŸ‡§ Royaume-Uni</option>
                        <option value="Italy">ğŸ‡®ğŸ‡¹ Italie</option>
                        <option value="Spain">ğŸ‡ªğŸ‡¸ Espagne</option>
                        <option value="Canada">ğŸ‡¨ğŸ‡¦ Canada</option>
                        <option value="Australia">ğŸ‡¦ğŸ‡º Australie</option>
                        <option value="Brazil">ğŸ‡§ğŸ‡· BrÃ©sil</option>
                        <option value="Mexico">ğŸ‡²ğŸ‡½ Mexique</option>
                        <option value="China">ğŸ‡¨ğŸ‡³ Chine</option>
                        <option value="India">ğŸ‡®ğŸ‡³ Inde</option>
                        <option value="South Korea">ğŸ‡°ğŸ‡· CorÃ©e du Sud</option>
                        <option value="Russia">ğŸ‡·ğŸ‡º Russie</option>
                        <option value="Netherlands">ğŸ‡³ğŸ‡± Pays-Bas</option>
                        <option value="Sweden">ğŸ‡¸ğŸ‡ª SuÃ¨de</option>
                        <option value="Norway">ğŸ‡³ğŸ‡´ NorvÃ¨ge</option>
                        <option value="Denmark">ğŸ‡©ğŸ‡° Danemark</option>
                        <option value="Finland">ğŸ‡«ğŸ‡® Finlande</option>
                        <option value="Switzerland">ğŸ‡¨ğŸ‡­ Suisse</option>
                        <option value="Belgium">ğŸ‡§ğŸ‡ª Belgique</option>
                        <option value="Austria">ğŸ‡¦ğŸ‡¹ Autriche</option>
                        <option value="Portugal">ğŸ‡µğŸ‡¹ Portugal</option>
                        <option value="Poland">ğŸ‡µğŸ‡± Pologne</option>
                        <option value="Czech Republic">ğŸ‡¨ğŸ‡¿ RÃ©publique tchÃ¨que</option>
                        <option value="Greece">ğŸ‡¬ğŸ‡· GrÃ¨ce</option>
                        <option value="Turkey">ğŸ‡¹ğŸ‡· Turquie</option>
                        <option value="Egypt">ğŸ‡ªğŸ‡¬ Ã‰gypte</option>
                        <option value="Morocco">ğŸ‡²ğŸ‡¦ Maroc</option>
                        <option value="Algeria">ğŸ‡©ğŸ‡¿ AlgÃ©rie</option>
                        <option value="Kabylia">âµ£ Kabylie</option>
                        <option value="Tunisia">ğŸ‡¹ğŸ‡³ Tunisie</option>
                        <option value="South Africa">ğŸ‡¿ğŸ‡¦ Afrique du Sud</option>
                        <option value="Nigeria">ğŸ‡³ğŸ‡¬ Nigeria</option>
                        <option value="Kenya">ğŸ‡°ğŸ‡ª Kenya</option>
                        <option value="Argentina">ğŸ‡¦ğŸ‡· Argentine</option>
                        <option value="Chile">ğŸ‡¨ğŸ‡± Chili</option>
                        <option value="Peru">ğŸ‡µğŸ‡ª PÃ©rou</option>
                        <option value="Colombia">ğŸ‡¨ğŸ‡´ Colombie</option>
                        <option value="Venezuela">ğŸ‡»ğŸ‡ª Venezuela</option>
                        <option value="Thailand">ğŸ‡¹ğŸ‡­ ThaÃ¯lande</option>
                        <option value="Vietnam">ğŸ‡»ğŸ‡³ Vietnam</option>
                        <option value="Philippines">ğŸ‡µğŸ‡­ Philippines</option>
                        <option value="Indonesia">ğŸ‡®ğŸ‡© IndonÃ©sie</option>
                        <option value="Malaysia">ğŸ‡²ğŸ‡¾ Malaisie</option>
                        <option value="Singapore">ğŸ‡¸ğŸ‡¬ Singapour</option>
                        <option value="New Zealand">ğŸ‡³ğŸ‡¿ Nouvelle-ZÃ©lande</option>
                        <option value="Israel">ğŸ‡®ğŸ‡± IsraÃ«l</option>
                        <option value="Saudi Arabia">ğŸ‡¸ğŸ‡¦ Arabie Saoudite</option>
                        <option value="UAE">ğŸ‡¦ğŸ‡ª Ã‰mirats Arabes Unis</option>
                        <option value="Iran">ğŸ‡®ğŸ‡· Iran</option>
                        <option value="Iraq">ğŸ‡®ğŸ‡¶ Irak</option>
                        <option value="Syria">ğŸ‡¸ğŸ‡¾ Syrie</option>
                        <option value="Lebanon">ğŸ‡±ğŸ‡§ Liban</option>
                        <option value="Jordan">ğŸ‡¯ğŸ‡´ Jordanie</option>
                        <option value="Palestine">ğŸ‡µğŸ‡¸ Palestine</option>
                        <option value="Libya">ğŸ‡±ğŸ‡¾ Libye</option>
                        <option value="Sudan">ğŸ‡¸ğŸ‡© Soudan</option>
                        <option value="Ethiopia">ğŸ‡ªğŸ‡¹ Ã‰thiopie</option>
                        <option value="Ghana">ğŸ‡¬ğŸ‡­ Ghana</option>
                        <option value="Ivory Coast">ğŸ‡¨ğŸ‡® CÃ´te d'Ivoire</option>
                        <option value="Senegal">ğŸ‡¸ğŸ‡³ SÃ©nÃ©gal</option>
                        <option value="Mali">ğŸ‡²ğŸ‡± Mali</option>
                        <option value="Burkina Faso">ğŸ‡§ğŸ‡« Burkina Faso</option>
                        <option value="Niger">ğŸ‡³ğŸ‡ª Niger</option>
                        <option value="Chad">ğŸ‡¹ğŸ‡© Tchad</option>
                        <option value="Cameroon">ğŸ‡¨ğŸ‡² Cameroun</option>
                        <option value="Central African Republic">ğŸ‡¨ğŸ‡« RÃ©publique centrafricaine</option>
                        <option value="Democratic Republic of Congo">ğŸ‡¨ğŸ‡© RÃ©publique dÃ©mocratique du Congo</option>
                        <option value="Republic of Congo">ğŸ‡¨ğŸ‡¬ RÃ©publique du Congo</option>
                        <option value="Gabon">ğŸ‡¬ğŸ‡¦ Gabon</option>
                        <option value="Equatorial Guinea">ğŸ‡¬ğŸ‡¶ GuinÃ©e Ã©quatoriale</option>
                        <option value="Sao Tome and Principe">ğŸ‡¸ğŸ‡¹ Sao TomÃ©-et-Principe</option>
                        <option value="Cape Verde">ğŸ‡¨ğŸ‡» Cap-Vert</option>
                        <option value="Guinea-Bissau">ğŸ‡¬ğŸ‡¼ GuinÃ©e-Bissau</option>
                        <option value="Guinea">ğŸ‡¬ğŸ‡³ GuinÃ©e</option>
                        <option value="Sierra Leone">ğŸ‡¸ğŸ‡± Sierra Leone</option>
                        <option value="Liberia">ğŸ‡±ğŸ‡· Liberia</option>
                        <option value="Togo">ğŸ‡¹ğŸ‡¬ Togo</option>
                        <option value="Benin">ğŸ‡§ğŸ‡¯ BÃ©nin</option>
                        <option value="Mauritania">ğŸ‡²ğŸ‡· Mauritanie</option>
                        <option value="Gambia">ğŸ‡¬ğŸ‡² Gambie</option>
                        <option value="Guinea">ğŸ‡¬ğŸ‡³ GuinÃ©e</option>
                        <option value="Madagascar">ğŸ‡²ğŸ‡¬ Madagascar</option>
                        <option value="Mauritius">ğŸ‡²ğŸ‡º Maurice</option>
                        <option value="Seychelles">ğŸ‡¸ğŸ‡¨ Seychelles</option>
                        <option value="Comoros">ğŸ‡°ğŸ‡² Comores</option>
                        <option value="Djibouti">ğŸ‡©ğŸ‡¯ Djibouti</option>
                        <option value="Eritrea">ğŸ‡ªğŸ‡· Ã‰rythrÃ©e</option>
                        <option value="Somalia">ğŸ‡¸ğŸ‡´ Somalie</option>
                        <option value="Uganda">ğŸ‡ºğŸ‡¬ Ouganda</option>
                        <option value="Tanzania">ğŸ‡¹ğŸ‡¿ Tanzanie</option>
                        <option value="Rwanda">ğŸ‡·ğŸ‡¼ Rwanda</option>
                        <option value="Burundi">ğŸ‡§ğŸ‡® Burundi</option>
                        <option value="Malawi">ğŸ‡²ğŸ‡¼ Malawi</option>
                        <option value="Zambia">ğŸ‡¿ğŸ‡² Zambie</option>
                        <option value="Zimbabwe">ğŸ‡¿ğŸ‡¼ Zimbabwe</option>
                        <option value="Botswana">ğŸ‡§ğŸ‡¼ Botswana</option>
                        <option value="Namibia">ğŸ‡³ğŸ‡¦ Namibie</option>
                        <option value="Lesotho">ğŸ‡±ğŸ‡¸ Lesotho</option>
                        <option value="Eswatini">ğŸ‡¸ğŸ‡¿ Eswatini</option>
                        <option value="Mozambique">ğŸ‡²ğŸ‡¿ Mozambique</option>
                        <option value="Angola">ğŸ‡¦ğŸ‡´ Angola</option>
                    </select>
                </div>
                
                <button id="startGameBtn" class="btn btn-primary mt-8 text-xl px-8 py-4" onclick="startMainGame()">
                    ğŸš€ Commencer l'aventure !
                </button>
            </div>
        </div>

        <!-- Jeu principal -->
        <div id="gameMain" class="hidden">
            <!-- Informations du joueur -->
            <div class="country-card mb-6">
                <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                    <div>
                        <h2 class="text-2xl font-bold" id="playerInfo">Joueur</h2>
                        <p class="text-gray-600 dark:text-gray-300" id="playerDetails">Niveau 1</p>
                    </div>
                    
                    <div class="flex-1 max-w-md">
                        <div class="flex justify-between text-sm mb-2">
                            <span>XP</span>
                            <span id="xpText">0 / 100</span>
                        </div>
                        <div class="bg-gray-200 dark:bg-gray-700 rounded-full h-3">
                            <div id="xpBar" class="xp-bar h-3 rounded-full" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Menu de navigation -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                <button class="btn btn-primary" onclick="showSection('explore')">
                    ğŸŒ Explorer
                </button>
                <button class="btn btn-success" onclick="showSection('marriage')">
                    ğŸ’’ Mariages
                </button>
                <button class="btn btn-warning" onclick="showSection('missions')">
                    ğŸ¯ Missions
                </button>
                <button class="btn btn-info" onclick="showSection('quiz')">
                    ğŸ“š Quiz
                </button>
                <button class="btn btn-secondary" onclick="showSection('saves')">
                    ğŸ’¾ Sauvegardes
                </button>
            </div>

            <!-- Section Explorer -->
            <div id="exploreSection" class="section">
                <div class="country-card">
                    <h3 class="text-2xl font-bold mb-6 text-center">ğŸŒ Explorez le monde et trouvez l'amour ! ğŸŒ</h3>
                    
                    <div class="text-center mb-6">
                        <button id="exploreBtn" class="btn btn-primary text-xl px-8 py-4" onclick="exploreWorld()">
                            ğŸš€ Explorer un pays alÃ©atoire !
                        </button>
                    </div>
                    
                    <div id="exploreResult" class="hidden"></div>
                </div>
            </div>

            <!-- Section Mariages -->
            <div id="marriageSection" class="section hidden">
                <div class="country-card">
                    <h3 class="text-2xl font-bold mb-6 text-center">ğŸ’’ Vos Mariages ğŸ’’</h3>
                    <div id="marriageList">
                        <p class="text-center text-gray-500 dark:text-gray-400">Aucun mariage pour le moment. Explorez le monde !</p>
                    </div>
                </div>
            </div>

            <!-- Section Missions -->
            <div id="missionsSection" class="section hidden">
                <div class="country-card">
                    <h3 class="text-2xl font-bold mb-6 text-center">ğŸ¯ Missions ğŸ¯</h3>
                    <div id="missionsList"></div>
                </div>
            </div>

            <!-- Section Quiz -->
            <div id="quizSection" class="section hidden">
                <div id="quizCard" class="quiz-card text-center">
                    <div id="quizQuestion" class="text-xl font-semibold mb-4"></div>
                    <div id="quizOptions" class="grid grid-cols-1 gap-4"></div>
                    <button id="nextQuestionBtn" class="btn btn-primary mt-4 hidden" onclick="nextQuizQuestion()">Question suivante</button>
                    <div id="quizScore" class="mt-4 text-lg font-bold"></div>
                </div>
            </div>

            <!-- Section Sauvegardes -->
            <div id="savesSection" class="section hidden">
                <div class="country-card">
                    <h3 class="text-2xl font-bold mb-6 text-center">ğŸ’¾ Sauvegardes ğŸ’¾</h3>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                        <button class="btn btn-success" onclick="showSaveMenu()">
                            ğŸ’¾ Sauvegarder
                        </button>
                        <button class="btn btn-warning" onclick="showLoadMenu()">
                            ğŸ“ Charger
                        </button>
                    </div>
                    
                    <div id="saveLoadContent"></div>
                </div>
            </div>

            <!-- Chat/Messages -->
            <div class="country-card mt-8">
                <h3 class="text-xl font-bold mb-4">ğŸ“± ActualitÃ©s et Messages</h3>
                <div id="messageContainer" class="space-y-3 max-h-96 overflow-y-auto">
                    <div class="message special">
                        ğŸ’• Bienvenue dans Country Balls: Mariage ! Explorez le monde et trouvez l'amour ! ğŸ’•
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Composant de tchat interactif AVANCÃ‰ -->
    <div id="chatContainer" class="chat-container hidden">
        <div class="chat-window">
            <!-- En-tÃªte du tchat -->
            <div class="chat-header">
                <div class="chat-partner-info">
                    <div class="chat-avatar" id="chatAvatar">ğŸ’•</div>
                    <div class="chat-partner-details">
                        <h4 id="chatPartnerName">Chat Romance</h4>
                        <p id="chatPartnerStatus">
                            <span class="online-indicator" style="width: 8px; height: 8px; background: #28a745; border-radius: 50%; display: inline-block; margin-right: 5px;"></span>
                            En ligne
                        </p>
                    </div>
                </div>
                
                <div class="chat-controls">
                    <button class="chat-btn" onclick="toggleChat()" title="RÃ©duire">
                        â–
                    </button>
                    <button class="chat-btn" onclick="closeChat()" title="Fermer">
                        âŒ
                    </button>
                </div>
            </div>
            
            <!-- Onglets du tchat -->
            <div class="chat-tabs">
                <div class="chat-tab active" onclick="switchChatTab('messages')">ğŸ’¬ Messages</div>
                <div class="chat-tab" onclick="switchChatTab('history')">ğŸ“– Historique</div>
            </div>
            
            <!-- Contenu des onglets -->
            <div class="chat-tab-content active" id="messagesTab">
                <!-- Messages du tchat -->
                <div class="chat-messages" id="chatMessages">
                    <div class="message-bubble received">
                        <div>Salut ! ğŸ‘‹ FÃ©licitations pour votre aventure romantique !</div>
                        <div class="message-time" id="welcomeTime"></div>
                        <!-- Bouton de rÃ©action -->
                        <button class="reaction-add-btn" onclick="showReactionPicker(this)">ğŸ˜Š</button>
                        <div class="message-reactions" id="reactions-0"></div>
                    </div>
                </div>
                
                <!-- Zone de saisie -->
                <div class="chat-input-area">
                    <!-- Messages rapides -->
                    <div class="quick-messages">
                        <button class="quick-msg-btn" onclick="sendQuickMessage('ğŸ’• Je t\'aime')">ğŸ’• Je t'aime</button>
                        <button class="quick-msg-btn" onclick="sendQuickMessage('ğŸ˜ Tu es magnifique')">ğŸ˜ Magnifique</button>
                        <button class="quick-msg-btn" onclick="sendQuickMessage('ğŸŒ¹ Pour toi')">ğŸŒ¹ Pour toi</button>
                        <button class="quick-msg-btn" onclick="sendQuickMessage('ğŸ’‘ Ensemble pour toujours')">ğŸ’‘ Ensemble</button>
                        <button class="quick-msg-btn" onclick="createPoll()">ğŸ“Š Sondage</button>
                        <button class="quick-msg-btn" onclick="triggerDramaCard()">ğŸ­ Drama</button>
                    </div>
                    
                    <!-- Barre de saisie -->
                    <div class="chat-input-container">
                        <textarea 
                            id="chatInput" 
                            class="chat-input" 
                            placeholder="Ã‰crivez votre message..."
                            rows="1"
                            onkeydown="handleChatKeydown(event)"
                            oninput="adjustTextareaHeight(this)"
                        ></textarea>
                        <button class="emoji-btn" onclick="toggleEmojiPicker()" title="Ã‰mojis">
                            ğŸ˜Š
                        </button>
                        <button class="emoji-btn" onclick="toggleGiftPicker()" title="Cadeaux" style="background: linear-gradient(45deg, #FFD700, #FFA500);">
                            ğŸ
                        </button>
                        <button class="send-btn" onclick="sendChatMessage()" title="Envoyer" id="chatSendBtn" disabled>
                            â¤
                        </button>
                    </div>
                    
                    <!-- SÃ©lecteur d'Ã©mojis -->
                    <div class="emoji-picker" id="emojiPicker">
                        <button class="emoji-option" onclick="addEmoji('ğŸ˜Š')">ğŸ˜Š</button>
                        <button class="emoji-option" onclick="addEmoji('ğŸ˜')">ğŸ˜</button>
                        <button class="emoji-option" onclick="addEmoji('ğŸ¥°')">ğŸ¥°</button>
                        <button class="emoji-option" onclick="addEmoji('ğŸ˜˜')">ğŸ˜˜</button>
                        <button class="emoji-option" onclick="addEmoji('ğŸ’•')">ğŸ’•</button>
                        <button class="emoji-option" onclick="addEmoji('ğŸ’–')">ğŸ’–</button>
                        <button class="emoji-option" onclick="addEmoji('ğŸ’—')">ğŸ’—</button>
                        <button class="emoji-option" onclick="addEmoji('ğŸ’˜')">ğŸ’˜</button>
                        <button class="emoji-option" onclick="addEmoji('ğŸ’')">ğŸ’</button>
                        <button class="emoji-option" onclick="addEmoji('ğŸ’')">ğŸ’</button>
                        <button class="emoji-option" onclick="addEmoji('ğŸ’“')">ğŸ’“</button>
                        <button class="emoji-option" onclick="addEmoji('â¤ï¸')">â¤ï¸</button>
                        <button class="emoji-option" onclick="addEmoji('ğŸŒ¹')">ğŸŒ¹</button>
                        <button class="emoji-option" onclick="addEmoji('ğŸŒº')">ğŸŒº</button>
                        <button class="emoji-option" onclick="addEmoji('ğŸŒ·')">ğŸŒ·</button>
                        <button class="emoji-option" onclick="addEmoji('ğŸŒ¸')">ğŸŒ¸</button>
                        <button class="emoji-option" onclick="addEmoji('ğŸ’')">ğŸ’</button>
                        <button class="emoji-option" onclick="addEmoji('ğŸ‰')">ğŸ‰</button>
                        <button class="emoji-option" onclick="addEmoji('ğŸŠ')">ğŸŠ</button>
                        <button class="emoji-option" onclick="addEmoji('âœ¨')">âœ¨</button>
                        <button class="emoji-option" onclick="addEmoji('ğŸ’«')">ğŸ’«</button>
                        <button class="emoji-option" onclick="addEmoji('â­')">â­</button>
                        <button class="emoji-option" onclick="addEmoji('ğŸŒŸ')">ğŸŒŸ</button>
                        <button class="emoji-option" onclick="addEmoji('ğŸ’¥')">ğŸ’¥</button>
                        <button class="emoji-option" onclick="addEmoji('ğŸ”¥')">ğŸ”¥</button>
                        <button class="emoji-option" onclick="addEmoji('ğŸ‘‘')">ğŸ‘‘</button>
                        <button class="emoji-option" onclick="addEmoji('ğŸ’')">ğŸ’</button>
                        <button class="emoji-option" onclick="addEmoji('ğŸ¾')">ğŸ¾</button>
                        <button class="emoji-option" onclick="addEmoji('ğŸ¥‚')">ğŸ¥‚</button>
                        <button class="emoji-option" onclick="addEmoji('ğŸ·')">ğŸ·</button>
                        <button class="emoji-option" onclick="addEmoji('ğŸ«')">ğŸ«</button>
                        <button class="emoji-option" onclick="addEmoji('ğŸ°')">ğŸ°</button>
                        <button class="emoji-option" onclick="addEmoji('ğŸ‚')">ğŸ‚</button>
                        <button class="emoji-option" onclick="addEmoji('ğŸ­')">ğŸ­</button>
                        <button class="emoji-option" onclick="addEmoji('ğŸ¯')">ğŸ¯</button>
                        <button class="emoji-option" onclick="addEmoji('ğŸŒ™')">ğŸŒ™</button>
                        <button class="emoji-option" onclick="addEmoji('â˜€ï¸')">â˜€ï¸</button>
                    </div>
                    
                    <!-- SÃ©lecteur de cadeaux -->
                    <div class="gift-picker" id="giftPicker">
                        <div class="gift-option" onclick="sendGift('ğŸ¥˜', 'Couscous kabyle')">
                            <div class="gift-option-emoji">ğŸ¥˜</div>
                            <div class="gift-option-text">Couscous</div>
                        </div>
                        <div class="gift-option" onclick="sendGift('ğŸµ', 'Musique traditionnelle')">
                            <div class="gift-option-emoji">ğŸµ</div>
                            <div class="gift-option-text">Musique</div>
                        </div>
                        <div class="gift-option" onclick="sendGift('ğŸ', 'Cadeau surprise')">
                            <div class="gift-option-emoji">ğŸ</div>
                            <div class="gift-option-text">Surprise</div>
                        </div>
                        <div class="gift-option" onclick="sendGift('ğŸŒ¹', 'Bouquet de roses')">
                            <div class="gift-option-emoji">ğŸŒ¹</div>
                            <div class="gift-option-text">Roses</div>
                        </div>
                        <div class="gift-option" onclick="sendGift('ğŸ’', 'Bague prÃ©cieuse')">
                            <div class="gift-option-emoji">ğŸ’</div>
                            <div class="gift-option-text">Bague</div>
                        </div>
                        <div class="gift-option" onclick="sendGift('ğŸ§¸', 'Peluche mignonne')">
                            <div class="gift-option-emoji">ğŸ§¸</div>
                            <div class="gift-option-text">Peluche</div>
                        </div>
                        <div class="gift-option" onclick="sendGift('ğŸ«', 'Chocolats fins')">
                            <div class="gift-option-emoji">ğŸ«</div>
                            <div class="gift-option-text">Chocolats</div>
                        </div>
                        <div class="gift-option" onclick="sendGift('ğŸ•¯ï¸', 'DÃ®ner romantique')">
                            <div class="gift-option-emoji">ğŸ•¯ï¸</div>
                            <div class="gift-option-text">DÃ®ner</div>
                        </div>
                        <div class="gift-option" onclick="sendGift('ğŸˆ', 'Ballons de fÃªte')">
                            <div class="gift-option-emoji">ğŸˆ</div>
                            <div class="gift-option-text">Ballons</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Onglet Historique des dramas -->
            <div class="chat-tab-content" id="historyTab">
                <div class="drama-history" id="dramaHistory">
                    <div class="text-center text-gray-500 dark:text-gray-400 p-4">
                        Aucun drama pour le moment... ğŸ˜Œ
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Notification de nouveaux messages -->
        <div class="chat-notification hidden" id="chatNotification">1</div>
    </div>

    <script>
        // Configuration du thÃ¨me dark/light
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });

        // Ã‰tat du jeu
        let gameState = {
            player: {
                firstName: '',
                lastName: '',
                country: '',
                fullName: '',
                gender: '',
                level: 1,
                xp: 0
            },
            currentSection: 'explore',
            theme: 'light'
        };

        // Historique des mariages
        let marriageHistory = [];
        let discoveredCouples = new Set();

        // SystÃ¨me de jalousie et guerre
        let relationshipStability = 100;
        let jealousyEvents = [];

        // Liste des pays avec emojis
        const countries = {
            'France': 'ğŸ‡«ğŸ‡·',
            'Germany': 'ğŸ‡©ğŸ‡ª',
            'United States': 'ğŸ‡ºğŸ‡¸',
            'Japan': 'ğŸ‡¯ğŸ‡µ',
            'United Kingdom': 'ğŸ‡¬ğŸ‡§',
            'Italy': 'ğŸ‡®ğŸ‡¹',
            'Spain': 'ğŸ‡ªğŸ‡¸',
            'Canada': 'ğŸ‡¨ğŸ‡¦',
            'Australia': 'ğŸ‡¦ğŸ‡º',
            'Brazil': 'ğŸ‡§ğŸ‡·',
            'Mexico': 'ğŸ‡²ğŸ‡½',
            'China': 'ğŸ‡¨ğŸ‡³',
            'India': 'ğŸ‡®ğŸ‡³',
            'South Korea': 'ğŸ‡°ğŸ‡·',
            'Russia': 'ğŸ‡·ğŸ‡º',
            'Netherlands': 'ğŸ‡³ğŸ‡±',
            'Sweden': 'ğŸ‡¸ğŸ‡ª',
            'Norway': 'ğŸ‡³ğŸ‡´',
            'Denmark': 'ğŸ‡©ğŸ‡°',
            'Finland': 'ğŸ‡«ğŸ‡®',
            'Switzerland': 'ğŸ‡¨ğŸ‡­',
            'Belgium': 'ğŸ‡§ğŸ‡ª',
            'Austria': 'ğŸ‡¦ğŸ‡¹',
            'Portugal': 'ğŸ‡µğŸ‡¹',
            'Poland': 'ğŸ‡µğŸ‡±',
            'Czech Republic': 'ğŸ‡¨ğŸ‡¿',
            'Greece': 'ğŸ‡¬ğŸ‡·',
            'Turkey': 'ğŸ‡¹ğŸ‡·',
            'Egypt': 'ğŸ‡ªğŸ‡¬',
            'Morocco': 'ğŸ‡²ğŸ‡¦',
            'Algeria': 'ğŸ‡©ğŸ‡¿',
            'Kabylia': 'âµ£',
            'Tunisia': 'ğŸ‡¹ğŸ‡³',
            'South Africa': 'ğŸ‡¿ğŸ‡¦',
            'Nigeria': 'ğŸ‡³ğŸ‡¬',
            'Kenya': 'ğŸ‡°ğŸ‡ª',
            'Argentina': 'ğŸ‡¦ğŸ‡·',
            'Chile': 'ğŸ‡¨ğŸ‡±',
            'Peru': 'ğŸ‡µğŸ‡ª',
            'Colombia': 'ğŸ‡¨ğŸ‡´',
            'Venezuela': 'ğŸ‡»ğŸ‡ª',
            'Thailand': 'ğŸ‡¹ğŸ‡­',
            'Vietnam': 'ğŸ‡»ğŸ‡³',
            'Philippines': 'ğŸ‡µğŸ‡­',
            'Indonesia': 'ğŸ‡®ğŸ‡©',
            'Malaysia': 'ğŸ‡²ğŸ‡¾',
            'Singapore': 'ğŸ‡¸ğŸ‡¬',
            'New Zealand': 'ğŸ‡³ğŸ‡¿',
            'Saudi Arabia': 'ğŸ‡¸ğŸ‡¦',
            'UAE': 'ğŸ‡¦ğŸ‡ª',
            'Iran': 'ğŸ‡®ğŸ‡·'
        };

        // Outils pour gÃ©rer les origines multiples
        function parseOrigins(country) {
            if (Array.isArray(country)) return country;
            if (countries[country]) return [country];
            return country.split(/[-\/]/).map(c => c.trim()).filter(Boolean);
        }

        function formatCountryName(country) {
            return parseOrigins(country).join(' - ');
        }

        function getFlags(country) {
            return parseOrigins(country).map(c => countries[c] || 'ğŸ³ï¸').join('-');
        }

        // PrÃ©noms par pays
        const namesByCountry = {
            'France': {
                male: ['Pierre', 'Jean', 'FranÃ§ois', 'Michel', 'Alain', 'Philippe', 'Daniel', 'Bernard', 'Christian', 'Thierry'],
                female: ['Marie', 'FranÃ§oise', 'Monique', 'Catherine', 'Isabelle', 'Sylvie', 'Christine', 'Brigitte', 'Martine', 'Nicole']
            },
            'Germany': {
                male: ['Hans', 'Wolfgang', 'Klaus', 'JÃ¼rgen', 'Dieter', 'Peter', 'Andreas', 'Thomas', 'Michael', 'Stefan'],
                female: ['Ursula', 'Ingrid', 'Monika', 'Petra', 'Sabine', 'Gabriele', 'Andrea', 'Susanne', 'Brigitte', 'Christine']
            },
            'United States': {
                male: ['James', 'Robert', 'John', 'Michael', 'David', 'William', 'Richard', 'Joseph', 'Thomas', 'Christopher'],
                female: ['Mary', 'Patricia', 'Jennifer', 'Linda', 'Elizabeth', 'Barbara', 'Susan', 'Jessica', 'Sarah', 'Karen']
            },
            'Japan': {
                male: ['Hiroshi', 'Takeshi', 'Akira', 'Satoshi', 'Kazuhiro', 'Masahiro', 'Yuji', 'Shinji', 'Koji', 'Taro'],
                female: ['Yoko', 'Keiko', 'Michiko', 'Naoko', 'Tomoko', 'Hiroko', 'Mayumi', 'Akiko', 'Kyoko', 'Noriko']
            },
            'United Kingdom': {
                male: ['James', 'John', 'Robert', 'Michael', 'William', 'David', 'Richard', 'Charles', 'Joseph', 'Thomas'],
                female: ['Mary', 'Patricia', 'Jennifer', 'Linda', 'Elizabeth', 'Barbara', 'Susan', 'Jessica', 'Sarah', 'Karen']
            },
            'Italy': {
                male: ['Giuseppe', 'Antonio', 'Mario', 'Francesco', 'Giovanni', 'Salvatore', 'Angelo', 'Vincenzo', 'Pietro', 'Carlo'],
                female: ['Maria', 'Anna', 'Giuseppina', 'Rosa', 'Angela', 'Giovanna', 'Teresa', 'Lucia', 'Carmela', 'Caterina']
            },
            'Spain': {
                male: ['Antonio', 'JosÃ©', 'Manuel', 'Francisco', 'Juan', 'David', 'JosÃ© Antonio', 'JosÃ© Luis', 'JesÃºs', 'Javier'],
                female: ['MarÃ­a Carmen', 'MarÃ­a', 'Carmen', 'Josefa', 'Isabel', 'Ana MarÃ­a', 'MarÃ­a Dolores', 'MarÃ­a Pilar', 'MarÃ­a Teresa', 'Ana']
            },
            'Brazil': {
                male: ['JosÃ©', 'JoÃ£o', 'Antonio', 'Francisco', 'Carlos', 'Paulo', 'Pedro', 'Lucas', 'Luiz', 'Marcos'],
                female: ['Maria', 'Ana', 'Francisca', 'Antonia', 'Adriana', 'Juliana', 'MÃ¡rcia', 'Fernanda', 'Patricia', 'Aline']
            },
            'Mexico': {
                male: ['JosÃ©', 'Luis', 'Juan', 'Miguel', 'Carlos', 'Antonio', 'Francisco', 'Alejandro', 'Rafael', 'JesÃºs'],
                female: ['MarÃ­a', 'Guadalupe', 'Juana', 'Margarita', 'Francisca', 'Rosa', 'Antonia', 'Ana', 'Carmen', 'Martha']
            },
            'China': {
                male: ['Wei', 'Ming', 'Jun', 'Qiang', 'Gang', 'Lei', 'Tao', 'Peng', 'Jie', 'Hao'],
                female: ['Li', 'Wang', 'Zhang', 'Liu', 'Chen', 'Yang', 'Zhao', 'Huang', 'Zhou', 'Wu']
            },
            'India': {
                male: ['Raj', 'Ravi', 'Anil', 'Sunil', 'Sanjay', 'Rakesh', 'Ajay', 'Vijay', 'Ashok', 'Deepak'],
                female: ['Sunita', 'Asha', 'Usha', 'Rekha', 'Meera', 'Pooja', 'Kavita', 'Anita', 'Sushma', 'Ritu']
            },
            'Russia': {
                male: ['ĞĞ»ĞµĞºÑĞ°Ğ½Ğ´Ñ€', 'Ğ¡ĞµÑ€Ğ³ĞµĞ¹', 'Ğ”Ğ¼Ğ¸Ñ‚Ñ€Ğ¸Ğ¹', 'ĞĞ½Ğ´Ñ€ĞµĞ¹', 'ĞĞ»ĞµĞºÑĞµĞ¹', 'ĞœĞ¸Ñ…Ğ°Ğ¸Ğ»', 'Ğ•Ğ²Ğ³ĞµĞ½Ğ¸Ğ¹', 'ĞĞ¸ĞºĞ¾Ğ»Ğ°Ğ¹', 'Ğ’Ğ»Ğ°Ğ´Ğ¸Ğ¼Ğ¸Ñ€', 'Ğ˜Ğ³Ğ¾Ñ€ÑŒ'],
                female: ['Ğ•Ğ»ĞµĞ½Ğ°', 'Ğ¢Ğ°Ñ‚ÑŒÑĞ½Ğ°', 'ĞĞ°Ñ‚Ğ°Ğ»ÑŒÑ', 'ĞĞ»ÑŒĞ³Ğ°', 'Ğ¡Ğ²ĞµÑ‚Ğ»Ğ°Ğ½Ğ°', 'Ğ›ÑĞ´Ğ¼Ğ¸Ğ»Ğ°', 'Ğ“Ğ°Ğ»Ğ¸Ğ½Ğ°', 'Ğ˜Ñ€Ğ¸Ğ½Ğ°', 'ĞĞ½Ğ½Ğ°', 'Ğ•ĞºĞ°Ñ‚ĞµÑ€Ğ¸Ğ½Ğ°']
            },
            'Kabylia': {
                male: ['Massinissa', 'Tarik', 'Youcef', 'Amirouche', 'Akli', 'Jugurtha', 'Mohand', 'Said', 'Larbi', 'Ouali'],
                female: ['Tamazight', 'Kahina', 'Fadhma', 'Malika', 'Zahra', 'Yamina', 'Tassadit', 'Djamila', 'Noura', 'Fatima']
            }
        };

        // Missions disponibles
        const missions = {
            'first_marriage': {
                title: 'ğŸ’‘ Premier Amour',
                description: 'Se marier pour la premiÃ¨re fois',
                reward: 100,
                completed: false
            },
            'five_marriages': {
                title: 'ğŸ’• Collectionneur de CÅ“urs',
                description: 'Se marier 5 fois',
                reward: 250,
                completed: false
            },
            'ten_marriages': {
                title: 'ğŸ‘‘ Roi/Reine du Mariage',
                description: 'Se marier 10 fois',
                reward: 500,
                completed: false
            },
            'continent_explorer': {
                title: 'ğŸŒ Explorateur Continental',
                description: 'Se marier avec des partenaires de 3 continents diffÃ©rents',
                reward: 300,
                completed: false
            },
            'polyglot': {
                title: 'ğŸ—£ï¸ Polyglotte Romantique',
                description: 'Se marier avec des partenaires parlant 5 langues diffÃ©rentes',
                reward: 400,
                completed: false
            },
            'diplomat': {
                title: 'ğŸ¤ Diplomate de l\'Amour',
                description: 'RÃ©soudre 3 conflits par la discussion',
                reward: 200,
                completed: false
            },
            'peace_maker': {
                title: 'ğŸ•Šï¸ Artisan de Paix',
                description: 'NÃ©gocier avec succÃ¨s 2 traitÃ©s de paix',
                reward: 300,
                completed: false
            }
        };

        // Questions du quiz culturel
        const quizQuestions = [
            {
                question: 'Quelle est la capitale du Maroc ?',
                options: ['Casablanca', 'Rabat', 'Marrakech', 'FÃ¨s'],
                correct: 1
            },
            {
                question: "Comment dit-on 'bonjour' en kabyle ?",
                options: ['Azul', 'Marhaban', 'Salam', 'Bonjour'],
                correct: 0
            },
            {
                question: 'Quelle spÃ©cialitÃ© libanaise est Ã  base de boulgour et de persil ?',
                options: ['TaboulÃ©', 'Couscous', 'Chawarma', 'Makroud'],
                correct: 0
            },
            {
                question: 'Quel est l\'instrument typique du folklore kabyle ?',
                options: ['Gimbri', 'Mandole', 'Guitare', 'Oud'],
                correct: 1
            },
            {
                question: 'Quel dessert marocain Ã  base d\'amandes est souvent servi aux mariages ?',
                options: ['Baklava', 'Cornes de gazelle', 'Tiramisu', 'Makrout'],
                correct: 1
            },
            {
                question: "Quelle ville est surnommÃ©e 'la perle du Nord' au Liban ?",
                options: ['Jounieh', 'Beyrouth', 'Tripoli', 'SaÃ¯da'],
                correct: 2
            },
            {
                question: 'Quelle langue parle-t-on principalement en Kabylie ?',
                options: ['Kabyle', 'Libanais', 'Darija', 'Anglais'],
                correct: 0
            },
            {
                question: 'Quel plat marocain est cuit dans un plat en terre cuite conique ?',
                options: ['Tajine', 'Briouate', 'Pastilla', 'Harira'],
                correct: 0
            }
        ];

        let quizIndex = 0;
        let quizScore = 0;

        // SystÃ¨me de sauvegarde avec auto-save
        let saveStatus = {
            hasUnsavedChanges: false,
            lastSaveTime: null,
            currentState: 'saved' // 'saved', 'has-changes', 'saving', 'error'
        };

        // ============================================
        // SYSTÃˆME DE JALOUSIE ET GUERRE DRAMATIQUE
        // ============================================

        // DÃ©clencher Ã©vÃ©nement de jalousie automatiquement
        function triggerJealousyEvent() {
            // Seulement s'il y a des mariages
            if (marriageHistory.length === 0) return;
            
            // SÃ©lectionner un pays alÃ©atoire des mariages
            const randomMarriage = marriageHistory[Math.floor(Math.random() * marriageHistory.length)];
            const targetCountry = randomMarriage.formattedCountry || randomMarriage.partnerCountry;
            const targetFlags = getFlags(targetCountry);
            
            // Messages dramatiques selon le type d'Ã©vÃ©nement
            const eventTypes = [
                {
                    type: 'ex_returns',
                    message: `ğŸ˜± Drama ! Un(e) ex de ${targetCountry} ${targetFlags} essaie de rÃ©cupÃ©rer votre partenaire !`,
                    effect: -20,
                    emoji: 'ğŸ’”ğŸ’”ğŸ’”'
                },
                {
                    type: 'celebrity_crush',
                    message: `ğŸ“¸ Scandale ! Votre partenaire de ${targetCountry} ${targetFlags} a Ã©tÃ© vu(e) avec une cÃ©lÃ©britÃ© !`,
                    effect: -15,
                    emoji: 'ğŸ“¸ğŸ“¸ğŸ“¸'
                },
                {
                    type: 'family_disapproval',
                    message: `ğŸ’” La famille de ${targetCountry} ${targetFlags} n'approuve pas votre relation !`,
                    effect: -25,
                    emoji: 'âš¡ğŸ˜¤âš¡'
                },
                {
                    type: 'social_media_drama',
                    message: `ğŸ“± Drama sur les rÃ©seaux ! Votre relation avec ${targetCountry} ${targetFlags} fait polÃ©mique !`,
                    effect: -10,
                    emoji: 'ğŸ“±ğŸ’¬ğŸ“±'
                },
                {
                    type: 'old_flame',
                    message: `ğŸŒ¹ Coup de thÃ©Ã¢tre ! Une ancienne flamme de ${targetCountry} ${targetFlags} rÃ©apparaÃ®t !`,
                    effect: -18,
                    emoji: 'ğŸŒ¹ğŸ’•ğŸŒ¹'
                }
            ];
            
            const selectedEvent = eventTypes[Math.floor(Math.random() * eventTypes.length)];
            executeJealousyEvent(selectedEvent, targetCountry);
        }

        // ExÃ©cuter un Ã©vÃ©nement de jalousie dramatique
        function executeJealousyEvent(eventType, country) {
            const messageContainer = document.getElementById('messageContainer');
            const eventDiv = document.createElement('div');
            eventDiv.className = 'jealousy-message';
            eventDiv.style.background = 'linear-gradient(45deg, #FF6B6B, #FF8E53)';
            eventDiv.style.color = 'white';
            eventDiv.style.padding = '25px';
            eventDiv.style.borderRadius = '15px';
            eventDiv.style.margin = '15px 0';
            eventDiv.style.textAlign = 'center';
            eventDiv.style.animation = 'dramaticPulse 2s ease-in-out infinite';
            eventDiv.style.border = '2px solid #FF0000';
            eventDiv.style.boxShadow = '0 0 20px rgba(255, 0, 0, 0.5)';
            
            eventDiv.innerHTML = `
                <div style="font-size: 3em; margin-bottom: 15px;">${eventType.emoji}</div>
                <div style="font-size: 20px; font-weight: bold; margin-bottom: 15px;">
                    ğŸš¨ DRAMA RELATIONNEL ! ğŸš¨
                </div>
                <div style="font-size: 18px; margin-bottom: 20px; background: rgba(0,0,0,0.3); padding: 15px; border-radius: 10px;">
                    ${eventType.message}
                </div>
                <div style="font-size: 14px; opacity: 0.9; margin: 15px 0;">
                    ğŸ’” StabilitÃ© relationnelle affectÃ©e : ${eventType.effect} points !
                </div>
                
                <div style="margin: 25px 0; display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                    <button class="btn btn-success" onclick="handleJealousyReaction('discuss', '${country}', ${eventType.effect})">
                        ğŸ’¬ Discuter calmement
                    </button>
                    <button class="btn btn-warning" onclick="handleJealousyReaction('ignore', '${country}', ${eventType.effect})">
                        ğŸ˜¤ Ignorer le problÃ¨me
                    </button>
                    <button class="btn btn-warning" onclick="handleJealousyReaction('jealous', '${country}', ${eventType.effect})">
                        ğŸ˜  Devenir jaloux/jalouse
                    </button>
                    <button class="btn" style="background: linear-gradient(45deg, #8B0000, #FF0000); color: white;" onclick="triggerWarEvent('${country}')">
                        âš”ï¸ DÃ©clencher une guerre !
                    </button>
                </div>
            `;
            
            messageContainer.appendChild(eventDiv);
            
            // Effets visuels selon la gravitÃ©
            if (eventType.effect < -20) {
                createHeartbreakEffect();
            } else {
                createTensionEffect();
            }
            
            // RÃ©duire la stabilitÃ© relationnelle
            relationshipStability = Math.max(0, relationshipStability + eventType.effect);
            
            markUnsavedChanges();
        }

        // GÃ©rer les rÃ©actions de jalousie
        function handleJealousyReaction(reactionType, country, originalEffect) {
            // Supprimer le message d'Ã©vÃ©nement
            document.querySelectorAll('.jealousy-message').forEach(msg => msg.remove());
            
            let stabilityChange = 0;
            let responseMessage = '';
            
            switch (reactionType) {
                case 'ignore':
                    stabilityChange = Math.floor(originalEffect * 0.5);
                    responseMessage = `ğŸ˜¤ Vous avez choisi d'ignorer le problÃ¨me avec ${country}. La tension persiste...`;
                    break;
                    
                case 'discuss':
                    stabilityChange = Math.abs(originalEffect) * 1.5;
                    responseMessage = `ğŸ’¬ Discussion rÃ©ussie ! Votre relation avec ${country} est plus forte maintenant !`;
                    gainXP(25);
                    
                    // Chance d'Ã©vÃ©nement de rÃ©conciliation
                    if (Math.random() < 0.6) {
                        setTimeout(() => {
                            triggerReconciliationEvent(country);
                        }, 3000);
                    }
                    break;
                    
                case 'jealous':
                    stabilityChange = originalEffect * 1.5;
                    responseMessage = `ğŸ˜  Votre jalousie a empirÃ© les choses avec ${country} ! Situation explosive !`;
                    break;
            }
            
            relationshipStability = Math.max(0, Math.min(100, relationshipStability + stabilityChange));
            showMessage(responseMessage, reactionType === 'discuss' ? 'success' : 'error');
            markUnsavedChanges();
        }

        // Ã‰VÃ‰NEMENT DE GUERRE DRAMATIQUE (comme demandÃ©)
        function triggerWarEvent(country) {
            // Supprimer le message de jalousie
            document.querySelectorAll('.jealousy-message').forEach(msg => msg.remove());
            
            const messageContainer = document.getElementById('messageContainer');
            const warDiv = document.createElement('div');
            warDiv.className = 'war-message';
            warDiv.style.background = 'linear-gradient(45deg, #8B0000, #FF0000, #FF4500)';
            warDiv.style.color = 'white';
            warDiv.style.padding = '30px';
            warDiv.style.borderRadius = '15px';
            warDiv.style.margin = '15px 0';
            warDiv.style.textAlign = 'center';
            warDiv.style.border = '3px solid #FF0000';
            warDiv.style.boxShadow = '0 0 40px rgba(255, 0, 0, 0.8)';
            warDiv.style.animation = 'warAlert 1s ease-in-out infinite';
            
            // Message automatique exact comme demandÃ©
            const warMessage = `Oh non ğŸ˜­ IsraÃ«l qui attaque ${country} !`;
            
            warDiv.innerHTML = `
                <div style="font-size: 4em; margin-bottom: 20px;">âš”ï¸ğŸ’¥âš”ï¸</div>
                <div style="font-size: 24px; font-weight: bold; margin-bottom: 15px; text-shadow: 2px 2px 4px rgba(0,0,0,0.7);">
                    ğŸš¨ GUERRE DÃ‰CLENCHÃ‰E ! ğŸš¨
                </div>
                <div style="font-size: 20px; margin-bottom: 20px; background: rgba(0,0,0,0.5); padding: 20px; border-radius: 15px; border: 2px solid #FFFF00;">
                    ${warMessage}
                </div>
                <div style="font-size: 16px; margin: 20px 0;">
                    ğŸ’£ La jalousie a dÃ©gÃ©nÃ©rÃ© en conflit international !<br>
                    ğŸ›ï¸ Relations diplomatiques rompues !<br>
                    ğŸ’” StabilitÃ© relationnelle : -40 points !
                </div>
                
                <div style="font-size: 3em; margin: 20px 0; animation: explosionBlink 0.5s infinite;">
                    ğŸ”¥ğŸ’£ğŸ”¥
                </div>
                
                <div style="margin: 25px 0; display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
                    <button class="btn btn-warning" onclick="attemptPeaceTreaty('${country}')">
                        ğŸ•Šï¸ NÃ©gocier la paix
                    </button>
                    <button class="btn" style="background: linear-gradient(45deg, #FF4500, #FF0000);" onclick="escalateWar('${country}')">
                        ğŸ’¥ Escalade militaire
                    </button>
                    <button class="btn btn-success" onclick="callUN('${country}')">
                        ğŸ›ï¸ Appeler l'ONU
                    </button>
                    <button class="btn btn-secondary" onclick="endWarEvent()">
                        âœ–ï¸ Fermer
                    </button>
                </div>
            `;
            
            messageContainer.appendChild(warDiv);
            
            // Effets visuels spectaculaires de guerre
            createWarEffects();
            playWarSound();
            
            // PÃ©nalitÃ© massive pour la stabilitÃ©
            relationshipStability = Math.max(0, relationshipStability - 40);
            
            markUnsavedChanges();
        }

        // NÃ©gocier la paix
        function attemptPeaceTreaty(country) {
            document.querySelectorAll('.war-message').forEach(msg => msg.remove());
            
            if (Math.random() > 0.4) { // 60% de chance de succÃ¨s
                showMessage(`ğŸ•Šï¸ SuccÃ¨s diplomatique ! TraitÃ© de paix signÃ© avec ${country} ! Relations normalisÃ©es.`, 'success');
                relationshipStability = Math.min(100, relationshipStability + 30);
                gainXP(100);
                updateMissions('peace_maker');
            } else {
                showMessage(`ğŸ’¥ Ã‰chec des nÃ©gociations ! ${country} refuse le dialogue. Le conflit continue...`, 'error');
            }
        }

        // Escalade militaire
        function escalateWar(country) {
            document.querySelectorAll('.war-message').forEach(msg => msg.remove());
            
            showMessage(`ğŸ’£ Escalade catastrophique ! Conflit majeur avec ${country} ! Toutes relations affectÃ©es !`, 'error');
            relationshipStability = Math.max(0, relationshipStability - 30);
            gameState.player.xp = Math.max(0, gameState.player.xp - 100);
            updateXPDisplay();
            createNuclearEffect();
        }

        // Appeler l'ONU
        function callUN(country) {
            document.querySelectorAll('.war-message').forEach(msg => msg.remove());
            
            const unMessage = `ğŸ›ï¸ L'ONU intervient ! Cessez-le-feu immÃ©diat entre tous les pays ! Mission de paix rÃ©ussie.`;
            showMessage(unMessage, 'success');
            relationshipStability = Math.min(100, relationshipStability + 50);
            gainXP(150);
        }

        // Fermer Ã©vÃ©nement de guerre
        function endWarEvent() {
            document.querySelectorAll('.war-message').forEach(msg => msg.remove());
        }

        // Ã‰vÃ©nement de rÃ©conciliation
        function triggerReconciliationEvent(country) {
            const reconciliationMessages = [
                `ğŸ’• Geste romantique ! Votre partenaire de ${country} vous fait une surprise !`,
                `ğŸ“¢ DÃ©claration publique ! ${country} proclame son amour devant tout le monde !`,
                `ğŸ¤ RÃ©conciliation parfaite ! ProblÃ¨me rÃ©solu avec ${country} !`,
                `ğŸ’‘ ThÃ©rapie de couple rÃ©ussie ! Relation avec ${country} renforcÃ©e !`
            ];
            
            const message = reconciliationMessages[Math.floor(Math.random() * reconciliationMessages.length)];
            
            const messageContainer = document.getElementById('messageContainer');
            const reconciliationDiv = document.createElement('div');
            reconciliationDiv.className = 'special-message';
            reconciliationDiv.style.background = 'linear-gradient(45deg, #4ECDC4, #44A08D)';
            reconciliationDiv.style.animation = 'heartsFloat 3s ease-in-out';
            
            reconciliationDiv.innerHTML = `
                <div style="font-size: 3em; margin-bottom: 15px;">ğŸ’•ğŸ’–ğŸ’•</div>
                <div style="font-size: 18px; font-weight: bold; color: white; margin-bottom: 15px;">
                    ${message}
                </div>
                <div style="margin: 15px 0; font-size: 16px; color: rgba(255,255,255,0.9);">
                    StabilitÃ© relationnelle : +25 points !
                </div>
                <div style="margin-top: 20px;">
                    <button class="btn btn-secondary" onclick="this.parentElement.remove()">
                        âœ–ï¸ Fermer
                    </button>
                </div>
            `;
            
            messageContainer.appendChild(reconciliationDiv);
            relationshipStability = Math.min(100, relationshipStability + 25);
            gainXP(30);
            createHeartAnimation();
        }

        // Effets visuels pour la guerre
        function createWarEffects() {
            // Tremblement de l'Ã©cran
            document.body.style.animation = 'warShake 0.5s ease-in-out 5';
            
            // Explosions multiples
            for (let i = 0; i < 15; i++) {
                setTimeout(() => {
                    const explosion = document.createElement('div');
                    explosion.style.position = 'fixed';
                    explosion.style.left = Math.random() * window.innerWidth + 'px';
                    explosion.style.top = Math.random() * window.innerHeight + 'px';
                    explosion.style.fontSize = '60px';
                    explosion.style.pointerEvents = 'none';
                    explosion.style.zIndex = '9999';
                    explosion.textContent = 'ğŸ’¥';
                    explosion.style.animation = 'explosionPop 1.2s ease-out';
                    document.body.appendChild(explosion);
                    
                    setTimeout(() => explosion.remove(), 1200);
                }, i * 200);
            }
            
            // Overlay rouge clignotant
            const warOverlay = document.createElement('div');
            warOverlay.style.position = 'fixed';
            warOverlay.style.top = '0';
            warOverlay.style.left = '0';
            warOverlay.style.width = '100%';
            warOverlay.style.height = '100%';
            warOverlay.style.background = 'rgba(255, 0, 0, 0.3)';
            warOverlay.style.pointerEvents = 'none';
            warOverlay.style.zIndex = '998';
            warOverlay.style.animation = 'warFlash 0.3s ease-in-out 10';
            document.body.appendChild(warOverlay);
            
            setTimeout(() => {
                warOverlay.remove();
                document.body.style.animation = '';
            }, 4000);
        }

        function createNuclearEffect() {
            const nuclearOverlay = document.createElement('div');
            nuclearOverlay.style.position = 'fixed';
            nuclearOverlay.style.top = '0';
            nuclearOverlay.style.left = '0';
            nuclearOverlay.style.width = '100%';
            nuclearOverlay.style.height = '100%';
            nuclearOverlay.style.background = 'radial-gradient(circle, rgba(255,255,255,0.9) 0%, rgba(255,100,0,0.8) 30%, rgba(255,0,0,0.6) 70%, rgba(0,0,0,0.4) 100%)';
            nuclearOverlay.style.pointerEvents = 'none';
            nuclearOverlay.style.zIndex = '9999';
            nuclearOverlay.style.animation = 'nuclearFlash 2.5s ease-out';
            document.body.appendChild(nuclearOverlay);
            
            const mushroom = document.createElement('div');
            mushroom.style.position = 'fixed';
            mushroom.style.top = '50%';
            mushroom.style.left = '50%';
            mushroom.style.transform = 'translate(-50%, -50%)';
            mushroom.style.fontSize = '150px';
            mushroom.style.zIndex = '10000';
            mushroom.textContent = 'â˜¢ï¸';
            mushroom.style.animation = 'mushroomRise 3s ease-out';
            document.body.appendChild(mushroom);
            
            setTimeout(() => {
                nuclearOverlay.remove();
                mushroom.remove();
            }, 3000);
        }

        function createHeartbreakEffect() {
            for (let i = 0; i < 10; i++) {
                setTimeout(() => {
                    const heartbreak = document.createElement('div');
                    heartbreak.className = 'heart-animation';
                    heartbreak.textContent = 'ğŸ’”';
                    heartbreak.style.left = Math.random() * window.innerWidth + 'px';
                    heartbreak.style.top = window.innerHeight + 'px';
                    heartbreak.style.color = '#FF6B6B';
                    heartbreak.style.fontSize = '40px';
                    document.body.appendChild(heartbreak);
                    
                    setTimeout(() => heartbreak.remove(), 2000);
                }, i * 300);
            }
        }

        function createTensionEffect() {
            const tensionOverlay = document.createElement('div');
            tensionOverlay.style.position = 'fixed';
            tensionOverlay.style.top = '0';
            tensionOverlay.style.left = '0';
            tensionOverlay.style.width = '100%';
            tensionOverlay.style.height = '100%';
            tensionOverlay.style.background = 'rgba(255, 0, 0, 0.15)';
            tensionOverlay.style.pointerEvents = 'none';
            tensionOverlay.style.zIndex = '999';
            tensionOverlay.style.animation = 'tensionFlash 0.5s ease-in-out 4';
            document.body.appendChild(tensionOverlay);
            
            setTimeout(() => tensionOverlay.remove(), 2500);
        }

        // Son d'alerte de guerre
        function playWarSound() {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                
                // SirÃ¨ne d'alerte dramatique
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.type = 'sawtooth';
                oscillator.frequency.setValueAtTime(300, audioContext.currentTime);
                oscillator.frequency.linearRampToValueAtTime(900, audioContext.currentTime + 0.7);
                oscillator.frequency.linearRampToValueAtTime(300, audioContext.currentTime + 1.4);
                
                gainNode.gain.setValueAtTime(0.4, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 2.5);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 2.5);
            } catch (error) {
                console.log('Audio de guerre non supportÃ©:', error);
            }
        }

        // Bouton pour dÃ©clencher manuellement la jalousie (pour test)
        function addManualJealousyButton() {
            const gameMain = document.getElementById('gameMain');
            if (gameMain && !document.getElementById('jealousyTrigger')) {
                const buttonDiv = document.createElement('div');
                buttonDiv.style.textAlign = 'center';
                buttonDiv.style.margin = '20px 0';
                buttonDiv.innerHTML = `
                    <button id="jealousyTrigger" class="btn btn-warning" onclick="triggerJealousyEvent()">
                        ğŸ˜± DÃ©clencher un Drama Relationnel !
                    </button>
                    <div style="margin-top: 10px; font-size: 14px; opacity: 0.8;">
                        StabilitÃ© relationnelle actuelle : <span style="font-weight: bold; color: ${relationshipStability > 70 ? '#28a745' : relationshipStability > 30 ? '#ffc107' : '#dc3545'}">${relationshipStability}/100</span>
                    </div>
                `;
                gameMain.appendChild(buttonDiv);
            }
        }

        // SystÃ¨me automatique de jalousie (toutes les 45 secondes)
        function startJealousySystem() {
            setInterval(() => {
                if (marriageHistory.length > 0 && Math.random() < 0.25) { // 25% de chance
                    triggerJealousyEvent();
                }
            }, 45000); // Toutes les 45 secondes
        }

        // ============================================
        // FONCTIONS PRINCIPALES DU JEU
        // ============================================

        function initGame() {
            updateMissionsList();
            initTheme();
        }

        function initTheme() {
            const themeToggle = document.getElementById('themeToggle');
            if (themeToggle) {
                const isDark = document.documentElement.classList.contains('dark');
                themeToggle.textContent = isDark ? 'â˜€ï¸ Mode Clair' : 'ğŸŒ™ Mode Sombre';
                gameState.theme = isDark ? 'dark' : 'light';
                
                // Forcer l'application du thÃ¨me
                if (isDark) {
                    document.body.classList.add('dark');
                    document.documentElement.setAttribute('data-theme', 'dark');
                } else {
                    document.body.classList.remove('dark');
                    document.documentElement.setAttribute('data-theme', 'light');
                }
            }
        }

        function toggleTheme() {
            const isDarkBefore = document.documentElement.classList.contains('dark');
            
            // Toggle les classes
            document.documentElement.classList.toggle('dark');
            document.body.classList.toggle('dark');
            
            const isDarkAfter = document.documentElement.classList.contains('dark');
            
            // Mettre Ã  jour le bouton
            const themeToggle = document.getElementById('themeToggle');
            if (themeToggle) {
                themeToggle.textContent = isDarkAfter ? 'â˜€ï¸ Mode Clair' : 'ğŸŒ™ Mode Sombre';
            }
            
            // Mettre Ã  jour l'Ã©tat du jeu
            gameState.theme = isDarkAfter ? 'dark' : 'light';
            
            // Attribut data pour CSS
            document.documentElement.setAttribute('data-theme', gameState.theme);
            
            // Forcer le re-rendu des styles
            document.body.style.transition = 'all 0.3s ease';
            
            if (gameState.player && gameState.player.fullName) {
                markUnsavedChanges();
            }
        }

        function startMainGame() {
            const firstName = document.getElementById('firstName').value.trim();
            const lastName = document.getElementById('lastName').value.trim();
            const country = document.getElementById('countrySelect').value;
            const gender = document.getElementById('genderSelect').value;

            if (!firstName || !lastName || !country || !gender) {
                alert('âš ï¸ Veuillez remplir tous les champs !');
                return;
            }

            gameState.player.firstName = firstName;
            gameState.player.lastName = lastName;
            gameState.player.country = country;
            gameState.player.gender = gender;
            gameState.player.fullName = `${firstName} ${lastName}`;

            document.getElementById('characterCreation').classList.add('hidden');
            document.getElementById('gameMain').classList.remove('hidden');

            updatePlayerInfo();
            
            const genderEmoji = gender === 'male' ? 'ğŸ‘¨' : 'ğŸ‘©';
            showMessage(`ğŸ‰ Bienvenue ${genderEmoji} ${gameState.player.fullName} ! Votre aventure amoureuse commence maintenant ! ğŸ‰`, 'success');
            
            markUnsavedChanges();
        }

        function updatePlayerInfo() {
            const flag = getFlags(gameState.player.country);
            document.getElementById('playerInfo').textContent =
                `${flag} ${gameState.player.fullName}`;
            document.getElementById('playerDetails').textContent =
                `Niveau ${gameState.player.level} â€¢ ${formatCountryName(gameState.player.country)}`;
            updateXPDisplay();
        }

        function updateXPDisplay() {
            const xpNeeded = gameState.player.level * 100;
            const xpProgress = (gameState.player.xp / xpNeeded) * 100;
            
            document.getElementById('xpText').textContent = `${gameState.player.xp} / ${xpNeeded}`;
            document.getElementById('xpBar').style.width = `${Math.min(xpProgress, 100)}%`;
            
            // VÃ©rifier montÃ©e de niveau
            if (gameState.player.xp >= xpNeeded) {
                levelUp();
            }
        }

        function levelUp() {
            gameState.player.level++;
            gameState.player.xp = 0;
            showMessage(`ğŸŠ NIVEAU SUPÃ‰RIEUR ! Vous Ãªtes maintenant niveau ${gameState.player.level} ! ğŸŠ`, 'special');
            updatePlayerInfo();
            createLevelUpEffect();
            markUnsavedChanges();
        }

        function gainXP(amount) {
            gameState.player.xp += amount;
            updateXPDisplay();
            markUnsavedChanges();
        }

        function createLevelUpEffect() {
            for (let i = 0; i < 20; i++) {
                setTimeout(() => {
                    createHeartAnimation();
                }, i * 100);
            }
        }

        function createHeartAnimation() {
            const heart = document.createElement('div');
            heart.className = 'heart-animation';
            heart.textContent = ['ğŸ’–', 'ğŸ’•', 'ğŸ’—', 'ğŸ’˜'][Math.floor(Math.random() * 4)];
            heart.style.left = Math.random() * window.innerWidth + 'px';
            heart.style.top = window.innerHeight + 'px';
            document.body.appendChild(heart);
            
            setTimeout(() => {
                heart.remove();
            }, 2000);
        }

        function showSection(sectionName) {
            gameState.currentSection = sectionName;
            
            document.querySelectorAll('.section').forEach(section => {
                section.classList.add('hidden');
            });
            
            document.getElementById(sectionName + 'Section').classList.remove('hidden');
            
            if (sectionName === 'missions') {
                updateMissionsList();
            } else if (sectionName === 'marriage') {
                updateMarriageList();
            } else if (sectionName === 'quiz') {
                startQuiz();
            }
            
            markUnsavedChanges();
        }

        function exploreWorld() {
            const availableCountries = Object.keys(countries).filter(country => 
                country !== gameState.player.country
            );
            
            if (availableCountries.length === 0) {
                showMessage('ğŸŒ Vous avez explorÃ© tous les pays disponibles !', 'error');
                return;
            }
            
            const baseCountry = availableCountries[Math.floor(Math.random() * availableCountries.length)];
            let randomCountry = baseCountry;
            if (Math.random() < 0.15) {
                const second = availableCountries[Math.floor(Math.random() * availableCountries.length)];
                if (second !== baseCountry) randomCountry = `${baseCountry}-${second}`;
            }
            const countryFlag = getFlags(randomCountry);
            
            // GÃ©nÃ©rer une personne alÃ©atoire du genre opposÃ© au joueur
            const names = namesByCountry[baseCountry] || namesByCountry['United States'];
            const gender = gameState.player.gender === 'male' ? 'female' : 'male';
            const firstName = names[gender][Math.floor(Math.random() * names[gender].length)];
            const lastName = generateLastName(baseCountry);
            
            const resultDiv = document.getElementById('exploreResult');
            resultDiv.classList.remove('hidden');
            
            const genderEmoji = gender === 'male' ? 'ğŸ‘¨' : 'ğŸ‘©';
            const genderText = gender === 'male' ? 'Homme' : 'Femme';
            
            resultDiv.innerHTML = `
                <div class="country-card text-center">
                    <div class="flag-heart w-24 h-24 mx-auto mb-4 flex items-center justify-center">
                        <span class="text-4xl">${countryFlag}</span>
                    </div>
                    <h4 class="text-2xl font-bold mb-2">${genderEmoji} ${firstName} ${lastName}</h4>
                    <p class="text-lg mb-2">${formatCountryName(randomCountry)}</p>
                    <p class="text-sm text-purple-600 dark:text-purple-400 mb-4">${genderText}</p>
            <p class="text-gray-600 dark:text-gray-300 mb-6">${generateDescription(baseCountry, firstName, gender)}</p>
                    
                    <div class="flex flex-col sm:flex-row gap-4 justify-center">
                        <button class="btn btn-success" onclick="proposeMarriage('${firstName}', '${lastName}', '${randomCountry}', '${gender}')">
                            ğŸ’ Demander en mariage
                        </button>
                        <button class="btn btn-secondary" onclick="exploreWorld()">
                            ğŸ”„ Continuer Ã  explorer
                        </button>
                    </div>
                </div>
            `;
            
            gainXP(10);
            showMessage(`ğŸŒ Vous explorez ${formatCountryName(randomCountry)} et rencontrez ${firstName} ${lastName} !`, 'special');
        }

        function generateLastName(country) {
            const lastNames = {
                'France': ['Martin', 'Bernard', 'Dubois', 'Thomas', 'Robert', 'Petit', 'Durand', 'Leroy', 'Moreau', 'Simon'],
                'Germany': ['MÃ¼ller', 'Schmidt', 'Schneider', 'Fischer', 'Weber', 'Meyer', 'Wagner', 'Becker', 'Schulz', 'Hoffmann'],
                'United States': ['Smith', 'Johnson', 'Williams', 'Brown', 'Jones', 'Garcia', 'Miller', 'Davis', 'Rodriguez', 'Martinez'],
                'Japan': ['Sato', 'Suzuki', 'Takahashi', 'Tanaka', 'Watanabe', 'Ito', 'Yamamoto', 'Nakamura', 'Kobayashi', 'Kato'],
                'United Kingdom': ['Smith', 'Jones', 'Taylor', 'Williams', 'Brown', 'Davies', 'Evans', 'Wilson', 'Thomas', 'Roberts'],
                'Italy': ['Rossi', 'Russo', 'Ferrari', 'Esposito', 'Bianchi', 'Romano', 'Colombo', 'Ricci', 'Marino', 'Greco'],
                'Spain': ['GarcÃ­a', 'RodrÃ­guez', 'GonzÃ¡lez', 'FernÃ¡ndez', 'LÃ³pez', 'MartÃ­nez', 'SÃ¡nchez', 'PÃ©rez', 'GÃ³mez', 'MartÃ­n'],
                'Brazil': ['Silva', 'Santos', 'Oliveira', 'Souza', 'Rodrigues', 'Ferreira', 'Alves', 'Pereira', 'Lima', 'Gomes'],
                'Mexico': ['HernÃ¡ndez', 'GarcÃ­a', 'MartÃ­nez', 'GonzÃ¡lez', 'LÃ³pez', 'RodrÃ­guez', 'PÃ©rez', 'SÃ¡nchez', 'RamÃ­rez', 'Cruz'],
                'Russia': ['Ğ˜Ğ²Ğ°Ğ½Ğ¾Ğ²', 'Ğ¡Ğ¼Ğ¸Ñ€Ğ½Ğ¾Ğ²', 'ĞšÑƒĞ·Ğ½ĞµÑ†Ğ¾Ğ²', 'ĞŸĞ¾Ğ¿Ğ¾Ğ²', 'Ğ’Ğ°ÑĞ¸Ğ»ÑŒĞµĞ²', 'ĞŸĞµÑ‚Ñ€Ğ¾Ğ²', 'Ğ¡Ğ¾ĞºĞ¾Ğ»Ğ¾Ğ²', 'ĞœĞ¸Ñ…Ğ°Ğ¹Ğ»Ğ¾Ğ²', 'ĞĞ¾Ğ²Ğ¸ĞºĞ¾Ğ²', 'Ğ¤Ñ‘Ğ´Ğ¾Ñ€Ğ¾Ğ²'],
                'Kabylia': ['Ait SaÃ¯d', 'Ait Ali', 'Amellal', 'Meziane', 'Slimani', 'Idir', 'Mammeri', 'Feraoun', 'Ait Ahmed', 'Mohia']
            };
            
            const names = lastNames[country] || lastNames['United States'];
            return names[Math.floor(Math.random() * names.length)];
        }

        function generateDescription(country, firstName, gender) {
            const descriptions = [
                `${firstName} est ${gender === 'male' ? 'un artiste passionnÃ©' : 'une artiste passionnÃ©e'} de ${country}.`,
                `${firstName} travaille comme ${gender === 'male' ? 'ingÃ©nieur' : 'ingÃ©nieure'} et adore voyager.`,
                `${firstName} est ${gender === 'male' ? 'un chef cuisinier talentueux' : 'une chef cuisiniÃ¨re talentueuse'} de ${country}.`,
                `${firstName} enseigne l'art et rÃªve de voir le monde.`,
                `${firstName} est ${gender === 'male' ? 'un musicien' : 'une musicienne'} qui compose de magnifiques mÃ©lodies.`,
                `${firstName} est passionnÃ©${gender === 'male' ? '' : 'e'} de littÃ©rature et Ã©crit des poÃ¨mes.`,
                `${firstName} travaille dans la mode et crÃ©e de superbes designs.`,
                `${firstName} est ${gender === 'male' ? 'un photographe aventurier' : 'une photographe aventuriÃ¨re'} qui capture la beautÃ© du monde.`
            ];
            
            return descriptions[Math.floor(Math.random() * descriptions.length)];
        }

        function proposeMarriage(firstName, lastName, country, gender) {
            // VÃ©rifier si dÃ©jÃ  mariÃ© avec cette personne
            const alreadyMarried = marriageHistory.some(marriage => 
                marriage.partner === `${firstName} ${lastName}` && marriage.partnerCountry === country
            );
            
            if (alreadyMarried) {
                showMessage(`ğŸ’” Vous Ãªtes dÃ©jÃ  mariÃ©(e) avec ${firstName} ${lastName} !`, 'error');
                return;
            }
            
            const success = Math.random() > 0.3; // 70% de chance de succÃ¨s
            
            if (success) {
                addToMarriageHistory(firstName, lastName, country, gender);
                gainXP(50);
                const genderEmoji = gender === 'male' ? 'ğŸ‘¨' : 'ğŸ‘©';
                
                // Jouer le son de victoire
                playVictorySound();
                
                // Message avec bouton de partage
                showMarriageSuccessMessage(firstName, lastName, country, gender, genderEmoji);
                
                updateMissions('first_marriage');
                updateMissions('five_marriages');
                updateMissions('ten_marriages');
                updateMissions('continent_explorer');
                updateMissions('polyglot');
                
                // Ajouter le bouton de jalousie aprÃ¨s le premier mariage
                if (marriageHistory.length === 1) {
                    setTimeout(() => {
                        addManualJealousyButton();
                    }, 1000);
                }
            } else {
                showMessage(`ğŸ’” ${firstName} ${lastName} a dÃ©clinÃ© votre demande. Ne vous dÃ©couragez pas !`, 'error');
                gainXP(10);
            }
            
            createHeartAnimation();
            document.getElementById('exploreResult').innerHTML = '';
            document.getElementById('exploreResult').classList.add('hidden');
            markUnsavedChanges();
        }

        function addToMarriageHistory(firstName, lastName, country, gender) {
            const marriage = {
                partner: `${firstName} ${lastName}`,
                partnerCountry: country,
                partnerGender: gender,
                date: new Date().toLocaleDateString('fr-FR'),
                flag: getFlags(country),
                formattedCountry: formatCountryName(country)
            };
            
            marriageHistory.push(marriage);
            
            // Initialiser le tchat avec le nouveau partenaire
            if (marriageHistory.length === 1) {
                initializeChatWithPartner(firstName, lastName, country, gender);
            }
            
            markUnsavedChanges();
        }

        function updateMarriageList() {
            const marriageList = document.getElementById('marriageList');
            
            if (marriageHistory.length === 0) {
                marriageList.innerHTML = '<p class="text-center text-gray-500 dark:text-gray-400">Aucun mariage pour le moment. Explorez le monde !</p>';
                return;
            }
            
            // Vider la liste d'abord
            marriageList.innerHTML = '';
            
            // CrÃ©er chaque carte de mariage
            marriageHistory.forEach((marriage, index) => {
                const genderEmoji = marriage.partnerGender === 'male' ? 'ğŸ‘¨' : 'ğŸ‘©';
                const genderText = marriage.partnerGender === 'male' ? 'Homme' : 'Femme';
                
                // CrÃ©er la carte de mariage
                const marriageCard = document.createElement('div');
                marriageCard.className = 'country-card';
                marriageCard.id = `marriage-${index}`;
                
                marriageCard.innerHTML = `
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-4">
                            <div class="text-4xl">${marriage.flag}</div>
                            <div>
                                <h4 class="text-xl font-bold">${genderEmoji} ${marriage.partner}</h4>
                                <p class="text-gray-600 dark:text-gray-300">${marriage.formattedCountry}</p>
                                <p class="text-sm text-purple-600 dark:text-purple-400">${genderText}</p>
                                <p class="text-sm text-gray-500 dark:text-gray-400">MariÃ©(e) le ${marriage.date}</p>
                            </div>
                        </div>
                        <div class="flex items-center gap-4">
                            <div class="text-2xl">ğŸ’•</div>
                            <button class="btn breakup-btn" style="background: linear-gradient(45deg, #dc3545, #c82333); color: white; padding: 8px 16px; font-size: 14px;">
                                ğŸ’” Je te quitte
                            </button>
                        </div>
                    </div>
                `;
                
                // Action "Je te quitte"
                const breakupBtn = marriageCard.querySelector('.breakup-btn');
                breakupBtn.addEventListener('click', () => {
                    breakUp(marriage.partner);
                });
                
                // Ajouter la carte Ã  la liste
                marriageList.appendChild(marriageCard);
            });
        }


        function updateMissions(missionKey) {
            if (!missionKey || missions[missionKey].completed) return;
            
            let shouldComplete = false;
            
            switch (missionKey) {
                case 'first_marriage':
                    shouldComplete = marriageHistory.length >= 1;
                    break;
                case 'five_marriages':
                    shouldComplete = marriageHistory.length >= 5;
                    break;
                case 'ten_marriages':
                    shouldComplete = marriageHistory.length >= 10;
                    break;
                case 'continent_explorer':
                    const continents = new Set();
                    marriageHistory.forEach(marriage => {
                        const continent = getContinent(marriage.partnerCountry);
                        if (continent) continents.add(continent);
                    });
                    shouldComplete = continents.size >= 3;
                    break;
                case 'polyglot':
                    const languages = new Set();
                    marriageHistory.forEach(marriage => {
                        const language = getMainLanguage(marriage.partnerCountry);
                        if (language) languages.add(language);
                    });
                    shouldComplete = languages.size >= 5;
                    break;
                case 'diplomat':
                    // ComptÃ© dans handleJealousyReaction
                    break;
                case 'peace_maker':
                    // ComptÃ© dans attemptPeaceTreaty
                    break;
            }
            
            if (shouldComplete) {
                missions[missionKey].completed = true;
                gainXP(missions[missionKey].reward);
                showMessage(`ğŸ¯ Mission accomplie : ${missions[missionKey].title} ! +${missions[missionKey].reward} XP !`, 'success');
                markUnsavedChanges();
            }
        }

        function getContinent(country) {
            const continents = {
                'Europe': ['France', 'Germany', 'United Kingdom', 'Italy', 'Spain', 'Netherlands', 'Sweden', 'Norway', 'Denmark', 'Finland', 'Switzerland', 'Belgium', 'Austria', 'Portugal', 'Poland', 'Czech Republic', 'Greece', 'Turkey'],
                'Asia': ['Japan', 'China', 'India', 'South Korea', 'Russia', 'Thailand', 'Vietnam', 'Philippines', 'Indonesia', 'Malaysia', 'Singapore', 'Saudi Arabia', 'UAE', 'Iran', 'Iraq', 'Syria', 'Lebanon', 'Jordan'],
                'America': ['United States', 'Canada', 'Brazil', 'Mexico', 'Argentina', 'Chile', 'Peru', 'Colombia', 'Venezuela'],
                'Africa': ['Egypt', 'Morocco', 'Algeria', 'Kabylia', 'Tunisia', 'South Africa', 'Nigeria', 'Kenya', 'Libya', 'Sudan', 'Ethiopia', 'Ghana'],
                'Oceania': ['Australia', 'New Zealand']
            };
            
            for (const [continent, countries] of Object.entries(continents)) {
                if (countries.includes(country)) {
                    return continent;
                }
            }
            return null;
        }

        function getMainLanguage(country) {
            const languages = {
                'French': ['France', 'Belgium', 'Switzerland'],
                'German': ['Germany', 'Austria', 'Switzerland'],
                'English': ['United States', 'United Kingdom', 'Canada', 'Australia', 'New Zealand'],
                'Japanese': ['Japan'],
                'Italian': ['Italy'],
                'Spanish': ['Spain', 'Mexico', 'Argentina', 'Chile', 'Peru', 'Colombia', 'Venezuela'],
                'Portuguese': ['Brazil', 'Portugal'],
                'Chinese': ['China'],
                'Hindi': ['India'],
                'Korean': ['South Korea'],
                'Russian': ['Russia'],
                'Dutch': ['Netherlands'],
                'Swedish': ['Sweden'],
                'Norwegian': ['Norway'],
                'Danish': ['Denmark'],
                'Finnish': ['Finland'],
                'Arabic': ['Egypt', 'Morocco', 'Algeria', 'Tunisia', 'Saudi Arabia', 'UAE', 'Iraq', 'Syria', 'Lebanon', 'Jordan'],
                'Berber': ['Kabylia'],
                'Thai': ['Thailand'],
                'Vietnamese': ['Vietnam'],
                'Tagalog': ['Philippines'],
                'Indonesian': ['Indonesia'],
                'Malay': ['Malaysia', 'Singapore'],
                'Turkish': ['Turkey'],
                'Greek': ['Greece'],
                'Polish': ['Poland'],
                'Czech': ['Czech Republic']
            };
            
            for (const [language, countries] of Object.entries(languages)) {
                if (countries.includes(country)) {
                    return language;
                }
            }
            return null;
        }

        function updateMissionsList() {
            const missionsList = document.getElementById('missionsList');
            
            missionsList.innerHTML = Object.entries(missions).map(([key, mission]) => `
                <div class="country-card ${mission.completed ? 'opacity-75' : ''}">
                    <div class="flex items-center justify-between">
                        <div class="flex-1">
                            <h4 class="text-lg font-bold ${mission.completed ? 'text-green-600 dark:text-green-400' : ''}">${mission.title}</h4>
                            <p class="text-gray-600 dark:text-gray-300">${mission.description}</p>
                            <p class="text-sm text-purple-600 dark:text-purple-400">RÃ©compense : ${mission.reward} XP</p>
                        </div>
                        <div class="text-3xl">
                            ${mission.completed ? 'âœ…' : 'â­'}
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function showMessage(text, type = 'special') {
            const messageContainer = document.getElementById('messageContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            messageDiv.innerHTML = `
                <div class="flex justify-between items-center">
                    <span>${text}</span>
                    <button class="btn btn-secondary ml-4 py-1 px-3 text-sm" onclick="this.parentElement.parentElement.remove()">
                        âœ–ï¸
                    </button>
                </div>
            `;
            messageContainer.appendChild(messageDiv);
            
            // Auto-scroll vers le bas
            messageContainer.scrollTop = messageContainer.scrollHeight;
            markUnsavedChanges();
        }

        // SystÃ¨me de sauvegarde adaptÃ© (sans localStorage)
        let gameSaves = {}; // Sauvegardes en mÃ©moire uniquement
        
        function markUnsavedChanges() {
            saveStatus.hasUnsavedChanges = true;
            saveStatus.currentState = 'has-changes';
        }

        function markSaveInProgress() {
            saveStatus.currentState = 'saving';
        }

        function markSaveSuccess() {
            saveStatus.hasUnsavedChanges = false;
            saveStatus.currentState = 'saved';
            saveStatus.lastSaveTime = Date.now();
        }

        function markSaveError() {
            saveStatus.currentState = 'error';
        }

        function showSaveMenu() {
            const saveLoadContent = document.getElementById('saveLoadContent');
            saveLoadContent.innerHTML = `
                <div class="space-y-4">
                    <div class="message error">
                        <strong>â„¹ï¸ Note :</strong> Les sauvegardes en mÃ©moire disparaÃ®tront si vous rechargez la page. 
                        Utilisez l'export de fichier .json pour une sauvegarde permanente.
                    </div>
                    <div>
                        <label class="block text-lg font-semibold mb-2">ğŸ’¾ Nom de la sauvegarde :</label>
                        <input type="text" id="saveNameInput" placeholder="Ma partie..." 
                               class="w-full p-3 border-2 border-purple-300 rounded-lg text-base focus:border-purple-500 focus:outline-none transition-colors duration-300 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <button class="btn btn-success" onclick="saveGame()">
                            ğŸ’¾ Sauvegarder (Session)
                        </button>
                        <button class="btn btn-primary" onclick="downloadSaveFile()">
                            ğŸ“ TÃ©lÃ©charger .json
                        </button>
                        <button class="btn btn-warning" onclick="exportSaveData()">
                            ğŸ“¤ Exporter Code
                        </button>
                        <button class="btn btn-secondary" onclick="document.getElementById('saveLoadContent').innerHTML = ''">
                            âŒ Annuler
                        </button>
                    </div>
                </div>
            `;
        }

        function saveGame() {
            const saveName = document.getElementById('saveNameInput').value.trim() || 'Sauvegarde';
            
            const saveData = {
                gameState: gameState,
                marriageHistory: marriageHistory,
                discoveredCouples: Array.from(discoveredCouples),
                missions: missions,
                relationshipStability: relationshipStability,
                jealousyEvents: jealousyEvents,
                saveTime: Date.now()
            };
            
            gameSaves[saveName] = saveData;
            
            showMessage(`ğŸ’¾ Partie sauvegardÃ©e : ${saveName} (session uniquement)`, 'success');
            document.getElementById('saveLoadContent').innerHTML = '';
            markSaveSuccess();
        }

        function exportSaveData() {
            const saveData = {
                gameState: gameState,
                marriageHistory: marriageHistory,
                discoveredCouples: Array.from(discoveredCouples),
                missions: missions,
                relationshipStability: relationshipStability,
                jealousyEvents: jealousyEvents,
                saveTime: Date.now()
            };
            
            // Encoder en base64 avec support Unicode
            const exportCode = btoa(unescape(encodeURIComponent(JSON.stringify(saveData))));
            
            const saveLoadContent = document.getElementById('saveLoadContent');
            saveLoadContent.innerHTML = `
                <div class="space-y-4">
                    <div class="message success">
                        <strong>ğŸ“¤ Code de sauvegarde gÃ©nÃ©rÃ© !</strong><br>
                        Copiez ce code pour restaurer votre partie plus tard :
                    </div>
                    <div>
                        <textarea id="exportCodeArea" class="w-full p-3 border-2 border-green-300 rounded-lg text-sm h-32 font-mono resize-none dark:bg-gray-700 dark:border-gray-600 dark:text-white" readonly>${exportCode}</textarea>
                    </div>
                    <div class="flex gap-4">
                        <button class="btn btn-success flex-1" onclick="copyExportCode()">
                            ğŸ“‹ Copier le Code
                        </button>
                        <button class="btn btn-secondary" onclick="document.getElementById('saveLoadContent').innerHTML = ''">
                            âœ–ï¸ Fermer
                        </button>
                    </div>
                </div>
            `;
        }

        function copyExportCode() {
            const exportCodeArea = document.getElementById('exportCodeArea');
            exportCodeArea.select();
            exportCodeArea.setSelectionRange(0, 99999);
            
            try {
                navigator.clipboard.writeText(exportCodeArea.value);
                showMessage('ğŸ“‹ Code de sauvegarde copiÃ© dans le presse-papiers !', 'success');
            } catch (error) {
                showMessage('âŒ Impossible de copier automatiquement. Veuillez copier manuellement.', 'error');
            }
        }

        function showLoadMenu() {
            let savesList = '';
            
            for (const [saveName, saveData] of Object.entries(gameSaves)) {
                const saveTime = new Date(saveData.saveTime).toLocaleString('fr-FR');
                savesList += `
                    <div class="country-card">
                        <div class="flex justify-between items-center">
                            <div>
                                <h4 class="font-bold">${saveName}</h4>
                                <p class="text-sm text-gray-600 dark:text-gray-400">${saveTime}</p>
                                <p class="text-sm text-gray-600 dark:text-gray-300">
                                    ${saveData.gameState.player.fullName} - Niveau ${saveData.gameState.player.level}
                                </p>
                            </div>
                            <div class="flex gap-2">
                                <button class="btn btn-success" onclick="loadSaveFromMemory('${saveName}')">
                                    ğŸ“ Charger
                                </button>
                                <button class="btn btn-warning" onclick="deleteSave('${saveName}')">
                                    ğŸ—‘ï¸
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            if (savesList === '') {
                savesList = '<p class="text-center text-gray-500 dark:text-gray-400">Aucune sauvegarde en mÃ©moire.</p>';
            }
            
            document.getElementById('saveLoadContent').innerHTML = `
                <div class="space-y-4">
                    <div class="message error">
                        <strong>â„¹ï¸ Sauvegardes de session :</strong> Ces sauvegardes disparaÃ®tront si vous rechargez la page.
                    </div>
                    ${savesList}
                    <div class="space-y-4">
                        <div class="border-t pt-4">
                            <h4 class="font-bold mb-2">ğŸ“¥ Importer depuis un fichier .json :</h4>
                            <div class="space-y-2">
                                <input type="file" id="jsonFileInput" accept=".json" 
                                       class="w-full p-3 border-2 border-purple-300 rounded-lg text-base focus:border-purple-500 focus:outline-none transition-colors duration-300 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                                <button class="btn btn-primary w-full" onclick="loadJsonFile()">
                                    ğŸ“ Charger fichier .json
                                </button>
                            </div>
                        </div>
                        <div class="border-t pt-4">
                            <h4 class="font-bold mb-2">ğŸ“¥ Importer depuis un code :</h4>
                            <div class="space-y-2">
                                <textarea id="importCodeArea" placeholder="Collez votre code de sauvegarde ici..." 
                                          class="w-full p-3 border-2 border-purple-300 rounded-lg text-sm h-24 font-mono resize-none dark:bg-gray-700 dark:border-gray-600 dark:text-white"></textarea>
                                <button class="btn btn-success w-full" onclick="importSaveData()">
                                    ğŸ“¥ Importer Code de Sauvegarde
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="text-center">
                        <button class="btn btn-secondary" onclick="document.getElementById('saveLoadContent').innerHTML = ''">
                            âŒ Fermer
                        </button>
                    </div>
                </div>
            `;
        }

        function loadSaveFromMemory(saveName) {
            if (gameSaves[saveName]) {
                loadSaveData(gameSaves[saveName]);
            }
        }

        function importSaveData() {
            const importCodeArea = document.getElementById('importCodeArea');
            const importCode = importCodeArea.value.trim();
            
            if (!importCode) {
                showMessage('âŒ Veuillez coller un code de sauvegarde !', 'error');
                return;
            }
            
            try {
                // DÃ©coder base64 avec support Unicode
                const saveDataString = decodeURIComponent(escape(atob(importCode)));
                const saveData = JSON.parse(saveDataString);
                loadSaveData(saveData);
            } catch (error) {
                showMessage('âŒ Code de sauvegarde invalide !', 'error');
            }
        }

        function loadSaveData(saveData) {
            try {
                gameState = saveData.gameState;
                marriageHistory = saveData.marriageHistory || [];
                discoveredCouples = new Set(saveData.discoveredCouples || []);
                
                if (saveData.missions) {
                    Object.assign(missions, saveData.missions);
                }
                
                relationshipStability = saveData.relationshipStability || 100;
                jealousyEvents = saveData.jealousyEvents || [];
                
                document.getElementById('characterCreation').classList.add('hidden');
                document.getElementById('gameMain').classList.remove('hidden');
                
                updatePlayerInfo();
                updateMarriageList();
                updateMissionsList();
                
                if (gameState.theme === 'dark') {
                    document.documentElement.classList.add('dark');
                } else {
                    document.documentElement.classList.remove('dark');
                }
                initTheme();
                
                showMessage('ğŸ“ Partie chargÃ©e avec succÃ¨s !', 'success');
                document.getElementById('saveLoadContent').innerHTML = '';
                markSaveSuccess();
                
                // Ajouter le bouton de jalousie si il y a des mariages
                if (marriageHistory.length > 0) {
                    setTimeout(() => {
                        addManualJealousyButton();
                    }, 500);
                }
                
                return true;
            } catch (error) {
                showMessage('âŒ Erreur lors du chargement de la sauvegarde !', 'error');
                markSaveError();
                return false;
            }
        }

        function deleteSave(saveName) {
            if (confirm(`ÃŠtes-vous sÃ»r de vouloir supprimer la sauvegarde "${saveName}" ?`)) {
                delete gameSaves[saveName];
                showMessage(`ğŸ—‘ï¸ Sauvegarde "${saveName}" supprimÃ©e`, 'success');
                showLoadMenu();
            }
        }

        // ============================================
        // SYSTÃˆME DE FICHIERS JSON
        // ============================================

        // TÃ©lÃ©charger la sauvegarde au format .json
        function downloadSaveFile() {
            const saveName = document.getElementById('saveNameInput').value.trim() || 'Ma_partie';
            
            const saveData = {
                gameState: gameState,
                marriageHistory: marriageHistory,
                discoveredCouples: Array.from(discoveredCouples),
                missions: missions,
                relationshipStability: relationshipStability,
                jealousyEvents: jealousyEvents,
                saveTime: Date.now(),
                version: "1.0"
            };
            
            // CrÃ©er le fichier JSON
            const jsonString = JSON.stringify(saveData, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            // CrÃ©er un nom de fichier valide
            const filename = `${saveName.replace(/[^a-z0-9]/gi, '_')}_${new Date().toISOString().split('T')[0]}.json`;
            
            // CrÃ©er le lien de tÃ©lÃ©chargement
            const downloadLink = document.createElement('a');
            downloadLink.href = url;
            downloadLink.download = filename;
            downloadLink.style.display = 'none';
            
            // DÃ©clencher le tÃ©lÃ©chargement
            document.body.appendChild(downloadLink);
            downloadLink.click();
            document.body.removeChild(downloadLink);
            
            // Nettoyer l'URL
            URL.revokeObjectURL(url);
            
            showMessage(`ğŸ“ Fichier ${filename} tÃ©lÃ©chargÃ© avec succÃ¨s !`, 'success');
            document.getElementById('saveLoadContent').innerHTML = '';
            markSaveSuccess();
        }

        // Charger un fichier .json
        function loadJsonFile() {
            const fileInput = document.getElementById('jsonFileInput');
            const file = fileInput.files[0];
            
            if (!file) {
                showMessage('âŒ Veuillez sÃ©lectionner un fichier .json !', 'error');
                return;
            }
            
            if (!file.name.toLowerCase().endsWith('.json')) {
                showMessage('âŒ Le fichier doit avoir l\'extension .json !', 'error');
                return;
            }
            
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const saveData = JSON.parse(e.target.result);
                    
                    // VÃ©rifier la structure de base du fichier
                    if (!saveData.gameState || !saveData.gameState.player) {
                        throw new Error('Fichier de sauvegarde invalide');
                    }
                    
                    // Charger les donnÃ©es
                    if (loadSaveData(saveData)) {
                        showMessage(`ğŸ“ Fichier ${file.name} chargÃ© avec succÃ¨s !`, 'success');
                        
                        // RÃ©initialiser l'input file
                        fileInput.value = '';
                    }
                } catch (error) {
                    console.error('Erreur lors du chargement du fichier JSON:', error);
                    showMessage('âŒ Fichier JSON invalide ou corrompu !', 'error');
                }
            };
            
            reader.onerror = function() {
                showMessage('âŒ Erreur lors de la lecture du fichier !', 'error');
            };
            
            reader.readAsText(file);
        }

        // ============================================
        // SYSTÃˆME AUDIO ET PARTAGE
        // ============================================

        // Son de victoire pour mariage rÃ©ussi
        function playVictorySound() {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                
                // MÃ©lodie joyeuse Ã  3 notes
                const notes = [
                    { frequency: 523.25, time: 0 },     // Do
                    { frequency: 659.25, time: 0.15 },  // Mi
                    { frequency: 783.99, time: 0.3 },   // Sol
                    { frequency: 1046.5, time: 0.45 }   // Do aigu
                ];
                
                notes.forEach(note => {
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    
                    oscillator.type = 'sine';
                    oscillator.frequency.setValueAtTime(note.frequency, audioContext.currentTime + note.time);
                    
                    gainNode.gain.setValueAtTime(0, audioContext.currentTime + note.time);
                    gainNode.gain.linearRampToValueAtTime(0.3, audioContext.currentTime + note.time + 0.05);
                    gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + note.time + 0.4);
                    
                    oscillator.start(audioContext.currentTime + note.time);
                    oscillator.stop(audioContext.currentTime + note.time + 0.4);
                });
                
            } catch (error) {
                console.log('Audio de victoire non supportÃ©:', error);
            }
        }

        // Message de mariage rÃ©ussi avec bouton de partage
        function showMarriageSuccessMessage(firstName, lastName, country, gender, genderEmoji) {
            const messageContainer = document.getElementById('messageContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message success marriage-success';
            messageDiv.style.background = 'linear-gradient(45deg, #d4edda, #c3e6cb)';
            messageDiv.style.border = '2px solid #28a745';
            messageDiv.style.boxShadow = '0 8px 25px rgba(40, 167, 69, 0.3)';
            
            const shareText = `ğŸ’• Mariage rÃ©ussi ! Je me suis mariÃ©(e) avec ${genderEmoji} ${firstName} ${lastName} de ${formatCountryName(country)} dans Country Balls: Mariage ! ğŸŒğŸ’`;
            
            messageDiv.innerHTML = `
                <div class="flex flex-col gap-3">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <div class="text-lg font-bold mb-2">ğŸ‰ FÃ‰LICITATIONS ! ğŸ‰</div>
                            <div class="text-base">
                                ğŸ’• ${genderEmoji} ${firstName} ${lastName} a acceptÃ© votre demande ! Vous voilÃ  mariÃ©s ! ğŸ’•
                            </div>
                            <div class="text-sm text-green-700 dark:text-green-300 mt-2">
                                ğŸŒ ${formatCountryName(country)} â€¢ ${new Date().toLocaleDateString('fr-FR')} â€¢ +50 XP
                            </div>
                        </div>
                        <button class="btn btn-secondary ml-4 py-1 px-3 text-sm" onclick="this.closest('.marriage-success').remove()">
                            âœ–ï¸
                        </button>
                    </div>
                    
                    <div class="flex flex-wrap gap-2 pt-3 border-t border-green-300">
                        <button class="btn btn-success" onclick="shareMarriage('${shareText.replace(/'/g, "\\'")}', '${firstName}', '${lastName}', '${country}', '${gender}')">
                            ğŸ“¤ Partager ce mariage
                        </button>
                        <button class="btn btn-primary" onclick="showSection('marriage')">
                            ğŸ’’ Voir tous mes mariages
                        </button>
                    </div>
                </div>
            `;
            
            messageContainer.appendChild(messageDiv);
            messageContainer.scrollTop = messageContainer.scrollHeight;
        }

        // SystÃ¨me de partage
        function shareMarriage(shareText, firstName, lastName, country, gender) {
            const flag = getFlags(country);
            const genderEmoji = gender === 'male' ? 'ğŸ‘¨' : 'ğŸ‘©';
            const fullShareText = `${shareText}\n\nğŸ® Jouez aussi : Country Balls Mariage !`;
            
            // Essayer d'abord le partage natif
            if (navigator.share) {
                navigator.share({
                    title: 'Country Balls: Mariage ğŸ’•',
                    text: fullShareText,
                    url: window.location.href
                }).then(() => {
                    showMessage('ğŸ“¤ Mariage partagÃ© avec succÃ¨s !', 'success');
                }).catch((error) => {
                    console.log('Partage natif annulÃ©:', error);
                    showCustomShareDialog(shareText, firstName, lastName, country, gender, flag, genderEmoji);
                });
            } else {
                // Fallback : dialogue de partage personnalisÃ©
                showCustomShareDialog(shareText, firstName, lastName, country, gender, flag, genderEmoji);
            }
        }

        // Dialogue de partage personnalisÃ©
        function showCustomShareDialog(shareText, firstName, lastName, country, gender, flag, genderEmoji) {
            const formattedCountry = formatCountryName(country);
            const messageContainer = document.getElementById('messageContainer');
            const shareDialog = document.createElement('div');
            shareDialog.className = 'message special share-dialog';
            shareDialog.style.background = 'linear-gradient(45deg, #667eea, #764ba2)';
            shareDialog.style.color = 'white';
            shareDialog.style.border = '2px solid #5D5CDE';
            shareDialog.style.maxWidth = '500px';
            shareDialog.style.margin = '0 auto';
            
            const encodedText = encodeURIComponent(shareText);
            const encodedUrl = encodeURIComponent(window.location.href);
            
            shareDialog.innerHTML = `
                <div class="text-center">
                    <div class="text-xl font-bold mb-4">ğŸ“¤ Partager votre mariage</div>
                    <div class="text-lg mb-4">${flag} ${genderEmoji} ${firstName} ${lastName} - ${formattedCountry}</div>
                    
                    <div class="bg-white bg-opacity-20 p-3 rounded-lg mb-4 text-sm">
                        <div class="font-semibold mb-2">ğŸ“ Message Ã  partager :</div>
                        <div class="text-left italic">"${shareText}"</div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-2 mb-4">
                        <button class="btn btn-success" onclick="copyToClipboard('${shareText.replace(/'/g, "\\'")}')">
                            ğŸ“‹ Copier le texte
                        </button>
                        <button class="btn btn-warning" onclick="openWhatsAppShare('${encodedText}')">
                            ğŸ’¬ WhatsApp
                        </button>
                        <button class="btn btn-primary" onclick="openFacebookShare('${encodedText}', '${encodedUrl}')">
                            ğŸ“˜ Facebook
                        </button>
                        <button class="btn" style="background: linear-gradient(45deg, #E4405F, #FF6B6B); color: white;" onclick="openInstagramStory()">
                            ğŸ“· Instagram Story
                        </button>
                        <button class="btn" style="background: linear-gradient(45deg, #1DA1F2, #55ACEE); color: white;" onclick="openTwitterShare('${encodedText}', '${encodedUrl}')">
                            ğŸ¦ Twitter
                        </button>
                        <button class="btn" style="background: linear-gradient(45deg, #0077B5, #00A0DC); color: white;" onclick="openLinkedInShare('${encodedText}', '${encodedUrl}')">
                            ğŸ’¼ LinkedIn
                        </button>
                    </div>
                    
                    <button class="btn btn-secondary" onclick="this.closest('.share-dialog').remove()">
                        âœ–ï¸ Fermer
                    </button>
                </div>
            `;
            
            messageContainer.appendChild(shareDialog);
            messageContainer.scrollTop = messageContainer.scrollHeight;
        }

        // Fonctions de partage spÃ©cifiques
        function copyToClipboard(text) {
            try {
                navigator.clipboard.writeText(text).then(() => {
                    showMessage('ğŸ“‹ Texte copiÃ© dans le presse-papiers !', 'success');
                    document.querySelector('.share-dialog')?.remove();
                });
            } catch (error) {
                // Fallback pour navigateurs non compatibles
                const textArea = document.createElement('textarea');
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                showMessage('ğŸ“‹ Texte copiÃ© !', 'success');
                document.querySelector('.share-dialog')?.remove();
            }
        }

        function openWhatsAppShare(text) {
            window.open(`https://wa.me/?text=${text}`, '_blank');
            document.querySelector('.share-dialog')?.remove();
        }

        function openFacebookShare(text, url) {
            window.open(`https://www.facebook.com/sharer/sharer.php?u=${url}&quote=${text}`, '_blank');
            document.querySelector('.share-dialog')?.remove();
        }

        function openTwitterShare(text, url) {
            window.open(`https://twitter.com/intent/tweet?text=${text}&url=${url}`, '_blank');
            document.querySelector('.share-dialog')?.remove();
        }

        function openLinkedInShare(text, url) {
            window.open(`https://www.linkedin.com/sharing/share-offsite/?url=${url}&summary=${text}`, '_blank');
            document.querySelector('.share-dialog')?.remove();
        }

        function openInstagramStory() {
            showMessage('ğŸ“· Instagram Story : Prenez une capture d\'Ã©cran et partagez-la dans votre story Instagram !', 'special');
            document.querySelector('.share-dialog')?.remove();
        }

        // ============================================
        // SYSTÃˆME DE TCHAT INTERACTIF
        // ============================================

        // Ã‰tat du tchat
        let chatState = {
            isOpen: false,
            isMinimized: false,
            currentPartner: null,
            unreadMessages: 0,
            typingTimeout: null,
            chatHistory: []
        };

        // Messages automatiques du partenaire virtuel
        const partnerResponses = [
            "C'est incroyable ! ğŸ˜",
            "Tu me fais rÃªver... ğŸ’•",
            "J'aimerais tellement te rencontrer ! ğŸŒ¹",
            "Parle-moi de ton pays ! ğŸŒ",
            "Tu es si romantique ğŸ’–",
            "Cette aventure est magique âœ¨",
            "Je pense Ã  toi... ğŸ˜˜",
            "Raconte-moi tes rÃªves ğŸŒ™",
            "Tu illumines ma journÃ©e â˜€ï¸",
            "Quel est ton endroit prÃ©fÃ©rÃ© ? ğŸï¸",
            "J'adore discuter avec toi ! ğŸ˜Š",
            "Tu me rends si heureux/heureuse ğŸ’",
            "Quelle belle histoire d'amour ! ğŸ“–",
            "Je t'envoie tout mon amour ğŸ’",
            "Tu es vraiment spÃ©cial(e) ğŸ‘‘"
        ];

        // Initialiser le tchat lors d'un mariage rÃ©ussi
        function initializeChatWithPartner(firstName, lastName, country, gender) {
            const partner = {
                name: `${firstName} ${lastName}`,
                country: formatCountryName(country),
                gender: gender,
                flag: getFlags(country),
                avatar: gender === 'male' ? 'ğŸ‘¨' : 'ğŸ‘©'
            };
            
            chatState.currentPartner = partner;
            updateChatHeader(partner);
            
            // Afficher le tchat automatiquement
            setTimeout(() => {
                showChat();
                // Message de bienvenue du partenaire
                setTimeout(() => {
                    addPartnerMessage(`Salut ${gameState.player.firstName} ! ğŸ’• Je suis si heureux/heureuse d'Ãªtre mariÃ©(e) avec toi ! ğŸ‰`);
                }, 1000);
            }, 2000);
        }

        // Mettre Ã  jour l'en-tÃªte du tchat
        function updateChatHeader(partner) {
            document.getElementById('chatAvatar').textContent = partner.flag;
            document.getElementById('chatPartnerName').textContent = `${partner.avatar} ${partner.name}`;
            document.getElementById('chatPartnerStatus').innerHTML = `
                <span class="online-indicator" style="width: 8px; height: 8px; background: #28a745; border-radius: 50%; display: inline-block; margin-right: 5px;"></span>
                ${partner.country}
            `;
            
            // Initialiser l'heure de bienvenue
            document.getElementById('welcomeTime').textContent = new Date().toLocaleTimeString('fr-FR', {
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // Afficher le tchat
        function showChat() {
            const chatContainer = document.getElementById('chatContainer');
            chatContainer.classList.remove('hidden');
            chatState.isOpen = true;
            chatState.isMinimized = false;
            clearNotifications();
        }

        // Masquer/Afficher le tchat
        function toggleChat() {
            const chatContainer = document.getElementById('chatContainer');
            
            if (chatState.isMinimized) {
                // Restaurer
                chatContainer.classList.remove('minimized');
                chatState.isMinimized = false;
            } else {
                // Minimiser
                chatContainer.classList.add('minimized');
                chatState.isMinimized = true;
            }
        }

        // Fermer le tchat
        function closeChat() {
            const chatContainer = document.getElementById('chatContainer');
            chatContainer.classList.add('hidden');
            chatState.isOpen = false;
            chatState.isMinimized = false;
            clearNotifications();
        }

        // Envoyer un message rapide
        function sendQuickMessage(message) {
            sendMessage(message);
        }

        // Envoyer un message du tchat
        function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (message) {
                sendMessage(message);
                input.value = '';
                adjustTextareaHeight(input);
                updateSendButton();
            }
        }

        // Envoyer un message (fonction principale)
        function sendMessage(message) {
            // Ajouter le message du joueur
            addPlayerMessage(message);
            
            // Simulation de frappe du partenaire
            showTypingIndicator();
            
            // RÃ©ponse automatique du partenaire (simulÃ©)
            setTimeout(() => {
                hideTypingIndicator();
                const response = generatePartnerResponse(message);
                addPartnerMessage(response);
            }, Math.random() * 3000 + 1000); // 1-4 secondes
        }

        // Ajouter un message du joueur
        function addPlayerMessage(message) {
            const messagesContainer = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message-bubble sent';
            
            const currentTime = new Date().toLocaleTimeString('fr-FR', {
                hour: '2-digit',
                minute: '2-digit'
            });
            
            messageDiv.innerHTML = `
                <div>${message}</div>
                <div class="message-time">${currentTime}</div>
            `;
            
            messagesContainer.appendChild(messageDiv);
            scrollToBottom();
            
            // Sauvegarder dans l'historique
            chatState.chatHistory.push({
                type: 'sent',
                message: message,
                time: currentTime
            });
        }

        // Ajouter un message du partenaire
        function addPartnerMessage(message) {
            const messagesContainer = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message-bubble received';
            
            const currentTime = new Date().toLocaleTimeString('fr-FR', {
                hour: '2-digit',
                minute: '2-digit'
            });
            
            messageDiv.innerHTML = `
                <div>${message}</div>
                <div class="message-time">${currentTime}</div>
            `;
            
            messagesContainer.appendChild(messageDiv);
            scrollToBottom();
            
            // Notification si le tchat est fermÃ© ou minimisÃ©
            if (!chatState.isOpen || chatState.isMinimized) {
                showNotification();
            }
            
            // Sauvegarder dans l'historique
            chatState.chatHistory.push({
                type: 'received',
                message: message,
                time: currentTime
            });
        }

        // GÃ©nÃ©rer une rÃ©ponse du partenaire basÃ©e sur le message
        function generatePartnerResponse(playerMessage) {
            const lowerMessage = playerMessage.toLowerCase();
            
            // RÃ©ponses contextuelles
            if (lowerMessage.includes('amour') || lowerMessage.includes('aime')) {
                return `Moi aussi je t'aime ! ğŸ’• Tu es tout pour moi !`;
            }
            if (lowerMessage.includes('mariage') || lowerMessage.includes('mariÃ©')) {
                return `Notre mariage est le plus beau jour de ma vie ! ğŸ’’âœ¨`;
            }
            if (lowerMessage.includes('pays') || lowerMessage.includes('voyage')) {
                return `J'aimerais explorer le monde avec toi ! ğŸŒ ${getFlags(gameState.player.country)} et ${chatState.currentPartner.flag} ensemble !`;
            }
            if (lowerMessage.includes('rÃªve') || lowerMessage.includes('futur')) {
                return `Mes rÃªves se rÃ©alisent avec toi ! ğŸŒŸ Construisons notre avenir ensemble !`;
            }
            if (lowerMessage.includes('belle') || lowerMessage.includes('beau')) {
                return `Tu es encore plus beau/belle ! ğŸ˜ Mon cÅ“ur bat la chamade !`;
            }
            if (lowerMessage.includes('merci') || lowerMessage.includes('remercie')) {
                return `C'est moi qui te remercie ! ğŸ™ Tu es un cadeau du ciel !`;
            }
            if (lowerMessage.includes('triste') || lowerMessage.includes('mal')) {
                return `Ne sois pas triste... ğŸ¤— Je suis lÃ  pour toi, toujours ! ğŸ’`;
            }
            if (lowerMessage.includes('heureux') || lowerMessage.includes('heureuse') || lowerMessage.includes('joie')) {
                return `Ta joie illumine mon monde ! â˜€ï¸ Restons heureux ensemble ! ğŸ‰`;
            }
            
            // RÃ©ponse alÃ©atoire par dÃ©faut
            return partnerResponses[Math.floor(Math.random() * partnerResponses.length)];
        }

        // Afficher l'indicateur de frappe
        function showTypingIndicator() {
            const messagesContainer = document.getElementById('chatMessages');
            const typingDiv = document.createElement('div');
            typingDiv.className = 'typing-indicator';
            typingDiv.id = 'typingIndicator';
            
            typingDiv.innerHTML = `
                <span style="font-size: 12px; color: #666;">En train d'Ã©crire...</span>
                <div class="typing-dots">
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                </div>
            `;
            
            messagesContainer.appendChild(typingDiv);
            scrollToBottom();
        }

        // Masquer l'indicateur de frappe
        function hideTypingIndicator() {
            const typingIndicator = document.getElementById('typingIndicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }

        // Faire dÃ©filer vers le bas
        function scrollToBottom() {
            const messagesContainer = document.getElementById('chatMessages');
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // Gestion des touches du clavier
        function handleChatKeydown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendChatMessage();
            }
            updateSendButton();
        }

        // Ajuster la hauteur du textarea
        function adjustTextareaHeight(textarea) {
            textarea.style.height = 'auto';
            const newHeight = Math.min(textarea.scrollHeight, 80);
            textarea.style.height = newHeight + 'px';
            updateSendButton();
        }

        // Mettre Ã  jour le bouton d'envoi
        function updateSendButton() {
            const input = document.getElementById('chatInput');
            const sendBtn = document.getElementById('chatSendBtn');
            
            if (input.value.trim()) {
                sendBtn.disabled = false;
                sendBtn.style.opacity = '1';
            } else {
                sendBtn.disabled = true;
                sendBtn.style.opacity = '0.5';
            }
        }

        // Toggle du sÃ©lecteur d'Ã©mojis
        function toggleEmojiPicker() {
            const emojiPicker = document.getElementById('emojiPicker');
            emojiPicker.classList.toggle('show');
        }

        // Ajouter un Ã©moji
        function addEmoji(emoji) {
            const input = document.getElementById('chatInput');
            const cursorPos = input.selectionStart;
            const textBefore = input.value.substring(0, cursorPos);
            const textAfter = input.value.substring(cursorPos);
            
            input.value = textBefore + emoji + textAfter;
            input.selectionStart = input.selectionEnd = cursorPos + emoji.length;
            
            adjustTextareaHeight(input);
            updateSendButton();
            input.focus();
            
            // Fermer le sÃ©lecteur d'Ã©mojis
            document.getElementById('emojiPicker').classList.remove('show');
        }

        // Afficher notification de nouveau message
        function showNotification() {
            chatState.unreadMessages++;
            const notification = document.getElementById('chatNotification');
            notification.textContent = chatState.unreadMessages;
            notification.classList.remove('hidden');
        }

        // Effacer les notifications
        function clearNotifications() {
            chatState.unreadMessages = 0;
            document.getElementById('chatNotification').classList.add('hidden');
        }

        // Fermer le sÃ©lecteur d'Ã©mojis en cliquant ailleurs
        document.addEventListener('click', function(event) {
            const emojiPicker = document.getElementById('emojiPicker');
            const emojiBtn = document.querySelector('.emoji-btn');
            const giftPicker = document.getElementById('giftPicker');
            
            if (emojiPicker && !emojiPicker.contains(event.target) && !emojiBtn.contains(event.target)) {
                emojiPicker.classList.remove('show');
            }
            
            if (giftPicker && !giftPicker.contains(event.target)) {
                giftPicker.classList.remove('show');
            }
        });

        // ============================================
        // NOUVELLES FONCTIONNALITÃ‰S CHAT AVANCÃ‰ES
        // ============================================

        // Variables pour les nouvelles fonctionnalitÃ©s
        let messageReactions = {};
        let activePoll = null;
        let activeMission = null;
        let dramHistory = [];
        let currentActiveTab = 'messages';

        // 1. RÃ‰ACTIONS EMOJI DIRECTES
        function showReactionPicker(button) {
            // Supprimer les autres pickers ouverts
            document.querySelectorAll('.reaction-picker').forEach(picker => picker.remove());
            
            const reactionPicker = document.createElement('div');
            reactionPicker.className = 'reaction-picker';
            reactionPicker.style.position = 'absolute';
            reactionPicker.style.top = '-50px';
            reactionPicker.style.left = '0';
            reactionPicker.style.background = 'rgba(255, 255, 255, 0.95)';
            reactionPicker.style.padding = '10px';
            reactionPicker.style.borderRadius = '15px';
            reactionPicker.style.boxShadow = '0 8px 25px rgba(0,0,0,0.2)';
            reactionPicker.style.display = 'flex';
            reactionPicker.style.gap = '8px';
            reactionPicker.style.zIndex = '999';
            reactionPicker.style.border = '1px solid rgba(0,0,0,0.1)';
            
            const reactions = ['ğŸ˜', 'ğŸ˜‚', 'ğŸ˜±', 'ğŸ‘', 'ğŸ’•', 'ğŸ”¥', 'ğŸ˜¢', 'ğŸ˜®'];
            
            reactions.forEach(emoji => {
                const reactionBtn = document.createElement('button');
                reactionBtn.textContent = emoji;
                reactionBtn.style.fontSize = '20px';
                reactionBtn.style.padding = '8px';
                reactionBtn.style.border = 'none';
                reactionBtn.style.background = 'transparent';
                reactionBtn.style.borderRadius = '8px';
                reactionBtn.style.cursor = 'pointer';
                reactionBtn.style.transition = 'all 0.2s ease';
                
                reactionBtn.onmouseover = () => {
                    reactionBtn.style.background = 'rgba(93, 92, 222, 0.2)';
                    reactionBtn.style.transform = 'scale(1.2)';
                };
                reactionBtn.onmouseout = () => {
                    reactionBtn.style.background = 'transparent';
                    reactionBtn.style.transform = 'scale(1)';
                };
                
                reactionBtn.onclick = () => {
                    addReactionToMessage(button, emoji);
                    reactionPicker.remove();
                };
                
                reactionPicker.appendChild(reactionBtn);
            });
            
            button.parentElement.style.position = 'relative';
            button.parentElement.appendChild(reactionPicker);
            
            // Fermer aprÃ¨s 5 secondes
            setTimeout(() => {
                if (reactionPicker.parentElement) {
                    reactionPicker.remove();
                }
            }, 5000);
        }

        function addReactionToMessage(button, emoji) {
            const messageBubble = button.closest('.message-bubble');
            const reactionsContainer = messageBubble.querySelector('.message-reactions');
            const messageId = messageBubble.getAttribute('data-message-id') || `msg-${Date.now()}`;
            
            messageBubble.setAttribute('data-message-id', messageId);
            
            if (!messageReactions[messageId]) {
                messageReactions[messageId] = {};
            }
            
            if (!messageReactions[messageId][emoji]) {
                messageReactions[messageId][emoji] = {
                    count: 0,
                    users: []
                };
            }
            
            const currentUser = gameState.player.firstName || 'Moi';
            
            // Toggle rÃ©action
            if (messageReactions[messageId][emoji].users.includes(currentUser)) {
                // Retirer rÃ©action
                messageReactions[messageId][emoji].count--;
                messageReactions[messageId][emoji].users = messageReactions[messageId][emoji].users.filter(u => u !== currentUser);
                
                if (messageReactions[messageId][emoji].count === 0) {
                    delete messageReactions[messageId][emoji];
                }
            } else {
                // Ajouter rÃ©action
                messageReactions[messageId][emoji].count++;
                messageReactions[messageId][emoji].users.push(currentUser);
            }
            
            updateReactionsDisplay(reactionsContainer, messageId);
        }

        function updateReactionsDisplay(container, messageId) {
            if (!messageReactions[messageId]) {
                container.innerHTML = '';
                return;
            }
            
            container.innerHTML = '';
            
            Object.entries(messageReactions[messageId]).forEach(([emoji, data]) => {
                if (data.count > 0) {
                    const reactionItem = document.createElement('div');
                    reactionItem.className = 'reaction-item';
                    
                    const currentUser = gameState.player.firstName || 'Moi';
                    if (data.users.includes(currentUser)) {
                        reactionItem.classList.add('selected');
                    }
                    
                    reactionItem.innerHTML = `
                        <span>${emoji}</span>
                        <span>${data.count}</span>
                    `;
                    
                    reactionItem.onclick = () => {
                        const button = container.closest('.message-bubble').querySelector('.reaction-add-btn');
                        addReactionToMessage(button, emoji);
                    };
                    
                    container.appendChild(reactionItem);
                }
            });
        }

        // 2. SONDAGES EXPRESS
        function createPoll() {
            if (activePoll) {
                showMessage('âš ï¸ Un sondage est dÃ©jÃ  en cours !', 'error');
                return;
            }
            
            const question = prompt('â“ Quelle est votre question pour le sondage ?');
            if (!question) return;
            
            const option1 = prompt('ğŸ“ Option 1 :');
            if (!option1) return;
            
            const option2 = prompt('ğŸ“ Option 2 :');
            if (!option2) return;
            
            activePoll = {
                question: question,
                options: [
                    { text: option1, votes: 0, voters: [] },
                    { text: option2, votes: 0, voters: [] }
                ],
                totalVotes: 0
            };
            
            addPollToChat(activePoll);
        }

        function addPollToChat(poll) {
            const messagesContainer = document.getElementById('chatMessages');
            const pollDiv = document.createElement('div');
            pollDiv.className = 'poll-container';
            pollDiv.id = 'activePoll';
            
            pollDiv.innerHTML = `
                <div class="poll-question">ğŸ“Š ${poll.question}</div>
                <div class="poll-options" id="pollOptions">
                    ${poll.options.map((option, index) => `
                        <div class="poll-option" onclick="voteInPoll(${index})" data-option="${index}">
                            <div class="poll-progress" style="width: 0%"></div>
                            <div class="poll-option-content">
                                <span>${option.text}</span>
                                <span class="poll-percentage">0%</span>
                            </div>
                        </div>
                    `).join('')}
                </div>
                <div style="margin-top: 10px; font-size: 12px; opacity: 0.8; text-align: center;">
                    Votes total : <span id="pollTotalVotes">0</span>
                </div>
            `;
            
            messagesContainer.appendChild(pollDiv);
            scrollToBottom();
            
            // Simulation du vote du partenaire aprÃ¨s 3-5 secondes
            setTimeout(() => {
                if (activePoll) {
                    const partnerChoice = Math.floor(Math.random() * poll.options.length);
                    voteInPoll(partnerChoice, 'partner');
                }
            }, Math.random() * 2000 + 3000);
        }

        function voteInPoll(optionIndex, voter = 'player') {
            if (!activePoll) return;
            
            const voterId = voter === 'partner' ? (chatState.currentPartner?.name || 'Partenaire') : (gameState.player.firstName || 'Moi');
            
            // VÃ©rifier si l'utilisateur a dÃ©jÃ  votÃ©
            let hasVoted = false;
            activePoll.options.forEach(option => {
                if (option.voters.includes(voterId)) {
                    hasVoted = true;
                }
            });
            
            if (hasVoted && voter === 'player') {
                showMessage('âš ï¸ Vous avez dÃ©jÃ  votÃ© !', 'error');
                return;
            }
            
            // Ajouter le vote
            activePoll.options[optionIndex].votes++;
            activePoll.options[optionIndex].voters.push(voterId);
            activePoll.totalVotes++;
            
            updatePollDisplay();
            
            if (voter === 'partner') {
                addPartnerMessage(`J'ai votÃ© pour "${activePoll.options[optionIndex].text}" ! ğŸ—³ï¸`);
            }
        }

        function updatePollDisplay() {
            const pollOptions = document.getElementById('pollOptions');
            const totalVotesSpan = document.getElementById('pollTotalVotes');
            
            if (!pollOptions || !activePoll) return;
            
            pollOptions.innerHTML = activePoll.options.map((option, index) => {
                const percentage = activePoll.totalVotes > 0 ? Math.round((option.votes / activePoll.totalVotes) * 100) : 0;
                
                return `
                    <div class="poll-option voted" data-option="${index}">
                        <div class="poll-progress" style="width: ${percentage}%"></div>
                        <div class="poll-option-content">
                            <span>${option.text}</span>
                            <span class="poll-percentage">${percentage}% (${option.votes})</span>
                        </div>
                    </div>
                `;
            }).join('');
            
            totalVotesSpan.textContent = activePoll.totalVotes;
            
            // ClÃ´turer le sondage aprÃ¨s 2 votes ou 30 secondes
            if (activePoll.totalVotes >= 2) {
                setTimeout(() => {
                    closePoll();
                }, 5000);
            }
        }

        function closePoll() {
            if (!activePoll) return;
            
            const winner = activePoll.options.reduce((prev, current) => 
                (prev.votes > current.votes) ? prev : current
            );
            
            addPartnerMessage(`ğŸ“Š RÃ©sultats du sondage : "${winner.text}" l'emporte avec ${winner.votes} votes ! ğŸ‰`);
            activePoll = null;
        }

        // 3. DRAMA CARDS
        const dramaCards = [
            {
                type: 'rupture',
                emoji: 'ğŸ’”',
                title: 'Rupture Dramatique !',
                description: 'Des rumeurs de rupture circulent... Est-ce vrai ?',
                impact: -15,
                color: '#FF6B6B'
            },
            {
                type: 'surprise',
                emoji: 'ğŸ‰',
                title: 'Surprise Romantique !',
                description: 'Une surprise incroyable vous attend !',
                impact: 20,
                color: '#4ECDC4'
            },
            {
                type: 'invitation',
                emoji: 'ğŸ’’',
                title: 'Invitation Mariage !',
                description: 'Vous Ãªtes invitÃ©s Ã  un mariage royal !',
                impact: 15,
                color: '#FFD93D'
            },
            {
                type: 'scandal',
                emoji: 'ğŸ“°',
                title: 'Scandale MÃ©diatique !',
                description: 'Les mÃ©dias parlent de votre relation !',
                impact: -10,
                color: '#FF8E53'
            },
            {
                type: 'voyage',
                emoji: 'âœˆï¸',
                title: 'Voyage de RÃªve !',
                description: 'Opportunity de voyage romantique Ã  saisir !',
                impact: 25,
                color: '#667eea'
            }
        ];

        function triggerDramaCard() {
            const randomCard = dramaCards[Math.floor(Math.random() * dramaCards.length)];
            addDramaCard(randomCard);
        }

        function addDramaCard(card) {
            const messagesContainer = document.getElementById('chatMessages');
            const cardDiv = document.createElement('div');
            cardDiv.className = 'drama-card';
            cardDiv.style.background = `linear-gradient(135deg, ${card.color}, ${card.color}dd)`;
            
            cardDiv.innerHTML = `
                <div class="drama-card-header">${card.emoji}</div>
                <div class="drama-card-title">${card.title}</div>
                <div class="drama-card-description">${card.description}</div>
                <div class="drama-card-actions">
                    <button class="btn btn-success" onclick="handleDramaAction('accept', '${card.type}', ${card.impact})">
                        âœ… Accepter
                    </button>
                    <button class="btn btn-warning" onclick="handleDramaAction('ignore', '${card.type}', ${card.impact})">
                        ğŸ¤· Ignorer
                    </button>
                    <button class="btn btn-secondary" onclick="handleDramaAction('reject', '${card.type}', ${card.impact})">
                        âŒ Rejeter
                    </button>
                </div>
            `;
            
            messagesContainer.appendChild(cardDiv);
            scrollToBottom();
            
            // Ajouter Ã  l'historique
            dramHistory.push({
                type: card.type,
                title: card.title,
                date: new Date().toLocaleDateString('fr-FR'),
                impact: card.impact,
                action: null
            });
            
            updateDramaHistory();
        }

        function handleDramaAction(action, cardType, impact) {
            // Supprimer la carte drama
            document.querySelectorAll('.drama-card').forEach(card => card.remove());
            
            let message = '';
            let actualImpact = impact;
            
            switch (action) {
                case 'accept':
                    message = `âœ… Vous avez acceptÃ© ! StabilitÃ© : ${impact > 0 ? '+' : ''}${impact}`;
                    break;
                case 'ignore':
                    actualImpact = Math.floor(impact * 0.5);
                    message = `ğŸ¤· Vous avez ignorÃ©. Impact rÃ©duit : ${actualImpact > 0 ? '+' : ''}${actualImpact}`;
                    break;
                case 'reject':
                    actualImpact = impact > 0 ? -Math.abs(impact) : Math.abs(impact);
                    message = `âŒ Vous avez rejetÃ©. Impact inversÃ© : ${actualImpact > 0 ? '+' : ''}${actualImpact}`;
                    break;
            }
            
            relationshipStability = Math.max(0, Math.min(100, relationshipStability + actualImpact));
            showMessage(message, actualImpact > 0 ? 'success' : 'error');
            
            // Mettre Ã  jour l'historique avec l'action
            if (dramHistory.length > 0) {
                dramHistory[dramHistory.length - 1].action = action;
                dramHistory[dramHistory.length - 1].actualImpact = actualImpact;
            }
            
            updateDramaHistory();
        }

        // 4. MESSAGES SPÃ‰CIAUX PENDANT GUERRE
        function enableWarChatMode() {
            const chatContainer = document.getElementById('chatContainer');
            chatContainer.classList.add('war-chat-mode');
            
            addWarMessage('ğŸ’£ La situation est critique, restons soudÃ©s !');
            
            setTimeout(() => {
                addWarMessage('âš¡ Tensions maximales ! Que faire ?', true);
            }, 3000);
        }

        function addWarMessage(message, withPeaceButton = false) {
            const messagesContainer = document.getElementById('chatMessages');
            const warDiv = document.createElement('div');
            warDiv.className = 'war-message';
            
            let content = `<div>${message}</div>`;
            
            if (withPeaceButton) {
                content += `
                    <div style="margin-top: 15px;">
                        <button class="btn btn-success" onclick="attemptPeaceFromChat()">
                            ğŸ¤ Tenter une rÃ©conciliation
                        </button>
                    </div>
                `;
            }
            
            warDiv.innerHTML = content;
            messagesContainer.appendChild(warDiv);
            scrollToBottom();
        }

        function attemptPeaceFromChat() {
            document.querySelectorAll('.war-message').forEach(msg => msg.remove());
            const chatContainer = document.getElementById('chatContainer');
            chatContainer.classList.remove('war-chat-mode');
            
            if (Math.random() > 0.3) {
                addPartnerMessage('ğŸ•Šï¸ Tu as raison... Faisons la paix. Notre amour est plus fort ! ğŸ’•');
                relationshipStability = Math.min(100, relationshipStability + 30);
                showMessage('ğŸ•Šï¸ RÃ©conciliation rÃ©ussie ! +30 stabilitÃ© !', 'success');
            } else {
                addPartnerMessage('ğŸ˜¤ Non ! Il faut du temps pour guÃ©rir ces blessures...');
                showMessage('ğŸ’” RÃ©conciliation Ã©chouÃ©e... Patience requise.', 'error');
            }
        }

        // 5. SYSTÃˆME DE CADEAUX VIRTUELS
        function toggleGiftPicker() {
            const giftPicker = document.getElementById('giftPicker');
            giftPicker.classList.toggle('show');
        }

        function sendGift(emoji, description) {
            const giftPicker = document.getElementById('giftPicker');
            giftPicker.classList.remove('show');
            
            addGiftToChat(emoji, description);
            
            // RÃ©action du partenaire
            setTimeout(() => {
                const reactions = [
                    'Oh ! Quel magnifique cadeau ! ğŸ˜',
                    'Tu me gÃ¢tes trop ! ğŸ¥°',
                    'C\'est exactement ce dont j\'avais besoin ! ğŸ’•',
                    'Tu es si attentionnÃ©(e) ! ğŸŒŸ',
                    'Je vais le chÃ©rir pour toujours ! ğŸ’'
                ];
                const reaction = reactions[Math.floor(Math.random() * reactions.length)];
                addPartnerMessage(reaction);
            }, 2000);
        }

        function addGiftToChat(emoji, description) {
            const messagesContainer = document.getElementById('chatMessages');
            const giftDiv = document.createElement('div');
            giftDiv.className = 'gift-container';
            
            giftDiv.innerHTML = `
                <div class="gift-emoji">${emoji}</div>
                <div class="gift-text">ğŸ ${description}</div>
                <div style="font-size: 12px; margin-top: 8px; opacity: 0.8;">
                    EnvoyÃ© avec amour par ${gameState.player.firstName || 'Vous'} ğŸ’•
                </div>
            `;
            
            messagesContainer.appendChild(giftDiv);
            scrollToBottom();
            
            relationshipStability = Math.min(100, relationshipStability + 5);
        }

        // 6. MISSIONS COOPÃ‰RATIVES
        const coopQuestions = [
            {
                question: 'Quelle est la capitale de la France ?',
                answers: ['Paris', 'Lyon', 'Marseille', 'Toulouse'],
                correct: 0
            },
            {
                question: 'Quel pays a inventÃ© la pizza ?',
                answers: ['France', 'Italie', 'GrÃ¨ce', 'Espagne'],
                correct: 1
            },
            {
                question: 'Quelle langue parle-t-on au BrÃ©sil ?',
                answers: ['Espagnol', 'Anglais', 'Portugais', 'FranÃ§ais'],
                correct: 2
            },
            {
                question: 'Combien de continents y a-t-il ?',
                answers: ['5', '6', '7', '8'],
                correct: 2
            }
        ];

        function startCoopMission() {
            if (activeMission) {
                showMessage('âš ï¸ Une mission est dÃ©jÃ  en cours !', 'error');
                return;
            }
            
            const randomQuestion = coopQuestions[Math.floor(Math.random() * coopQuestions.length)];
            activeMission = {
                question: randomQuestion,
                playerAnswer: null,
                partnerAnswer: null,
                completed: false
            };
            
            addCoopMissionToChat(randomQuestion);
        }

        function addCoopMissionToChat(question) {
            const messagesContainer = document.getElementById('chatMessages');
            const missionDiv = document.createElement('div');
            missionDiv.className = 'coop-mission';
            missionDiv.id = 'activeMission';
            
            missionDiv.innerHTML = `
                <div class="coop-mission-title">ğŸ¤ Mission CoopÃ©rative</div>
                <div class="coop-mission-question">${question.question}</div>
                <div class="coop-mission-answers" id="missionAnswers">
                    ${question.answers.map((answer, index) => `
                        <div class="coop-answer" onclick="answerCoopQuestion(${index})" data-answer="${index}">
                            ${answer}
                        </div>
                    `).join('')}
                </div>
                <div style="font-size: 12px; text-align: center; margin-top: 10px;">
                    RÃ©pondez ensemble pour rÃ©tablir la paix ! âœ¨
                </div>
            `;
            
            messagesContainer.appendChild(missionDiv);
            scrollToBottom();
            
            // Le partenaire rÃ©pond aprÃ¨s 3-8 secondes
            setTimeout(() => {
                if (activeMission && !activeMission.completed) {
                    const partnerChoice = Math.floor(Math.random() * question.answers.length);
                    answerCoopQuestion(partnerChoice, 'partner');
                }
            }, Math.random() * 5000 + 3000);
        }

        function answerCoopQuestion(answerIndex, responder = 'player') {
            if (!activeMission || activeMission.completed) return;
            
            if (responder === 'player') {
                if (activeMission.playerAnswer !== null) {
                    showMessage('âš ï¸ Vous avez dÃ©jÃ  rÃ©pondu !', 'error');
                    return;
                }
                activeMission.playerAnswer = answerIndex;
            } else {
                activeMission.partnerAnswer = answerIndex;
                addPartnerMessage(`J'ai choisi : "${activeMission.question.answers[answerIndex]}" ! ğŸ¤”`);
            }
            
            // Mettre Ã  jour l'affichage
            updateCoopMissionDisplay();
            
            // VÃ©rifier si les deux ont rÃ©pondu
            if (activeMission.playerAnswer !== null && activeMission.partnerAnswer !== null) {
                setTimeout(() => {
                    completeCoopMission();
                }, 2000);
            }
        }

        function updateCoopMissionDisplay() {
            const answersContainer = document.getElementById('missionAnswers');
            if (!answersContainer || !activeMission) return;
            
            answersContainer.innerHTML = activeMission.question.answers.map((answer, index) => {
                let className = 'coop-answer';
                let extraText = '';
                
                if (activeMission.playerAnswer === index) {
                    className += ' selected';
                    extraText = ' (Vous)';
                }
                if (activeMission.partnerAnswer === index) {
                    extraText += activeMission.playerAnswer === index ? ' (Vous deux)' : ` (${chatState.currentPartner?.name || 'Partenaire'})`;
                }
                
                return `
                    <div class="${className}" data-answer="${index}">
                        ${answer}${extraText}
                    </div>
                `;
            }).join('');
        }

        function completeCoopMission() {
            if (!activeMission || activeMission.completed) return;
            
            activeMission.completed = true;
            const correctAnswer = activeMission.question.correct;
            const bothCorrect = activeMission.playerAnswer === correctAnswer && activeMission.partnerAnswer === correctAnswer;
            const oneCorrect = activeMission.playerAnswer === correctAnswer || activeMission.partnerAnswer === correctAnswer;
            
            // Colorier les rÃ©ponses
            const answersContainer = document.getElementById('missionAnswers');
            answersContainer.innerHTML = activeMission.question.answers.map((answer, index) => {
                let className = 'coop-answer';
                if (index === correctAnswer) {
                    className += ' correct';
                } else if (index === activeMission.playerAnswer || index === activeMission.partnerAnswer) {
                    className += ' incorrect';
                }
                
                let extraText = '';
                if (activeMission.playerAnswer === index) {
                    extraText = ' (Vous)';
                }
                if (activeMission.partnerAnswer === index) {
                    extraText += activeMission.playerAnswer === index ? ' (Vous deux)' : ` (${chatState.currentPartner?.name || 'Partenaire'})`;
                }
                
                return `
                    <div class="${className}">
                        ${answer}${extraText}
                        ${index === correctAnswer ? ' âœ…' : ''}
                    </div>
                `;
            }).join('');
            
            let resultMessage = '';
            let stabilityBonus = 0;
            
            if (bothCorrect) {
                resultMessage = 'ğŸ‰ Parfait ! Vous avez tous les deux la bonne rÃ©ponse ! Paix rÃ©tablie ! +30 stabilitÃ© !';
                stabilityBonus = 30;
                gainXP(50);
            } else if (oneCorrect) {
                resultMessage = 'ğŸ‘ Pas mal ! L\'un de vous a trouvÃ© la bonne rÃ©ponse. +15 stabilitÃ© !';
                stabilityBonus = 15;
                gainXP(25);
            } else {
                resultMessage = 'ğŸ˜… Aucun de vous n\'a trouvÃ©... Mais l\'effort compte ! +5 stabilitÃ© !';
                stabilityBonus = 5;
                gainXP(10);
            }
            
            relationshipStability = Math.min(100, relationshipStability + stabilityBonus);
            
            setTimeout(() => {
                addPartnerMessage(resultMessage);
                activeMission = null;
            }, 1000);
        }

        // 7. HISTORIQUE DES DRAMAS
        function updateDramaHistory() {
            const historyContainer = document.getElementById('dramaHistory');
            
            if (dramHistory.length === 0) {
                historyContainer.innerHTML = `
                    <div class="text-center text-gray-500 dark:text-gray-400 p-4">
                        Aucun drama pour le moment... ğŸ˜Œ
                    </div>
                `;
                return;
            }
            
            historyContainer.innerHTML = dramHistory.map(drama => `
                <div class="drama-history-item">
                    <div class="drama-history-date">${drama.date}</div>
                    <div class="drama-history-type">${drama.title}</div>
                    <div class="drama-history-impact">
                        Impact : ${drama.actualImpact || drama.impact > 0 ? '+' : ''}${drama.actualImpact || drama.impact} stabilitÃ©
                        ${drama.action ? `(${drama.action === 'accept' ? 'AcceptÃ©' : drama.action === 'ignore' ? 'IgnorÃ©' : 'RejetÃ©'})` : ''}
                    </div>
                </div>
            `).join('');
        }

        // ONGLETS DU CHAT
        function switchChatTab(tabName) {
            // Mettre Ã  jour les onglets
            document.querySelectorAll('.chat-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.chat-tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Activer le bon onglet
            document.querySelector(`.chat-tab[onclick="switchChatTab('${tabName}')"]`).classList.add('active');
            document.getElementById(tabName + 'Tab').classList.add('active');
            
            currentActiveTab = tabName;
            
            if (tabName === 'history') {
                updateDramaHistory();
            }
        }

        // BOUTONS RAPIDES Ã‰TENDUS
        function addExtendedQuickButtons() {
            const quickMessages = document.querySelector('.quick-messages');
            
            // Ajouter le bouton de mission coopÃ©rative s'il n'existe pas
            if (!document.querySelector('[onclick="startCoopMission()"]')) {
                const missionBtn = document.createElement('button');
                missionBtn.className = 'quick-msg-btn';
                missionBtn.textContent = 'ğŸ¤ Mission';
                missionBtn.onclick = startCoopMission;
                quickMessages.appendChild(missionBtn);
            }
        }

        // Initialiser les fonctionnalitÃ©s Ã©tendues
        function initExtendedChatFeatures() {
            addExtendedQuickButtons();
            updateDramaHistory();
        }

        // ============================================
        // SYSTÃˆME DE RUPTURE DRAMATIQUE
        // ============================================

        function breakUp(partnerName) {
            const marriageIndex = marriageHistory.findIndex(m => m.partner === partnerName);
            if (marriageIndex === -1) {
                console.error('âŒ Partenaire introuvable:', partnerName);
                showMessage('âŒ Erreur : partenaire introuvable !', 'error');
                return;
            }

            const marriage = marriageHistory[marriageIndex];
            const partnerCountry = marriage.partnerCountry;
            const genderEmoji = marriage.partnerGender === 'male' ? 'ğŸ‘¨' : 'ğŸ‘©';

            console.log(`ğŸ’” Tentative de rupture avec ${partnerName} (index: ${marriageIndex})`);
            
            // Confirmation dramatique
            const confirmMessage = `ğŸ’” ÃŠtes-vous vraiment sÃ»r(e) de vouloir quitter ${genderEmoji} ${partnerName} de ${formatCountryName(partnerCountry)} ?\n\nâš ï¸ Cette action est irrÃ©versible et aura des consÃ©quences !`;
            
            if (!confirm(confirmMessage)) {
                console.log('ğŸ’” Rupture annulÃ©e par l\'utilisateur');
                return;
            }
            
            console.log(`ğŸ’” Rupture confirmÃ©e avec ${partnerName}`);
            
            // Supprimer immÃ©diatement la carte avec animation
            const marriageCard = document.getElementById(`marriage-${marriageIndex}`);
            if (marriageCard) {
                marriageCard.style.animation = 'breakupDisappear 1s ease-out';
                marriageCard.style.pointerEvents = 'none'; // DÃ©sactiver les interactions
                
                setTimeout(() => {
                    if (marriageCard.parentElement) {
                        marriageCard.remove();
                    }
                }, 1000);
            }
            
            // Supprimer le mariage de l'historique
            marriageHistory.splice(marriageIndex, 1);
            console.log(`âœ… ${partnerName} retirÃ© de l'historique des mariages`);
            
            // Mettre Ã  jour immÃ©diatement l'affichage de la liste
            setTimeout(() => {
                updateMarriageList();
                console.log('âœ… Liste des mariages mise Ã  jour');
            }, 500);
            
            // PÃ©nalitÃ©s
            const xpLoss = Math.min(gameState.player.xp, 75);
            gameState.player.xp = Math.max(0, gameState.player.xp - xpLoss);
            relationshipStability = Math.max(0, relationshipStability - 50);
            
            // Mettre Ã  jour les affichages
            updateXPDisplay();
            markUnsavedChanges();
            
            // Message de confirmation immÃ©diat
            showMessage(`ğŸ’” Rupture confirmÃ©e ! Vous avez quittÃ© ${genderEmoji} ${partnerName} de ${formatCountryName(partnerCountry)}. XP: -${xpLoss}, StabilitÃ©: -50`, 'error');
            
            // Effets dramatiques de rupture (aprÃ¨s le message de confirmation)
            setTimeout(() => {
                createBreakupEffects();
                playBreakupSound();
                
                // Message dramatique dÃ©taillÃ©
                setTimeout(() => {
                    showBreakupMessage(partnerName, partnerCountry, genderEmoji, xpLoss);
                }, 1000);
            }, 200);
            
            // Message dans le tchat si c'Ã©tait le partenaire principal
            if (chatState.currentPartner && chatState.currentPartner.name === partnerName) {
                setTimeout(() => {
                    addBreakupChatMessage(partnerName);
                }, 2000);
            }
            
            console.log(`âœ… Rupture complÃ¨te avec ${partnerName}`);
        }

        function createBreakupEffects() {
            // CÅ“urs brisÃ©s qui tombent
            for (let i = 0; i < 15; i++) {
                setTimeout(() => {
                    const brokenHeart = document.createElement('div');
                    brokenHeart.className = 'heart-animation';
                    brokenHeart.textContent = 'ğŸ’”';
                    brokenHeart.style.left = Math.random() * window.innerWidth + 'px';
                    brokenHeart.style.top = '0px';
                    brokenHeart.style.color = '#FF6B6B';
                    brokenHeart.style.fontSize = '50px';
                    brokenHeart.style.animation = 'breakupFall 3s ease-in';
                    document.body.appendChild(brokenHeart);
                    
                    setTimeout(() => brokenHeart.remove(), 3000);
                }, i * 200);
            }
            
            // Tremblement de l'Ã©cran
            document.body.style.animation = 'breakupShake 0.8s ease-in-out 3';
            
            // Overlay sombre temporaire
            const sadOverlay = document.createElement('div');
            sadOverlay.style.position = 'fixed';
            sadOverlay.style.top = '0';
            sadOverlay.style.left = '0';
            sadOverlay.style.width = '100%';
            sadOverlay.style.height = '100%';
            sadOverlay.style.background = 'rgba(0, 0, 0, 0.4)';
            sadOverlay.style.pointerEvents = 'none';
            sadOverlay.style.zIndex = '999';
            sadOverlay.style.animation = 'sadnessOverlay 2s ease-in-out';
            document.body.appendChild(sadOverlay);
            
            setTimeout(() => {
                sadOverlay.remove();
                document.body.style.animation = '';
            }, 2000);
        }

        function playBreakupSound() {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                
                // Son triste descendant
                const notes = [
                    { frequency: 523.25, time: 0 },     // Do
                    { frequency:493.88, time: 0.3 },   // Si
                    { frequency: 440.00, time: 0.6 },   // La
                    { frequency: 392.00, time: 0.9 },   // Sol
                    { frequency: 349.23, time: 1.2 }    // Fa
                ];
                
                notes.forEach(note => {
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    
                    oscillator.type = 'sine';
                    oscillator.frequency.setValueAtTime(note.frequency, audioContext.currentTime + note.time);
                    
                    gainNode.gain.setValueAtTime(0, audioContext.currentTime + note.time);
                    gainNode.gain.linearRampToValueAtTime(0.4, audioContext.currentTime + note.time + 0.05);
                    gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + note.time + 0.8);
                    
                    oscillator.start(audioContext.currentTime + note.time);
                    oscillator.stop(audioContext.currentTime + note.time + 0.8);
                });
                
            } catch (error) {
                console.log('Audio de rupture non supportÃ©:', error);
            }
        }

        function showBreakupMessage(partnerName, partnerCountry, genderEmoji, xpLoss) {
            const messageContainer = document.getElementById('messageContainer');
            const breakupDiv = document.createElement('div');
            breakupDiv.className = 'message error breakup-message';
            breakupDiv.style.background = 'linear-gradient(45deg, #8B0000, #DC143C, #FF6B6B)';
            breakupDiv.style.color = 'white';
            breakupDiv.style.border = '3px solid #8B0000';
            breakupDiv.style.boxShadow = '0 8px 25px rgba(139, 0, 0, 0.5)';
            breakupDiv.style.animation = 'dramaticPulse 2s ease-in-out 3';
            
            const breakupMessages = [
                `C'est fini entre nous ! Notre amour n'Ã©tait qu'un mensonge !`,
                `Je ne peux plus supporter cette relation ! C'est terminÃ© !`,
                `Nos diffÃ©rences sont trop importantes... Nous devons nous sÃ©parer.`,
                `Cette histoire d'amour s'arrÃªte ici ! Adieu !`,
                `Je mÃ©rite mieux que Ã§a ! Je te quitte dÃ©finitivement !`
            ];
            
            const randomMessage = breakupMessages[Math.floor(Math.random() * breakupMessages.length)];
            
            breakupDiv.innerHTML = `
                <div class="text-center">
                    <div style="font-size: 4em; margin-bottom: 20px;">ğŸ’”ğŸ’”ğŸ’”</div>
                    <div style="font-size: 24px; font-weight: bold; margin-bottom: 15px; text-shadow: 2px 2px 4px rgba(0,0,0,0.7);">
                        ğŸš¨ RUPTURE DRAMATIQUE ! ğŸš¨
                    </div>
                    <div style="font-size: 20px; margin-bottom: 20px; background: rgba(0,0,0,0.4); padding: 20px; border-radius: 15px;">
                        ğŸ’” Vous avez quittÃ© ${genderEmoji} ${partnerName} de ${formatCountryName(partnerCountry)} !
                    </div>
                    <div style="font-size: 18px; margin: 15px 0; background: rgba(139,0,0,0.6); padding: 15px; border-radius: 10px;">
                        "${randomMessage}"
                    </div>
                    <div style="font-size: 16px; margin: 20px 0;">
                        ğŸ’¸ Perte d'XP : -${xpLoss} points<br>
                        ğŸ’” StabilitÃ© relationnelle : -50 points<br>
                        ğŸ˜¢ Reputation dÃ©gradÃ©e...
                    </div>
                    
                    <div style="font-size: 3em; margin: 20px 0; animation: explosionBlink 0.8s infinite;">
                        ğŸ˜­ğŸ’”ğŸ˜­
                    </div>
                    
                    <div style="margin-top: 25px;">
                        <button class="btn btn-secondary" onclick="this.closest('.breakup-message').remove()">
                            ğŸ˜” Accepter la rÃ©alitÃ©
                        </button>
                    </div>
                </div>
            `;
            
            messageContainer.appendChild(breakupDiv);
            messageContainer.scrollTop = messageContainer.scrollHeight;
        }

        function addBreakupChatMessage(partnerName) {
            if (chatState.isOpen || chatState.isMinimized) {
                const farewellMessages = [
                    `ğŸ˜­ Comment as-tu pu me faire Ã§a ?! Je pensais qu'on s'aimait vraiment...`,
                    `ğŸ’” C'est fini alors... J'espÃ¨re que tu seras heureux/heureuse sans moi.`,
                    `ğŸ˜¢ Je ne comprends pas... Qu'est-ce qui n'allait pas dans notre relation ?`,
                    `ğŸ˜  Tu me brises le cÅ“ur ! Je ne t'oublierai jamais !`,
                    `ğŸ˜­ Adieu ${gameState.player.firstName}... Tu vas me manquer terriblement.`
                ];
                
                const randomFarewell = farewellMessages[Math.floor(Math.random() * farewellMessages.length)];
                
                // Message d'adieu du partenaire
                setTimeout(() => {
                    addPartnerMessage(randomFarewell);
                }, 1000);
                
                // Fermer le tchat aprÃ¨s le message d'adieu
                setTimeout(() => {
                    closeChat();
                    chatState.currentPartner = null;
                }, 4000);
            }
        }

        // ============================================
        // QUIZ CULTUREL
        // ============================================

        function startQuiz() {
            quizIndex = 0;
            quizScore = 0;
            document.getElementById('quizScore').textContent = '';
            showQuizQuestion();
        }

        function showQuizQuestion() {
            const q = quizQuestions[quizIndex];
            const questionEl = document.getElementById('quizQuestion');
            const optionsEl = document.getElementById('quizOptions');
            const nextBtn = document.getElementById('nextQuestionBtn');

            questionEl.textContent = q.question;
            optionsEl.innerHTML = '';

            q.options.forEach((opt, i) => {
                const btn = document.createElement('button');
                btn.className = 'btn btn-secondary quiz-option';
                btn.textContent = opt;
                btn.onclick = () => selectQuizAnswer(i);
                optionsEl.appendChild(btn);
            });

            nextBtn.classList.add('hidden');
        }

        function selectQuizAnswer(index) {
            const q = quizQuestions[quizIndex];
            const optionButtons = document.querySelectorAll('#quizOptions .quiz-option');

            optionButtons.forEach((btn, i) => {
                btn.disabled = true;
                if (i === q.correct) btn.classList.add('correct');
                if (i === index && i !== q.correct) btn.classList.add('incorrect');
            });

            if (index === q.correct) {
                quizScore++;
                gainXP(20);
            }

            const nextBtn = document.getElementById('nextQuestionBtn');
            nextBtn.textContent = quizIndex === quizQuestions.length - 1 ? 'Voir le score' : 'Question suivante';
            nextBtn.classList.remove('hidden');
        }

        function nextQuizQuestion() {
            quizIndex++;
            if (quizIndex < quizQuestions.length) {
                showQuizQuestion();
            } else {
                document.getElementById('quizQuestion').textContent = `Votre score : ${quizScore} / ${quizQuestions.length}`;
                document.getElementById('quizOptions').innerHTML = '';
                document.getElementById('nextQuestionBtn').classList.add('hidden');
                document.getElementById('quizScore').textContent = `XP gagnÃ© : ${quizScore * 20}`;
            }
        }

        // ============================================
        // INITIALISATION
        // ============================================

        // Initialisation au chargement de la page (sans localStorage)
        window.onload = function() {
            initGame();
            initTheme();
            startJealousySystem();
            
            // Initialiser les Ã©vÃ©nements du tchat
            const chatInput = document.getElementById('chatInput');
            if (chatInput) {
                chatInput.addEventListener('input', function() {
                    adjustTextareaHeight(this);
                    updateSendButton();
                });
            }
        };
    </script>
</body>
</html>
